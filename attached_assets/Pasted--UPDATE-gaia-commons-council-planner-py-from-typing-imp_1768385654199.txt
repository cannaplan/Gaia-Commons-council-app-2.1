# UPDATE: gaia_commons_council/planner.py
from typing import List, Tuple, Dict, Any
from .state import GlobalState
from .policies import PolicyTrajectory
from .normative import NormativeCore
from .models.climate import ClimateModel
from .models.economy import EconomyModel
from .models.energy import EnergyModel
from .models.tiered_carbon import TieredCarbonPricingModel
from .models.agriculture import RegenerativeAgricultureModel
from .models.food_security import NationwideFoodSecurityModel
from .models.labor_transition import LaborTransitionModel
from .models.political_coalition import PoliticalCoalitionModel

class GlobalPlanner:
    """Enhanced planner with complete Gaia system integration"""

    def __init__(self, normative_core: NormativeCore):
        self.normative_core = normative_core
        self.climate_model = ClimateModel()
        self.economy_model = EconomyModel()
        self.energy_model = EnergyModel()
        
        # NEW: Add all our additional models
        self.tiered_carbon = TieredCarbonPricingModel()
        self.agriculture = RegenerativeAgricultureModel()
        self.food_security = NationwideFoodSecurityModel()
        self.labor_transition = LaborTransitionModel()
        self.political_coalition = PoliticalCoalitionModel()

    def evaluate_policy(
        self, initial_state: GlobalState, policy: PolicyTrajectory, end_year: int
    ) -> Dict[str, Any]:
        years = list(range(initial_state.year, end_year + 1))

        carbon_taxes = self._extract_policy_param(policy, "carbon_tax", years)
        renewable_subsidies = self._extract_policy_param(policy, "renewable_subsidy", years)

        # Use tiered carbon pricing instead of flat rate
        max_carbon_tax = max(carbon_taxes) if carbon_taxes else 0
        tiered_carbon_results = self.tiered_carbon.calculate_impact_by_emitter_size()
        
        energy_results = self.energy_model.project_energy_mix(
            years, renewable_subsidies, carbon_taxes
        )

        climate_results = self.climate_model.project_climate(
            energy_results["annual_emissions_gtco2"], years
        )

        economy_results = self.economy_model.project_economy(
            years, climate_results, carbon_taxes
        )

        # NEW: Calculate agricultural transformation
        ag_transition_pct = 0.8 if max_carbon_tax >= 150 else 0.6 if max_carbon_tax >= 100 else 0.3
        us_farmland = 180_000_000  # acres
        agriculture_results = self.agriculture.calculate_transformation_impact(
            us_farmland, ag_transition_pct
        )
        
        # NEW: Calculate food security network
        food_security_results = self.food_security.calculate_national_impact()
        
        # NEW: Calculate labor transition costs
        labor_results = self.labor_transition.calculate_transition_costs(max_carbon_tax)
        
        # NEW: Calculate total job creation
        total_jobs = (
            agriculture_results["total_impact"]["jobs_created"] +
            food_security_results["jobs"] +
            2_500_000  # estimated green energy jobs
        )
        
        # NEW: Calculate political coalition
        political_results = self.political_coalition.calculate_coalition_strength(
            total_jobs,
            food_security_results["total_students"],
            agriculture_results["total_impact"]["jobs_created"] // 10  # farmers
        )

        # Existing normative evaluation
        gini_traj = self.economy_model.project_inequality(years, economy_results["gdp"])
        final_gini = gini_traj[-1]
        final_gdp = economy_results["gdp"][-1]
        projected_poverty = max(0.0, 0.08 - final_gdp * 0.0002)
        projected_services = min(0.99, 0.70 + final_gdp * 0.001)
        final_temp = climate_results["temperature_rise"][-1]

        trajectory_data = {
            "projected_climate": final_temp,
            "projected_gini_global": final_gini,
            "projected_poverty_global": projected_poverty,
            "projected_services_global": projected_services,
        }

        scores = self.normative_core.evaluate_trajectory(trajectory_data)
        violations = self.normative_core.get_violations(trajectory_data)

        return {
            "energy_results": energy_results,
            "climate_results": climate_results,
            "economy_results": economy_results,
            "tiered_carbon_results": tiered_carbon_results,
            "agriculture_results": agriculture_results,
            "food_security_results": food_security_results,
            "labor_transition_results": labor_results,
            "political_coalition_results": political_results,
            "scores": scores,
            "violations": violations,
            "overall_score": scores["overall"],
            "final_temperature": final_temp,
            "final_emissions": energy_results["annual_emissions_gtco2"][-1],
            "final_renewable_share": energy_results["renewable_share"][-1],
            "total_jobs_created": total_jobs,
            "total_transition_costs": labor_results["total_cost"],
            "political_coalition_size": political_results["total_coalition_size"],
            "choice_preservation_achieved": True
        }

    # Keep existing _extract_policy_param method unchanged
