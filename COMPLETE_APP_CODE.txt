================================================================================
GAIA COMMONS COUNCIL DASHBOARD - COMPLETE APPLICATION CODE
================================================================================
One Vote, Forever Fed - 2026 Ballot Initiative Dashboard
Full-Stack React + Express + PostgreSQL Application

TABLE OF CONTENTS:
1. FRONTEND: App.tsx (Router)
2. FRONTEND: Dashboard.tsx (Main Page)
3. FRONTEND: BallotPresentation.tsx (Slides)
4. FRONTEND: ClusterBuilder.tsx (Interactive Tool)
5. FRONTEND: Components (FundingCalculator, etc.)
6. BACKEND: server/routes.ts (API + Seed Data)
7. SHARED: shared/schema.ts (Database Schema)
8. BACKEND: server/storage.ts (Database Interface)

================================================================================
1. FRONTEND - client/src/App.tsx
================================================================================
import { Switch, Route } from "wouter";
import { queryClient } from "./lib/queryClient";
import { QueryClientProvider } from "@tanstack/react-query";
import { Toaster } from "@/components/ui/toaster";
import { TooltipProvider } from "@/components/ui/tooltip";
import { ThemeProvider } from "@/lib/theme-context";
import { HighContrastProvider } from "@/components/HighContrastToggle";
import { KeyboardNavProvider } from "@/components/KeyboardNav";
import Dashboard from "@/pages/Dashboard";
import ClusterBuilder from "@/pages/ClusterBuilder";
import BallotPresentation from "@/pages/BallotPresentation";
import NotFound from "@/pages/not-found";
import './lib/i18n';

function Router() {
  return (
    <Switch>
      <Route path="/" component={Dashboard} />
      <Route path="/cluster-builder" component={ClusterBuilder} />
      <Route path="/ballot-presentation" component={BallotPresentation} />
      <Route component={NotFound} />
    </Switch>
  );
}

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <ThemeProvider>
        <HighContrastProvider>
          <KeyboardNavProvider>
            <TooltipProvider>
              <a href="#main-content" className="skip-link">
                Skip to main content
              </a>
              <Toaster />
              <Router />
            </TooltipProvider>
          </KeyboardNavProvider>
        </HighContrastProvider>
      </ThemeProvider>
    </QueryClientProvider>
  );
}

export default App;


================================================================================
2. FRONTEND - client/src/pages/Dashboard.tsx
================================================================================

import { useState, useEffect, useRef } from "react";
import { motion } from "framer-motion";
import { Link } from "wouter";
import { Header } from "@/components/Header";
import { StatsCard, StatItem } from "@/components/StatsCard";
import { Timeline } from "@/components/Timeline";
import { EngagementFooter } from "@/components/EngagementPanel";
import EndowmentGrowthChart from "@/components/EndowmentGrowthChart";
import JobsBreakdownChart from "@/components/JobsBreakdownChart";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Tooltip as UITooltip, TooltipContent, TooltipTrigger } from "@/components/ui/tooltip";
import html2canvas from "html2canvas";
import jsPDF from "jspdf";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { 
  usePilotStats, 
  useEndowmentStats, 
  useTimeline,
  useFinancialMetrics,
  useClimateMetrics,
  useSlides,
  useHistoricalFinancials,
  useSchoolClusters,
  useSchools,
  useScaleProjections,
  useEnvironmentalImpact,
  useJobCreation,
  useLegalFramework,
  useEndowmentProjections,
  useExpandedJobs,
  useK12Curriculum,
  useCoalitionPartners,
  useFundingSources,
  useTransparencyFeatures,
  useAccountabilityMechanisms,
  useTribalPartnerships,
  useImplementationTimeline,
  usePoliticalRoadmap,
  useStressTests,
  useTieredCarbonPricing,
  useRegenerativeAgriculture,
  useNationwideFoodSecurity,
  useLaborTransition,
  usePoliticalCoalitionData,
  useGlobalRegenerationSummary,
  usePlanetaryBoundaries,
  useCalibrationTargets,
  useModelMaturity,
  useHistoricalClimateData,
  useMonteCarloSimulations,
  useScenarioComparisons,
  useOptimizationParams,
  useSensitivityAnalysis,
  useMiningAlternatives
} from "@/hooks/use-gaia";
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  BarChart,
  Bar,
  AreaChart,
  Area,
  PieChart,
  Pie,
  Cell,
  RadarChart,
  PolarGrid,
  PolarAngleAxis,
  PolarRadiusAxis,
  Radar
} from "recharts";
import { 
  Sprout, 
  Landmark, 
  Users, 
  Ruler, 
  School, 
  Activity,
  Trees,
  DollarSign,
  TrendingUp,
  Loader2,
  Thermometer,
  Wind,
  Presentation,
  Calculator,
  Leaf,
  Target,
  Shield,
  Vote,
  PiggyBank,
  Scale,
  Building2,
  Coins,
  Globe,
  MapPin,
  Briefcase,
  Factory,
  Droplets,
  Zap,
  Recycle,
  GraduationCap,
  Globe2,
  Map,
  Building,
  BookOpen,
  Users2,
  Banknote,
  HandCoins,
  Handshake,
  Clock,
  Eye,
  ShieldCheck,
  ClipboardCheck,
  AlertTriangle,
  Feather,
  Calendar,
  MapPinned,
  ShieldAlert,
  CheckCircle2,
  Flame,
  Wheat,
  Utensils,
  HardHat,
  Vote as VoteIcon,
  Gauge,
  FlaskConical,
  Database,
  Waypoints,
  CircleDot,
  AlertCircle,
  CheckCircle,
  XCircle,
  BarChart3,
  GitCompare,
  SlidersHorizontal,
  TrendingDown,
  Percent,
  ArrowUpDown,
  Download,
  Printer,
  Info,
  HelpCircle,
  ChevronRight,
  ChevronLeft,
  Truck,
  Sparkles,
  ArrowRight,
  Home
} from "lucide-react";
import {
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselNext,
  CarouselPrevious,
} from "@/components/ui/carousel";
import { QuickNav } from "@/components/QuickNav";
import { FundingCalculator } from "@/components/FundingCalculator";
import { CollapsibleSection } from "@/components/CollapsibleSection";
import { ProgressBar } from "@/components/ProgressBar";
import { SocialSharing } from "@/components/SocialSharing";
import { ImpactCalculator } from "@/components/ImpactCalculator";
import { CommunityComparison } from "@/components/CommunityComparison";

const SCALE_LABELS: Record<string, string> = {
  pilot: "Pilot (6 Schools)",
  statewide: "Statewide (1,200 Greenhouses)",
  national: "National (130K Schools)",
  global: "Global (1M Schools)"
};

const SCALE_COLORS = {
  pilot: "bg-blue-500",
  statewide: "bg-emerald-500",
  national: "bg-purple-500",
  global: "bg-amber-500"
};

function formatLargeNumber(num: number): string {
  if (num >= 1e12) return `$${(num / 1e12).toFixed(1)}T`;
  if (num >= 1e9) return `$${(num / 1e9).toFixed(1)}B`;
  if (num >= 1e6) return `$${(num / 1e6).toFixed(1)}M`;
  if (num >= 1e3) return `$${(num / 1e3).toFixed(0)}K`;
  return `$${num.toFixed(0)}`;
}

function formatNumber(num: number): string {
  if (num >= 1e9) return `${(num / 1e9).toFixed(1)}B`;
  if (num >= 1e6) return `${(num / 1e6).toFixed(1)}M`;
  if (num >= 10000) return `${(num / 1e3).toFixed(0)}K`;
  if (num >= 1000) return num.toLocaleString();
  return num.toLocaleString();
}

export default function Dashboard() {
  const [selectedScale, setSelectedScale] = useState(() => {
    if (typeof window !== 'undefined') {
      return localStorage.getItem('gaiaSelectedScale') || 'pilot';
    }
    return 'pilot';
  });
  const [isExporting, setIsExporting] = useState(false);
  const dashboardRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    localStorage.setItem('gaiaSelectedScale', selectedScale);
  }, [selectedScale]);

  const handleExportPDF = async () => {
    if (!dashboardRef.current) return;
    setIsExporting(true);
    try {
      const canvas = await html2canvas(dashboardRef.current, {
        scale: 1.5,
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff'
      });
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
      });
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
      let heightLeft = pdfHeight;
      let position = 0;
      pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
      heightLeft -= pdf.internal.pageSize.getHeight();
      while (heightLeft > 0) {
        position = heightLeft - pdfHeight;
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
        heightLeft -= pdf.internal.pageSize.getHeight();
      }
      pdf.save(`gaia-commons-report-${selectedScale}-${new Date().toISOString().split('T')[0]}.pdf`);
    } catch (error) {
      console.error('PDF export failed:', error);
    } finally {
      setIsExporting(false);
    }
  };

  const handlePrint = () => {
    window.print();
  };
  
  const { data: pilot, isLoading: loadingPilot } = usePilotStats();
  const { data: endowment, isLoading: loadingEndowment } = useEndowmentStats();
  const { data: timeline, isLoading: loadingTimeline } = useTimeline();
  const { data: financials, isLoading: loadingFinancials } = useFinancialMetrics();
  const { data: climate, isLoading: loadingClimate } = useClimateMetrics();
  const { data: slides, isLoading: loadingSlides } = useSlides();
  const { data: historicalData, isLoading: loadingHistorical } = useHistoricalFinancials();
  const { data: clusters, isLoading: loadingClusters } = useSchoolClusters();
  const { data: schoolsList, isLoading: loadingSchools } = useSchools();
  const { data: scaleProjections, isLoading: loadingScales } = useScaleProjections();
  const { data: envImpacts, isLoading: loadingEnv } = useEnvironmentalImpact();
  const { data: jobData, isLoading: loadingJobs } = useJobCreation();
  const { data: endowmentProjections } = useEndowmentProjections();
  const { data: expandedJobs } = useExpandedJobs();
  const { data: curriculum } = useK12Curriculum();
  const { data: coalition } = useCoalitionPartners();
  const { data: fundingSources } = useFundingSources();
  const { data: transparencyFeatures } = useTransparencyFeatures();
  const { data: accountabilityMechanisms } = useAccountabilityMechanisms();
  const { data: tribalPartnerships } = useTribalPartnerships();
  const { data: implementationTimeline } = useImplementationTimeline();
  const { data: politicalRoadmap } = usePoliticalRoadmap();
  const { data: stressTests } = useStressTests();
  const { data: tieredCarbonPricing } = useTieredCarbonPricing();
  const { data: regenerativeAgriculture } = useRegenerativeAgriculture();
  const { data: nationwideFoodSecurity } = useNationwideFoodSecurity();
  const { data: laborTransition } = useLaborTransition();
  const { data: politicalCoalitionData } = usePoliticalCoalitionData();
  const { data: globalRegenerationSummary } = useGlobalRegenerationSummary();
  const { data: planetaryBoundaries } = usePlanetaryBoundaries();
  const { data: calibrationTargets } = useCalibrationTargets();
  const { data: modelMaturity } = useModelMaturity();
  const { data: historicalClimateData } = useHistoricalClimateData();
  const { data: monteCarloSimulations } = useMonteCarloSimulations();
  const { data: scenarioComparisons } = useScenarioComparisons();
  const { data: optimizationParams } = useOptimizationParams();
  const { data: sensitivityAnalysis } = useSensitivityAnalysis();
  const { data: miningAlternatives } = useMiningAlternatives();
  const { data: legalFramework, isLoading: loadingLegal } = useLegalFramework();

  const isLoading = loadingPilot || loadingEndowment || loadingTimeline || loadingFinancials || 
    loadingClimate || loadingSlides || loadingHistorical || loadingClusters || loadingSchools || 
    loadingScales || loadingEnv || loadingJobs || loadingLegal;

  const currentScale = scaleProjections?.find(s => s.scale === selectedScale);
  const currentEnv = envImpacts?.find(e => e.scale === selectedScale);
  const currentJobs = jobData?.find(j => j.scale === selectedScale);

  const chartData = historicalData?.map(h => ({
    period: `${h.year} Q${h.quarter}`,
    revenue: h.totalRevenue / 1000,
    opex: h.totalOpex / 1000,
    yield: h.totalYieldLbs / 1000,
    endowment: h.endowmentValue / 1000000000,
    schools: h.schoolCount,
    students: h.studentsServed
  })) || [];

  const scaleComparisonData = scaleProjections?.map(s => ({
    name: s.scale.charAt(0).toUpperCase() + s.scale.slice(1),
    schools: s.schools,
    students: s.students,
    jobs: s.jobs,
    meals: s.mealsPerDay,
    co2: s.co2TonsAnnual
  })) || [];

  const jobBreakdownData = currentJobs ? [
    { name: "Direct Jobs", value: currentJobs.directJobs, color: "#3b82f6" },
    { name: "Indirect Jobs", value: currentJobs.indirectJobs, color: "#22c55e" },
    { name: "Induced Jobs", value: currentJobs.inducedJobs, color: "#f59e0b" }
  ] : [];

  if (isLoading) {
    return (
      <div className="min-h-screen w-full flex flex-col items-center justify-center bg-gradient-to-br from-background to-secondary/30">
        <Loader2 className="h-10 w-10 text-primary animate-spin mb-4" data-testid="loader-main" />
        <p className="text-muted-foreground font-medium animate-pulse">Loading Gaia Commons Platform v4.1...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-background to-secondary/30 pb-20 print:bg-white">
      <div id="main-content" ref={dashboardRef} className="max-w-[1800px] mx-auto px-4 sm:px-6 lg:px-8 2xl:px-12 pt-6">
        <motion.div initial={{ opacity: 0, y: -20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.6 }}>
          <div className="flex items-center justify-between flex-wrap gap-4 mb-4">
            <Header />
            <div className="flex items-center gap-2 print:hidden" data-testid="export-controls">
              <UITooltip>
                <TooltipTrigger asChild>
                  <Button 
                    variant="outline" 
                    size="sm" 
                    onClick={handleExportPDF}
                    disabled={isExporting}
                    data-testid="button-export-pdf"
                  >
                    {isExporting ? <Loader2 className="h-4 w-4 animate-spin" /> : <Download className="h-4 w-4" />}
                    <span className="ml-2 hidden sm:inline">Export PDF</span>
                  </Button>
                </TooltipTrigger>
                <TooltipContent>Download dashboard as PDF report</TooltipContent>
              </UITooltip>
              <UITooltip>
                <TooltipTrigger asChild>
                  <Button variant="outline" size="sm" onClick={handlePrint} data-testid="button-print">
                    <Printer className="h-4 w-4" />
                    <span className="ml-2 hidden sm:inline">Print</span>
                  </Button>
                </TooltipTrigger>
                <TooltipContent>Print dashboard</TooltipContent>
              </UITooltip>
            </div>
          </div>
        </motion.div>

        {/* 1. MISSION STATEMENT */}
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.05 }} className="mb-8">
          <Card className="glass-panel border-2 border-primary/20 bg-gradient-to-r from-primary/5 via-secondary/5 to-accent/5" data-testid="card-mission">
            <CardContent className="py-8">
              <div className="text-center max-w-4xl mx-auto">
                <div className="flex justify-center mb-4">
                  <div className="h-16 w-16 rounded-full bg-primary/10 flex items-center justify-center">
                    <Sprout className="h-8 w-8 text-primary" />
                  </div>
                </div>
                <h2 className="text-2xl md:text-3xl font-bold text-foreground mb-4">One Vote, Forever Fed</h2>
                <p className="text-lg text-muted-foreground mb-6">
                  The Gaia Commons Council 2026 ballot initiative aims to create a perpetual endowment that feeds every Minnesota student 
                  fresh, locally-grown food while building climate-resilient communities, permanent jobs, and regenerative food systems 
                  that scale from 6 pilot schools to a global network.
                </p>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                  <div className="p-4 bg-primary/10 rounded-xl">
                    <Leaf className="h-5 w-5 text-primary mx-auto mb-2" />
                    <p className="text-sm font-semibold text-foreground">Perpetual Endowment</p>
                    <p className="text-xs text-muted-foreground">$5B principal @ 4.5% = $225M/yr</p>
                  </div>
                  <div className="p-4 bg-secondary/10 rounded-xl">
                    <Users className="h-5 w-5 text-secondary mx-auto mb-2" />
                    <p className="text-sm font-semibold text-foreground">712,500 Students Fed</p>
                    <p className="text-xs text-muted-foreground">Fresh meals year-round</p>
                  </div>
                  <div className="p-4 bg-accent/10 rounded-xl">
                    <Briefcase className="h-5 w-5 text-accent mx-auto mb-2" />
                    <p className="text-sm font-semibold text-foreground">4,850+ Permanent Jobs</p>
                    <p className="text-xs text-muted-foreground">2,400 statewide + 50 tribal + 2,400 mining alt</p>
                  </div>
                  <div className="p-4 bg-emerald-500/10 rounded-xl">
                    <Trees className="h-5 w-5 text-emerald-600 mx-auto mb-2" />
                    <p className="text-sm font-semibold text-foreground">Climate Action</p>
                    <p className="text-xs text-muted-foreground">246K tons CO₂ sequestered/yr</p>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </motion.div>

        {/* 2. MINNESOTA PILOT CLUSTERS (moved before scale selector) */}
        {clusters && clusters.length > 0 && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.1 }} className="mb-8">
            <Card className="glass-panel" data-testid="card-school-clusters">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <MapPin className="h-5 w-5 text-primary" />
                <CardTitle className="text-lg font-semibold">Minnesota Pilot School Clusters — St. Paul & Mendota Heights</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {clusters.map(cluster => {
                    const clusterSchools = schoolsList?.filter(s => s.clusterId === cluster.id) || [];
                    return (
                      <div key={cluster.id} className="p-4 bg-muted/30 rounded-xl border border-border/50" data-testid={`cluster-${cluster.name.toLowerCase().replace(' ', '-')}`}>
                        <div className="flex items-center gap-3 mb-4">
                          <div className="h-10 w-10 rounded-lg bg-primary/10 flex items-center justify-center">
                            <Building2 className="h-5 w-5 text-primary" />
                          </div>
                          <div>
                            <h3 className="font-semibold text-foreground">{cluster.name} Cluster</h3>
                            <p className="text-sm text-muted-foreground">{cluster.region}</p>
                          </div>
                        </div>
                        <div className="grid grid-cols-4 gap-3 mb-4">
                          <div className="text-center p-2 bg-background rounded-lg">
                            <p className="text-xs text-muted-foreground">Students</p>
                            <p className="font-semibold text-foreground">{cluster.totalStudents.toLocaleString()}</p>
                          </div>
                          <div className="text-center p-2 bg-background rounded-lg">
                            <p className="text-xs text-muted-foreground">Yr 5 Est.</p>
                            <p className="font-semibold text-emerald-600">{cluster.yr5Students.toLocaleString()}</p>
                          </div>
                          <div className="text-center p-2 bg-background rounded-lg">
                            <p className="text-xs text-muted-foreground">Sq Ft</p>
                            <p className="font-semibold text-foreground">{(cluster.totalSqft / 1000).toFixed(1)}K</p>
                          </div>
                          <div className="text-center p-2 bg-background rounded-lg">
                            <p className="text-xs text-muted-foreground">Greenhouses</p>
                            <p className="font-semibold text-foreground">{cluster.greenhouses}</p>
                          </div>
                        </div>
                        <div className="space-y-2 mb-4">
                          <p className="text-xs font-medium text-muted-foreground uppercase tracking-wide">Individual Schools</p>
                          {clusterSchools.map(school => (
                            <div key={school.id} className="flex items-center justify-between p-2 bg-background rounded-lg border border-border/30">
                              <div className="flex items-center gap-2">
                                <GraduationCap className="h-4 w-4 text-muted-foreground" />
                                <span className="text-sm font-medium">{school.name}</span>
                                <Badge variant="outline" className="text-xs">{school.grades}</Badge>
                              </div>
                              <div className="text-right">
                                <span className="text-sm text-muted-foreground">{school.enrollment} students</span>
                              </div>
                            </div>
                          ))}
                        </div>
                        
                        {/* Cost Analysis per Cluster */}
                        <div className="mt-4 p-3 bg-gradient-to-r from-emerald-50/50 to-blue-50/50 dark:from-emerald-950/20 dark:to-blue-950/20 rounded-lg border border-emerald-200/50 dark:border-emerald-800/50">
                          <p className="text-xs font-medium text-muted-foreground uppercase tracking-wide mb-2 flex items-center gap-1">
                            <DollarSign className="h-3 w-3" /> Initial Cost Analysis
                          </p>
                          <div className="grid grid-cols-2 gap-2 text-xs">
                            <div className="flex justify-between">
                              <span className="text-muted-foreground">Construction ($85/sqft):</span>
                              <span className="font-semibold">${((cluster.totalSqft * 85) / 1e6).toFixed(2)}M</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-muted-foreground">Annual OpEx ($12/sqft):</span>
                              <span className="font-semibold">${((cluster.totalSqft * 12) / 1e3).toFixed(0)}K</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-muted-foreground">Est. Annual Yield:</span>
                              <span className="font-semibold">{((cluster.totalSqft * 40) / 1e6).toFixed(1)}M lbs</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-muted-foreground">State Savings (@$1.82/meal):</span>
                              <span className="font-semibold text-emerald-600">${((cluster.totalStudents * 180 * 1.82) / 1e6).toFixed(2)}M</span>
                            </div>
                          </div>
                          <div className="mt-2 pt-2 border-t border-border/30 flex justify-between text-xs">
                            <span className="text-muted-foreground">Net Annual State Savings:</span>
                            <span className="font-bold text-emerald-600">${(((cluster.totalStudents * 180 * 1.82) - (cluster.totalSqft * 12)) / 1e6).toFixed(2)}M</span>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* 2.5 TRIBAL PARTNERSHIPS - Food Sovereignty (moved here to follow MN pilot) */}
        {tribalPartnerships && tribalPartnerships.length > 0 && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.12 }} className="mb-8">
            <Card className="glass-panel" data-testid="card-tribal-partnerships">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <Feather className="h-5 w-5 text-primary" />
                <CardTitle className="text-lg font-semibold">Tribal Partnerships — Permanent Food Sovereignty</CardTitle>
                <Badge variant="secondary" className="ml-auto">{tribalPartnerships.length} Partnership{tribalPartnerships.length > 1 ? 's' : ''}</Badge>
              </CardHeader>
              <CardContent>
                <p className="text-sm text-muted-foreground mb-4 italic">Priority expansion with sovereign tribal nations. Tribe owns everything, forever. No money leaves the reservation.</p>
                <div className="space-y-4">
                  {tribalPartnerships.map((partnership) => (
                    <div key={partnership.id} className="p-4 bg-muted/30 rounded-xl border border-border/50" data-testid={`tribal-${partnership.id}`}>
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-2">
                          <h3 className="font-bold text-lg text-foreground">{partnership.tribeName}</h3>
                          <Badge variant="outline" className="bg-emerald-50 dark:bg-emerald-950/30 text-emerald-700 dark:text-emerald-300 border-emerald-200 dark:border-emerald-800">{partnership.status}</Badge>
                        </div>
                        <div className="flex items-center gap-1 text-sm text-muted-foreground">
                          <MapPin className="h-4 w-4" />
                          {partnership.location}
                        </div>
                      </div>
                      
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div className="p-3 bg-emerald-50 dark:bg-emerald-950/30 rounded-lg border border-emerald-100 dark:border-emerald-900/50">
                          <p className="text-xs text-emerald-700 dark:text-emerald-400 font-medium">Greenhouses</p>
                          <p className="text-lg font-bold text-emerald-800 dark:text-emerald-300">{partnership.greenhouseCount}</p>
                        </div>
                        <div className="p-3 bg-blue-50 dark:bg-blue-950/30 rounded-lg border border-blue-100 dark:border-blue-900/50">
                          <p className="text-xs text-blue-700 dark:text-blue-400 font-medium">Local Jobs</p>
                          <p className="text-lg font-bold text-blue-800 dark:text-blue-300">{partnership.jobsCreated}</p>
                          <p className="text-xs text-blue-600 dark:text-blue-400">{partnership.hourlyWage}</p>
                        </div>
                        <div className="p-3 bg-purple-50 dark:bg-purple-950/30 rounded-lg border border-purple-100 dark:border-purple-900/50">
                          <p className="text-xs text-purple-700 dark:text-purple-400 font-medium">Students Served</p>
                          <p className="text-lg font-bold text-purple-800 dark:text-purple-300">{partnership.studentsServed.toLocaleString()}</p>
                        </div>
                        <div className="p-3 bg-amber-50 dark:bg-amber-950/30 rounded-lg border border-amber-100 dark:border-amber-900/50">
                          <p className="text-xs text-amber-700 dark:text-amber-400 font-medium">First Harvest</p>
                          <p className="text-lg font-bold text-amber-800 dark:text-amber-300">{partnership.firstHarvest}</p>
                        </div>
                      </div>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div className="p-3 bg-muted/50 rounded-lg">
                          <p className="text-xs font-medium text-muted-foreground mb-1">Schools Served</p>
                          <p className="text-sm text-foreground">{partnership.schoolsServed}</p>
                        </div>
                        {partnership.annualSurplus && (
                          <div className="p-3 bg-muted/50 rounded-lg">
                            <p className="text-xs font-medium text-muted-foreground mb-1">Annual Surplus (after Year {partnership.breakEvenYear})</p>
                            <p className="text-sm font-semibold text-primary">{partnership.annualSurplus}</p>
                          </div>
                        )}
                      </div>
                      
                      {partnership.surplusSplit && (
                        <div className="p-3 bg-primary/5 rounded-lg border border-primary/10 mb-3">
                          <p className="text-xs font-medium text-primary/70 mb-1">Surplus Distribution</p>
                          <p className="text-sm text-foreground">{partnership.surplusSplit}</p>
                        </div>
                      )}
                      
                      <div className="p-3 bg-muted/30 rounded-lg mb-3">
                        <p className="text-xs font-medium text-muted-foreground mb-1 flex items-center gap-1">
                          <ShieldCheck className="h-3 w-3" /> Governance & Fraud Protection
                        </p>
                        <p className="text-sm text-foreground">{partnership.governance}</p>
                      </div>
                      
                      {partnership.complementaryProjects && (
                        <div className="p-3 bg-emerald-50/50 dark:bg-emerald-950/20 rounded-lg border border-emerald-100 dark:border-emerald-900/30">
                          <p className="text-xs font-medium text-emerald-700 dark:text-emerald-400 mb-1 flex items-center gap-1">
                            <Leaf className="h-3 w-3" /> Complementary Projects
                          </p>
                          <p className="text-sm text-emerald-800 dark:text-emerald-300">{partnership.complementaryProjects}</p>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* 3. PILOT TO GLOBAL - Scale Selector Tabs */}
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.15 }} className="mb-8">
          <Card className="glass-panel" data-testid="card-scale-selector">
            <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
              <Globe className="h-5 w-5 text-primary" />
              <CardTitle className="text-lg font-semibold">Multi-Scale Deployment Dashboard — From Pilot to Global</CardTitle>
            </CardHeader>
            <CardContent>
              <Tabs value={selectedScale} onValueChange={setSelectedScale} className="w-full">
                <TabsList className="grid w-full grid-cols-4 mb-4" data-testid="tabs-scale">
                  <TabsTrigger value="pilot" data-testid="tab-pilot" className="flex items-center gap-2">
                    <School className="h-4 w-4" />
                    <span className="hidden sm:inline">Pilot</span>
                  </TabsTrigger>
                  <TabsTrigger value="statewide" data-testid="tab-statewide" className="flex items-center gap-2">
                    <Map className="h-4 w-4" />
                    <span className="hidden sm:inline">Statewide</span>
                  </TabsTrigger>
                  <TabsTrigger value="national" data-testid="tab-national" className="flex items-center gap-2">
                    <Building className="h-4 w-4" />
                    <span className="hidden sm:inline">National</span>
                  </TabsTrigger>
                  <TabsTrigger value="global" data-testid="tab-global" className="flex items-center gap-2">
                    <Globe2 className="h-4 w-4" />
                    <span className="hidden sm:inline">Global</span>
                  </TabsTrigger>
                </TabsList>
                
                {/* Phase Context Info */}
                <div className="mb-4 p-3 bg-muted/30 rounded-lg border border-border/50">
                  {selectedScale === 'pilot' && (
                    <div className="flex items-start gap-2">
                      <Info className="h-4 w-4 text-blue-500 mt-0.5 shrink-0" />
                      <div>
                        <p className="text-sm font-medium text-foreground">2026 Pilot Phase</p>
                        <p className="text-xs text-muted-foreground">6 St. Paul/Mendota schools demonstrating the model. 5,630 students receiving fresh produce daily. $2.95M initial investment with 435% ROI.</p>
                      </div>
                    </div>
                  )}
                  {selectedScale === 'statewide' && (
                    <div className="flex items-start gap-2">
                      <Info className="h-4 w-4 text-emerald-500 mt-0.5 shrink-0" />
                      <div>
                        <p className="text-sm font-medium text-foreground">2028-2030 Statewide Expansion</p>
                        <p className="text-xs text-muted-foreground">After ballot initiative passes, $5B endowment @ 4.5% = $225M/yr funds 1,200 greenhouses across all Minnesota school districts. 712,500 students fed daily with year-round fresh produce.</p>
                      </div>
                    </div>
                  )}
                  {selectedScale === 'national' && (
                    <div className="flex items-start gap-2">
                      <Info className="h-4 w-4 text-purple-500 mt-0.5 shrink-0" />
                      <div>
                        <p className="text-sm font-medium text-foreground">2035 National Rollout</p>
                        <p className="text-xs text-muted-foreground">Other states adopt the proven Minnesota model through similar ballot initiatives. 130,000 schools and 50 million students benefit nationwide with $48B total investment.</p>
                      </div>
                    </div>
                  )}
                  {selectedScale === 'global' && (
                    <div className="flex items-start gap-2">
                      <Info className="h-4 w-4 text-amber-500 mt-0.5 shrink-0" />
                      <div>
                        <p className="text-sm font-medium text-foreground">2040+ Global Impact</p>
                        <p className="text-xs text-muted-foreground">International partners replicate the model. 1 million schools serve 500 million children with food security. 41M tons CO2 sequestered annually, transforming global food systems.</p>
                      </div>
                    </div>
                  )}
                </div>

                {currentScale && (
                  <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                    <div className="p-4 bg-blue-50 dark:bg-blue-950/30 rounded-xl border border-blue-100 dark:border-blue-900/50 text-center">
                      <School className="h-5 w-5 text-blue-600 mx-auto mb-2" />
                      <p className="text-xs text-blue-800 dark:text-blue-400 font-medium">Schools</p>
                      <p className="text-xl font-bold text-blue-700 dark:text-blue-300" data-testid="text-scale-schools">{formatNumber(currentScale.schools)}</p>
                    </div>
                    <div className="p-4 bg-emerald-50 dark:bg-emerald-950/30 rounded-xl border border-emerald-100 dark:border-emerald-900/50 text-center">
                      <Users className="h-5 w-5 text-emerald-600 mx-auto mb-2" />
                      <p className="text-xs text-emerald-800 dark:text-emerald-400 font-medium">Students</p>
                      <p className="text-xl font-bold text-emerald-700 dark:text-emerald-300" data-testid="text-scale-students">{formatNumber(currentScale.students)}</p>
                    </div>
                    <div className="p-4 bg-purple-50 dark:bg-purple-950/30 rounded-xl border border-purple-100 dark:border-purple-900/50 text-center">
                      <Sprout className="h-5 w-5 text-purple-600 mx-auto mb-2" />
                      <p className="text-xs text-purple-800 dark:text-purple-400 font-medium">Greenhouses</p>
                      <p className="text-xl font-bold text-purple-700 dark:text-purple-300" data-testid="text-scale-greenhouses">{formatNumber(currentScale.greenhouses)}</p>
                    </div>
                    <div className="p-4 bg-amber-50 dark:bg-amber-950/30 rounded-xl border border-amber-100 dark:border-amber-900/50 text-center">
                      <DollarSign className="h-5 w-5 text-amber-600 mx-auto mb-2" />
                      <p className="text-xs text-amber-800 dark:text-amber-400 font-medium">CAPEX</p>
                      <p className="text-xl font-bold text-amber-700 dark:text-amber-300" data-testid="text-scale-capex">{formatLargeNumber(currentScale.capex)}</p>
                    </div>
                    <div className="p-4 bg-teal-50 dark:bg-teal-950/30 rounded-xl border border-teal-100 dark:border-teal-900/50 text-center">
                      <Leaf className="h-5 w-5 text-teal-600 mx-auto mb-2" />
                      <p className="text-xs text-teal-800 dark:text-teal-400 font-medium">State Savings</p>
                      <p className="text-xl font-bold text-teal-700 dark:text-teal-300" data-testid="text-scale-state-savings">{formatLargeNumber(currentScale.annualRevenue)}</p>
                    </div>
                    <div className="p-4 bg-green-50 dark:bg-green-950/30 rounded-xl border border-green-100 dark:border-green-900/50 text-center">
                      <TrendingUp className="h-5 w-5 text-green-600 mx-auto mb-2" />
                      <p className="text-xs text-green-800 dark:text-green-400 font-medium">5-Yr NPV</p>
                      <p className="text-xl font-bold text-green-700 dark:text-green-300" data-testid="text-scale-npv">{formatLargeNumber(currentScale.npv5yr)}</p>
                    </div>
                    <div className="p-4 bg-rose-50 dark:bg-rose-950/30 rounded-xl border border-rose-100 dark:border-rose-900/50 text-center">
                      <Target className="h-5 w-5 text-rose-600 mx-auto mb-2" />
                      <p className="text-xs text-rose-800 dark:text-rose-400 font-medium">ROI</p>
                      <p className="text-xl font-bold text-rose-700 dark:text-rose-300" data-testid="text-scale-roi">{currentScale.roiPct}%</p>
                    </div>
                  </div>
                )}
              </Tabs>
            </CardContent>
          </Card>
        </motion.div>

        {/* 4. CLUSTER BUILDER CTA */}
        {(
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.18 }} className="mb-8">
            <Card className="glass-panel border-primary/20 bg-gradient-to-r from-primary/5 to-emerald-500/5" data-testid="card-cluster-builder-cta">
              <CardContent className="py-6">
                <div className="flex flex-col md:flex-row items-center justify-between gap-4">
                  <div className="flex items-center gap-4">
                    <div className="h-14 w-14 rounded-xl bg-primary/10 flex items-center justify-center">
                      <Sprout className="h-8 w-8 text-primary" />
                    </div>
                    <div>
                      <h3 className="text-xl font-bold text-foreground">Build Your Own Greenhouse Cluster</h3>
                      <p className="text-muted-foreground">
                        Design a custom pilot program for your school district with interactive metrics
                      </p>
                    </div>
                  </div>
                  <div className="flex gap-3">
                    <Link href="/cluster-builder">
                      <Button size="lg" className="gap-2" data-testid="button-goto-cluster-builder">
                        <Calculator className="h-5 w-5" />
                        Cluster Builder
                      </Button>
                    </Link>
                  </div>
                </div>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* 4.5 STANDALONE 2026 BALLOT DECK CTA */}
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.19 }} className="mb-8">
          <Card className="glass-panel border-purple-500/20 bg-gradient-to-r from-purple-500/5 to-indigo-500/5" data-testid="card-ballot-deck-cta">
            <CardContent className="py-6">
              <div className="flex flex-col md:flex-row items-center justify-between gap-4">
                <div className="flex items-center gap-4">
                  <div className="h-14 w-14 rounded-xl bg-purple-500/10 flex items-center justify-center">
                    <Vote className="h-8 w-8 text-purple-600" />
                  </div>
                  <div>
                    <h3 className="text-xl font-bold text-foreground">2026 Ballot Initiative Presentation</h3>
                    <p className="text-muted-foreground">
                      View the complete "One Vote, Forever Fed" deck for community presentations
                    </p>
                  </div>
                </div>
                <Link href="/ballot-presentation">
                  <Button size="lg" variant="outline" className="gap-2 border-purple-500/30" data-testid="button-goto-presentation">
                    <Presentation className="h-5 w-5" />
                    View Ballot Deck
                  </Button>
                </Link>
              </div>
            </CardContent>
          </Card>
        </motion.div>

        {/* Environmental Impact & Job Creation */}
        <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-2 gap-6 xl:gap-8 mb-8">
          {/* Environmental Impact */}
          <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }} transition={{ duration: 0.5, delay: 0.2 }}>
            <Card className="glass-panel h-full" data-testid="card-environmental">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <Leaf className="h-5 w-5 text-primary" />
                <CardTitle className="text-lg font-semibold">Environmental Impact — {SCALE_LABELS[selectedScale]}</CardTitle>
              </CardHeader>
              <CardContent>
                {currentEnv && (
                  <div className="space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                      <div className="p-4 bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-950/30 dark:to-emerald-950/30 rounded-xl border border-green-100 dark:border-green-900/50">
                        <div className="flex items-center gap-2 mb-2">
                          <Trees className="h-4 w-4 text-green-600" />
                          <span className="text-xs font-medium text-green-800 dark:text-green-400 uppercase">CO2 Sequestered</span>
                        </div>
                        <p className="text-2xl font-bold text-green-700 dark:text-green-300" data-testid="text-env-co2">
                          {formatNumber(currentEnv.co2SequesteredTons)} tons/yr
                        </p>
                      </div>
                      <div className="p-4 bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-950/30 dark:to-cyan-950/30 rounded-xl border border-blue-100 dark:border-blue-900/50">
                        <div className="flex items-center gap-2 mb-2">
                          <Droplets className="h-4 w-4 text-blue-600" />
                          <span className="text-xs font-medium text-blue-800 dark:text-blue-400 uppercase">Water Saved</span>
                        </div>
                        <p className="text-2xl font-bold text-blue-700 dark:text-blue-300" data-testid="text-env-water">
                          {formatNumber(currentEnv.waterSavedGallons)} gal
                        </p>
                      </div>
                    </div>
                    <div className="grid grid-cols-3 gap-3">
                      <div className="text-center p-3 bg-muted/50 rounded-lg">
                        <Map className="h-4 w-4 text-muted-foreground mx-auto mb-1" />
                        <p className="text-xs text-muted-foreground">Land Preserved</p>
                        <p className="font-semibold text-foreground">{formatNumber(currentEnv.landPreservedAcres)} acres</p>
                      </div>
                      <div className="text-center p-3 bg-muted/50 rounded-lg">
                        <Factory className="h-4 w-4 text-muted-foreground mx-auto mb-1" />
                        <p className="text-xs text-muted-foreground">Food Miles Cut</p>
                        <p className="font-semibold text-foreground">{formatNumber(currentEnv.foodMilesReduced)}</p>
                      </div>
                      <div className="text-center p-3 bg-muted/50 rounded-lg">
                        <Zap className="h-4 w-4 text-muted-foreground mx-auto mb-1" />
                        <p className="text-xs text-muted-foreground">Renewable Energy</p>
                        <p className="font-semibold text-foreground">{currentEnv.renewableEnergyPct}%</p>
                      </div>
                    </div>
                    <div className="p-3 bg-primary/5 rounded-lg border border-primary/10">
                      <div className="flex items-center gap-2">
                        <Recycle className="h-4 w-4 text-primary" />
                        <span className="text-sm font-medium text-foreground">Waste Reduced: {formatNumber(currentEnv.wasteReducedTons)} tons/year</span>
                      </div>
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>
          </motion.div>

          {/* Job Creation */}
          <motion.div initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} transition={{ duration: 0.5, delay: 0.25 }}>
            <Card className="glass-panel h-full" data-testid="card-jobs">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <Briefcase className="h-5 w-5 text-primary" />
                <CardTitle className="text-lg font-semibold">Job Creation & Economic Impact — {SCALE_LABELS[selectedScale]}</CardTitle>
              </CardHeader>
              <CardContent>
                {currentJobs && (
                  <div className="space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                      <div className="p-4 bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-purple-950/30 dark:to-indigo-950/30 rounded-xl border border-purple-100 dark:border-purple-900/50">
                        <div className="flex items-center gap-2 mb-2">
                          <Users className="h-4 w-4 text-purple-600" />
                          <span className="text-xs font-medium text-purple-800 dark:text-purple-400 uppercase">Total Jobs Created</span>
                        </div>
                        <p className="text-2xl font-bold text-purple-700 dark:text-purple-300" data-testid="text-jobs-total">
                          {formatNumber(currentJobs.totalJobs)}
                        </p>
                      </div>
                      <div className="p-4 bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-950/30 dark:to-orange-950/30 rounded-xl border border-amber-100 dark:border-amber-900/50">
                        <div className="flex items-center gap-2 mb-2">
                          <DollarSign className="h-4 w-4 text-amber-600" />
                          <span className="text-xs font-medium text-amber-800 dark:text-amber-400 uppercase">Economic Impact</span>
                        </div>
                        <p className="text-2xl font-bold text-amber-700 dark:text-amber-300" data-testid="text-jobs-impact">
                          {formatLargeNumber(currentJobs.economicImpact)}
                        </p>
                      </div>
                    </div>
                    <div className="grid grid-cols-3 gap-3">
                      <div className="text-center p-3 bg-blue-50 dark:bg-blue-950/30 rounded-lg border border-blue-100 dark:border-blue-900/50">
                        <p className="text-xs text-blue-800 dark:text-blue-400 font-medium">Direct Jobs</p>
                        <p className="font-semibold text-blue-700 dark:text-blue-300">{formatNumber(currentJobs.directJobs)}</p>
                      </div>
                      <div className="text-center p-3 bg-green-50 dark:bg-green-950/30 rounded-lg border border-green-100 dark:border-green-900/50">
                        <p className="text-xs text-green-800 dark:text-green-400 font-medium">Indirect Jobs</p>
                        <p className="font-semibold text-green-700 dark:text-green-300">{formatNumber(currentJobs.indirectJobs)}</p>
                      </div>
                      <div className="text-center p-3 bg-amber-50 dark:bg-amber-950/30 rounded-lg border border-amber-100 dark:border-amber-900/50">
                        <p className="text-xs text-amber-800 dark:text-amber-400 font-medium">Induced Jobs</p>
                        <p className="font-semibold text-amber-700 dark:text-amber-300">{formatNumber(currentJobs.inducedJobs)}</p>
                      </div>
                    </div>
                    <div className="p-3 bg-primary/5 rounded-lg border border-primary/10">
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-muted-foreground">Average Salary</span>
                        <span className="font-semibold text-foreground">${currentJobs.avgSalary.toLocaleString()}/year</span>
                      </div>
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>
          </motion.div>
        </div>

        {/* Scale Comparison - Detailed Table with Context */}
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.3 }} className="mb-8">
          <CollapsibleSection
            title="Growth Pathway — From 6 Schools to Global Impact"
            icon={<TrendingUp className="h-5 w-5 text-primary" />}
            badge={<Badge variant="secondary">4 Phases</Badge>}
            defaultOpen={true}
            testId="card-scale-comparison"
          >
            <p className="text-sm text-muted-foreground mb-4">
              The Gaia Commons model scales from a 6-school Minnesota pilot to global deployment. Each phase builds on proven success, 
              with the 2026 ballot initiative funding statewide expansion. Here's how the numbers grow at each stage:
            </p>
            
            {/* Detailed Comparison Table */}
            <div className="overflow-x-auto mb-6">
              <table className="w-full text-sm border-collapse">
                <thead>
                  <tr className="border-b border-border">
                    <th className="text-left p-3 font-semibold text-foreground bg-muted/30">Metric</th>
                    {scaleProjections?.map(s => (
                      <th key={s.scale} className="text-center p-3 font-semibold text-foreground bg-muted/30">
                        <div className="flex flex-col items-center gap-1">
                          <span className="capitalize">{s.scale}</span>
                          <Badge variant="outline" className="text-xs">
                            {s.scale === 'pilot' ? '2026' : s.scale === 'statewide' ? '2028-30' : s.scale === 'national' ? '2035' : '2040+'}
                          </Badge>
                        </div>
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  <tr className="border-b border-border/50 hover:bg-muted/20">
                    <td className="p-3 text-muted-foreground flex items-center gap-2">
                      <School className="h-4 w-4" /> Schools
                    </td>
                    {scaleProjections?.map(s => (
                      <td key={s.scale} className="text-center p-3 font-medium">{formatNumber(s.schools)}</td>
                    ))}
                  </tr>
                  <tr className="border-b border-border/50 hover:bg-muted/20">
                    <td className="p-3 text-muted-foreground flex items-center gap-2">
                      <Users className="h-4 w-4" /> Students Fed Daily
                    </td>
                    {scaleProjections?.map(s => (
                      <td key={s.scale} className="text-center p-3 font-medium">{formatNumber(s.students)}</td>
                    ))}
                  </tr>
                  <tr className="border-b border-border/50 hover:bg-muted/20">
                    <td className="p-3 text-muted-foreground flex items-center gap-2">
                      <Briefcase className="h-4 w-4" /> Jobs Created
                    </td>
                    {scaleProjections?.map(s => (
                      <td key={s.scale} className="text-center p-3 font-medium text-primary">{formatNumber(s.jobs)}</td>
                    ))}
                  </tr>
                  <tr className="border-b border-border/50 hover:bg-muted/20">
                    <td className="p-3 text-muted-foreground flex items-center gap-2">
                      <Utensils className="h-4 w-4" /> Meals Per Day
                    </td>
                    {scaleProjections?.map(s => (
                      <td key={s.scale} className="text-center p-3 font-medium text-emerald-600 dark:text-emerald-400">{formatNumber(s.mealsPerDay)}</td>
                    ))}
                  </tr>
                  <tr className="border-b border-border/50 hover:bg-muted/20">
                    <td className="p-3 text-muted-foreground flex items-center gap-2">
                      <Leaf className="h-4 w-4" /> CO2 Sequestered (tons/yr)
                    </td>
                    {scaleProjections?.map(s => (
                      <td key={s.scale} className="text-center p-3 font-medium">{formatNumber(s.co2TonsAnnual)}</td>
                    ))}
                  </tr>
                  <tr className="border-b border-border/50 hover:bg-muted/20">
                    <td className="p-3 text-muted-foreground flex items-center gap-2">
                      <DollarSign className="h-4 w-4" /> Endowment Target
                    </td>
                    {scaleProjections?.map(s => (
                      <td key={s.scale} className="text-center p-3 font-medium">{formatLargeNumber(s.endowmentTarget)}</td>
                    ))}
                  </tr>
                </tbody>
              </table>
            </div>

            {/* Phase Explanations */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div className="p-4 bg-blue-50/50 dark:bg-blue-950/20 rounded-lg border border-blue-200 dark:border-blue-800">
                <h4 className="font-semibold text-blue-700 dark:text-blue-300 mb-2">Pilot (2026)</h4>
                <p className="text-xs text-muted-foreground">6 St. Paul/Mendota schools prove the model works. 5,630 students receive fresh produce daily.</p>
              </div>
              <div className="p-4 bg-emerald-50/50 dark:bg-emerald-950/20 rounded-lg border border-emerald-200 dark:border-emerald-800">
                <h4 className="font-semibold text-emerald-700 dark:text-emerald-300 mb-2">Statewide (2026-29)</h4>
                <p className="text-xs text-muted-foreground">Ballot initiative passes. $5B endowment @ 4.5% = $225M/yr funds 1,200 greenhouses across all Minnesota districts.</p>
              </div>
              <div className="p-4 bg-purple-50/50 dark:bg-purple-950/20 rounded-lg border border-purple-200 dark:border-purple-800">
                <h4 className="font-semibold text-purple-700 dark:text-purple-300 mb-2">National (2035)</h4>
                <p className="text-xs text-muted-foreground">Other states adopt the proven Minnesota model. 50 million students benefit nationwide.</p>
              </div>
              <div className="p-4 bg-amber-50/50 dark:bg-amber-950/20 rounded-lg border border-amber-200 dark:border-amber-800">
                <h4 className="font-semibold text-amber-700 dark:text-amber-300 mb-2">Global (2040+)</h4>
                <p className="text-xs text-muted-foreground">International partners replicate the model. Half a billion children gain food security.</p>
              </div>
            </div>
          </CollapsibleSection>
        </motion.div>

        {/* Expanded Jobs: FTE + Internships + Volunteers - Moved to top */}
        {expandedJobs && expandedJobs.length > 0 && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.31 }} className="mb-8">
            <Card className="glass-panel" data-testid="card-expanded-jobs">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <Briefcase className="h-5 w-5 text-primary" />
                <CardTitle className="text-lg font-semibold">Job Creation — FTE, Internships & Volunteers</CardTitle>
                <Badge variant="secondary" className="ml-auto">2.4× Economic Multiplier</Badge>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  {expandedJobs.map((job) => (
                    <div key={job.id} className="p-4 bg-muted/30 rounded-xl border border-border/50" data-testid={`job-scale-${job.scale}`}>
                      <div className="flex items-center gap-2 mb-3">
                        <Badge className={SCALE_COLORS[job.scale as keyof typeof SCALE_COLORS]}>{SCALE_LABELS[job.scale]}</Badge>
                      </div>
                      <div className="space-y-2">
                        <div className="flex justify-between items-center">
                          <span className="text-sm text-muted-foreground flex items-center gap-1">
                            <Users className="h-3 w-3" /> FTE Jobs
                          </span>
                          <span className="font-semibold text-foreground">{job.fteJobs.toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="text-sm text-muted-foreground flex items-center gap-1">
                            <GraduationCap className="h-3 w-3" /> Internships
                          </span>
                          <span className="font-semibold text-foreground">{job.studentInternships.toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="text-sm text-muted-foreground flex items-center gap-1">
                            <Handshake className="h-3 w-3" /> Volunteers
                          </span>
                          <span className="font-semibold text-foreground">{job.volunteerPositions.toLocaleString()}</span>
                        </div>
                        <div className="pt-2 mt-2 border-t border-border/30">
                          <div className="flex justify-between items-center">
                            <span className="text-xs text-muted-foreground">Direct Wages</span>
                            <span className="text-sm font-semibold text-primary">{formatLargeNumber(job.directWages)}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="mt-4 p-3 bg-primary/5 rounded-lg border border-primary/10 flex items-center gap-2">
                  <DollarSign className="h-4 w-4 text-primary" />
                  <span className="text-sm text-muted-foreground">Student internships pay</span>
                  <span className="font-semibold text-foreground">${expandedJobs[0]?.hourlyWage || 15}/hr</span>
                  <span className="text-sm text-muted-foreground ml-2">| Economic multiplier effect:</span>
                  <span className="font-semibold text-primary">{expandedJobs[0]?.economicMultiplier || 2.4}×</span>
                </div>

                {/* Construction Phase Jobs */}
                <div className="mt-6 p-4 bg-blue-50 dark:bg-blue-950/30 rounded-xl border border-blue-200 dark:border-blue-800" data-testid="section-construction-jobs">
                  <div className="flex items-center gap-2 mb-4">
                    <HardHat className="h-5 w-5 text-blue-600" />
                    <h4 className="font-semibold text-blue-800 dark:text-blue-300">Construction Phase Jobs — All Scales</h4>
                    <Badge variant="outline" className="ml-auto bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 border-blue-300 dark:border-blue-700">
                      Skilled Trades
                    </Badge>
                  </div>
                  <p className="text-sm text-blue-700 dark:text-blue-400 mb-4">
                    Before permanent jobs begin, greenhouse construction creates skilled trades jobs for electricians, plumbers, HVAC technicians, and construction workers. All scales use local union labor with prevailing wages.
                  </p>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {expandedJobs.map((job) => (
                      <div key={job.id} className="p-3 bg-white/70 dark:bg-black/30 rounded-lg border border-blue-100 dark:border-blue-800/50" data-testid={`card-construction-${job.scale}`}>
                        <div className="flex items-center gap-2 mb-2">
                          <Badge className={SCALE_COLORS[job.scale as keyof typeof SCALE_COLORS]}>{SCALE_LABELS[job.scale]}</Badge>
                        </div>
                        <p className="text-2xl font-bold text-blue-800 dark:text-blue-200" data-testid={`text-construction-jobs-${job.scale}`}>{(job.constructionJobs || 0).toLocaleString()}</p>
                        <p className="text-xs text-blue-600 dark:text-blue-400 font-medium">Construction Jobs</p>
                        <p className="text-[10px] text-blue-500 dark:text-blue-500 mt-1" data-testid={`text-construction-duration-${job.scale}`}>{job.constructionDurationYears || "TBD"}</p>
                        
                        <div className="mt-3 pt-2 border-t border-blue-200 dark:border-blue-700/50 space-y-1">
                          <div className="flex justify-between text-xs" data-testid={`row-construction-${job.scale}-general`}>
                            <span className="text-blue-600 dark:text-blue-400">General</span>
                            <span className="font-medium text-blue-700 dark:text-blue-300">{(job.constructionGeneral || 0).toLocaleString()}</span>
                          </div>
                          <div className="flex justify-between text-xs" data-testid={`row-construction-${job.scale}-electricians`}>
                            <span className="text-blue-600 dark:text-blue-400">Electricians</span>
                            <span className="font-medium text-blue-700 dark:text-blue-300">{(job.constructionElectricians || 0).toLocaleString()}</span>
                          </div>
                          <div className="flex justify-between text-xs" data-testid={`row-construction-${job.scale}-plumbers`}>
                            <span className="text-blue-600 dark:text-blue-400">Plumbers</span>
                            <span className="font-medium text-blue-700 dark:text-blue-300">{(job.constructionPlumbers || 0).toLocaleString()}</span>
                          </div>
                          <div className="flex justify-between text-xs" data-testid={`row-construction-${job.scale}-hvac`}>
                            <span className="text-blue-600 dark:text-blue-400">HVAC</span>
                            <span className="font-medium text-blue-700 dark:text-blue-300">{(job.constructionHvac || 0).toLocaleString()}</span>
                          </div>
                          <div className="flex justify-between text-xs" data-testid={`row-construction-${job.scale}-specialists`}>
                            <span className="text-blue-600 dark:text-blue-400">Specialists</span>
                            <span className="font-medium text-blue-700 dark:text-blue-300">{(job.constructionSpecialists || 0).toLocaleString()}</span>
                          </div>
                        </div>
                        
                        <div className="mt-2 pt-2 border-t border-blue-200 dark:border-blue-700/50">
                          <div className="flex justify-between text-xs" data-testid={`text-construction-wage-${job.scale}`}>
                            <span className="text-blue-600 dark:text-blue-400">Avg. Wage</span>
                            <span className="font-bold text-blue-700 dark:text-blue-300">${job.constructionWage || 35}/hr</span>
                          </div>
                          <div className="flex justify-between text-xs mt-1" data-testid={`text-construction-spending-${job.scale}`}>
                            <span className="text-blue-600 dark:text-blue-400">Spending</span>
                            <span className="font-bold text-blue-700 dark:text-blue-300">{formatLargeNumber(job.constructionSpending || 0)}</span>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                  
                  <div className="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div className="p-2 bg-blue-100 dark:bg-blue-900/50 rounded-lg text-center" data-testid="stat-construction-total-jobs">
                      <p className="text-lg font-bold text-blue-800 dark:text-blue-200">
                        {expandedJobs.reduce((sum, j) => sum + (j.constructionJobs || 0), 0).toLocaleString()}
                      </p>
                      <p className="text-xs text-blue-600 dark:text-blue-400">Total Construction Jobs</p>
                    </div>
                    <div className="p-2 bg-blue-100 dark:bg-blue-900/50 rounded-lg text-center" data-testid="stat-construction-prevailing-wage">
                      <p className="text-lg font-bold text-blue-800 dark:text-blue-200">$32-35/hr</p>
                      <p className="text-xs text-blue-600 dark:text-blue-400">Prevailing Wage</p>
                    </div>
                    <div className="p-2 bg-blue-100 dark:bg-blue-900/50 rounded-lg text-center" data-testid="stat-construction-union-priority">
                      <p className="text-lg font-bold text-blue-800 dark:text-blue-200">100%</p>
                      <p className="text-xs text-blue-600 dark:text-blue-400">Union Labor Priority</p>
                    </div>
                    <div className="p-2 bg-blue-100 dark:bg-blue-900/50 rounded-lg text-center" data-testid="stat-construction-total-spending">
                      <p className="text-lg font-bold text-blue-800 dark:text-blue-200">
                        {formatLargeNumber(expandedJobs.reduce((sum, j) => sum + (j.constructionSpending || 0), 0))}
                      </p>
                      <p className="text-xs text-blue-600 dark:text-blue-400">Total Construction $</p>
                    </div>
                  </div>
                  
                  <div className="mt-3 p-2 bg-white/50 dark:bg-black/20 rounded-lg" data-testid="text-construction-union-trades">
                    <p className="text-xs text-blue-700 dark:text-blue-400">
                      <span className="font-bold">Union trades:</span> IBEW (electricians), UA (plumbers & pipefitters), SMART (HVAC), UBC (carpenters). All construction requires prevailing wage and local hire priority.
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* K-12 NGSS Curriculum - Grouped by Grade Range */}
        {curriculum && curriculum.length > 0 && (() => {
          const gradeGroups = [
            { range: "K-2", label: "Early Elementary", grades: ["K", "1", "2"], color: "from-green-50 to-emerald-50 dark:from-green-950/30 dark:to-emerald-950/30", borderColor: "border-green-200 dark:border-green-800" },
            { range: "3-5", label: "Upper Elementary", grades: ["3", "4", "5"], color: "from-blue-50 to-indigo-50 dark:from-blue-950/30 dark:to-indigo-950/30", borderColor: "border-blue-200 dark:border-blue-800" },
            { range: "6-8", label: "Middle School", grades: ["6", "7", "8"], color: "from-purple-50 to-violet-50 dark:from-purple-950/30 dark:to-violet-950/30", borderColor: "border-purple-200 dark:border-purple-800" },
            { range: "9-12", label: "High School", grades: ["9", "10", "11", "12"], color: "from-amber-50 to-orange-50 dark:from-amber-950/30 dark:to-orange-950/30", borderColor: "border-amber-200 dark:border-amber-800" }
          ];
          return (
            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.32 }} className="mb-8">
              <Card className="glass-panel" data-testid="card-curriculum">
                <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                  <BookOpen className="h-5 w-5 text-primary" />
                  <CardTitle className="text-lg font-semibold">K-12 NGSS Curriculum</CardTitle>
                  <Badge variant="secondary" className="ml-auto">Standards-Aligned</Badge>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {gradeGroups.map((group) => {
                      const groupUnits = curriculum.filter(u => group.grades.includes(u.gradeRange));
                      const totalWeeks = groupUnits.reduce((sum, u) => sum + u.durationWeeks, 0);
                      return (
                        <div key={group.range} className={`p-4 bg-gradient-to-br ${group.color} rounded-lg border ${group.borderColor}`} data-testid={`curriculum-${group.range}`}>
                          <div className="flex items-center justify-between mb-3">
                            <Badge variant="outline" className="bg-primary/10 text-primary border-primary/20 font-bold">{group.range}</Badge>
                            <span className="text-xs text-muted-foreground flex items-center gap-1">
                              <Clock className="h-3 w-3" /> {totalWeeks} weeks total
                            </span>
                          </div>
                          <h4 className="font-semibold text-foreground mb-2">{group.label}</h4>
                          <div className="space-y-1">
                            {groupUnits.slice(0, 3).map((unit) => (
                              <p key={unit.id} className="text-xs text-muted-foreground flex items-center gap-1">
                                <Sprout className="h-3 w-3 text-primary/60" />
                                <span className="font-medium">Gr {unit.gradeRange}:</span> {unit.title}
                              </p>
                            ))}
                            {groupUnits.length > 3 && (
                              <p className="text-xs text-muted-foreground/70 italic">+{groupUnits.length - 3} more units</p>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </CardContent>
              </Card>
            </motion.div>
          );
        })()}

        {/* Interactive Tools Section - Impact Calculator & Community Comparison */}
        <div className="grid grid-cols-1 xl:grid-cols-2 gap-6 xl:gap-8 mb-8">
          <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }} transition={{ duration: 0.5, delay: 0.33 }}>
            <ImpactCalculator />
          </motion.div>
          <motion.div initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} transition={{ duration: 0.5, delay: 0.34 }}>
            <CommunityComparison />
          </motion.div>
        </div>

        {/* Financial Engine */}
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.35 }} className="mb-8">
          <Card className="glass-panel card-hover" data-testid="card-financials">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-2">
                <Calculator className="h-5 w-5 text-primary" />
                <CardTitle className="text-lg font-semibold">Financial Projection Engine v4.1 — Pilot Program ROI</CardTitle>
                {financials && <Badge variant="secondary" className="ml-auto">{financials.schoolCount} Schools</Badge>}
              </CardHeader>
              <CardContent>
                {financials && (
                  <div className="space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                      <div className="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-950/30 dark:to-emerald-950/30 p-4 rounded-xl border border-green-100 dark:border-green-900/50">
                        <div className="flex items-center gap-2 mb-2">
                          <DollarSign className="h-4 w-4 text-green-600" />
                          <span className="text-xs font-medium text-green-800 dark:text-green-400 uppercase">5-Year NPV</span>
                        </div>
                        <p className="text-2xl font-bold text-green-700 dark:text-green-300" data-testid="text-npv">
                          ${(financials.npv10yr / 1e6).toFixed(2)}M
                        </p>
                      </div>
                      <div className="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-950/30 dark:to-indigo-950/30 p-4 rounded-xl border border-blue-100 dark:border-blue-900/50">
                        <div className="flex items-center gap-2 mb-2">
                          <TrendingUp className="h-4 w-4 text-blue-600" />
                          <span className="text-xs font-medium text-blue-800 dark:text-blue-400 uppercase">Return on Investment</span>
                        </div>
                        <p className="text-2xl font-bold text-blue-700 dark:text-blue-300" data-testid="text-roi">
                          {financials.roi10yrPct}%
                        </p>
                      </div>
                    </div>
                    <div className="grid grid-cols-4 gap-3">
                      <div className="text-center p-3 bg-muted/50 rounded-lg">
                        <p className="text-xs text-muted-foreground">CAPEX</p>
                        <p className="font-semibold text-foreground">${(financials.initialInvestment / 1e6).toFixed(1)}M</p>
                      </div>
                      <div className="text-center p-3 bg-muted/50 rounded-lg">
                        <p className="text-xs text-muted-foreground">Annual OpEx</p>
                        <p className="font-semibold text-foreground">${(financials.annualOpex / 1e3).toFixed(0)}K</p>
                      </div>
                      <div className="text-center p-3 bg-muted/50 rounded-lg">
                        <p className="text-xs text-muted-foreground">State Savings</p>
                        <p className="font-semibold text-foreground">${(financials.totalAnnualRevenue / 1e6).toFixed(1)}M</p>
                      </div>
                      <div className="text-center p-3 bg-muted/50 rounded-lg">
                        <p className="text-xs text-muted-foreground">Payback</p>
                        <p className="font-semibold text-foreground">{financials.paybackYears} yrs</p>
                      </div>
                    </div>
                  </div>
                )}
              </CardContent>
          </Card>
        </motion.div>

        {/* Legal Framework */}
        {legalFramework && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.45 }} className="mb-8">
            <Card className="glass-panel" data-testid="card-legal">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <Shield className="h-5 w-5 text-primary" />
                <CardTitle className="text-lg font-semibold">Legal Framework & Governance — {legalFramework.entityName}</CardTitle>
                <UITooltip>
                  <TooltipTrigger asChild>
                    <HelpCircle className="h-4 w-4 text-muted-foreground cursor-help" />
                  </TooltipTrigger>
                  <TooltipContent className="max-w-sm">
                    <p>A 501(c)(3) nonprofit trust structure ensures tax-exempt status, perpetual existence, and legal protections that prevent funds from being diverted or misused.</p>
                  </TooltipContent>
                </UITooltip>
                <Badge variant="secondary" className="ml-auto">{legalFramework.entityType}</Badge>
              </CardHeader>
              <CardContent>
                {/* Explanation */}
                <p className="text-sm text-muted-foreground mb-4">
                  The Gaia Commons Council operates as a perpetual nonprofit trust with multi-stakeholder governance, ensuring no single party controls the endowment. Legal safeguards protect the principal forever while annual draws fund operations.
                </p>

                {/* Governance Flow Visual */}
                <div className="bg-muted/30 rounded-xl p-4 border border-border/50 mb-6">
                  <div className="flex items-center gap-2 mb-3">
                    <GitCompare className="h-4 w-4 text-primary" />
                    <span className="text-xs font-semibold text-foreground uppercase">Accountability Layers</span>
                  </div>
                  <div className="flex flex-col md:flex-row items-stretch gap-2">
                    {[
                      { layer: 'Voters', desc: 'Approve ballot initiative', icon: '1', color: 'bg-blue-500' },
                      { layer: 'State AG', desc: 'Legal oversight', icon: '2', color: 'bg-indigo-500' },
                      { layer: 'Board', desc: '7 multi-stakeholder seats', icon: '3', color: 'bg-purple-500' },
                      { layer: 'Big 4 Audit', desc: 'Annual independent review', icon: '4', color: 'bg-pink-500' },
                      { layer: 'Public Dashboard', desc: 'Real-time transparency', icon: '5', color: 'bg-rose-500' },
                    ].map((item, idx) => (
                      <div key={idx} className="flex-1 relative">
                        <div className="flex flex-col items-center p-3 bg-background/60 rounded-lg border border-border/50 h-full">
                          <div className={`w-6 h-6 rounded-full ${item.color} text-white text-xs font-bold flex items-center justify-center mb-2`}>
                            {item.icon}
                          </div>
                          <span className="text-xs font-semibold text-foreground text-center">{item.layer}</span>
                          <span className="text-[10px] text-muted-foreground text-center mt-1">{item.desc}</span>
                        </div>
                        {idx < 4 && (
                          <div className="hidden md:block absolute top-1/2 -right-1.5 transform -translate-y-1/2 text-muted-foreground z-10">
                            <ChevronRight className="h-3 w-3" />
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                  <p className="text-xs text-muted-foreground text-center mt-3">
                    Five independent layers of oversight ensure no single point of failure or corruption
                  </p>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-3 gap-6 xl:gap-8">
                  <div className="p-4 bg-muted/30 rounded-xl border border-border/50">
                    <div className="flex items-center gap-2 mb-3">
                      <Users className="h-4 w-4 text-primary" />
                      <h3 className="font-semibold text-foreground">Board Composition</h3>
                      <UITooltip>
                        <TooltipTrigger asChild>
                          <HelpCircle className="h-3 w-3 text-muted-foreground cursor-help" />
                        </TooltipTrigger>
                        <TooltipContent className="max-w-xs">
                          <p>Multi-stakeholder board prevents capture by any single interest group. Includes educators, donors, agriculture experts, tribal representatives, and students.</p>
                        </TooltipContent>
                      </UITooltip>
                    </div>
                    <p className="text-sm text-muted-foreground">{legalFramework.boardSize}-Member Board</p>
                    <p className="text-sm text-muted-foreground mt-1">{legalFramework.boardComposition}</p>
                  </div>
                  <div className="p-4 bg-muted/30 rounded-xl border border-border/50">
                    <div className="flex items-center gap-2 mb-3">
                      <Landmark className="h-4 w-4 text-primary" />
                      <h3 className="font-semibold text-foreground">Endowment Rules</h3>
                      <UITooltip>
                        <TooltipTrigger asChild>
                          <HelpCircle className="h-3 w-3 text-muted-foreground cursor-help" />
                        </TooltipTrigger>
                        <TooltipContent className="max-w-xs">
                          <p>4% annual spend follows the "Yale Model" used by major university endowments. Principal is protected forever, only investment returns fund operations.</p>
                        </TooltipContent>
                      </UITooltip>
                    </div>
                    <p className="text-sm text-muted-foreground">{legalFramework.endowmentRules}</p>
                  </div>
                  <div className="p-4 bg-muted/30 rounded-xl border border-border/50">
                    <div className="flex items-center gap-2 mb-3">
                      <Scale className="h-4 w-4 text-primary" />
                      <h3 className="font-semibold text-foreground">Required Filings</h3>
                      <UITooltip>
                        <TooltipTrigger asChild>
                          <HelpCircle className="h-3 w-3 text-muted-foreground cursor-help" />
                        </TooltipTrigger>
                        <TooltipContent className="max-w-xs">
                          <p>Public IRS Form 990 filings are available to anyone. State registration ensures Attorney General oversight of charitable operations.</p>
                        </TooltipContent>
                      </UITooltip>
                    </div>
                    <p className="text-sm text-muted-foreground">{legalFramework.filings}</p>
                  </div>
                </div>

                {/* Trust Protection Highlights */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
                  <div className="text-center p-3 bg-emerald-50 dark:bg-emerald-950/30 rounded-lg border border-emerald-100 dark:border-emerald-900/50">
                    <CheckCircle2 className="h-4 w-4 text-emerald-600 mx-auto mb-1" />
                    <p className="text-xs font-medium text-emerald-700 dark:text-emerald-400">Tax Exempt</p>
                    <p className="text-[10px] text-emerald-600 dark:text-emerald-500">501(c)(3) status</p>
                  </div>
                  <div className="text-center p-3 bg-blue-50 dark:bg-blue-950/30 rounded-lg border border-blue-100 dark:border-blue-900/50">
                    <CheckCircle2 className="h-4 w-4 text-blue-600 mx-auto mb-1" />
                    <p className="text-xs font-medium text-blue-700 dark:text-blue-400">Perpetual</p>
                    <p className="text-[10px] text-blue-600 dark:text-blue-500">Exists forever</p>
                  </div>
                  <div className="text-center p-3 bg-purple-50 dark:bg-purple-950/30 rounded-lg border border-purple-100 dark:border-purple-900/50">
                    <CheckCircle2 className="h-4 w-4 text-purple-600 mx-auto mb-1" />
                    <p className="text-xs font-medium text-purple-700 dark:text-purple-400">Principal Protected</p>
                    <p className="text-[10px] text-purple-600 dark:text-purple-500">Cannot be spent</p>
                  </div>
                  <div className="text-center p-3 bg-amber-50 dark:bg-amber-950/30 rounded-lg border border-amber-100 dark:border-amber-900/50">
                    <CheckCircle2 className="h-4 w-4 text-amber-600 mx-auto mb-1" />
                    <p className="text-xs font-medium text-amber-700 dark:text-amber-400">Public Oversight</p>
                    <p className="text-[10px] text-amber-600 dark:text-amber-500">Full transparency</p>
                  </div>
                </div>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* 50-Year Endowment Growth Chart */}
        {endowmentProjections && endowmentProjections.length > 0 && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.46 }} className="mb-8">
            <Card className="glass-panel" data-testid="card-endowment-projections">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <TrendingUp className="h-5 w-5 text-primary" />
                <CardTitle className="text-lg font-semibold">50-Year Endowment Growth — 4.5% Annual Draw</CardTitle>
                <Badge variant="secondary" className="ml-auto">2027–2077</Badge>
              </CardHeader>
              <CardContent>
                <div className="h-72">
                  <ResponsiveContainer width="100%" height="100%">
                    <AreaChart data={endowmentProjections}>
                      <defs>
                        <linearGradient id="colorCorpus" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="5%" stopColor="#22c55e" stopOpacity={0.3}/>
                          <stop offset="95%" stopColor="#22c55e" stopOpacity={0}/>
                        </linearGradient>
                      </defs>
                      <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />
                      <XAxis dataKey="year" className="text-xs" />
                      <YAxis className="text-xs" tickFormatter={(v) => formatLargeNumber(v)} />
                      <Tooltip 
                        formatter={(value: number, name: string) => [
                          formatLargeNumber(value), 
                          name === 'corpus' ? 'Corpus' : name === 'annualDraw' ? 'Annual Draw' : 'Inflation-Adjusted'
                        ]} 
                      />
                      <Legend />
                      <Area type="monotone" dataKey="corpus" name="Endowment Corpus" stroke="#22c55e" fillOpacity={1} fill="url(#colorCorpus)" />
                      <Line type="monotone" dataKey="annualDraw" name="Annual Draw (4.5%)" stroke="#8b5cf6" strokeWidth={2} dot={false} />
                    </AreaChart>
                  </ResponsiveContainer>
                </div>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                  <div className="text-center p-3 bg-emerald-50 dark:bg-emerald-950/30 rounded-lg border border-emerald-100 dark:border-emerald-900/50">
                    <p className="text-xs text-emerald-700 dark:text-emerald-400 font-medium">Year 1 ({endowmentProjections[0]?.year || 2028})</p>
                    <p className="font-semibold text-emerald-800 dark:text-emerald-300">{formatLargeNumber(endowmentProjections[0]?.corpus || 0)}</p>
                  </div>
                  <div className="text-center p-3 bg-blue-50 dark:bg-blue-950/30 rounded-lg border border-blue-100 dark:border-blue-900/50">
                    <p className="text-xs text-blue-700 dark:text-blue-400 font-medium">Year 20 ({(endowmentProjections[0]?.year || 2028) + 20})</p>
                    <p className="font-semibold text-blue-800 dark:text-blue-300">{formatLargeNumber(endowmentProjections.find(e => e.year === (endowmentProjections[0]?.year || 2028) + 20)?.corpus || 0)}</p>
                  </div>
                  <div className="text-center p-3 bg-purple-50 dark:bg-purple-950/30 rounded-lg border border-purple-100 dark:border-purple-900/50">
                    <p className="text-xs text-purple-700 dark:text-purple-400 font-medium">Year 40 ({(endowmentProjections[0]?.year || 2028) + 40})</p>
                    <p className="font-semibold text-purple-800 dark:text-purple-300">{formatLargeNumber(endowmentProjections.find(e => e.year === (endowmentProjections[0]?.year || 2028) + 40)?.corpus || 0)}</p>
                  </div>
                  <div className="text-center p-3 bg-amber-50 dark:bg-amber-950/30 rounded-lg border border-amber-100 dark:border-amber-900/50">
                    <p className="text-xs text-amber-700 dark:text-amber-400 font-medium">Year 50 ({endowmentProjections[endowmentProjections.length - 1]?.year || 2078})</p>
                    <p className="font-semibold text-amber-800 dark:text-amber-300">{formatLargeNumber(endowmentProjections[endowmentProjections.length - 1]?.corpus || 0)}</p>
                  </div>
                </div>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* Land & Water Conservation Fund */}
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.462 }} className="mb-8">
          <Card className="glass-panel border-2 border-teal-200 dark:border-teal-800" data-testid="card-land-conservation">
            <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
              <Trees className="h-5 w-5 text-teal-600" />
              <div>
                <CardTitle className="text-lg font-semibold">Land & Water Conservation Fund</CardTitle>
                <p className="text-sm text-muted-foreground mt-1">10% of annual endowment revenue dedicated to purchasing and protecting Minnesota's natural resources</p>
              </div>
              <Badge variant="outline" className="ml-auto bg-teal-50 dark:bg-teal-950/30 text-teal-700 dark:text-teal-300 border-teal-200 dark:border-teal-800">Perpetual Protection</Badge>
            </CardHeader>
            <CardContent>
              <div className="mb-6 p-4 bg-teal-50 dark:bg-teal-950/30 rounded-xl border border-teal-200 dark:border-teal-800">
                <div className="flex items-start gap-3">
                  <Shield className="h-5 w-5 text-teal-600 mt-0.5 shrink-0" />
                  <div>
                    <h4 className="font-semibold text-teal-800 dark:text-teal-300">Why Land Protection Matters</h4>
                    <p className="text-sm text-teal-700 dark:text-teal-400 mt-1">
                      By dedicating 10% of annual revenue to land acquisition, the endowment builds a permanent land trust that protects forests, farmland, and waterways from development, mining, and exploitation. Once acquired, these lands are held in perpetuity — never to be sold or developed.
                    </p>
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div className="p-4 bg-emerald-50 dark:bg-emerald-950/30 rounded-xl border border-emerald-200 dark:border-emerald-800 text-center">
                  <Trees className="h-8 w-8 text-emerald-600 mx-auto mb-2" />
                  <p className="text-2xl font-bold text-emerald-800 dark:text-emerald-300">10%</p>
                  <p className="text-sm text-emerald-700 dark:text-emerald-400 font-medium">Endowment Draw</p>
                  <p className="text-xs text-emerald-600 dark:text-emerald-500 mt-1">~$23.3M/year at statewide scale</p>
                </div>
                <div className="p-4 bg-blue-50 dark:bg-blue-950/30 rounded-xl border border-blue-200 dark:border-blue-800 text-center">
                  <Droplets className="h-8 w-8 text-blue-600 mx-auto mb-2" />
                  <p className="text-2xl font-bold text-blue-800 dark:text-blue-300">$315M</p>
                  <p className="text-sm text-blue-700 dark:text-blue-400 font-medium">50-Year Acquisition</p>
                  <p className="text-xs text-blue-600 dark:text-blue-500 mt-1">Compound growth adds land yearly</p>
                </div>
                <div className="p-4 bg-amber-50 dark:bg-amber-950/30 rounded-xl border border-amber-200 dark:border-amber-800 text-center">
                  <MapPin className="h-8 w-8 text-amber-600 mx-auto mb-2" />
                  <p className="text-2xl font-bold text-amber-800 dark:text-amber-300">100K+</p>
                  <p className="text-sm text-amber-700 dark:text-amber-400 font-medium">Acres Protected</p>
                  <p className="text-xs text-amber-600 dark:text-amber-500 mt-1">At $3,000/acre average</p>
                </div>
                <div className="p-4 bg-purple-50 dark:bg-purple-950/30 rounded-xl border border-purple-200 dark:border-purple-800 text-center">
                  <Shield className="h-8 w-8 text-purple-600 mx-auto mb-2" />
                  <p className="text-2xl font-bold text-purple-800 dark:text-purple-300">Forever</p>
                  <p className="text-sm text-purple-700 dark:text-purple-400 font-medium">Protection Period</p>
                  <p className="text-xs text-purple-600 dark:text-purple-500 mt-1">Land trust holds in perpetuity</p>
                </div>
              </div>

              <h4 className="font-semibold text-foreground mb-3 flex items-center gap-2">
                <Target className="h-4 w-4 text-teal-600" /> Acquisition Priorities
              </h4>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div className="p-3 bg-muted/30 rounded-lg border border-border/50">
                  <div className="flex items-center gap-2 mb-2">
                    <Trees className="h-4 w-4 text-emerald-600" />
                    <p className="font-medium text-foreground">Forests</p>
                  </div>
                  <p className="text-xs text-muted-foreground">Northern Minnesota forests, Boundary Waters buffer zones, old-growth stands, wildlife corridors</p>
                  <p className="text-xs text-emerald-600 dark:text-emerald-400 mt-2 font-medium">35% allocation</p>
                </div>
                <div className="p-3 bg-muted/30 rounded-lg border border-border/50">
                  <div className="flex items-center gap-2 mb-2">
                    <Wheat className="h-4 w-4 text-amber-600" />
                    <p className="font-medium text-foreground">Farmland</p>
                  </div>
                  <p className="text-xs text-muted-foreground">Prime agricultural land, organic transition parcels, family farm preservation, regenerative agriculture sites</p>
                  <p className="text-xs text-amber-600 dark:text-amber-400 mt-2 font-medium">30% allocation</p>
                </div>
                <div className="p-3 bg-muted/30 rounded-lg border border-border/50">
                  <div className="flex items-center gap-2 mb-2">
                    <Droplets className="h-4 w-4 text-blue-600" />
                    <p className="font-medium text-foreground">Waterways</p>
                  </div>
                  <p className="text-xs text-muted-foreground">River corridors, lake shorelines, wetlands, groundwater recharge areas, watershed headwaters</p>
                  <p className="text-xs text-blue-600 dark:text-blue-400 mt-2 font-medium">25% allocation</p>
                </div>
                <div className="p-3 bg-muted/30 rounded-lg border border-border/50">
                  <div className="flex items-center gap-2 mb-2">
                    <Feather className="h-4 w-4 text-purple-600" />
                    <p className="font-medium text-foreground">Tribal Lands</p>
                  </div>
                  <p className="text-xs text-muted-foreground">Support tribal land reclamation, sacred sites protection, treaty territory restoration</p>
                  <p className="text-xs text-purple-600 dark:text-purple-400 mt-2 font-medium">10% allocation</p>
                </div>
              </div>

              <h4 className="font-semibold text-foreground mb-3 flex items-center gap-2">
                <Building className="h-4 w-4 text-teal-600" /> Acquisition Sources
              </h4>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div className="p-4 bg-white/50 dark:bg-black/20 rounded-lg border border-border/50">
                  <h5 className="font-medium text-foreground mb-2 flex items-center gap-2">
                    <Users className="h-4 w-4 text-blue-600" /> Private Landowners
                  </h5>
                  <ul className="space-y-1 text-xs text-muted-foreground">
                    <li className="flex items-center gap-1"><ArrowRight className="h-3 w-3 text-blue-500" /> Willing seller negotiations</li>
                    <li className="flex items-center gap-1"><ArrowRight className="h-3 w-3 text-blue-500" /> Conservation easement purchases</li>
                    <li className="flex items-center gap-1"><ArrowRight className="h-3 w-3 text-blue-500" /> Estate/inheritance acquisitions</li>
                    <li className="flex items-center gap-1"><ArrowRight className="h-3 w-3 text-blue-500" /> Farm succession programs</li>
                  </ul>
                  <p className="text-xs text-blue-600 dark:text-blue-400 mt-2 font-medium">~60% of acquisitions</p>
                </div>
                <div className="p-4 bg-white/50 dark:bg-black/20 rounded-lg border border-border/50">
                  <h5 className="font-medium text-foreground mb-2 flex items-center gap-2">
                    <Building2 className="h-4 w-4 text-amber-600" /> Federal Government
                  </h5>
                  <ul className="space-y-1 text-xs text-muted-foreground">
                    <li className="flex items-center gap-1"><ArrowRight className="h-3 w-3 text-amber-500" /> USDA surplus property</li>
                    <li className="flex items-center gap-1"><ArrowRight className="h-3 w-3 text-amber-500" /> BLM land transfers</li>
                    <li className="flex items-center gap-1"><ArrowRight className="h-3 w-3 text-amber-500" /> Forest Service partnerships</li>
                    <li className="flex items-center gap-1"><ArrowRight className="h-3 w-3 text-amber-500" /> Military base closures</li>
                  </ul>
                  <p className="text-xs text-amber-600 dark:text-amber-400 mt-2 font-medium">~25% of acquisitions</p>
                </div>
                <div className="p-4 bg-white/50 dark:bg-black/20 rounded-lg border border-border/50">
                  <h5 className="font-medium text-foreground mb-2 flex items-center gap-2">
                    <Scale className="h-4 w-4 text-emerald-600" /> State & County
                  </h5>
                  <ul className="space-y-1 text-xs text-muted-foreground">
                    <li className="flex items-center gap-1"><ArrowRight className="h-3 w-3 text-emerald-500" /> Tax-forfeited land purchases</li>
                    <li className="flex items-center gap-1"><ArrowRight className="h-3 w-3 text-emerald-500" /> DNR surplus properties</li>
                    <li className="flex items-center gap-1"><ArrowRight className="h-3 w-3 text-emerald-500" /> County land sales</li>
                    <li className="flex items-center gap-1"><ArrowRight className="h-3 w-3 text-emerald-500" /> School trust land swaps</li>
                  </ul>
                  <p className="text-xs text-emerald-600 dark:text-emerald-400 mt-2 font-medium">~15% of acquisitions</p>
                </div>
              </div>

              <div className="p-4 bg-teal-50 dark:bg-teal-950/30 rounded-xl border border-teal-200 dark:border-teal-800">
                <div className="flex items-start gap-3">
                  <Leaf className="h-5 w-5 text-teal-600 mt-0.5 shrink-0" />
                  <div>
                    <h4 className="font-semibold text-teal-800 dark:text-teal-300">Permanent Protection Guarantee</h4>
                    <p className="text-sm text-teal-700 dark:text-teal-400 mt-1">
                      All acquired lands are placed in a permanent land trust with legal protections preventing future sale or development. The endowment's perpetual structure means the land fund grows every year — protecting more acres as the endowment grows. Unlike government programs that can be defunded, this land protection is forever.
                    </p>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </motion.div>

        {/* Interactive Data Visualizations */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5, delay: 0.475 }}
          className="mb-8"
          data-testid="section-interactive-charts"
        >
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <EndowmentGrowthChart initialCorpus={5000000000} drawRate={0.045} growthRate={0.07} />
            <JobsBreakdownChart defaultScale={["pilot", "statewide", "national", "global"].includes(selectedScale) ? selectedScale as "pilot" | "statewide" | "national" | "global" : "statewide"} />
          </div>
        </motion.div>

        {/* Coalition Partners Row */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          {/* Coalition Partners */}
          {coalition && coalition.length > 0 && (
            <motion.div initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} transition={{ duration: 0.5, delay: 0.49 }}>
              <Card className="glass-panel h-full" data-testid="card-coalition">
                <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                  <Users2 className="h-5 w-5 text-primary" />
                  <CardTitle className="text-lg font-semibold">Coalition Partners</CardTitle>
                  <Badge variant="secondary" className="ml-auto">400K+ Members</Badge>
                </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    {[1, 2, 3].map(tier => {
                      const tierPartners = coalition.filter(p => p.tier === tier);
                      if (tierPartners.length === 0) return null;
                      return (
                        <div key={tier}>
                          <p className="text-xs font-medium text-muted-foreground uppercase tracking-wide mb-2">
                            Tier {tier} {tier === 1 ? '— Core' : tier === 2 ? '— Strategic' : '— Corporate'}
                          </p>
                          <div className="flex flex-wrap gap-2">
                            {tierPartners.map(partner => (
                              <Badge 
                                key={partner.id} 
                                variant="outline" 
                                className={`${tier === 1 ? 'bg-emerald-50 dark:bg-emerald-950/30 border-emerald-200 dark:border-emerald-800 text-emerald-700 dark:text-emerald-300' : tier === 2 ? 'bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800 text-blue-700 dark:text-blue-300' : 'bg-purple-50 dark:bg-purple-950/30 border-purple-200 dark:border-purple-800 text-purple-700 dark:text-purple-300'}`}
                                data-testid={`partner-${partner.id}`}
                              >
                                {partner.name}
                                {partner.memberCount && partner.memberCount > 0 && (
                                  <span className="ml-1 opacity-70">({formatNumber(partner.memberCount)})</span>
                                )}
                              </Badge>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </CardContent>
              </Card>
            </motion.div>
          )}
        </div>

        {/* Funding Sources */}
        {fundingSources && fundingSources.length > 0 && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.495 }} className="mb-8">
            <Card className="glass-panel" data-testid="card-funding">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <Banknote className="h-5 w-5 text-primary" />
                <div>
                  <CardTitle className="text-lg font-semibold">Endowment Funding Sources</CardTitle>
                  <p className="text-sm text-muted-foreground mt-1">Potential annual revenue from proposed surcharges — $5B endowment target @ 4.5% = $225M/yr</p>
                </div>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                  {fundingSources.map((source, idx) => {
                    // Extract charge rate from description (e.g., "0.27%", "3%", "5%")
                    const chargeRateMatch = source.description.match(/(\d+\.?\d*)%/);
                    const chargeRate = chargeRateMatch ? chargeRateMatch[1] + '%' : null;
                    const isVoluntary = source.description.toLowerCase().includes('voluntary');
                    
                    return (
                      <div key={source.id} className="p-4 bg-muted/30 rounded-xl border border-border/50" data-testid={`funding-source-${source.id}`}>
                        <div className="flex items-center justify-between mb-2 gap-2 flex-wrap">
                          <h4 className="font-semibold text-foreground">{source.sourceType}</h4>
                          {chargeRate && !isVoluntary && (
                            <Badge className="bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-300 border-amber-200 dark:border-amber-800 text-xs">
                              {chargeRate} rate
                            </Badge>
                          )}
                          {isVoluntary && (
                            <Badge className="bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300 border-blue-200 dark:border-blue-800 text-xs">
                              Voluntary
                            </Badge>
                          )}
                        </div>
                        <p className="text-2xl font-bold text-primary mb-2">{formatLargeNumber(source.targetAmount)}</p>
                        <p className="text-sm text-muted-foreground line-clamp-2">{source.description}</p>
                        {source.entities && (
                          <p className="text-xs text-muted-foreground/70 mt-2 italic line-clamp-2">{source.entities}</p>
                        )}
                      </div>
                    );
                  })}
                </div>
                {(() => {
                  const totalRevenue = fundingSources.reduce((sum, source) => sum + (source.targetAmount || 0), 0);
                  const coreEndowment = 5000000000;
                  const excessAllocation = Math.max(0, totalRevenue - coreEndowment);
                  const yearlyDraw = coreEndowment * 0.045;
                  
                  return (
                    <>
                      <div className="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div className="p-3 bg-purple-50 dark:bg-purple-950/30 rounded-lg border border-purple-100 dark:border-purple-900/50 flex items-center gap-3">
                          <Banknote className="h-5 w-5 text-purple-600" />
                          <div>
                            <p className="text-xs text-purple-700 dark:text-purple-400 font-medium">Total Potential Revenue</p>
                            <p className="font-semibold text-purple-800 dark:text-purple-300" data-testid="text-total-potential-revenue">{formatLargeNumber(totalRevenue)}</p>
                          </div>
                        </div>
                        <div className="p-3 bg-emerald-50 dark:bg-emerald-950/30 rounded-lg border border-emerald-100 dark:border-emerald-900/50 flex items-center gap-3">
                          <PiggyBank className="h-5 w-5 text-emerald-600" />
                          <div>
                            <p className="text-xs text-emerald-700 dark:text-emerald-400 font-medium">Core Endowment Target</p>
                            <p className="font-semibold text-emerald-800 dark:text-emerald-300">{formatLargeNumber(coreEndowment)}</p>
                          </div>
                        </div>
                        <div className="p-3 bg-amber-50 dark:bg-amber-950/30 rounded-lg border border-amber-100 dark:border-amber-900/50 flex items-center gap-3">
                          <Trees className="h-5 w-5 text-amber-600" />
                          <div>
                            <p className="text-xs text-amber-700 dark:text-amber-400 font-medium">Excess Allocation</p>
                            <p className="font-semibold text-amber-800 dark:text-amber-300">{formatLargeNumber(excessAllocation)}</p>
                          </div>
                        </div>
                        <div className="p-3 bg-blue-50 dark:bg-blue-950/30 rounded-lg border border-blue-100 dark:border-blue-900/50 flex items-center gap-3">
                          <TrendingUp className="h-5 w-5 text-blue-600" />
                          <div>
                            <p className="text-xs text-blue-700 dark:text-blue-400 font-medium">Year 1 Draw (4.5%)</p>
                            <p className="font-semibold text-blue-800 dark:text-blue-300">{formatLargeNumber(yearlyDraw)}</p>
                          </div>
                        </div>
                      </div>
                      
                      <div className="mt-4 p-4 bg-gradient-to-r from-amber-50 to-emerald-50 dark:from-amber-950/30 dark:to-emerald-950/30 rounded-xl border border-amber-200 dark:border-amber-800">
                        <h4 className="font-semibold text-foreground mb-3 flex items-center gap-2">
                          <Sparkles className="h-4 w-4 text-amber-600" />
                          Excess Revenue Allocation ({formatLargeNumber(excessAllocation)} over target)
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                          <div className="p-3 bg-white/50 dark:bg-black/20 rounded-lg">
                            <p className="text-sm font-medium text-amber-700 dark:text-amber-300">Leech Lake Tribal Programs</p>
                            <p className="text-xs text-muted-foreground mt-1">Food sovereignty initiatives for Red Lake, Cass Lake-Bena, and Nay Ah Shing communities</p>
                          </div>
                          <div className="p-3 bg-white/50 dark:bg-black/20 rounded-lg">
                            <p className="text-sm font-medium text-emerald-700 dark:text-emerald-300">Boundary Waters Mining Alternative</p>
                            <p className="text-xs text-muted-foreground mt-1">Northern MN greenhouse hubs replacing Twin Metals mining jobs with permanent positions</p>
                          </div>
                          <div className="p-3 bg-white/50 dark:bg-black/20 rounded-lg">
                            <p className="text-sm font-medium text-blue-700 dark:text-blue-300">Distribution Infrastructure</p>
                            <p className="text-xs text-muted-foreground mt-1">Statewide produce delivery network connecting greenhouses to 330 school districts</p>
                          </div>
                        </div>
                      </div>
                    </>
                  );
                })()}
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* Interactive Funding Calculator */}
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.497 }} className="mb-8">
          <FundingCalculator />
        </motion.div>

        {/* Mining Alternative - Twin Metals Replacement */}
        {miningAlternatives && miningAlternatives.length > 0 && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.4955 }} className="mb-8">
            <Card className="glass-panel border-2 border-emerald-200 dark:border-emerald-800" data-testid="card-mining-alternative">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <Trees className="h-5 w-5 text-emerald-600" />
                <div>
                  <CardTitle className="text-lg font-semibold">Boundary Waters Alternative — Greenhouse Jobs vs. Twin Metals Mining</CardTitle>
                  <p className="text-sm text-muted-foreground mt-1">Endowment-funded permanent jobs for Northern Minnesota communities — protecting the BWCA while creating lasting economic opportunity</p>
                </div>
                <Badge variant="outline" className="ml-auto bg-emerald-50 dark:bg-emerald-950/30 text-emerald-700 dark:text-emerald-300 border-emerald-200 dark:border-emerald-800">Sustainable Alternative</Badge>
              </CardHeader>
              <CardContent>
                <div className="mb-6 p-4 bg-amber-50 dark:bg-amber-950/30 rounded-xl border border-amber-200 dark:border-amber-800">
                  <div className="flex items-start gap-3">
                    <Shield className="h-5 w-5 text-amber-600 mt-0.5 shrink-0" />
                    <div>
                      <h4 className="font-semibold text-amber-800 dark:text-amber-300">The Twin Metals Dilemma</h4>
                      <p className="text-sm text-amber-700 dark:text-amber-400 mt-1">
                        The proposed Twin Metals copper-nickel sulfide mine near Ely promises ~1,850 jobs but would operate for only 20-25 years before depletion, leaving communities dependent on mining with no economic future — and risking irreversible pollution to the Boundary Waters Canoe Area Wilderness.
                      </p>
                      <p className="text-sm text-emerald-700 dark:text-emerald-400 mt-2 font-medium">
                        Our alternative: Massive greenhouse complexes + school greenhouses funded by the endowment, creating permanent jobs that protect the environment.
                      </p>
                    </div>
                  </div>
                </div>

                {/* Foreign Ownership & Profit Leakage Section */}
                <div className="mb-6 p-4 bg-red-50 dark:bg-red-950/30 rounded-xl border border-red-200 dark:border-red-800">
                  <div className="flex items-start gap-3 mb-4">
                    <Globe className="h-5 w-5 text-red-600 mt-0.5 shrink-0" />
                    <div>
                      <h4 className="font-semibold text-red-800 dark:text-red-300">Foreign Ownership: Where Your Resources Go</h4>
                      <p className="text-sm text-red-700 dark:text-red-400 mt-1">
                        Twin Metals is <span className="font-bold">100% owned by Antofagasta PLC</span> — a Chilean mining conglomerate controlled by the <span className="font-bold">Luksic family (Chilean billionaires)</span>, headquartered in London. Minnesota provides the land, water, and workers. Foreign billionaires keep the profits.
                      </p>
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div className="p-3 bg-white/70 dark:bg-black/30 rounded-lg">
                      <h5 className="font-semibold text-red-700 dark:text-red-300 mb-2 flex items-center gap-2">
                        <DollarSign className="h-4 w-4" /> What Leaves Minnesota
                      </h5>
                      <ul className="space-y-1 text-sm text-red-600 dark:text-red-400">
                        <li className="flex items-center gap-2"><ArrowRight className="h-3 w-3" /> <span className="font-bold">50% of profits</span> → dividends to Luksic family (Chile)</li>
                        <li className="flex items-center gap-2"><ArrowRight className="h-3 w-3" /> Corporate profits → London headquarters</li>
                        <li className="flex items-center gap-2"><ArrowRight className="h-3 w-3" /> Management fees → parent company</li>
                        <li className="flex items-center gap-2"><ArrowRight className="h-3 w-3" /> Ore leaves state → processed elsewhere</li>
                        <li className="flex items-center gap-2"><ArrowRight className="h-3 w-3" /> Equipment often imported from Canada/Australia</li>
                      </ul>
                    </div>
                    
                    <div className="p-3 bg-white/70 dark:bg-black/30 rounded-lg">
                      <h5 className="font-semibold text-red-700 dark:text-red-300 mb-2 flex items-center gap-2">
                        <Building className="h-4 w-4" /> What Minnesota Gets
                      </h5>
                      <ul className="space-y-1 text-sm text-red-600 dark:text-red-400">
                        <li className="flex items-center gap-2"><ArrowRight className="h-3 w-3" /> Employee wages (~$45-50M/yr for ~1,500 jobs)</li>
                        <li className="flex items-center gap-2"><ArrowRight className="h-3 w-3" /> <span className="font-bold">Only 0.4%</span> gross proceeds tax</li>
                        <li className="flex items-center gap-2"><ArrowRight className="h-3 w-3" /> Of that 0.4%: <span className="font-bold">0% to State General Fund</span></li>
                        <li className="flex items-center gap-2"><ArrowRight className="h-3 w-3" /> Local property taxes (minimal)</li>
                        <li className="flex items-center gap-2"><ArrowRight className="h-3 w-3" /> <span className="font-bold">Cleanup liability</span> when mine closes</li>
                      </ul>
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div className="p-3 bg-red-100 dark:bg-red-900/40 rounded-lg text-center">
                      <p className="text-2xl font-bold text-red-800 dark:text-red-200">0.4%</p>
                      <p className="text-xs text-red-600 dark:text-red-400">MN Tax Rate</p>
                      <p className="text-xs text-red-500 dark:text-red-500">(vs. 3.35/ton for iron)</p>
                    </div>
                    <div className="p-3 bg-red-100 dark:bg-red-900/40 rounded-lg text-center">
                      <p className="text-2xl font-bold text-red-800 dark:text-red-200">0%</p>
                      <p className="text-xs text-red-600 dark:text-red-400">To State Fund</p>
                      <p className="text-xs text-red-500 dark:text-red-500">(Taconite Area rules)</p>
                    </div>
                    <div className="p-3 bg-red-100 dark:bg-red-900/40 rounded-lg text-center">
                      <p className="text-2xl font-bold text-red-800 dark:text-red-200">50%</p>
                      <p className="text-xs text-red-600 dark:text-red-400">Profits to Chile</p>
                      <p className="text-xs text-red-500 dark:text-red-500">(Antofagasta dividend)</p>
                    </div>
                    <div className="p-3 bg-red-100 dark:bg-red-900/40 rounded-lg text-center">
                      <p className="text-2xl font-bold text-red-800 dark:text-red-200">20-25</p>
                      <p className="text-xs text-red-600 dark:text-red-400">Years Then Gone</p>
                      <p className="text-xs text-red-500 dark:text-red-500">(Resource depleted)</p>
                    </div>
                  </div>
                </div>

                {/* Gaia Alternative Comparison */}
                <div className="mb-6 p-4 bg-emerald-50 dark:bg-emerald-950/30 rounded-xl border border-emerald-200 dark:border-emerald-800">
                  <div className="flex items-start gap-3 mb-4">
                    <Home className="h-5 w-5 text-emerald-600 mt-0.5 shrink-0" />
                    <div>
                      <h4 className="font-semibold text-emerald-800 dark:text-emerald-300">Gaia Commons Alternative: 100% Minnesota-Owned</h4>
                      <p className="text-sm text-emerald-700 dark:text-emerald-400 mt-1">
                        The Gaia Commons endowment is a <span className="font-bold">501(c)(3) nonprofit permanently domiciled in Minnesota</span>. Every dollar of profit stays in-state, reinvested in schools and communities. No foreign shareholders, no profit extraction.
                      </p>
                    </div>
                  </div>
                  
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="border-b border-emerald-200 dark:border-emerald-700">
                          <th className="text-left py-2 px-3 text-emerald-800 dark:text-emerald-300 font-semibold">Comparison</th>
                          <th className="text-center py-2 px-3 text-red-700 dark:text-red-400 font-semibold">Twin Metals (Chile)</th>
                          <th className="text-center py-2 px-3 text-emerald-700 dark:text-emerald-400 font-semibold">Gaia Commons (MN)</th>
                        </tr>
                      </thead>
                      <tbody className="text-foreground">
                        <tr className="border-b border-emerald-100 dark:border-emerald-800/50">
                          <td className="py-2 px-3 font-medium">Ownership</td>
                          <td className="py-2 px-3 text-center text-red-600 dark:text-red-400">100% Chilean billionaires</td>
                          <td className="py-2 px-3 text-center text-emerald-600 dark:text-emerald-400 font-bold">100% Minnesota nonprofit</td>
                        </tr>
                        <tr className="border-b border-emerald-100 dark:border-emerald-800/50">
                          <td className="py-2 px-3 font-medium">Profits Stay in MN</td>
                          <td className="py-2 px-3 text-center text-red-600 dark:text-red-400">~0% (dividends to Chile)</td>
                          <td className="py-2 px-3 text-center text-emerald-600 dark:text-emerald-400 font-bold">100% reinvested locally</td>
                        </tr>
                        <tr className="border-b border-emerald-100 dark:border-emerald-800/50">
                          <td className="py-2 px-3 font-medium">State Tax Revenue</td>
                          <td className="py-2 px-3 text-center text-red-600 dark:text-red-400">0.4% gross (0% to state fund)</td>
                          <td className="py-2 px-3 text-center text-emerald-600 dark:text-emerald-400 font-bold">Full property + payroll taxes</td>
                        </tr>
                        <tr className="border-b border-emerald-100 dark:border-emerald-800/50">
                          <td className="py-2 px-3 font-medium">Construction Jobs</td>
                          <td className="py-2 px-3 text-center text-red-600 dark:text-red-400">~400 (3-yr build)</td>
                          <td className="py-2 px-3 text-center text-emerald-600 dark:text-emerald-400 font-bold">800+ (phased statewide)</td>
                        </tr>
                        <tr className="border-b border-emerald-100 dark:border-emerald-800/50">
                          <td className="py-2 px-3 font-medium">Permanent Jobs</td>
                          <td className="py-2 px-3 text-center text-red-600 dark:text-red-400">~1,500 temporary</td>
                          <td className="py-2 px-3 text-center text-emerald-600 dark:text-emerald-400 font-bold">2,400 permanent</td>
                        </tr>
                        <tr className="border-b border-emerald-100 dark:border-emerald-800/50">
                          <td className="py-2 px-3 font-medium">Job Duration</td>
                          <td className="py-2 px-3 text-center text-red-600 dark:text-red-400">20-25 years (ore depletes)</td>
                          <td className="py-2 px-3 text-center text-emerald-600 dark:text-emerald-400 font-bold">Forever (renewable)</td>
                        </tr>
                        <tr className="border-b border-emerald-100 dark:border-emerald-800/50">
                          <td className="py-2 px-3 font-medium">Average Wage</td>
                          <td className="py-2 px-3 text-center text-red-600 dark:text-red-400">~$58K/year</td>
                          <td className="py-2 px-3 text-center text-emerald-600 dark:text-emerald-400 font-bold">$58K+/year (matching)</td>
                        </tr>
                        <tr className="border-b border-emerald-100 dark:border-emerald-800/50">
                          <td className="py-2 px-3 font-medium">Resource</td>
                          <td className="py-2 px-3 text-center text-red-600 dark:text-red-400">Finite ore (depletes)</td>
                          <td className="py-2 px-3 text-center text-emerald-600 dark:text-emerald-400 font-bold">Sunlight (infinite)</td>
                        </tr>
                        <tr className="border-b border-emerald-100 dark:border-emerald-800/50">
                          <td className="py-2 px-3 font-medium">Environment</td>
                          <td className="py-2 px-3 text-center text-red-600 dark:text-red-400">Sulfide pollution risk</td>
                          <td className="py-2 px-3 text-center text-emerald-600 dark:text-emerald-400 font-bold">Carbon-negative</td>
                        </tr>
                        <tr className="border-b border-emerald-100 dark:border-emerald-800/50">
                          <td className="py-2 px-3 font-medium">After Closure</td>
                          <td className="py-2 px-3 text-center text-red-600 dark:text-red-400">Cleanup liability for MN</td>
                          <td className="py-2 px-3 text-center text-emerald-600 dark:text-emerald-400 font-bold">Still operating</td>
                        </tr>
                        <tr>
                          <td className="py-2 px-3 font-medium">Foreign Workers On-Site</td>
                          <td className="py-2 px-3 text-center text-red-600 dark:text-red-400">Chile, UK, Canada, Australia</td>
                          <td className="py-2 px-3 text-center text-emerald-600 dark:text-emerald-400 font-bold">100% local hire priority</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  
                  <div className="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div className="p-3 bg-emerald-100 dark:bg-emerald-900/40 rounded-lg text-center">
                      <p className="text-2xl font-bold text-emerald-800 dark:text-emerald-200">100%</p>
                      <p className="text-xs text-emerald-600 dark:text-emerald-400">Profits Stay in MN</p>
                    </div>
                    <div className="p-3 bg-emerald-100 dark:bg-emerald-900/40 rounded-lg text-center">
                      <p className="text-2xl font-bold text-emerald-800 dark:text-emerald-200">$28/hr</p>
                      <p className="text-xs text-emerald-600 dark:text-emerald-400">Living Wage Jobs</p>
                    </div>
                    <div className="p-3 bg-emerald-100 dark:bg-emerald-900/40 rounded-lg text-center">
                      <p className="text-2xl font-bold text-emerald-800 dark:text-emerald-200">∞</p>
                      <p className="text-xs text-emerald-600 dark:text-emerald-400">Years of Operation</p>
                    </div>
                    <div className="p-3 bg-emerald-100 dark:bg-emerald-900/40 rounded-lg text-center">
                      <p className="text-2xl font-bold text-emerald-800 dark:text-emerald-200">0</p>
                      <p className="text-xs text-emerald-600 dark:text-emerald-400">Foreign Shareholders</p>
                    </div>
                  </div>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-6">
                  {miningAlternatives.map((alt) => (
                    <div key={alt.id} className="p-4 bg-muted/30 rounded-xl border border-border/50" data-testid={`mining-alt-${alt.id}`}>
                      <div className="flex items-center justify-between mb-3">
                        <h4 className="font-bold text-foreground text-lg">{alt.community}</h4>
                        <Badge variant="outline" className="text-xs">{alt.county} Co.</Badge>
                      </div>
                      <p className="text-xs text-muted-foreground mb-3">Pop. {alt.population.toLocaleString()}</p>
                      
                      <div className="space-y-3">
                        <div className="p-2 bg-red-50 dark:bg-red-950/30 rounded-lg border border-red-100 dark:border-red-900/50">
                          <p className="text-xs text-red-600 dark:text-red-400 font-medium mb-1">Mining Promise</p>
                          <p className="text-lg font-bold text-red-700 dark:text-red-300">{alt.miningJobsPromised} jobs</p>
                          <p className="text-xs text-red-600 dark:text-red-400">${(alt.miningAvgSalary / 1000).toFixed(0)}K avg · {alt.miningDuration}</p>
                        </div>
                        
                        <div className="p-2 bg-emerald-50 dark:bg-emerald-950/30 rounded-lg border border-emerald-100 dark:border-emerald-900/50">
                          <p className="text-xs text-emerald-600 dark:text-emerald-400 font-medium mb-1">Greenhouse Alternative</p>
                          <p className="text-lg font-bold text-emerald-700 dark:text-emerald-300">{alt.totalGreenhouseJobs} jobs</p>
                          <p className="text-xs text-emerald-600 dark:text-emerald-400">${(alt.greenhouseAvgSalary / 1000).toFixed(0)}K avg · {alt.jobDuration}</p>
                        </div>
                        
                        <div className="pt-2 border-t border-border/30 space-y-1">
                          <p className="text-xs text-muted-foreground"><span className="font-medium">Complex:</span> {(alt.greenhouseComplexSqft / 1000).toFixed(0)}K sqft</p>
                          <p className="text-xs text-muted-foreground"><span className="font-medium">Production:</span> {((alt.annualProductionLbs || 0) / 1000000).toFixed(1)}M lbs/yr</p>
                          <p className="text-xs text-blue-600 dark:text-blue-400"><span className="font-medium">Schools:</span> {((alt.schoolDistributionLbs || 0) / 1000000).toFixed(1)}M lbs</p>
                          <p className="text-xs text-amber-600 dark:text-amber-400"><span className="font-medium">Stores:</span> {((alt.excessForSaleLbs || 0) / 1000000).toFixed(1)}M lbs</p>
                          <p className="text-xs text-emerald-600 dark:text-emerald-400 font-medium"><span className="font-medium">Sales:</span> ${((alt.annualSalesRevenue || 0) / 1000000).toFixed(1)}M/yr</p>
                          {alt.specialtyCrops && (
                            <p className="text-xs text-purple-700 dark:text-purple-400 font-medium mt-1">{alt.specialtyCrops}</p>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div className="p-4 bg-red-50 dark:bg-red-950/30 rounded-xl border border-red-200 dark:border-red-800">
                    <p className="text-sm text-red-700 dark:text-red-400 font-medium">Twin Metals Total Jobs</p>
                    <p className="text-2xl font-bold text-red-800 dark:text-red-300">
                      {miningAlternatives.reduce((sum, a) => sum + a.miningJobsPromised, 0).toLocaleString()}
                    </p>
                    <p className="text-xs text-red-600 dark:text-red-400">Temporary (20-25 years)</p>
                  </div>
                  
                  <div className="p-4 bg-emerald-50 dark:bg-emerald-950/30 rounded-xl border border-emerald-200 dark:border-emerald-800">
                    <p className="text-sm text-emerald-700 dark:text-emerald-400 font-medium">Greenhouse Network Jobs</p>
                    <p className="text-2xl font-bold text-emerald-800 dark:text-emerald-300">
                      {miningAlternatives.reduce((sum, a) => sum + a.totalGreenhouseJobs, 0).toLocaleString()}
                    </p>
                    <p className="text-xs text-emerald-600 dark:text-emerald-400">Permanent (endowment-funded)</p>
                  </div>
                  
                  <div className="p-4 bg-blue-50 dark:bg-blue-950/30 rounded-xl border border-blue-200 dark:border-blue-800">
                    <p className="text-sm text-blue-700 dark:text-blue-400 font-medium">Total Greenhouse Complex</p>
                    <p className="text-2xl font-bold text-blue-800 dark:text-blue-300">
                      {(miningAlternatives.reduce((sum, a) => sum + a.greenhouseComplexSqft, 0) / 1000).toFixed(0)}K sqft
                    </p>
                    <p className="text-xs text-blue-600 dark:text-blue-400">$85/sqft construction</p>
                  </div>
                  
                  <div className="p-4 bg-purple-50 dark:bg-purple-950/30 rounded-xl border border-purple-200 dark:border-purple-800">
                    <p className="text-sm text-purple-700 dark:text-purple-400 font-medium">Annual Production</p>
                    <p className="text-2xl font-bold text-purple-800 dark:text-purple-300">
                      {(miningAlternatives.reduce((sum, a) => sum + (a.annualProductionLbs || 0), 0) / 1000000).toFixed(1)}M lbs
                    </p>
                    <p className="text-xs text-purple-600 dark:text-purple-400">40 lbs/sqft/year specialty crops</p>
                  </div>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mt-4">
                  <div className="p-4 bg-amber-50 dark:bg-amber-950/30 rounded-xl border border-amber-200 dark:border-amber-800">
                    <p className="text-sm text-amber-700 dark:text-amber-400 font-medium">School Distribution</p>
                    <p className="text-2xl font-bold text-amber-800 dark:text-amber-300">
                      {(miningAlternatives.reduce((sum, a) => sum + (a.schoolDistributionLbs || 0), 0) / 1000000).toFixed(1)}M lbs
                    </p>
                    <p className="text-xs text-amber-600 dark:text-amber-400">60% to 330 school districts</p>
                  </div>
                  
                  <div className="p-4 bg-orange-50 dark:bg-orange-950/30 rounded-xl border border-orange-200 dark:border-orange-800">
                    <p className="text-sm text-orange-700 dark:text-orange-400 font-medium">Excess for Stores</p>
                    <p className="text-2xl font-bold text-orange-800 dark:text-orange-300">
                      {(miningAlternatives.reduce((sum, a) => sum + (a.excessForSaleLbs || 0), 0) / 1000000).toFixed(1)}M lbs
                    </p>
                    <p className="text-xs text-orange-600 dark:text-orange-400">40% sold to stores/markets</p>
                  </div>
                  
                  <div className="p-4 bg-emerald-50 dark:bg-emerald-950/30 rounded-xl border border-emerald-200 dark:border-emerald-800">
                    <p className="text-sm text-emerald-700 dark:text-emerald-400 font-medium">Annual Sales Revenue</p>
                    <p className="text-2xl font-bold text-emerald-800 dark:text-emerald-300">
                      ${(miningAlternatives.reduce((sum, a) => sum + (a.annualSalesRevenue || 0), 0) / 1000000).toFixed(1)}M
                    </p>
                    <p className="text-xs text-emerald-600 dark:text-emerald-400">@ $3.50/lb wholesale</p>
                  </div>
                  
                  <div className="p-4 bg-slate-50 dark:bg-slate-950/30 rounded-xl border border-slate-200 dark:border-slate-800">
                    <p className="text-sm text-slate-700 dark:text-slate-400 font-medium">Construction Cost</p>
                    <p className="text-2xl font-bold text-slate-800 dark:text-slate-300">
                      ${(miningAlternatives.reduce((sum, a) => sum + (a.constructionCost || 0), 0) / 1000000).toFixed(1)}M
                    </p>
                    <p className="text-xs text-slate-600 dark:text-slate-400">One-time capital investment</p>
                  </div>
                  
                  <div className="p-4 bg-teal-50 dark:bg-teal-950/30 rounded-xl border border-teal-200 dark:border-teal-800">
                    <p className="text-sm text-teal-700 dark:text-teal-400 font-medium">Net State Savings</p>
                    <p className="text-2xl font-bold text-teal-800 dark:text-teal-300">
                      ${(miningAlternatives.reduce((sum, a) => sum + (a.netAnnualRevenue || 0), 0) / 1000000).toFixed(1)}M
                    </p>
                    <p className="text-xs text-teal-600 dark:text-teal-400">After $12/sqft/yr operations</p>
                  </div>
                </div>
                
                <div className="mt-6 p-4 bg-amber-50 dark:bg-amber-950/30 rounded-xl border border-amber-200 dark:border-amber-800">
                  <div className="flex items-start gap-3">
                    <Truck className="h-5 w-5 text-amber-600 mt-0.5 shrink-0" />
                    <div>
                      <h4 className="font-semibold text-amber-800 dark:text-amber-300">Specialty Crops for All 330 School Districts</h4>
                      <p className="text-sm text-amber-700 dark:text-amber-400 mt-1">
                        These massive regional greenhouse complexes grow specialty produce that school greenhouses don't: mushrooms, microgreens, edible flowers, year-round strawberries, specialty melons, and gourmet vegetables. All production is distributed to the 330 participating Minnesota school districts, supplementing what each school grows on-site.
                      </p>
                    </div>
                  </div>
                </div>
                
                <div className="mt-4 p-4 bg-emerald-50 dark:bg-emerald-950/30 rounded-xl border border-emerald-200 dark:border-emerald-800">
                  <div className="flex items-start gap-3">
                    <Leaf className="h-5 w-5 text-emerald-600 mt-0.5 shrink-0" />
                    <div>
                      <h4 className="font-semibold text-emerald-800 dark:text-emerald-300">Environmental Protection Guarantee</h4>
                      <p className="text-sm text-emerald-700 dark:text-emerald-400 mt-1">
                        Zero risk of sulfide acid mine drainage into the Boundary Waters. Instead, {miningAlternatives.reduce((sum, a) => sum + a.co2Sequestered, 0).toLocaleString()} tons of CO2 sequestered annually, {(miningAlternatives.reduce((sum, a) => sum + a.localFoodProduction, 0) / 1000000).toFixed(1)} million lbs of specialty produce for schools, and 2.4x economic multiplier keeping dollars in these communities.
                      </p>
                    </div>
                  </div>
                </div>

                {/* Construction Phase Jobs Breakdown */}
                <div className="mt-6 p-4 bg-blue-50 dark:bg-blue-950/30 rounded-xl border border-blue-200 dark:border-blue-800" data-testid="construction-jobs-section">
                  <div className="flex items-start gap-3 mb-4">
                    <HardHat className="h-5 w-5 text-blue-600 mt-0.5 shrink-0" />
                    <div>
                      <h4 className="font-semibold text-blue-800 dark:text-blue-300">Construction Phase Jobs — Building the Greenhouse Network</h4>
                      <p className="text-sm text-blue-700 dark:text-blue-400 mt-1">
                        Before permanent jobs begin, the greenhouse construction phase creates <span className="font-bold">800+ skilled trades jobs</span> for electricians, plumbers, HVAC technicians, and construction workers across Minnesota. Unlike mining construction (foreign contractors), Gaia prioritizes local union labor.
                      </p>
                    </div>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                      <h5 className="font-semibold text-blue-700 dark:text-blue-300 mb-3 flex items-center gap-2">
                        <Building className="h-4 w-4" /> Northern MN Hubs (Phase 1: 960K sqft)
                      </h5>
                      <div className="grid grid-cols-2 gap-2">
                        <div className="p-2 bg-white/70 dark:bg-black/30 rounded-lg">
                          <p className="text-lg font-bold text-blue-800 dark:text-blue-200">130</p>
                          <p className="text-xs text-blue-600 dark:text-blue-400">General Construction</p>
                          <p className="text-[10px] text-blue-500">Carpentry, concrete, framing</p>
                        </div>
                        <div className="p-2 bg-white/70 dark:bg-black/30 rounded-lg">
                          <p className="text-lg font-bold text-blue-800 dark:text-blue-200">65</p>
                          <p className="text-xs text-blue-600 dark:text-blue-400">Electricians</p>
                          <p className="text-[10px] text-blue-500">Grow lights, controls, panels</p>
                        </div>
                        <div className="p-2 bg-white/70 dark:bg-black/30 rounded-lg">
                          <p className="text-lg font-bold text-blue-800 dark:text-blue-200">50</p>
                          <p className="text-xs text-blue-600 dark:text-blue-400">Plumbers</p>
                          <p className="text-[10px] text-blue-500">Irrigation, hydroponics, water</p>
                        </div>
                        <div className="p-2 bg-white/70 dark:bg-black/30 rounded-lg">
                          <p className="text-lg font-bold text-blue-800 dark:text-blue-200">50</p>
                          <p className="text-xs text-blue-600 dark:text-blue-400">HVAC Technicians</p>
                          <p className="text-[10px] text-blue-500">Climate control, ventilation</p>
                        </div>
                        <div className="p-2 bg-white/70 dark:bg-black/30 rounded-lg">
                          <p className="text-lg font-bold text-blue-800 dark:text-blue-200">30</p>
                          <p className="text-xs text-blue-600 dark:text-blue-400">Greenhouse Specialists</p>
                          <p className="text-[10px] text-blue-500">Glass, structure, systems</p>
                        </div>
                        <div className="p-2 bg-blue-100 dark:bg-blue-900/50 rounded-lg">
                          <p className="text-lg font-bold text-blue-800 dark:text-blue-200">325</p>
                          <p className="text-xs text-blue-700 dark:text-blue-300 font-medium">Phase 1 Total</p>
                          <p className="text-[10px] text-blue-600">2-3 year build-out</p>
                        </div>
                      </div>
                    </div>

                    <div>
                      <h5 className="font-semibold text-emerald-700 dark:text-emerald-300 mb-3 flex items-center gap-2">
                        <School className="h-4 w-4" /> Statewide School Greenhouses (330 Districts)
                      </h5>
                      <div className="grid grid-cols-2 gap-2">
                        <div className="p-2 bg-white/70 dark:bg-black/30 rounded-lg">
                          <p className="text-lg font-bold text-emerald-800 dark:text-emerald-200">160</p>
                          <p className="text-xs text-emerald-600 dark:text-emerald-400">General Construction</p>
                          <p className="text-[10px] text-emerald-500">Site prep, foundations</p>
                        </div>
                        <div className="p-2 bg-white/70 dark:bg-black/30 rounded-lg">
                          <p className="text-lg font-bold text-emerald-800 dark:text-emerald-200">95</p>
                          <p className="text-xs text-emerald-600 dark:text-emerald-400">Electricians</p>
                          <p className="text-[10px] text-emerald-500">School connections, lighting</p>
                        </div>
                        <div className="p-2 bg-white/70 dark:bg-black/30 rounded-lg">
                          <p className="text-lg font-bold text-emerald-800 dark:text-emerald-200">75</p>
                          <p className="text-xs text-emerald-600 dark:text-emerald-400">Plumbers</p>
                          <p className="text-[10px] text-emerald-500">Water systems, drainage</p>
                        </div>
                        <div className="p-2 bg-white/70 dark:bg-black/30 rounded-lg">
                          <p className="text-lg font-bold text-emerald-800 dark:text-emerald-200">70</p>
                          <p className="text-xs text-emerald-600 dark:text-emerald-400">HVAC Technicians</p>
                          <p className="text-[10px] text-emerald-500">Heating, cooling</p>
                        </div>
                        <div className="p-2 bg-white/70 dark:bg-black/30 rounded-lg">
                          <p className="text-lg font-bold text-emerald-800 dark:text-emerald-200">50</p>
                          <p className="text-xs text-emerald-600 dark:text-emerald-400">Greenhouse Specialists</p>
                          <p className="text-[10px] text-emerald-500">Educational designs</p>
                        </div>
                        <div className="p-2 bg-emerald-100 dark:bg-emerald-900/50 rounded-lg">
                          <p className="text-lg font-bold text-emerald-800 dark:text-emerald-200">450</p>
                          <p className="text-xs text-emerald-700 dark:text-emerald-300 font-medium">Phase 2 Total</p>
                          <p className="text-[10px] text-emerald-600">Rolling 3-5 year build</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
                    <div className="p-3 bg-blue-100 dark:bg-blue-900/40 rounded-lg text-center">
                      <p className="text-2xl font-bold text-blue-800 dark:text-blue-200">775+</p>
                      <p className="text-xs text-blue-600 dark:text-blue-400">Total Construction Jobs</p>
                      <p className="text-[10px] text-blue-500">(Northern MN + Schools)</p>
                    </div>
                    <div className="p-3 bg-blue-100 dark:bg-blue-900/40 rounded-lg text-center">
                      <p className="text-2xl font-bold text-blue-800 dark:text-blue-200">$35+/hr</p>
                      <p className="text-xs text-blue-600 dark:text-blue-400">Avg. Union Wage</p>
                      <p className="text-[10px] text-blue-500">Prevailing wage required</p>
                    </div>
                    <div className="p-3 bg-blue-100 dark:bg-blue-900/40 rounded-lg text-center">
                      <p className="text-2xl font-bold text-blue-800 dark:text-blue-200">100%</p>
                      <p className="text-xs text-blue-600 dark:text-blue-400">Local Hire Priority</p>
                      <p className="text-[10px] text-blue-500">MN contractors first</p>
                    </div>
                    <div className="p-3 bg-blue-100 dark:bg-blue-900/40 rounded-lg text-center">
                      <p className="text-2xl font-bold text-blue-800 dark:text-blue-200">$81M+</p>
                      <p className="text-xs text-blue-600 dark:text-blue-400">Construction Spending</p>
                      <p className="text-[10px] text-blue-500">Stays in Minnesota</p>
                    </div>
                  </div>

                  <div className="mt-4 p-3 bg-white/70 dark:bg-black/30 rounded-lg">
                    <p className="text-sm text-blue-700 dark:text-blue-400">
                      <span className="font-bold">Key difference from mining:</span> Twin Metals would bring construction crews from Chile, UK, Canada, and Australia. Gaia's greenhouses use <span className="font-bold">Minnesota union labor</span> — electricians from IBEW, plumbers from UA, carpenters from UBC. Every construction dollar circulates locally with a 2.4x economic multiplier.
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* Accountability & Transparency - Fraud Prevention */}
        {transparencyFeatures && transparencyFeatures.length > 0 && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.496 }} className="mb-8">
            <Card className="glass-panel" data-testid="card-transparency">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <Eye className="h-5 w-5 text-primary" />
                <CardTitle className="text-lg font-semibold">Accountability & Transparency — Fraud Prevention by Design</CardTitle>
                <Badge variant="secondary" className="ml-auto">Everyone Sees Everything</Badge>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div>
                    <p className="text-xs font-medium text-muted-foreground uppercase tracking-wide mb-3 flex items-center gap-2">
                      <Eye className="h-3 w-3" /> Transparency Features
                    </p>
                    <div className="space-y-3">
                      {transparencyFeatures.map((feature) => (
                        <div key={feature.id} className="p-3 bg-muted/30 rounded-lg border border-border/50" data-testid={`transparency-${feature.id}`}>
                          <div className="flex items-center gap-2 mb-1">
                            <Badge variant="outline" className="bg-emerald-50 dark:bg-emerald-950/30 text-emerald-700 dark:text-emerald-300 border-emerald-200 dark:border-emerald-800 text-xs">{feature.category}</Badge>
                          </div>
                          <h4 className="font-semibold text-foreground text-sm">{feature.feature}</h4>
                          <p className="text-xs text-muted-foreground mt-1">{feature.description}</p>
                          <div className="mt-2 pt-2 border-t border-border/30">
                            <p className="text-xs text-muted-foreground/80"><span className="font-medium">Who sees:</span> {feature.whoSees}</p>
                            <p className="text-xs text-emerald-600 dark:text-emerald-400 mt-1"><ShieldCheck className="h-3 w-3 inline mr-1" />{feature.fraudPrevention}</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  {accountabilityMechanisms && accountabilityMechanisms.length > 0 && (
                    <div>
                      <p className="text-xs font-medium text-muted-foreground uppercase tracking-wide mb-3 flex items-center gap-2">
                        <ClipboardCheck className="h-3 w-3" /> Accountability Mechanisms
                      </p>
                      <div className="space-y-3">
                        {accountabilityMechanisms.map((mechanism) => (
                          <div key={mechanism.id} className="p-3 bg-muted/30 rounded-lg border border-border/50" data-testid={`accountability-${mechanism.id}`}>
                            <div className="flex items-center justify-between mb-1">
                              <h4 className="font-semibold text-foreground text-sm">{mechanism.mechanism}</h4>
                              <Badge variant="outline" className="text-xs">{mechanism.frequency}</Badge>
                            </div>
                            <p className="text-xs text-muted-foreground">{mechanism.description}</p>
                            <div className="mt-2 grid grid-cols-2 gap-2">
                              <div className="p-2 bg-blue-50 dark:bg-blue-950/30 rounded border border-blue-100 dark:border-blue-900/50">
                                <p className="text-xs text-blue-700 dark:text-blue-400 font-medium">Who Audits</p>
                                <p className="text-xs text-blue-800 dark:text-blue-300">{mechanism.whoAudits}</p>
                              </div>
                              <div className="p-2 bg-purple-50 dark:bg-purple-950/30 rounded border border-purple-100 dark:border-purple-900/50">
                                <p className="text-xs text-purple-700 dark:text-purple-400 font-medium">Visibility</p>
                                <p className="text-xs text-purple-800 dark:text-purple-300 line-clamp-2">{mechanism.visibility}</p>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
                
                <div className="mt-4 p-4 bg-amber-50 dark:bg-amber-950/30 rounded-lg border border-amber-100 dark:border-amber-900/50">
                  <div className="flex items-start gap-3">
                    <AlertTriangle className="h-5 w-5 text-amber-600 flex-shrink-0 mt-0.5" />
                    <div>
                      <h4 className="font-semibold text-amber-800 dark:text-amber-300 text-sm">Why Traditional Systems Fail</h4>
                      <p className="text-xs text-amber-700 dark:text-amber-400 mt-1">
                        Minnesota has seen $250M+ in COVID relief fraud, childcare system collapse, and ongoing school lunch contractor fraud. 
                        Root causes: opaque funding flows, fragmented oversight, profit incentives misaligned with kid welfare. 
                        Gaia Commons makes fraud almost impossible through radical visibility and distributed accountability.
                      </p>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* Implementation Timeline */}
        {implementationTimeline && implementationTimeline.length > 0 && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.50 }} className="mb-8">
            <Card className="glass-panel" data-testid="card-implementation-timeline">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <Calendar className="h-5 w-5 text-primary" />
                <CardTitle className="text-lg font-semibold">Implementation Timeline — Greenhouse Rollout 2027-2028</CardTitle>
                <Badge variant="secondary" className="ml-auto">{implementationTimeline.length} Milestones</Badge>
              </CardHeader>
              <CardContent>
                <div className="relative">
                  <div className="absolute left-4 top-0 bottom-0 w-0.5 bg-primary/20" />
                  <div className="space-y-4">
                    {implementationTimeline.map((item, idx) => (
                      <div key={item.id} className="relative pl-10" data-testid={`timeline-item-${item.id}`}>
                        <div className={`absolute left-2 w-4 h-4 rounded-full border-2 ${idx === implementationTimeline.length - 1 ? 'bg-primary border-primary' : 'bg-background border-primary'}`} />
                        <div className="p-4 bg-muted/30 rounded-lg border border-border/50">
                          <div className="flex flex-wrap items-center gap-2 mb-2">
                            <Badge variant="outline" className="text-xs">{item.phase}</Badge>
                            <span className="text-sm font-semibold text-primary">{item.quarter}</span>
                            <span className="text-sm font-medium text-foreground">{item.milestone}</span>
                          </div>
                          <p className="text-sm text-muted-foreground mb-3">{item.details}</p>
                          <div className="grid grid-cols-3 gap-3 text-center">
                            <div className="p-2 bg-background/50 rounded">
                              <p className="text-lg font-bold text-primary">{item.greenhouseCount}</p>
                              <p className="text-xs text-muted-foreground">Greenhouses</p>
                            </div>
                            <div className="p-2 bg-background/50 rounded">
                              <p className="text-lg font-bold text-emerald-600">{item.jobsCreated?.toLocaleString()}</p>
                              <p className="text-xs text-muted-foreground">Jobs</p>
                            </div>
                            <div className="p-2 bg-background/50 rounded">
                              <p className="text-lg font-bold text-blue-600">{item.studentsServed?.toLocaleString()}</p>
                              <p className="text-xs text-muted-foreground">Students</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* Political Roadmap */}
        {politicalRoadmap && politicalRoadmap.length > 0 && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.51 }} className="mb-8">
            <Card className="glass-panel" data-testid="card-political-roadmap">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <MapPinned className="h-5 w-5 text-primary" />
                <CardTitle className="text-lg font-semibold">Political Roadmap — 8 Districts, One Message</CardTitle>
                <Badge variant="secondary" className="ml-auto">Target: 58%+ Vote Share</Badge>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  {politicalRoadmap.map((district) => (
                    <div 
                      key={district.id} 
                      className={`p-4 rounded-lg border ${
                        district.supportLevel === 'Strong YES' 
                          ? 'bg-emerald-50/50 dark:bg-emerald-950/20 border-emerald-200 dark:border-emerald-900/50' 
                          : district.supportLevel === 'Competitive' 
                            ? 'bg-amber-50/50 dark:bg-amber-950/20 border-amber-200 dark:border-amber-900/50'
                            : 'bg-red-50/50 dark:bg-red-950/20 border-red-200 dark:border-red-900/50'
                      }`}
                      data-testid={`district-${district.district}`}
                    >
                      <div className="flex items-center justify-between mb-2">
                        <span className="font-bold text-foreground">{district.district}</span>
                        <Badge 
                          variant="outline" 
                          className={`text-xs ${
                            district.supportLevel === 'Strong YES' 
                              ? 'border-emerald-500 text-emerald-700 dark:text-emerald-400' 
                              : district.supportLevel === 'Competitive'
                                ? 'border-amber-500 text-amber-700 dark:text-amber-400'
                                : 'border-red-500 text-red-700 dark:text-red-400'
                          }`}
                        >
                          {district.supportPct}
                        </Badge>
                      </div>
                      <p className={`text-sm font-medium mb-2 ${
                        district.supportLevel === 'Strong YES' 
                          ? 'text-emerald-700 dark:text-emerald-400' 
                          : district.supportLevel === 'Competitive'
                            ? 'text-amber-700 dark:text-amber-400'
                            : 'text-red-700 dark:text-red-400'
                      }`}>{district.supportLevel}</p>
                      <p className="text-xs text-muted-foreground mb-2">{district.strategy}</p>
                      <div className="pt-2 border-t border-border/50">
                        <p className="text-xs text-muted-foreground">Key messaging:</p>
                        <p className="text-xs font-medium text-foreground">{district.keyMessaging}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* Stress Tests / Resilience - Using CollapsibleSection */}
        {stressTests && stressTests.length > 0 && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.52 }} className="mb-8">
            <CollapsibleSection
              title="Financial Resilience — Stress Tests Prove Sustainability"
              icon={<ShieldAlert className="h-5 w-5 text-primary" />}
              badge={<Badge variant="secondary">99%+ Solvency</Badge>}
              defaultOpen={false}
              testId="card-stress-tests"
            >
              <p className="text-sm text-muted-foreground mb-4">
                50-year stress tests using 1926-2022 market data show resilience across bear markets, inflation surges, and combined shocks.
                More conservative than pension funds; tested against Great-Recession scenarios.
              </p>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {stressTests.map((test) => (
                  <div key={test.id} className="p-4 bg-muted/30 rounded-lg border border-border/50" data-testid={`stress-test-${test.id}`}>
                    <div className="flex items-center justify-between mb-2">
                      <span className="font-semibold text-foreground">{test.scenario}</span>
                      <Badge variant="outline" className="text-xs border-emerald-500 text-emerald-700 dark:text-emerald-400">
                        <CheckCircle2 className="h-3 w-3 mr-1" />
                        {test.solvencyProbability}
                      </Badge>
                    </div>
                    <p className="text-sm text-muted-foreground mb-2">{test.description}</p>
                    <div className="space-y-2">
                      <div className="flex items-start gap-2">
                        <AlertTriangle className="h-4 w-4 text-amber-500 mt-0.5 shrink-0" />
                        <p className="text-xs text-foreground"><span className="font-medium">Impact:</span> {test.impact}</p>
                      </div>
                      <div className="flex items-start gap-2">
                        <ShieldCheck className="h-4 w-4 text-emerald-500 mt-0.5 shrink-0" />
                        <p className="text-xs text-foreground"><span className="font-medium">Mitigation:</span> {test.mitigation}</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </CollapsibleSection>
          </motion.div>
        )}

        {/* Global Regeneration Project */}
        {globalRegenerationSummary && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.53 }} className="mb-8">
            <Card className="glass-panel bg-gradient-to-r from-emerald-50/50 to-blue-50/50 dark:from-emerald-950/20 dark:to-blue-950/20" data-testid="card-global-regeneration">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <Globe className="h-5 w-5 text-primary" />
                <CardTitle className="text-lg font-semibold">Global Regeneration Project — Complete Climate Transformation</CardTitle>
                <Badge variant="secondary" className="ml-auto">National Scale</Badge>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                  <div className="p-4 bg-background/60 rounded-lg border border-border/50 text-center">
                    <p className="text-2xl font-bold text-primary">{formatNumber(globalRegenerationSummary.totalJobsCreated)}</p>
                    <p className="text-xs text-muted-foreground">Total Jobs Created</p>
                  </div>
                  <div className="p-4 bg-background/60 rounded-lg border border-border/50 text-center">
                    <p className="text-2xl font-bold text-emerald-600">{formatNumber(globalRegenerationSummary.totalCoalitionSize)}</p>
                    <p className="text-xs text-muted-foreground">Coalition Size</p>
                  </div>
                  <div className="p-4 bg-background/60 rounded-lg border border-border/50 text-center">
                    <p className="text-2xl font-bold text-blue-600">{globalRegenerationSummary.coalitionPercentage.toFixed(1)}%</p>
                    <p className="text-xs text-muted-foreground">Of Electorate</p>
                  </div>
                  <div className="p-4 bg-background/60 rounded-lg border border-border/50 text-center">
                    <p className="text-2xl font-bold text-amber-600">{globalRegenerationSummary.coalitionAdvantage}</p>
                    <p className="text-xs text-muted-foreground">vs Opposition</p>
                  </div>
                </div>
                <div className="p-4 bg-background/40 rounded-lg border border-emerald-200 dark:border-emerald-900/50 mb-4">
                  <div className="flex items-center gap-2 mb-2">
                    <VoteIcon className="h-5 w-5 text-emerald-600" />
                    <span className="font-semibold text-foreground">{globalRegenerationSummary.politicalPowerAssessment}</span>
                  </div>
                  <p className="text-sm text-muted-foreground">Choice preservation achieved through tiered carbon pricing, voluntary labor transition, and farmer-led regenerative adoption.</p>
                </div>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* Tiered Carbon Pricing */}
        {tieredCarbonPricing && tieredCarbonPricing.length > 0 && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.54 }} className="mb-8">
            <Card className="glass-panel" data-testid="card-tiered-carbon">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <Flame className="h-5 w-5 text-primary" />
                <CardTitle className="text-lg font-semibold">Tiered Carbon Pricing — Protecting Small Businesses, Targeting Mega-Polluters</CardTitle>
                <Badge variant="secondary" className="ml-auto">4 Tiers</Badge>
              </CardHeader>
              <CardContent>
                <p className="text-sm text-muted-foreground mb-4">
                  Progressive carbon tax structure: Small businesses pay $25/ton, mega-polluters face $200/ton + exponential penalties.
                </p>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  {tieredCarbonPricing.map((tier) => (
                    <div 
                      key={tier.id} 
                      className={`p-4 rounded-lg border ${
                        tier.carbonTaxRate <= 25 ? 'bg-emerald-50/50 dark:bg-emerald-950/20 border-emerald-200 dark:border-emerald-900/50' :
                        tier.carbonTaxRate <= 75 ? 'bg-blue-50/50 dark:bg-blue-950/20 border-blue-200 dark:border-blue-900/50' :
                        tier.carbonTaxRate <= 150 ? 'bg-amber-50/50 dark:bg-amber-950/20 border-amber-200 dark:border-amber-900/50' :
                        'bg-red-50/50 dark:bg-red-950/20 border-red-200 dark:border-red-900/50'
                      }`}
                      data-testid={`carbon-tier-${tier.id}`}
                    >
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-lg font-bold text-primary">${tier.carbonTaxRate}/ton</span>
                        <Badge variant="outline" className="text-xs">{(tier.businessSurvival * 100).toFixed(0)}% survive</Badge>
                      </div>
                      <p className="text-sm font-medium text-foreground mb-1">{tier.description}</p>
                      <div className="grid grid-cols-2 gap-2 mt-3 text-center">
                        <div className="p-2 bg-background/50 rounded">
                          <p className="text-sm font-bold text-foreground">{(tier.reductionRate * 100).toFixed(0)}%</p>
                          <p className="text-xs text-muted-foreground">Reduction</p>
                        </div>
                        <div className="p-2 bg-background/50 rounded">
                          <p className="text-sm font-bold text-foreground">${tier.revenueMillions?.toLocaleString()}M</p>
                          <p className="text-xs text-muted-foreground">Revenue</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* Regenerative Agriculture */}
        {regenerativeAgriculture && regenerativeAgriculture.length > 0 && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.55 }} className="mb-8">
            <Card className="glass-panel" data-testid="card-regenerative-ag">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <Wheat className="h-5 w-5 text-primary" />
                <CardTitle className="text-lg font-semibold">Regenerative Agriculture — 144M Acres Transformed</CardTitle>
                <Badge variant="secondary" className="ml-auto">5 Operation Types</Badge>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                  {regenerativeAgriculture.map((op) => (
                    <div key={op.id} className="p-4 bg-muted/30 rounded-lg border border-border/50" data-testid={`ag-op-${op.id}`}>
                      <div className="flex items-center gap-2 mb-2">
                        <Leaf className="h-4 w-4 text-emerald-500" />
                        <span className="font-semibold text-foreground">{op.name}</span>
                      </div>
                      <p className="text-xs text-muted-foreground mb-3">{op.description}</p>
                      <div className="grid grid-cols-3 gap-2 text-center">
                        <div className="p-2 bg-background/50 rounded">
                          <p className="text-sm font-bold text-emerald-600">{formatNumber(op.totalJobs)}</p>
                          <p className="text-xs text-muted-foreground">Jobs</p>
                        </div>
                        <div className="p-2 bg-background/50 rounded">
                          <p className="text-sm font-bold text-blue-600">${formatNumber(op.totalRevenue)}</p>
                          <p className="text-xs text-muted-foreground">Revenue</p>
                        </div>
                        <div className="p-2 bg-background/50 rounded">
                          <p className="text-sm font-bold text-primary">{formatNumber(op.totalCarbonSequestered)}</p>
                          <p className="text-xs text-muted-foreground">CO2 Tons</p>
                        </div>
                      </div>
                      <div className="mt-3 pt-3 border-t border-border/50 flex justify-between text-xs text-muted-foreground">
                        <span>${op.revenuePerAcre}/acre</span>
                        <span>{op.avgWage.toLocaleString()} avg wage</span>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* Nationwide Food Security & Labor Transition */}
        <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-2 gap-6 xl:gap-8 mb-8">
          {nationwideFoodSecurity && (
            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.56 }}>
              <Card className="glass-panel h-full" data-testid="card-food-security">
                <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                  <Utensils className="h-5 w-5 text-primary" />
                  <CardTitle className="text-lg font-semibold">Nationwide Food Security</CardTitle>
                  <Badge variant="secondary" className="ml-auto">{nationwideFoodSecurity.scope}</Badge>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-2 gap-3 mb-4">
                    <div className="p-3 bg-muted/30 rounded-lg text-center">
                      <p className="text-xl font-bold text-primary">{formatNumber(nationwideFoodSecurity.totalStudents)}</p>
                      <p className="text-xs text-muted-foreground">Students Served</p>
                    </div>
                    <div className="p-3 bg-muted/30 rounded-lg text-center">
                      <p className="text-xl font-bold text-emerald-600">{formatNumber(nationwideFoodSecurity.facilitiesNeeded)}</p>
                      <p className="text-xs text-muted-foreground">Facilities</p>
                    </div>
                    <div className="p-3 bg-muted/30 rounded-lg text-center">
                      <p className="text-xl font-bold text-blue-600">{formatNumber(nationwideFoodSecurity.jobsCreated)}</p>
                      <p className="text-xs text-muted-foreground">Jobs Created</p>
                    </div>
                    <div className="p-3 bg-muted/30 rounded-lg text-center">
                      <p className="text-xl font-bold text-amber-600">${formatNumber(nationwideFoodSecurity.constructionCost)}</p>
                      <p className="text-xs text-muted-foreground">Investment</p>
                    </div>
                  </div>
                  <div className="p-3 bg-emerald-50/50 dark:bg-emerald-950/20 rounded-lg border border-emerald-200 dark:border-emerald-900/50">
                    <p className="text-xs text-emerald-700 dark:text-emerald-400"><span className="font-medium">Model:</span> {nationwideFoodSecurity.replicationModel}</p>
                    <p className="text-xs text-emerald-700 dark:text-emerald-400 mt-1"><span className="font-medium">Pesticides:</span> {nationwideFoodSecurity.pesticideElimination}</p>
                  </div>
                </CardContent>
              </Card>
            </motion.div>
          )}

          {laborTransition && laborTransition.length > 0 && (
            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.57 }}>
              <Card className="glass-panel h-full" data-testid="card-labor-transition">
                <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                  <HardHat className="h-5 w-5 text-primary" />
                  <CardTitle className="text-lg font-semibold">Labor Transition Program</CardTitle>
                  <Badge variant="secondary" className="ml-auto">{laborTransition.reduce((sum, l) => sum + l.workersAffected, 0).toLocaleString()} Workers</Badge>
                </CardHeader>
                <CardContent>
                  <p className="text-sm text-muted-foreground mb-4">
                    125% income guarantee for 3 years + $45K retraining. Workers choose timing and pathway.
                  </p>
                  <div className="space-y-3">
                    {laborTransition.map((sector) => (
                      <div key={sector.id} className="p-3 bg-muted/30 rounded-lg" data-testid={`labor-sector-${sector.id}`}>
                        <div className="flex items-center justify-between mb-1">
                          <span className="font-medium text-foreground">{sector.sector}</span>
                          <span className="text-sm font-bold text-primary">{sector.workersAffected.toLocaleString()}</span>
                        </div>
                        <div className="flex items-center justify-between text-xs text-muted-foreground">
                          <span>{(sector.successRate * 100).toFixed(0)}% success rate</span>
                          <span>Total: ${formatNumber(sector.totalCost)}</span>
                        </div>
                      </div>
                    ))}
                  </div>
                </CardContent>
              </Card>
            </motion.div>
          )}
        </div>

        {/* Political Coalition */}
        {politicalCoalitionData && politicalCoalitionData.length > 0 && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.58 }} className="mb-8">
            <Card className="glass-panel" data-testid="card-political-coalition">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <VoteIcon className="h-5 w-5 text-primary" />
                <CardTitle className="text-lg font-semibold">Political Coalition — Largest in US History</CardTitle>
                <Badge variant="secondary" className="ml-auto">{politicalCoalitionData.length} Groups</Badge>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                  {politicalCoalitionData.map((group) => (
                    <div key={group.id} className="p-4 bg-muted/30 rounded-lg border border-border/50" data-testid={`coalition-group-${group.id}`}>
                      <p className="font-medium text-foreground mb-1">{group.groupName}</p>
                      <p className="text-xl font-bold text-primary">{group.memberCount > 0 ? formatNumber(group.memberCount) : 'Dynamic'}</p>
                      {group.description && <p className="text-xs text-muted-foreground mt-1">{group.description}</p>}
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* Model Calibration & Validation Section */}
        {(planetaryBoundaries && planetaryBoundaries.length > 0) && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.59 }} className="mb-8">
            <Card className="glass-panel bg-gradient-to-r from-blue-50/50 to-purple-50/50 dark:from-blue-950/20 dark:to-purple-950/20" data-testid="card-model-validation">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <FlaskConical className="h-5 w-5 text-primary" />
                <CardTitle className="text-lg font-semibold">Model Calibration & Validation — Why You Can Trust These Projections</CardTitle>
                <Badge variant="secondary" className="ml-auto">Real-World Data</Badge>
              </CardHeader>
              <CardContent>
                <p className="text-sm text-muted-foreground mb-6">
                  All projections are grounded in empirical data from NASA, NOAA, IEA, World Bank, and peer-reviewed science. 
                  Our models are continuously calibrated against real-world observations.
                </p>

                {/* Model Maturity Levels */}
                {modelMaturity && modelMaturity.length > 0 && (
                  <div className="mb-6">
                    <h4 className="text-sm font-semibold text-foreground mb-3 flex items-center gap-2">
                      <Gauge className="h-4 w-4 text-primary" />
                      Model Maturity Levels
                    </h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                      {modelMaturity.map((m) => (
                        <div key={m.id} className="p-3 bg-background/60 rounded-lg border border-border/50" data-testid={`maturity-${m.id}`}>
                          <div className="flex items-center justify-between mb-2">
                            <span className="font-medium text-foreground">{m.subsystem}</span>
                            <Badge 
                              variant="outline" 
                              className={`text-xs ${
                                m.maturityLevel === 'validated' ? 'border-emerald-500 text-emerald-700 dark:text-emerald-400' :
                                m.maturityLevel === 'calibrated' ? 'border-blue-500 text-blue-700 dark:text-blue-400' :
                                'border-amber-500 text-amber-700 dark:text-amber-400'
                              }`}
                            >
                              {m.maturityLevel === 'validated' && <CheckCircle className="h-3 w-3 mr-1" />}
                              {m.maturityLevel === 'calibrated' && <CircleDot className="h-3 w-3 mr-1" />}
                              {m.maturityLevel === 'sandbox' && <AlertCircle className="h-3 w-3 mr-1" />}
                              {m.maturityLevel}
                            </Badge>
                          </div>
                          <p className="text-xs text-muted-foreground mb-2">{m.description}</p>
                          <div className="flex gap-4 text-xs text-muted-foreground">
                            <span><Database className="h-3 w-3 inline mr-1" />{m.dataSourcesCount} sources</span>
                            <span><CheckCircle2 className="h-3 w-3 inline mr-1" />{m.validationTests} tests</span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Calibration Targets */}
                {calibrationTargets && calibrationTargets.length > 0 && (
                  <div className="mb-6">
                    <h4 className="text-sm font-semibold text-foreground mb-3 flex items-center gap-2">
                      <Target className="h-4 w-4 text-primary" />
                      Calibration Accuracy ({calibrationTargets.filter(t => t.status === 'passed').length}/{calibrationTargets.length} Passed)
                    </h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                      {calibrationTargets.map((t) => (
                        <div key={t.id} className="p-3 bg-background/60 rounded-lg border border-border/50" data-testid={`calibration-${t.id}`}>
                          <div className="flex items-center justify-between mb-2">
                            <span className="font-medium text-foreground text-sm">{t.parameter}</span>
                            <Badge 
                              variant="outline" 
                              className={`text-xs ${
                                t.status === 'passed' ? 'border-emerald-500 text-emerald-700 dark:text-emerald-400' :
                                t.status === 'warning' ? 'border-amber-500 text-amber-700 dark:text-amber-400' :
                                'border-red-500 text-red-700 dark:text-red-400'
                              }`}
                            >
                              {t.status === 'passed' && <CheckCircle className="h-3 w-3 mr-1" />}
                              {t.status === 'warning' && <AlertCircle className="h-3 w-3 mr-1" />}
                              {t.status === 'failed' && <XCircle className="h-3 w-3 mr-1" />}
                              {(t.actualAccuracy * 100).toFixed(1)}% error
                            </Badge>
                          </div>
                          <p className="text-xs text-muted-foreground">{t.dataSource}</p>
                          <p className="text-xs text-muted-foreground">Validated: {t.validationPeriodStart}-{t.validationPeriodEnd}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Planetary Boundaries */}
                <div>
                  <h4 className="text-sm font-semibold text-foreground mb-3 flex items-center gap-2">
                    <Globe className="h-4 w-4 text-primary" />
                    Planetary Boundaries Status (Steffen et al. 2015, Richardson et al. 2023)
                  </h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {planetaryBoundaries.map((b) => (
                      <div key={b.id} className="p-3 bg-background/60 rounded-lg border border-border/50" data-testid={`boundary-${b.id}`}>
                        <div className="flex items-center justify-between mb-2">
                          <span className="font-medium text-foreground text-sm">{b.boundary}</span>
                          <Badge 
                            variant="outline" 
                            className={`text-xs ${
                              b.status === 'safe' ? 'border-emerald-500 text-emerald-700 dark:text-emerald-400' :
                              b.status === 'caution' ? 'border-amber-500 text-amber-700 dark:text-amber-400' :
                              'border-red-500 text-red-700 dark:text-red-400'
                            }`}
                          >
                            {b.status === 'safe' && <CheckCircle className="h-3 w-3 mr-1" />}
                            {b.status === 'caution' && <AlertCircle className="h-3 w-3 mr-1" />}
                            {b.status === 'danger' && <XCircle className="h-3 w-3 mr-1" />}
                            {b.status}
                          </Badge>
                        </div>
                        <div className="mb-2">
                          <div className="flex justify-between text-xs text-muted-foreground mb-1">
                            <span>Current: {b.currentValue} {b.unit}</span>
                            <span>Safe: {b.safeLimit}</span>
                          </div>
                          <div className="h-2 bg-muted rounded-full overflow-hidden">
                            <div 
                              className={`h-full rounded-full ${
                                b.status === 'safe' ? 'bg-emerald-500' :
                                b.status === 'caution' ? 'bg-amber-500' :
                                'bg-red-500'
                              }`}
                              style={{ width: `${Math.min(100, (b.currentValue / b.criticalLimit) * 100)}%` }}
                            />
                          </div>
                        </div>
                        <p className="text-xs text-muted-foreground">{b.source}</p>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Historical Climate Data Chart */}
                {historicalClimateData && historicalClimateData.length > 0 && (
                  <div className="mt-6">
                    <h4 className="text-sm font-semibold text-foreground mb-3 flex items-center gap-2">
                      <Thermometer className="h-4 w-4 text-primary" />
                      Historical Validation Data (2015-2024)
                    </h4>
                    <div className="h-64 w-full">
                      <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={historicalClimateData}>
                          <CartesianGrid strokeDasharray="3 3" className="opacity-30" />
                          <XAxis dataKey="year" tick={{ fontSize: 11 }} />
                          <YAxis yAxisId="temp" orientation="left" tick={{ fontSize: 11 }} domain={[0.8, 1.3]} />
                          <YAxis yAxisId="co2" orientation="right" tick={{ fontSize: 11 }} domain={[395, 430]} />
                          <Tooltip 
                            contentStyle={{ 
                              backgroundColor: 'hsl(var(--background))', 
                              border: '1px solid hsl(var(--border))',
                              borderRadius: '8px'
                            }}
                          />
                          <Legend />
                          <Line yAxisId="temp" type="monotone" dataKey="tempAnomaly" stroke="#ef4444" name="Temp Anomaly (°C)" strokeWidth={2} dot={{ r: 3 }} />
                          <Line yAxisId="co2" type="monotone" dataKey="co2Ppm" stroke="#3b82f6" name="CO2 (ppm)" strokeWidth={2} dot={{ r: 3 }} />
                        </LineChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* Advanced Modeling Section */}
        {(monteCarloSimulations && monteCarloSimulations.length > 0) && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.60 }} className="mb-8">
            <Card className="glass-panel bg-gradient-to-r from-purple-50/50 to-indigo-50/50 dark:from-purple-950/20 dark:to-indigo-950/20" data-testid="card-advanced-modeling">
              <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
                <BarChart3 className="h-5 w-5 text-primary" />
                <CardTitle className="text-lg font-semibold">Advanced Modeling — Monte Carlo, Scenarios & Optimization</CardTitle>
                <Badge variant="secondary" className="ml-auto">10,000 Iterations</Badge>
              </CardHeader>
              <CardContent>
                <p className="text-sm text-muted-foreground mb-6">
                  Probabilistic simulations with confidence intervals, scenario comparisons, and optimization analysis 
                  for robust decision-making under uncertainty.
                </p>

                {/* Monte Carlo Simulations */}
                <div className="mb-6">
                  <h4 className="text-sm font-semibold text-foreground mb-3 flex items-center gap-2">
                    <BarChart3 className="h-4 w-4 text-primary" />
                    Monte Carlo Uncertainty Analysis (95% Confidence)
                    <UITooltip>
                      <TooltipTrigger asChild>
                        <HelpCircle className="h-3.5 w-3.5 text-muted-foreground cursor-help" />
                      </TooltipTrigger>
                      <TooltipContent className="max-w-xs">
                        <p>P10/P50/P90 represent the 10th, 50th (median), and 90th percentile outcomes from 10,000 simulation runs, capturing uncertainty in projections.</p>
                      </TooltipContent>
                    </UITooltip>
                  </h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-6 gap-3">
                    {monteCarloSimulations.map((mc) => (
                      <div key={mc.id} className="p-3 bg-background/60 rounded-lg border border-border/50" data-testid={`monte-carlo-${mc.id}`}>
                        <div className="flex items-center justify-between mb-2">
                          <span className="font-medium text-foreground text-sm">{mc.parameter}</span>
                          <Badge variant="outline" className="text-xs border-purple-500 text-purple-700 dark:text-purple-400">
                            {mc.scale}
                          </Badge>
                        </div>
                        <div className="mb-2">
                          <div className="text-lg font-bold text-foreground">
                            {mc.unit === 'USD' || mc.unit === 'USD/year' 
                              ? formatLargeNumber(mc.p50Value)
                              : formatNumber(mc.p50Value)} <span className="text-xs font-normal text-muted-foreground">{mc.unit !== 'USD' && mc.unit !== 'USD/year' ? mc.unit : ''}</span>
                          </div>
                          <div className="flex justify-between text-xs text-muted-foreground">
                            <span>P10: {mc.unit === 'USD' || mc.unit === 'USD/year' ? formatLargeNumber(mc.p10Value) : formatNumber(mc.p10Value)}</span>
                            <span>P90: {mc.unit === 'USD' || mc.unit === 'USD/year' ? formatLargeNumber(mc.p90Value) : formatNumber(mc.p90Value)}</span>
                          </div>
                        </div>
                        <div className="h-2 bg-muted rounded-full overflow-hidden relative">
                          <div className="absolute h-full bg-purple-200 dark:bg-purple-900" style={{ left: `${(mc.p10Value / mc.p90Value) * 50}%`, width: `${100 - (mc.p10Value / mc.p90Value) * 50}%` }} />
                          <div className="absolute h-full w-1 bg-purple-600" style={{ left: '50%' }} />
                        </div>
                        <p className="text-xs text-muted-foreground mt-1">{mc.iterations.toLocaleString()} iterations</p>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Scenario Comparisons */}
                {scenarioComparisons && scenarioComparisons.length > 0 && (
                  <div className="mb-6">
                    <h4 className="text-sm font-semibold text-foreground mb-3 flex items-center gap-2">
                      <GitCompare className="h-4 w-4 text-primary" />
                      Scenario Comparison (Baseline / Optimistic / Conservative)
                      <UITooltip>
                        <TooltipTrigger asChild>
                          <HelpCircle className="h-3.5 w-3.5 text-muted-foreground cursor-help" />
                        </TooltipTrigger>
                        <TooltipContent className="max-w-xs">
                          <p>Three scenarios model different assumptions: Conservative (worst-case delays), Baseline (current plan), Optimistic (accelerated adoption).</p>
                        </TooltipContent>
                      </UITooltip>
                    </h4>
                    <div className="overflow-x-auto -mx-3 px-3">
                      <table className="w-full text-sm min-w-[500px]">
                        <thead>
                          <tr className="border-b border-border/50">
                            <th className="text-left py-2 px-3 font-medium text-muted-foreground">Metric</th>
                            <th className="text-left py-2 px-3 font-medium text-muted-foreground">Category</th>
                            <th className="text-right py-2 px-3 font-medium text-amber-600 dark:text-amber-400">Conservative</th>
                            <th className="text-right py-2 px-3 font-medium text-blue-600 dark:text-blue-400">Baseline</th>
                            <th className="text-right py-2 px-3 font-medium text-emerald-600 dark:text-emerald-400">Optimistic</th>
                          </tr>
                        </thead>
                        <tbody>
                          {scenarioComparisons.map((s) => (
                            <tr key={s.id} className="border-b border-border/30 hover:bg-muted/20" data-testid={`scenario-${s.id}`}>
                              <td className="py-2 px-3 font-medium">{s.metric}</td>
                              <td className="py-2 px-3">
                                <Badge variant="outline" className="text-xs">{s.category}</Badge>
                              </td>
                              <td className="py-2 px-3 text-right text-amber-600 dark:text-amber-400">
                                {s.unit === 'USD' ? formatLargeNumber(s.conservativeValue) : 
                                 s.unit === 'approval rate' ? `${(s.conservativeValue * 100).toFixed(0)}%` :
                                 s.conservativeValue.toLocaleString()}
                              </td>
                              <td className="py-2 px-3 text-right text-blue-600 dark:text-blue-400 font-medium">
                                {s.unit === 'USD' ? formatLargeNumber(s.baselineValue) : 
                                 s.unit === 'approval rate' ? `${(s.baselineValue * 100).toFixed(0)}%` :
                                 s.baselineValue.toLocaleString()}
                              </td>
                              <td className="py-2 px-3 text-right text-emerald-600 dark:text-emerald-400">
                                {s.unit === 'USD' ? formatLargeNumber(s.optimisticValue) : 
                                 s.unit === 'approval rate' ? `${(s.optimisticValue * 100).toFixed(0)}%` :
                                 s.optimisticValue.toLocaleString()}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Optimization Parameters */}
                {optimizationParams && optimizationParams.length > 0 && (
                  <div className="mb-6">
                    <h4 className="text-sm font-semibold text-foreground mb-3 flex items-center gap-2">
                      <SlidersHorizontal className="h-4 w-4 text-primary" />
                      Optimization Targets
                      <UITooltip>
                        <TooltipTrigger asChild>
                          <HelpCircle className="h-3.5 w-3.5 text-muted-foreground cursor-help" />
                        </TooltipTrigger>
                        <TooltipContent className="max-w-xs">
                          <p>Optimization finds the best achievable values for each target while respecting real-world constraints like budget caps and quality standards.</p>
                        </TooltipContent>
                      </UITooltip>
                    </h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-3">
                      {optimizationParams.map((o) => (
                        <div key={o.id} className="p-3 bg-background/60 rounded-lg border border-border/50" data-testid={`optimization-${o.id}`}>
                          <div className="flex items-center justify-between mb-2">
                            <span className="font-medium text-foreground text-sm">{o.targetMetric}</span>
                            <Badge 
                              variant="outline" 
                              className={`text-xs ${
                                o.feasibility === 'achievable' ? 'border-emerald-500 text-emerald-700 dark:text-emerald-400' :
                                'border-amber-500 text-amber-700 dark:text-amber-400'
                              }`}
                            >
                              {o.feasibility}
                            </Badge>
                          </div>
                          <div className="flex items-center gap-2 mb-2">
                            <span className="text-xs text-muted-foreground">Current:</span>
                            <span className="text-sm font-medium">{o.currentValue}</span>
                            <TrendingUp className="h-3 w-3 text-muted-foreground" />
                            <span className="text-xs text-muted-foreground">Target:</span>
                            <span className="text-sm font-medium text-primary">{o.targetValue}</span>
                          </div>
                          <div className="h-2 bg-muted rounded-full overflow-hidden mb-1">
                            <div 
                              className="h-full bg-gradient-to-r from-blue-500 to-emerald-500 rounded-full"
                              style={{ width: `${Math.min(100, (o.optimalValue / o.targetValue) * 100)}%` }}
                            />
                          </div>
                          <p className="text-xs text-muted-foreground">Optimal: {o.optimalValue} | Constraint: {o.constraintName}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Sensitivity Analysis */}
                {sensitivityAnalysis && sensitivityAnalysis.length > 0 && (
                  <div>
                    <h4 className="text-sm font-semibold text-foreground mb-3 flex items-center gap-2">
                      <ArrowUpDown className="h-4 w-4 text-primary" />
                      Sensitivity Analysis (Parameter Impact Ranking)
                      <UITooltip>
                        <TooltipTrigger asChild>
                          <HelpCircle className="h-3.5 w-3.5 text-muted-foreground cursor-help" />
                        </TooltipTrigger>
                        <TooltipContent className="max-w-xs">
                          <p>Elasticity measures how much output changes for a 1% change in input. Higher values indicate parameters that most affect outcomes.</p>
                        </TooltipContent>
                      </UITooltip>
                    </h4>
                    <div className="space-y-2">
                      {sensitivityAnalysis.map((s) => (
                        <div key={s.id} className="flex items-center gap-3 p-2 bg-background/60 rounded-lg border border-border/50" data-testid={`sensitivity-${s.id}`}>
                          <div className="flex items-center justify-center w-8 h-8 rounded-full bg-primary/10 text-primary font-bold text-sm">
                            {s.rank}
                          </div>
                          <div className="flex-1">
                            <div className="flex items-center gap-2">
                              <span className="font-medium text-sm">{s.inputParameter}</span>
                              <span className="text-xs text-muted-foreground">→ {s.outputMetric}</span>
                            </div>
                            <div className="flex items-center gap-3 text-xs text-muted-foreground">
                              <span>Elasticity: <span className={`font-medium ${s.elasticity > 0 ? 'text-emerald-600' : 'text-red-600'}`}>{s.elasticity.toFixed(2)}</span></span>
                              <span>±{(s.perturbationPct * 100).toFixed(0)}% input → {s.outputChange > 0 ? '+' : ''}{(s.outputChange * 100).toFixed(0)}% output</span>
                            </div>
                          </div>
                          <div className="w-24">
                            <div className="h-2 bg-muted rounded-full overflow-hidden">
                              <div 
                                className={`h-full rounded-full ${s.elasticity > 0 ? 'bg-emerald-500' : 'bg-red-500'}`}
                                style={{ width: `${Math.min(100, Math.abs(s.elasticity) * 50)}%` }}
                              />
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* Timeline & Endowment Row */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <StatsCard title="Perpetual Endowment" icon={<Landmark className="h-5 w-5" />} delay={0.5}>
            {endowment && (
              <>
                <StatItem label="Total Principal" value={endowment.size} trend="Stable" trendUp={true} />
                <StatItem label="Annual Draw (4.5%)" value={endowment.annual} />
                <StatItem label="Greenhouses Funded" value={endowment.greenhouses} />
              </>
            )}
          </StatsCard>

          <StatsCard title="Pilot Program Status" icon={<Sprout className="h-5 w-5" />} delay={0.55}>
            {pilot && (
              <>
                <StatItem label="Students Served" value={pilot.students.toLocaleString()} trend="+12%" trendUp={true} />
                <StatItem label="Schools Active" value={pilot.schools} />
                <StatItem label="Total Sq Ft" value={`${(pilot.sqft / 1000).toFixed(1)}k`} />
                <Badge variant="outline" className="bg-primary/10 text-primary border-primary/20 mt-2">
                  <Activity className="w-3 h-3 mr-1.5" />Status: {pilot.status}
                </Badge>
              </>
            )}
          </StatsCard>

          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.6 }} className="h-full">
            {timeline && <Timeline events={timeline} />}
          </motion.div>
        </div>

        {/* Footer */}
        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.7 }} className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-12 border-t border-border/40 pt-8">
          <div className="flex gap-4 items-start p-4 rounded-xl hover:bg-white/40 dark:hover:bg-white/5 transition-colors">
            <div className="bg-blue-100 dark:bg-blue-900/30 text-blue-600 p-2 rounded-lg">
              <Users className="h-5 w-5" />
            </div>
            <div>
              <h3 className="font-semibold text-foreground">Democratic Governance</h3>
              <p className="text-sm text-muted-foreground mt-1">Tri-cameral board with student, educator, and community representation.</p>
            </div>
          </div>
          <div className="flex gap-4 items-start p-4 rounded-xl hover:bg-white/40 dark:hover:bg-white/5 transition-colors">
            <div className="bg-green-100 dark:bg-green-900/30 text-green-600 p-2 rounded-lg">
              <Leaf className="h-5 w-5" />
            </div>
            <div>
              <h3 className="font-semibold text-foreground">Planetary Boundaries</h3>
              <p className="text-sm text-muted-foreground mt-1">ESG-only investments with fossil fuel divestment mandate.</p>
            </div>
          </div>
          <div className="flex gap-4 items-start p-4 rounded-xl hover:bg-white/40 dark:hover:bg-white/5 transition-colors">
            <div className="bg-purple-100 dark:bg-purple-900/30 text-purple-600 p-2 rounded-lg">
              <Vote className="h-5 w-5" />
            </div>
            <div>
              <h3 className="font-semibold text-foreground">2026 Ballot Initiative</h3>
              <p className="text-sm text-muted-foreground mt-1">One Vote, Forever Fed — Constitutional amendment for perpetual school food funding.</p>
            </div>
          </div>
        </motion.div>

        {/* Social Sharing - Share and Spread the Word */}
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.75 }} className="mb-8">
          <SocialSharing />
        </motion.div>

        {/* Engagement Section */}
        <EngagementFooter />

        {/* License & Attribution Footer */}
        <motion.footer 
          initial={{ opacity: 0 }} 
          animate={{ opacity: 1 }} 
          transition={{ delay: 0.8 }} 
          className="mt-8 pt-6 border-t border-border/30 text-center text-sm text-muted-foreground print:mt-4"
          data-testid="footer-license"
        >
          <div className="flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-4 mb-2">
            <span className="font-medium text-foreground">Gaia Commons Council</span>
            <span className="hidden sm:inline text-border">|</span>
            <span>Planetary governance framework for regenerative school lunches</span>
          </div>
          <p className="text-xs text-muted-foreground/70">
            Created by Braden Chance. Licensed under Gaia Commons License v1.0
          </p>
          <p className="text-xs text-muted-foreground/50 mt-1">
            Data sources: NASA GISS, NOAA, IPCC AR6, IEA World Energy Outlook, World Bank, FAO
          </p>
        </motion.footer>
      </div>
      
      {/* Quick Navigation Menu */}
      <QuickNav />
    </div>
  );
}


================================================================================
3. FRONTEND - client/src/pages/BallotPresentation.tsx
================================================================================

import { useState } from "react";
import { Link } from "wouter";
import { motion, AnimatePresence } from "framer-motion";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import {
  ChevronLeft,
  ChevronRight,
  Home,
  Sprout,
  Users,
  Building2,
  Globe,
  DollarSign,
  GraduationCap,
  Leaf,
  Heart,
  TrendingUp,
  Shield,
  MapPin,
  Award,
  Vote,
  TreePine,
  Droplets,
  Sun,
  Factory,
  Briefcase,
  Scale,
  CircleDollarSign,
  Apple,
  Cherry,
  Grape,
  Banana,
  Citrus,
  TreeDeciduous,
  Flower,
  X,
  Check,
  FlaskConical,
} from "lucide-react";

interface SlideData {
  id: number;
  title: string;
  subtitle?: string;
  content: React.ReactNode;
  bgGradient: string;
  icon: React.ReactNode;
}

export default function BallotPresentation() {
  const [currentSlide, setCurrentSlide] = useState(0);

  const slides: SlideData[] = [
    {
      id: 1,
      title: "One Vote, Forever Fed",
      subtitle: "Minnesota 2026 Ballot Initiative",
      bgGradient: "from-emerald-600 via-emerald-500 to-teal-500",
      icon: <Vote className="h-24 w-24" />,
      content: (
        <div className="flex flex-col items-center gap-8">
          <div className="text-center">
            <div className="text-8xl font-black mb-4 drop-shadow-2xl">2026</div>
            <p className="text-2xl opacity-90 max-w-2xl mx-auto">
              A bold initiative to feed every Minnesota student with fresh, local produce 
              grown right at their schools - forever.
            </p>
          </div>
          <div className="flex gap-6 mt-8">
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6 text-center">
              <div className="text-4xl font-bold">712,500</div>
              <div className="text-sm opacity-80">Students Served</div>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6 text-center">
              <div className="text-4xl font-bold">$225M</div>
              <div className="text-sm opacity-80">Endowment Draw/Year</div>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6 text-center">
              <div className="text-4xl font-bold">Forever</div>
              <div className="text-sm opacity-80">Perpetual Funding</div>
            </div>
          </div>
        </div>
      ),
    },
    {
      id: 2,
      title: "The Problem",
      subtitle: "Food Insecurity in Minnesota Schools",
      bgGradient: "from-red-600 via-orange-500 to-amber-500",
      icon: <Heart className="h-24 w-24" />,
      content: (
        <div className="grid grid-cols-2 gap-8">
          <div className="space-y-6">
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6">
              <div className="text-5xl font-bold mb-2">1 in 6</div>
              <p className="text-lg">Minnesota children face food insecurity</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6">
              <div className="text-5xl font-bold mb-2">1,500+</div>
              <p className="text-lg">Average miles food travels to schools</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6">
              <div className="text-5xl font-bold mb-2">$200M+</div>
              <p className="text-lg">Spent annually on out-of-state produce</p>
            </div>
          </div>
          <div className="flex items-center justify-center">
            <div className="relative">
              <div className="w-72 h-72 rounded-full bg-white/10 flex items-center justify-center">
                <div className="text-center">
                  <div className="text-7xl font-black">87%</div>
                  <p className="text-lg mt-2">of school produce<br/>comes from outside MN</p>
                </div>
              </div>
              <div className="absolute -top-4 -right-4 bg-red-500 rounded-full p-4 animate-pulse">
                <Factory className="h-8 w-8" />
              </div>
            </div>
          </div>
        </div>
      ),
    },
    {
      id: 3,
      title: "Our Solution",
      subtitle: "School Greenhouses Funded Forever",
      bgGradient: "from-emerald-600 via-green-500 to-lime-500",
      icon: <Sprout className="h-24 w-24" />,
      content: (
        <div className="flex flex-col items-center gap-8">
          <div className="grid grid-cols-3 gap-6 w-full max-w-3xl">
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6 text-center transform hover:scale-105 transition-transform">
              <Sprout className="h-12 w-12 mx-auto mb-3" />
              <div className="text-2xl font-bold">Greenhouses</div>
              <p className="text-sm opacity-80 mt-2">Year-round produce & citrus</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6 text-center transform hover:scale-105 transition-transform">
              <TreeDeciduous className="h-12 w-12 mx-auto mb-3" />
              <div className="text-2xl font-bold">Orchards</div>
              <p className="text-sm opacity-80 mt-2">Outdoor fruit & nut trees</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6 text-center transform hover:scale-105 transition-transform">
              <DollarSign className="h-12 w-12 mx-auto mb-3" />
              <div className="text-2xl font-bold">Endowment</div>
              <p className="text-sm opacity-80 mt-2">Perpetual funding</p>
            </div>
          </div>
          <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 max-w-3xl text-center">
            <p className="text-xl leading-relaxed">
              Build greenhouses at all 330 Minnesota school districts, complete with year-round 
              production of <span className="font-bold text-lime-300">vegetables, berries, fruits, herbs</span>, 
              and even <span className="font-bold text-yellow-300">exotic citrus trees</span> - all funded 
              by a perpetual endowment that never runs out.
            </p>
          </div>
        </div>
      ),
    },
    {
      id: 4,
      title: "What We'll Grow",
      subtitle: "100+ Varieties of Fresh Produce",
      bgGradient: "from-purple-600 via-pink-500 to-rose-500",
      icon: <Apple className="h-24 w-24" />,
      content: (
        <div className="grid grid-cols-4 gap-4">
          <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-5 space-y-3">
            <div className="flex items-center gap-2">
              <Leaf className="h-8 w-8 text-green-300" />
              <h3 className="font-bold text-lg">Salad Greens</h3>
            </div>
            <ul className="text-sm space-y-1 opacity-90">
              <li>Butterhead Lettuce</li>
              <li>Baby Spinach</li>
              <li>Tuscan Kale</li>
              <li>Wild Arugula</li>
              <li>Microgreen Mix</li>
              <li>Rainbow Swiss Chard</li>
              <li>Baby Bok Choy</li>
              <li>Mizuna</li>
            </ul>
          </div>
          <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-5 space-y-3">
            <div className="flex items-center gap-2">
              <Apple className="h-8 w-8 text-red-300" />
              <h3 className="font-bold text-lg">Vegetables</h3>
            </div>
            <ul className="text-sm space-y-1 opacity-90">
              <li>Heirloom Tomatoes</li>
              <li>English Cucumbers</li>
              <li>Sweet Bell Peppers</li>
              <li>Rainbow Carrots</li>
              <li>Zucchini</li>
              <li>Japanese Eggplant</li>
              <li>Sugar Snap Peas</li>
              <li>Purple Kohlrabi</li>
            </ul>
          </div>
          <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-5 space-y-3">
            <div className="flex items-center gap-2">
              <Cherry className="h-8 w-8 text-pink-300" />
              <h3 className="font-bold text-lg">Berries</h3>
            </div>
            <ul className="text-sm space-y-1 opacity-90">
              <li>Everbearing Strawberries</li>
              <li>Highbush Blueberries</li>
              <li>Red Raspberries</li>
              <li>Thornless Blackberries</li>
              <li>Red & Black Currants</li>
              <li>Goji Berries</li>
              <li>Ground Cherries</li>
              <li>Honeyberries</li>
            </ul>
          </div>
          <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-5 space-y-3">
            <div className="flex items-center gap-2">
              <Citrus className="h-8 w-8 text-yellow-300" />
              <h3 className="font-bold text-lg">Citrus & Specialty</h3>
            </div>
            <ul className="text-sm space-y-1 opacity-90">
              <li>Meyer Lemons</li>
              <li>Key Limes</li>
              <li>Kumquats</li>
              <li>Dwarf Bananas</li>
              <li>Shiitake Mushrooms</li>
              <li>Lion's Mane</li>
              <li>Microgreens</li>
              <li>Edible Flowers</li>
            </ul>
          </div>
        </div>
      ),
    },
    {
      id: 6,
      title: "Outdoor Orchards",
      subtitle: "Traditional Fruit Trees for Each School",
      bgGradient: "from-green-600 via-emerald-500 to-teal-400",
      icon: <TreePine className="h-24 w-24" />,
      content: (
        <div className="flex flex-col items-center gap-8">
          <p className="text-xl text-center max-w-3xl opacity-90">
            Every school can have their own outdoor orchard with cold-hardy fruit and nut trees 
            native to Minnesota's climate.
          </p>
          <div className="grid grid-cols-3 gap-6 w-full max-w-4xl">
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6">
              <h3 className="font-bold text-xl mb-4 flex items-center gap-2">
                <Apple className="h-6 w-6" /> Fruit Trees
              </h3>
              <ul className="space-y-2 text-sm">
                <li className="flex items-center gap-2"><Apple className="h-4 w-4 text-red-300" /> Apple Orchards</li>
                <li className="flex items-center gap-2"><Apple className="h-4 w-4 text-green-300" /> Pear Trees</li>
                <li className="flex items-center gap-2"><Cherry className="h-4 w-4 text-red-400" /> Cherry Trees</li>
                <li className="flex items-center gap-2"><Apple className="h-4 w-4 text-orange-300" /> Peach Trees</li>
                <li className="flex items-center gap-2"><Apple className="h-4 w-4 text-orange-400" /> Apricot Trees</li>
                <li className="flex items-center gap-2"><Apple className="h-4 w-4 text-purple-400" /> Plum Trees</li>
              </ul>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6">
              <h3 className="font-bold text-xl mb-4 flex items-center gap-2">
                <TreeDeciduous className="h-6 w-6" /> Nut Trees
              </h3>
              <ul className="space-y-2 text-sm">
                <li className="flex items-center gap-2"><TreeDeciduous className="h-4 w-4 text-amber-400" /> Hazelnut Groves</li>
                <li className="flex items-center gap-2"><TreeDeciduous className="h-4 w-4 text-amber-500" /> Walnut Groves</li>
                <li className="flex items-center gap-2"><TreeDeciduous className="h-4 w-4 text-amber-600" /> Chestnut Groves</li>
              </ul>
              <p className="text-xs mt-4 opacity-70">Heart-healthy fats & protein</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6">
              <h3 className="font-bold text-xl mb-4 flex items-center gap-2">
                <Grape className="h-6 w-6" /> Berry Bushes
              </h3>
              <ul className="space-y-2 text-sm">
                <li className="flex items-center gap-2"><Grape className="h-4 w-4 text-purple-400" /> Elderberry Bushes</li>
                <li className="flex items-center gap-2"><Grape className="h-4 w-4 text-indigo-400" /> Aronia Berries</li>
                <li className="flex items-center gap-2"><Cherry className="h-4 w-4 text-blue-400" /> Serviceberries</li>
              </ul>
              <p className="text-xs mt-4 opacity-70">Highest antioxidants found in nature</p>
            </div>
          </div>
          <div className="bg-black/20 backdrop-blur-lg rounded-2xl p-6 flex items-center gap-4 max-w-3xl">
            <GraduationCap className="h-12 w-12 text-lime-300 flex-shrink-0" />
            <p className="text-lg">Students learn agriculture, ecology, and sustainability while tending their school orchard</p>
          </div>
        </div>
      ),
    },
    {
      id: 7,
      title: "The Endowment Model",
      subtitle: "Funded Forever, Never Depleted",
      bgGradient: "from-blue-600 via-indigo-500 to-purple-500",
      icon: <CircleDollarSign className="h-24 w-24" />,
      content: (
        <div className="flex flex-col items-center gap-8">
          <div className="grid grid-cols-3 gap-6 w-full max-w-4xl">
            <div className="bg-white/20 backdrop-blur-lg rounded-3xl p-8 text-center">
              <div className="text-5xl font-black mb-2">$5B</div>
              <p className="text-lg">Initial Endowment</p>
              <p className="text-sm opacity-70 mt-2">Principal never touched</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-3xl p-8 text-center">
              <div className="text-5xl font-black mb-2">4.5%</div>
              <p className="text-lg">Annual Distribution</p>
              <p className="text-sm opacity-70 mt-2">Conservative draw rate</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-3xl p-8 text-center">
              <div className="text-5xl font-black mb-2">$225M</div>
              <p className="text-lg">Annual Draw</p>
              <p className="text-sm opacity-70 mt-2">Forever, inflation-adjusted</p>
            </div>
          </div>
          <div className="bg-gradient-to-r from-green-500/30 to-emerald-500/30 backdrop-blur-lg rounded-3xl p-8 max-w-3xl">
            <div className="flex items-center gap-6">
              <div className="flex-shrink-0">
                <div className="w-24 h-24 rounded-full bg-white/20 flex items-center justify-center">
                  <TrendingUp className="h-12 w-12" />
                </div>
              </div>
              <div>
                <h3 className="text-2xl font-bold mb-2">How It Works</h3>
                <p className="opacity-90">
                  Like university endowments, the principal grows tax-free while annual returns 
                  fund operations. After 50 years: <span className="font-bold text-lime-300">$11.25 billion in total draws</span> while 
                  principal remains at $5B+.
                </p>
              </div>
            </div>
          </div>
        </div>
      ),
    },
    {
      id: 8,
      title: "Jobs Created",
      subtitle: "Local, Union, Permanent Employment",
      bgGradient: "from-amber-500 via-orange-500 to-red-500",
      icon: <Briefcase className="h-24 w-24" />,
      content: (
        <div className="grid grid-cols-2 gap-8">
          <div className="space-y-4">
            <h3 className="text-2xl font-bold mb-4">Construction Phase</h3>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-5">
              <div className="flex justify-between items-center">
                <span>Pilot (6 Schools)</span>
                <Badge className="bg-white/30 text-white">76 Jobs</Badge>
              </div>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-5">
              <div className="flex justify-between items-center">
                <span>Statewide (1,200 Greenhouses)</span>
                <Badge className="bg-white/30 text-white">13,900 Jobs</Badge>
              </div>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-5">
              <div className="flex justify-between items-center">
                <span>National (130K Schools)</span>
                <Badge className="bg-white/30 text-white">1.17M Jobs</Badge>
              </div>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-5">
              <div className="flex justify-between items-center">
                <span>Global (1M Schools)</span>
                <Badge className="bg-white/30 text-white">6.5M Jobs</Badge>
              </div>
            </div>
          </div>
          <div className="space-y-4">
            <h3 className="text-2xl font-bold mb-4">Permanent Operations</h3>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-5">
              <div className="text-4xl font-bold mb-2">2,400</div>
              <p>Permanent jobs in Minnesota</p>
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div className="bg-white/10 rounded-xl p-3 text-center">
                <div className="text-xl font-bold">1,440</div>
                <p className="text-xs">Greenhouse Staff</p>
              </div>
              <div className="bg-white/10 rounded-xl p-3 text-center">
                <div className="text-xl font-bold">240</div>
                <p className="text-xs">Educators</p>
              </div>
              <div className="bg-white/10 rounded-xl p-3 text-center">
                <div className="text-xl font-bold">360</div>
                <p className="text-xs">Distribution</p>
              </div>
              <div className="bg-white/10 rounded-xl p-3 text-center">
                <div className="text-xl font-bold">360</div>
                <p className="text-xs">School Staff</p>
              </div>
            </div>
            <div className="bg-green-500/30 rounded-2xl p-4 flex items-center gap-3">
              <Award className="h-8 w-8" />
              <span className="font-semibold">100% Union Labor at $32-35/hr</span>
            </div>
          </div>
        </div>
      ),
    },
    {
      id: 9,
      title: "vs. Foreign Mining",
      subtitle: "Keep Minnesota's Wealth in Minnesota",
      bgGradient: "from-slate-700 via-gray-600 to-slate-800",
      icon: <Scale className="h-24 w-24" />,
      content: (
        <div className="grid grid-cols-2 gap-8">
          <div className="bg-red-500/30 backdrop-blur-lg rounded-2xl p-6 border-2 border-red-400/50">
            <h3 className="text-2xl font-bold mb-4 flex items-center gap-2">
              <Factory className="h-8 w-8" /> Twin Metals Mining
            </h3>
            <ul className="space-y-3 text-sm">
              <li className="flex items-center gap-2"><X className="h-4 w-4 text-red-300" /> 100% foreign owned (Chile)</li>
              <li className="flex items-center gap-2"><X className="h-4 w-4 text-red-300" /> 50% profits to billionaire family</li>
              <li className="flex items-center gap-2"><X className="h-4 w-4 text-red-300" /> 0.4% gross proceeds tax</li>
              <li className="flex items-center gap-2"><X className="h-4 w-4 text-red-300" /> ~1,500 temporary jobs</li>
              <li className="flex items-center gap-2"><X className="h-4 w-4 text-red-300" /> 20-25 year mine lifespan</li>
              <li className="flex items-center gap-2"><X className="h-4 w-4 text-red-300" /> Ore shipped out of state</li>
              <li className="flex items-center gap-2"><X className="h-4 w-4 text-red-300" /> MN pays cleanup costs</li>
              <li className="flex items-center gap-2"><X className="h-4 w-4 text-red-300" /> Threatens Boundary Waters</li>
            </ul>
          </div>
          <div className="bg-green-500/30 backdrop-blur-lg rounded-2xl p-6 border-2 border-green-400/50">
            <h3 className="text-2xl font-bold mb-4 flex items-center gap-2">
              <Sprout className="h-8 w-8" /> Gaia Commons
            </h3>
            <ul className="space-y-3 text-sm">
              <li className="flex items-center gap-2"><Check className="h-4 w-4 text-green-300" /> 100% Minnesota owned</li>
              <li className="flex items-center gap-2"><Check className="h-4 w-4 text-green-300" /> 100% reinvested locally</li>
              <li className="flex items-center gap-2"><Check className="h-4 w-4 text-green-300" /> Revenue stays in communities</li>
              <li className="flex items-center gap-2"><Check className="h-4 w-4 text-green-300" /> 2,400 permanent jobs</li>
              <li className="flex items-center gap-2"><Check className="h-4 w-4 text-green-300" /> Forever - perpetual model</li>
              <li className="flex items-center gap-2"><Check className="h-4 w-4 text-green-300" /> Food stays in Minnesota</li>
              <li className="flex items-center gap-2"><Check className="h-4 w-4 text-green-300" /> Self-sustaining operations</li>
              <li className="flex items-center gap-2"><Check className="h-4 w-4 text-green-300" /> Protects natural resources</li>
            </ul>
          </div>
        </div>
      ),
    },
    {
      id: 10,
      title: "330 School Districts",
      subtitle: "Serving All of Minnesota",
      bgGradient: "from-blue-600 via-sky-500 to-cyan-400",
      icon: <MapPin className="h-24 w-24" />,
      content: (
        <div className="flex flex-col items-center gap-6">
          <div className="grid grid-cols-4 gap-4 w-full">
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-4 text-center">
              <div className="text-3xl font-bold">712.5K</div>
              <p className="text-sm">Students</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-4 text-center">
              <div className="text-3xl font-bold">330</div>
              <p className="text-sm">Districts</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-4 text-center">
              <div className="text-3xl font-bold">1,200</div>
              <p className="text-sm">Greenhouses</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-4 text-center">
              <div className="text-3xl font-bold">7,500</div>
              <p className="text-sm">Avg Sqft/Greenhouse</p>
            </div>
          </div>
          <div className="grid grid-cols-3 gap-4 w-full text-sm">
            <div className="bg-white/10 rounded-xl p-4">
              <h4 className="font-bold mb-2">Twin Cities Metro</h4>
              <p className="text-xs opacity-80">Minneapolis, St. Paul, Bloomington, Eden Prairie, Anoka-Hennepin, Osseo, Rosemount-AV-Eagan...</p>
            </div>
            <div className="bg-white/10 rounded-xl p-4">
              <h4 className="font-bold mb-2">Greater Minnesota</h4>
              <p className="text-xs opacity-80">Rochester, Duluth, St. Cloud, Mankato, Moorhead, Bemidji, Brainerd, Winona...</p>
            </div>
            <div className="bg-white/10 rounded-xl p-4">
              <h4 className="font-bold mb-2">Tribal Communities</h4>
              <p className="text-xs opacity-80">Cass Lake-Bena (Leech Lake), Red Lake Nation, Nay Ah Shing (Mille Lacs)</p>
            </div>
          </div>
          <div className="bg-gradient-to-r from-emerald-500/30 to-green-500/30 rounded-2xl p-6 flex items-center gap-4">
            <Heart className="h-10 w-10 text-red-300" />
            <p className="text-lg">Priority: <span className="font-bold">Tribal food sovereignty</span> and high-need communities served first</p>
          </div>
        </div>
      ),
    },
    {
      id: 11,
      title: "Land Conservation",
      subtitle: "10% of Revenue Protects Natural Resources",
      bgGradient: "from-teal-600 via-cyan-500 to-sky-400",
      icon: <TreePine className="h-24 w-24" />,
      content: (
        <div className="flex flex-col items-center gap-8">
          <div className="grid grid-cols-3 gap-6 w-full max-w-4xl">
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6 text-center">
              <Droplets className="h-12 w-12 mx-auto mb-3 text-blue-300" />
              <div className="text-3xl font-bold">$6.3M</div>
              <p className="text-sm">Annual Conservation Fund</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6 text-center">
              <TreePine className="h-12 w-12 mx-auto mb-3 text-green-300" />
              <div className="text-3xl font-bold">$315M</div>
              <p className="text-sm">Total Over 50 Years</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6 text-center">
              <MapPin className="h-12 w-12 mx-auto mb-3 text-amber-300" />
              <div className="text-3xl font-bold">100K+</div>
              <p className="text-sm">Acres Protected Forever</p>
            </div>
          </div>
          <div className="grid grid-cols-4 gap-4 w-full max-w-4xl">
            <div className="bg-green-500/30 rounded-xl p-4 text-center">
              <div className="text-2xl font-bold">35%</div>
              <p className="text-xs">Forests</p>
            </div>
            <div className="bg-amber-500/30 rounded-xl p-4 text-center">
              <div className="text-2xl font-bold">30%</div>
              <p className="text-xs">Farmland</p>
            </div>
            <div className="bg-blue-500/30 rounded-xl p-4 text-center">
              <div className="text-2xl font-bold">25%</div>
              <p className="text-xs">Waterways</p>
            </div>
            <div className="bg-purple-500/30 rounded-xl p-4 text-center">
              <div className="text-2xl font-bold">10%</div>
              <p className="text-xs">Tribal Lands</p>
            </div>
          </div>
          <div className="bg-black/20 backdrop-blur-lg rounded-2xl p-6 flex items-center gap-4">
            <Shield className="h-10 w-10 text-green-300" />
            <p className="text-lg">All lands held in <span className="font-bold">permanent land trust</span> - never to be sold or developed</p>
          </div>
        </div>
      ),
    },
    {
      id: 12,
      title: "Environmental Impact",
      subtitle: "Healing Minnesota's Land & Water",
      bgGradient: "from-green-600 via-emerald-500 to-lime-400",
      icon: <Leaf className="h-24 w-24" />,
      content: (
        <div className="grid grid-cols-2 gap-8">
          <div className="space-y-4">
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-5">
              <div className="flex items-center gap-3 mb-2">
                <Droplets className="h-8 w-8 text-blue-300" />
                <span className="font-bold text-lg">Water Saved</span>
              </div>
              <div className="text-3xl font-bold">9 Billion Gallons/Year</div>
              <p className="text-sm opacity-70">90% less water than traditional farming</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-5">
              <div className="flex items-center gap-3 mb-2">
                <Globe className="h-8 w-8 text-green-300" />
                <span className="font-bold text-lg">Carbon Sequestered</span>
              </div>
              <div className="text-3xl font-bold">53,370 Tons/Year</div>
              <p className="text-sm opacity-70">Net carbon negative operations</p>
            </div>
          </div>
          <div className="space-y-4">
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-5">
              <div className="flex items-center gap-3 mb-2">
                <Factory className="h-8 w-8 text-amber-300" />
                <span className="font-bold text-lg">Food Miles Eliminated</span>
              </div>
              <div className="text-3xl font-bold">100+ Million Miles/Year</div>
              <p className="text-sm opacity-70">Local food = zero transport emissions</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-5">
              <div className="flex items-center gap-3 mb-2">
                <Shield className="h-8 w-8 text-red-300" />
                <span className="font-bold text-lg">Pesticides Used</span>
              </div>
              <div className="text-3xl font-bold">ZERO</div>
              <p className="text-sm opacity-70">100% organic hydroponic systems</p>
            </div>
          </div>
        </div>
      ),
    },
    {
      id: 13,
      title: "Educational Benefits",
      subtitle: "Learning by Growing",
      bgGradient: "from-indigo-600 via-violet-500 to-purple-400",
      icon: <GraduationCap className="h-24 w-24" />,
      content: (
        <div className="flex flex-col items-center gap-8">
          <div className="grid grid-cols-3 gap-6 w-full max-w-4xl">
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6 text-center">
              <FlaskConical className="h-12 w-12 mx-auto mb-3 text-cyan-300" />
              <h3 className="font-bold text-lg">STEM Integration</h3>
              <p className="text-sm opacity-80 mt-2">Biology, chemistry, physics, math - all in one living lab</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6 text-center">
              <Sprout className="h-12 w-12 mx-auto mb-3 text-green-300" />
              <h3 className="font-bold text-lg">Agriculture</h3>
              <p className="text-sm opacity-80 mt-2">Modern farming techniques and food systems</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6 text-center">
              <Briefcase className="h-12 w-12 mx-auto mb-3 text-amber-300" />
              <h3 className="font-bold text-lg">Career Pathways</h3>
              <p className="text-sm opacity-80 mt-2">Real work experience and job skills</p>
            </div>
          </div>
          <div className="grid grid-cols-4 gap-4 w-full max-w-4xl">
            <div className="bg-white/10 rounded-xl p-4 text-center">
              <div className="text-2xl font-bold">4</div>
              <p className="text-xs">HS Interns/School</p>
            </div>
            <div className="bg-white/10 rounded-xl p-4 text-center">
              <div className="text-2xl font-bold">6</div>
              <p className="text-xs">MS Helpers/School</p>
            </div>
            <div className="bg-white/10 rounded-xl p-4 text-center">
              <div className="text-2xl font-bold">8</div>
              <p className="text-xs">Elementary Explorers</p>
            </div>
            <div className="bg-white/10 rounded-xl p-4 text-center">
              <div className="text-2xl font-bold">7</div>
              <p className="text-xs">Community Volunteers</p>
            </div>
          </div>
          <div className="bg-gradient-to-r from-purple-500/30 to-pink-500/30 rounded-2xl p-6 flex items-center gap-4 max-w-3xl">
            <Users className="h-10 w-10" />
            <p className="text-lg">Every student participates - from <span className="font-bold">kindergarten seed planting</span> to <span className="font-bold">high school internships</span></p>
          </div>
        </div>
      ),
    },
    {
      id: 14,
      title: "Scaling Beyond Minnesota",
      subtitle: "A Model for America & the World",
      bgGradient: "from-blue-700 via-blue-500 to-cyan-400",
      icon: <Globe className="h-24 w-24" />,
      content: (
        <div className="flex flex-col items-center gap-8">
          <div className="grid grid-cols-4 gap-4 w-full">
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-5 text-center transform hover:scale-105 transition-transform">
              <div className="text-lg font-bold text-amber-300">PILOT</div>
              <div className="text-3xl font-bold my-2">6</div>
              <p className="text-sm">Schools</p>
              <p className="text-xs opacity-70 mt-2">$7.65M Investment</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-5 text-center transform hover:scale-105 transition-transform">
              <div className="text-lg font-bold text-green-300">STATEWIDE</div>
              <div className="text-3xl font-bold my-2">1,200</div>
              <p className="text-sm">Greenhouses</p>
              <p className="text-xs opacity-70 mt-2">$1.39B Investment</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-5 text-center transform hover:scale-105 transition-transform">
              <div className="text-lg font-bold text-blue-300">NATIONAL</div>
              <div className="text-3xl font-bold my-2">130K</div>
              <p className="text-sm">Schools</p>
              <p className="text-xs opacity-70 mt-2">$117B Investment</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-5 text-center transform hover:scale-105 transition-transform">
              <div className="text-lg font-bold text-purple-300">GLOBAL</div>
              <div className="text-3xl font-bold my-2">1M</div>
              <p className="text-sm">Schools</p>
              <p className="text-xs opacity-70 mt-2">$650B Investment</p>
            </div>
          </div>
          <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 max-w-3xl">
            <h3 className="text-2xl font-bold mb-4 text-center">Global Impact Potential</h3>
            <div className="grid grid-cols-3 gap-6 text-center">
              <div>
                <div className="text-3xl font-bold text-green-300">350M</div>
                <p className="text-sm">Children Fed</p>
              </div>
              <div>
                <div className="text-3xl font-bold text-blue-300">6.5M</div>
                <p className="text-sm">Jobs Created</p>
              </div>
              <div>
                <div className="text-3xl font-bold text-amber-300">$650B</div>
                <p className="text-sm">Global Investment</p>
              </div>
            </div>
          </div>
        </div>
      ),
    },
    {
      id: 15,
      title: "Vote YES in 2026",
      subtitle: "One Vote to Feed Minnesota Forever",
      bgGradient: "from-emerald-600 via-green-500 to-lime-400",
      icon: <Vote className="h-24 w-24" />,
      content: (
        <div className="flex flex-col items-center gap-8">
          <div className="text-center max-w-3xl">
            <p className="text-2xl leading-relaxed mb-8">
              One vote creates greenhouses at every school. One vote feeds every student fresh, 
              local produce. One vote keeps Minnesota's wealth in Minnesota - <span className="font-bold text-yellow-300">forever</span>.
            </p>
          </div>
          <div className="grid grid-cols-3 gap-6 w-full max-w-4xl">
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6 text-center">
              <Sprout className="h-12 w-12 mx-auto mb-3" />
              <p className="font-bold">330 Districts</p>
              <p className="text-sm opacity-80">Every corner of MN</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6 text-center">
              <Users className="h-12 w-12 mx-auto mb-3" />
              <p className="font-bold">712,500 Students</p>
              <p className="text-sm opacity-80">Fed fresh daily</p>
            </div>
            <div className="bg-white/20 backdrop-blur-lg rounded-2xl p-6 text-center">
              <Heart className="h-12 w-12 mx-auto mb-3" />
              <p className="font-bold">Forever</p>
              <p className="text-sm opacity-80">Perpetual endowment</p>
            </div>
          </div>
          <div className="mt-8">
            <div className="bg-white text-emerald-800 rounded-full px-12 py-6 text-3xl font-black shadow-2xl transform hover:scale-105 transition-transform cursor-pointer">
              VOTE YES on Question 1
            </div>
          </div>
          <p className="text-lg opacity-80 mt-4">
            November 2026 • gaiacommons.org
          </p>
        </div>
      ),
    },
  ];

  const nextSlide = () => {
    if (currentSlide < slides.length - 1) {
      setCurrentSlide(currentSlide + 1);
    }
  };

  const prevSlide = () => {
    if (currentSlide > 0) {
      setCurrentSlide(currentSlide - 1);
    }
  };

  const goToSlide = (index: number) => {
    setCurrentSlide(index);
  };

  const currentSlideData = slides[currentSlide];

  return (
    <div className={`min-h-screen bg-gradient-to-br ${currentSlideData.bgGradient} text-white overflow-hidden`}>
      <div className="fixed top-0 left-0 right-0 z-50 bg-black/20 backdrop-blur-sm">
        <div className="container mx-auto px-4 py-3 flex items-center justify-between">
          <Link href="/">
            <Button variant="ghost" size="sm" className="text-white hover:bg-white/20" data-testid="button-back-dashboard">
              <Home className="h-4 w-4 mr-2" />
              Dashboard
            </Button>
          </Link>
          <div className="flex items-center gap-2">
            <span className="text-sm opacity-80">Slide {currentSlide + 1} of {slides.length}</span>
            <Progress value={((currentSlide + 1) / slides.length) * 100} className="w-32 h-2 bg-white/20" />
          </div>
          <div className="flex gap-2">
            <Button 
              variant="ghost" 
              size="sm" 
              onClick={prevSlide} 
              disabled={currentSlide === 0}
              className="text-white hover:bg-white/20 disabled:opacity-30"
              data-testid="button-prev-slide"
            >
              <ChevronLeft className="h-5 w-5" />
            </Button>
            <Button 
              variant="ghost" 
              size="sm" 
              onClick={nextSlide} 
              disabled={currentSlide === slides.length - 1}
              className="text-white hover:bg-white/20 disabled:opacity-30"
              data-testid="button-next-slide"
            >
              <ChevronRight className="h-5 w-5" />
            </Button>
          </div>
        </div>
      </div>

      <AnimatePresence mode="wait">
        <motion.div
          key={currentSlide}
          initial={{ opacity: 0, x: 100 }}
          animate={{ opacity: 1, x: 0 }}
          exit={{ opacity: 0, x: -100 }}
          transition={{ duration: 0.4, ease: "easeInOut" }}
          className="min-h-screen pt-20 pb-24 px-8 flex flex-col"
        >
          <div className="flex-1 flex flex-col items-center justify-center max-w-6xl mx-auto w-full">
            <div className="text-center mb-8">
              <div className="mb-4 opacity-80">{currentSlideData.icon}</div>
              <h1 className="text-5xl font-black mb-2 drop-shadow-lg">{currentSlideData.title}</h1>
              {currentSlideData.subtitle && (
                <p className="text-2xl opacity-90">{currentSlideData.subtitle}</p>
              )}
            </div>
            <div className="w-full">
              {currentSlideData.content}
            </div>
          </div>
        </motion.div>
      </AnimatePresence>

      <div className="fixed bottom-0 left-0 right-0 bg-black/20 backdrop-blur-sm py-3">
        <div className="container mx-auto px-4">
          <div className="flex justify-center gap-2 flex-wrap">
            {slides.map((_, index) => (
              <button
                key={index}
                onClick={() => goToSlide(index)}
                className={`w-3 h-3 rounded-full transition-all ${
                  index === currentSlide 
                    ? 'bg-white scale-125' 
                    : 'bg-white/40 hover:bg-white/60'
                }`}
                data-testid={`slide-dot-${index}`}
              />
            ))}
          </div>
        </div>
      </div>

      <style>{`
        @keyframes float {
          0%, 100% { transform: translateY(0px); }
          50% { transform: translateY(-10px); }
        }
        .animate-float {
          animation: float 3s ease-in-out infinite;
        }
      `}</style>
    </div>
  );
}


================================================================================
4. FRONTEND - client/src/pages/ClusterBuilder.tsx
================================================================================

import { useState, useMemo } from "react";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Checkbox } from "@/components/ui/checkbox";
import { Progress } from "@/components/ui/progress";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { 
  ArrowLeft, 
  ArrowRight, 
  School, 
  Users, 
  Leaf, 
  Building2, 
  DollarSign,
  Briefcase,
  Salad,
  CheckCircle2,
  Loader2,
  MapPin,
  Sprout,
  Calculator,
  FileText,
  Home,
  Ruler,
  Box,
  Lightbulb,
  Droplets,
  Thermometer,
  Layers,
  GraduationCap,
  Wrench,
  Heart,
  AlertCircle,
  Building,
  Lock,
  Unlock
} from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";
import { Link } from "wouter";

interface SchoolGreenhouse {
  id: string;
  name: string;
  enrollment: number;
  gradeLevel: "elementary" | "middle" | "high" | "k8" | "k12";
  schoolType: "public" | "private" | "charter";
  isCustom?: boolean;
  greenhouseLength: number;
  greenhouseWidth: number;
  greenhouseSqft: number;
}

interface ProduceItem {
  id: string;
  name: string;
  category: "greens" | "vegetables" | "berries" | "fruits" | "exotictrees" | "orchard" | "herbs" | "specialty";
  yieldPerSqft: number;
  growingDays: number;
  nutritionValue: string;
  selected: boolean;
  allocation: number;
}

interface EquipmentItem {
  id: string;
  name: string;
  category: "growing" | "lighting" | "irrigation" | "climate" | "infrastructure";
  unitCost: number;
  unitsPerSqft: number;
  description: string;
}

interface StaffPosition {
  role: string;
  type: "employee" | "student" | "volunteer";
  countPerSchool: number;
  hoursPerWeek: number;
  hourlyWage: number;
  description: string;
}

const PRODUCE_OPTIONS: ProduceItem[] = [
  // SALAD GREENS
  { id: "lettuce", name: "Butterhead Lettuce", category: "greens", yieldPerSqft: 4.5, growingDays: 45, nutritionValue: "Vitamins A, K", selected: false, allocation: 0 },
  { id: "romaine", name: "Romaine Lettuce", category: "greens", yieldPerSqft: 4.2, growingDays: 50, nutritionValue: "Vitamins A, K, Folate", selected: false, allocation: 0 },
  { id: "spinach", name: "Baby Spinach", category: "greens", yieldPerSqft: 3.8, growingDays: 40, nutritionValue: "Iron, Vitamins A, C", selected: false, allocation: 0 },
  { id: "kale", name: "Tuscan Kale", category: "greens", yieldPerSqft: 3.2, growingDays: 55, nutritionValue: "Vitamins K, A, C", selected: false, allocation: 0 },
  { id: "arugula", name: "Wild Arugula", category: "greens", yieldPerSqft: 4.0, growingDays: 35, nutritionValue: "Vitamin K, Folate", selected: false, allocation: 0 },
  { id: "microgreens", name: "Microgreen Mix", category: "greens", yieldPerSqft: 6.0, growingDays: 14, nutritionValue: "40x concentrated nutrients", selected: false, allocation: 0 },
  { id: "swisschard", name: "Rainbow Swiss Chard", category: "greens", yieldPerSqft: 3.5, growingDays: 50, nutritionValue: "Vitamins K, A, C, Magnesium", selected: false, allocation: 0 },
  { id: "mizuna", name: "Mizuna", category: "greens", yieldPerSqft: 3.8, growingDays: 35, nutritionValue: "Vitamins A, C, K", selected: false, allocation: 0 },
  { id: "bokchoy", name: "Baby Bok Choy", category: "greens", yieldPerSqft: 4.0, growingDays: 45, nutritionValue: "Vitamins A, C, Calcium", selected: false, allocation: 0 },
  { id: "mustardgreens", name: "Mustard Greens", category: "greens", yieldPerSqft: 3.6, growingDays: 40, nutritionValue: "Vitamins K, A, C", selected: false, allocation: 0 },
  
  // VEGETABLES
  { id: "tomatoes", name: "Heirloom Tomatoes", category: "vegetables", yieldPerSqft: 8.0, growingDays: 80, nutritionValue: "Vitamins C, K, Lycopene", selected: false, allocation: 0 },
  { id: "cherrytomatoes", name: "Cherry Tomatoes", category: "vegetables", yieldPerSqft: 7.5, growingDays: 65, nutritionValue: "Vitamins C, K, Lycopene", selected: false, allocation: 0 },
  { id: "cucumbers", name: "English Cucumbers", category: "vegetables", yieldPerSqft: 6.5, growingDays: 55, nutritionValue: "Vitamin K, Hydration", selected: false, allocation: 0 },
  { id: "peppers", name: "Sweet Bell Peppers", category: "vegetables", yieldPerSqft: 5.0, growingDays: 75, nutritionValue: "Vitamins C, A, B6", selected: false, allocation: 0 },
  { id: "hotpeppers", name: "Hot Peppers Mix", category: "vegetables", yieldPerSqft: 4.5, growingDays: 80, nutritionValue: "Vitamins C, A, Capsaicin", selected: false, allocation: 0 },
  { id: "carrots", name: "Rainbow Carrots", category: "vegetables", yieldPerSqft: 4.2, growingDays: 70, nutritionValue: "Vitamin A, Beta-carotene", selected: false, allocation: 0 },
  { id: "beans", name: "French Green Beans", category: "vegetables", yieldPerSqft: 3.5, growingDays: 60, nutritionValue: "Fiber, Vitamins C, K", selected: false, allocation: 0 },
  { id: "squash", name: "Zucchini", category: "vegetables", yieldPerSqft: 5.5, growingDays: 50, nutritionValue: "Vitamins C, B6", selected: false, allocation: 0 },
  { id: "yellowsquash", name: "Yellow Summer Squash", category: "vegetables", yieldPerSqft: 5.2, growingDays: 50, nutritionValue: "Vitamins C, B6, Manganese", selected: false, allocation: 0 },
  { id: "eggplant", name: "Japanese Eggplant", category: "vegetables", yieldPerSqft: 4.8, growingDays: 70, nutritionValue: "Fiber, Antioxidants", selected: false, allocation: 0 },
  { id: "radishes", name: "French Breakfast Radishes", category: "vegetables", yieldPerSqft: 3.8, growingDays: 25, nutritionValue: "Vitamin C, Potassium", selected: false, allocation: 0 },
  { id: "beets", name: "Golden & Red Beets", category: "vegetables", yieldPerSqft: 3.5, growingDays: 55, nutritionValue: "Folate, Manganese, Nitrates", selected: false, allocation: 0 },
  { id: "peas", name: "Sugar Snap Peas", category: "vegetables", yieldPerSqft: 2.8, growingDays: 60, nutritionValue: "Vitamins C, K, Fiber", selected: false, allocation: 0 },
  { id: "snowpeas", name: "Snow Peas", category: "vegetables", yieldPerSqft: 2.6, growingDays: 55, nutritionValue: "Vitamins C, K", selected: false, allocation: 0 },
  { id: "broccoli", name: "Broccoli", category: "vegetables", yieldPerSqft: 3.2, growingDays: 70, nutritionValue: "Vitamins C, K, Sulforaphane", selected: false, allocation: 0 },
  { id: "cauliflower", name: "Colorful Cauliflower", category: "vegetables", yieldPerSqft: 3.0, growingDays: 75, nutritionValue: "Vitamins C, K, B6", selected: false, allocation: 0 },
  { id: "kohlrabi", name: "Purple Kohlrabi", category: "vegetables", yieldPerSqft: 3.2, growingDays: 55, nutritionValue: "Vitamins C, B6, Potassium", selected: false, allocation: 0 },
  { id: "leeks", name: "Baby Leeks", category: "vegetables", yieldPerSqft: 2.8, growingDays: 90, nutritionValue: "Vitamins K, A, Manganese", selected: false, allocation: 0 },
  { id: "scallions", name: "Green Onions", category: "vegetables", yieldPerSqft: 3.5, growingDays: 60, nutritionValue: "Vitamins K, C", selected: false, allocation: 0 },
  
  // BERRIES
  { id: "strawberries", name: "Everbearing Strawberries", category: "berries", yieldPerSqft: 2.8, growingDays: 90, nutritionValue: "Vitamin C, Antioxidants", selected: false, allocation: 0 },
  { id: "alpinestrawberries", name: "Alpine Strawberries", category: "berries", yieldPerSqft: 1.8, growingDays: 100, nutritionValue: "Vitamin C, Intense flavor", selected: false, allocation: 0 },
  { id: "blueberries", name: "Highbush Blueberries", category: "berries", yieldPerSqft: 1.5, growingDays: 120, nutritionValue: "Antioxidants, Vitamin C, K", selected: false, allocation: 0 },
  { id: "raspberries", name: "Red Raspberries", category: "berries", yieldPerSqft: 1.8, growingDays: 110, nutritionValue: "Fiber, Vitamin C, Manganese", selected: false, allocation: 0 },
  { id: "goldenraspberries", name: "Golden Raspberries", category: "berries", yieldPerSqft: 1.6, growingDays: 115, nutritionValue: "Vitamin C, Antioxidants", selected: false, allocation: 0 },
  { id: "blackberries", name: "Thornless Blackberries", category: "berries", yieldPerSqft: 2.0, growingDays: 105, nutritionValue: "Vitamins C, K, Fiber", selected: false, allocation: 0 },
  { id: "gooseberries", name: "Gooseberries", category: "berries", yieldPerSqft: 1.4, growingDays: 120, nutritionValue: "Vitamin C, Fiber", selected: false, allocation: 0 },
  { id: "currants", name: "Red & Black Currants", category: "berries", yieldPerSqft: 1.5, growingDays: 110, nutritionValue: "Vitamin C, Iron, Potassium", selected: false, allocation: 0 },
  { id: "mulberries", name: "Dwarf Mulberries", category: "berries", yieldPerSqft: 2.2, growingDays: 100, nutritionValue: "Vitamin C, Iron, Resveratrol", selected: false, allocation: 0 },
  { id: "groundcherries", name: "Ground Cherries", category: "berries", yieldPerSqft: 2.5, growingDays: 75, nutritionValue: "Vitamins A, C, Antioxidants", selected: false, allocation: 0 },
  { id: "honeyberries", name: "Honeyberries (Haskap)", category: "berries", yieldPerSqft: 1.3, growingDays: 130, nutritionValue: "Antioxidants, Vitamin C", selected: false, allocation: 0 },
  { id: "lingonberries", name: "Lingonberries", category: "berries", yieldPerSqft: 1.2, growingDays: 140, nutritionValue: "Vitamin E, Antioxidants", selected: false, allocation: 0 },
  { id: "goji", name: "Goji Berries", category: "berries", yieldPerSqft: 1.0, growingDays: 150, nutritionValue: "Vitamins A, C, Iron, Zeaxanthin", selected: false, allocation: 0 },
  
  // GREENHOUSE FRUITS
  { id: "melons", name: "Charentais Melons", category: "fruits", yieldPerSqft: 3.2, growingDays: 85, nutritionValue: "Vitamins A, C", selected: false, allocation: 0 },
  { id: "watermelon", name: "Personal Watermelons", category: "fruits", yieldPerSqft: 3.0, growingDays: 80, nutritionValue: "Vitamins A, C, Lycopene", selected: false, allocation: 0 },
  { id: "honeydew", name: "Honeydew Melons", category: "fruits", yieldPerSqft: 2.8, growingDays: 90, nutritionValue: "Vitamins C, B6, Potassium", selected: false, allocation: 0 },
  { id: "cantaloupe", name: "French Cantaloupe", category: "fruits", yieldPerSqft: 3.0, growingDays: 85, nutritionValue: "Vitamins A, C", selected: false, allocation: 0 },
  { id: "passionfruit", name: "Passion Fruit", category: "fruits", yieldPerSqft: 1.8, growingDays: 180, nutritionValue: "Vitamins A, C, Iron, Fiber", selected: false, allocation: 0 },
  { id: "figs", name: "Fresh Figs", category: "fruits", yieldPerSqft: 2.0, growingDays: 150, nutritionValue: "Fiber, Potassium, Calcium", selected: false, allocation: 0 },
  { id: "kiwi", name: "Hardy Kiwi", category: "fruits", yieldPerSqft: 1.5, growingDays: 180, nutritionValue: "Vitamins C, K, E", selected: false, allocation: 0 },
  { id: "grapes", name: "Table Grapes", category: "fruits", yieldPerSqft: 2.5, growingDays: 170, nutritionValue: "Vitamins C, K, Resveratrol", selected: false, allocation: 0 },
  
  // EXOTIC GREENHOUSE TREES
  { id: "dwarflemons", name: "Meyer Lemon Trees", category: "exotictrees", yieldPerSqft: 0.8, growingDays: 365, nutritionValue: "Vitamin C, Citric acid", selected: false, allocation: 0 },
  { id: "dwarflimes", name: "Key Lime Trees", category: "exotictrees", yieldPerSqft: 0.7, growingDays: 365, nutritionValue: "Vitamin C, Antioxidants", selected: false, allocation: 0 },
  { id: "dwarforanges", name: "Calamondin Orange Trees", category: "exotictrees", yieldPerSqft: 0.9, growingDays: 365, nutritionValue: "Vitamins C, A", selected: false, allocation: 0 },
  { id: "kumquats", name: "Nagami Kumquat Trees", category: "exotictrees", yieldPerSqft: 0.6, growingDays: 365, nutritionValue: "Vitamins C, A, Fiber", selected: false, allocation: 0 },
  { id: "dwarfbananas", name: "Dwarf Cavendish Bananas", category: "exotictrees", yieldPerSqft: 1.2, growingDays: 270, nutritionValue: "Potassium, Vitamin B6", selected: false, allocation: 0 },
  { id: "papaya", name: "Dwarf Papaya Trees", category: "exotictrees", yieldPerSqft: 1.5, growingDays: 240, nutritionValue: "Vitamins C, A, Papain enzyme", selected: false, allocation: 0 },
  { id: "avocado", name: "Dwarf Avocado Trees", category: "exotictrees", yieldPerSqft: 0.5, growingDays: 365, nutritionValue: "Healthy fats, Vitamins K, E", selected: false, allocation: 0 },
  { id: "guava", name: "Tropical Guava Trees", category: "exotictrees", yieldPerSqft: 0.8, growingDays: 300, nutritionValue: "Vitamin C, Fiber, Lycopene", selected: false, allocation: 0 },
  { id: "pomegranate", name: "Dwarf Pomegranate Trees", category: "exotictrees", yieldPerSqft: 0.6, growingDays: 365, nutritionValue: "Antioxidants, Vitamin C, K", selected: false, allocation: 0 },
  { id: "olivetrees", name: "Arbequina Olive Trees", category: "exotictrees", yieldPerSqft: 0.4, growingDays: 365, nutritionValue: "Healthy fats, Vitamin E", selected: false, allocation: 0 },
  { id: "dragonfruit", name: "Dragon Fruit Cactus", category: "exotictrees", yieldPerSqft: 0.7, growingDays: 180, nutritionValue: "Vitamin C, Fiber, Antioxidants", selected: false, allocation: 0 },
  { id: "cherimoya", name: "Cherimoya Trees", category: "exotictrees", yieldPerSqft: 0.5, growingDays: 365, nutritionValue: "Vitamins C, B6, Fiber", selected: false, allocation: 0 },
  
  // ORCHARD FRUIT TREES (Outdoor)
  { id: "appletrees", name: "Apple Orchard (Outdoor)", category: "orchard", yieldPerSqft: 0.3, growingDays: 180, nutritionValue: "Fiber, Vitamin C, Antioxidants", selected: false, allocation: 0 },
  { id: "peartrees", name: "Pear Orchard (Outdoor)", category: "orchard", yieldPerSqft: 0.3, growingDays: 180, nutritionValue: "Fiber, Vitamin C, K", selected: false, allocation: 0 },
  { id: "cherrytrees", name: "Cherry Orchard (Outdoor)", category: "orchard", yieldPerSqft: 0.25, growingDays: 120, nutritionValue: "Antioxidants, Vitamin C, Melatonin", selected: false, allocation: 0 },
  { id: "plumtrees", name: "Plum Orchard (Outdoor)", category: "orchard", yieldPerSqft: 0.28, growingDays: 150, nutritionValue: "Vitamins C, K, Fiber", selected: false, allocation: 0 },
  { id: "peachtrees", name: "Peach Orchard (Outdoor)", category: "orchard", yieldPerSqft: 0.35, growingDays: 160, nutritionValue: "Vitamins A, C, Potassium", selected: false, allocation: 0 },
  { id: "apricottrees", name: "Apricot Orchard (Outdoor)", category: "orchard", yieldPerSqft: 0.28, growingDays: 140, nutritionValue: "Vitamins A, C, E", selected: false, allocation: 0 },
  { id: "hazelnuttrees", name: "Hazelnut Grove (Outdoor)", category: "orchard", yieldPerSqft: 0.15, growingDays: 200, nutritionValue: "Vitamin E, Healthy fats", selected: false, allocation: 0 },
  { id: "walnuttrees", name: "Walnut Grove (Outdoor)", category: "orchard", yieldPerSqft: 0.12, growingDays: 210, nutritionValue: "Omega-3, Antioxidants", selected: false, allocation: 0 },
  { id: "chestnuttrees", name: "Chestnut Grove (Outdoor)", category: "orchard", yieldPerSqft: 0.18, growingDays: 180, nutritionValue: "Fiber, Vitamins C, B6", selected: false, allocation: 0 },
  { id: "elderberrytrees", name: "Elderberry Bushes (Outdoor)", category: "orchard", yieldPerSqft: 0.4, growingDays: 120, nutritionValue: "Antioxidants, Immune support", selected: false, allocation: 0 },
  { id: "aronia", name: "Aronia Berry Bushes (Outdoor)", category: "orchard", yieldPerSqft: 0.5, growingDays: 110, nutritionValue: "Highest antioxidants of any berry", selected: false, allocation: 0 },
  { id: "serviceberry", name: "Serviceberry Trees (Outdoor)", category: "orchard", yieldPerSqft: 0.35, growingDays: 100, nutritionValue: "Fiber, Manganese, Antioxidants", selected: false, allocation: 0 },
  
  // HERBS
  { id: "basil", name: "Genovese Basil", category: "herbs", yieldPerSqft: 2.5, growingDays: 28, nutritionValue: "Vitamin K, Antioxidants", selected: false, allocation: 0 },
  { id: "thaibasil", name: "Thai Basil", category: "herbs", yieldPerSqft: 2.3, growingDays: 30, nutritionValue: "Vitamins A, K", selected: false, allocation: 0 },
  { id: "cilantro", name: "Cilantro", category: "herbs", yieldPerSqft: 2.2, growingDays: 25, nutritionValue: "Vitamins A, C, K", selected: false, allocation: 0 },
  { id: "parsley", name: "Italian Parsley", category: "herbs", yieldPerSqft: 2.0, growingDays: 30, nutritionValue: "Vitamins K, C, A", selected: false, allocation: 0 },
  { id: "mint", name: "Spearmint", category: "herbs", yieldPerSqft: 2.3, growingDays: 30, nutritionValue: "Vitamin A, Antioxidants", selected: false, allocation: 0 },
  { id: "peppermint", name: "Peppermint", category: "herbs", yieldPerSqft: 2.2, growingDays: 30, nutritionValue: "Menthol, Antioxidants", selected: false, allocation: 0 },
  { id: "dill", name: "Fresh Dill", category: "herbs", yieldPerSqft: 1.8, growingDays: 40, nutritionValue: "Vitamins A, C, Manganese", selected: false, allocation: 0 },
  { id: "chives", name: "Chives", category: "herbs", yieldPerSqft: 2.0, growingDays: 60, nutritionValue: "Vitamins K, A, C", selected: false, allocation: 0 },
  { id: "oregano", name: "Greek Oregano", category: "herbs", yieldPerSqft: 1.8, growingDays: 45, nutritionValue: "Vitamin K, Antioxidants", selected: false, allocation: 0 },
  { id: "thyme", name: "French Thyme", category: "herbs", yieldPerSqft: 1.5, growingDays: 50, nutritionValue: "Vitamin C, Manganese", selected: false, allocation: 0 },
  { id: "rosemary", name: "Rosemary", category: "herbs", yieldPerSqft: 1.2, growingDays: 80, nutritionValue: "Vitamin A, Calcium, Iron", selected: false, allocation: 0 },
  { id: "sage", name: "Garden Sage", category: "herbs", yieldPerSqft: 1.3, growingDays: 75, nutritionValue: "Vitamin K, Antioxidants", selected: false, allocation: 0 },
  { id: "lemongrass", name: "Lemongrass", category: "herbs", yieldPerSqft: 1.8, growingDays: 100, nutritionValue: "Citral, Antioxidants", selected: false, allocation: 0 },
  { id: "tarragon", name: "French Tarragon", category: "herbs", yieldPerSqft: 1.5, growingDays: 60, nutritionValue: "Vitamin A, Potassium", selected: false, allocation: 0 },
  { id: "lavender", name: "Culinary Lavender", category: "herbs", yieldPerSqft: 1.0, growingDays: 90, nutritionValue: "Calming properties, Antioxidants", selected: false, allocation: 0 },
  
  // SPECIALTY CROPS
  { id: "mushrooms", name: "Shiitake Mushrooms", category: "specialty", yieldPerSqft: 4.0, growingDays: 21, nutritionValue: "Vitamin D, B vitamins", selected: false, allocation: 0 },
  { id: "oyster", name: "Oyster Mushrooms", category: "specialty", yieldPerSqft: 4.5, growingDays: 18, nutritionValue: "Protein, B vitamins, Iron", selected: false, allocation: 0 },
  { id: "lionsmane", name: "Lion's Mane Mushrooms", category: "specialty", yieldPerSqft: 3.0, growingDays: 28, nutritionValue: "Nerve growth factors, Antioxidants", selected: false, allocation: 0 },
  { id: "maitake", name: "Maitake Mushrooms", category: "specialty", yieldPerSqft: 2.5, growingDays: 35, nutritionValue: "Beta-glucans, Vitamin D", selected: false, allocation: 0 },
  { id: "edibleflowers", name: "Edible Flower Mix", category: "specialty", yieldPerSqft: 1.5, growingDays: 45, nutritionValue: "Antioxidants, Natural colors", selected: false, allocation: 0 },
  { id: "nasturtium", name: "Nasturtium Flowers", category: "specialty", yieldPerSqft: 1.8, growingDays: 50, nutritionValue: "Vitamin C, Peppery flavor", selected: false, allocation: 0 },
  { id: "borage", name: "Borage Flowers", category: "specialty", yieldPerSqft: 1.3, growingDays: 55, nutritionValue: "Omega-6, Anti-inflammatory", selected: false, allocation: 0 },
  { id: "sprouts", name: "Sprouted Seeds Mix", category: "specialty", yieldPerSqft: 8.0, growingDays: 7, nutritionValue: "Enzymes, Concentrated nutrients", selected: false, allocation: 0 },
  { id: "wheatgrass", name: "Wheatgrass", category: "specialty", yieldPerSqft: 5.0, growingDays: 10, nutritionValue: "Chlorophyll, Vitamins A, C, E", selected: false, allocation: 0 },
  { id: "sunflowergreens", name: "Sunflower Greens", category: "specialty", yieldPerSqft: 4.5, growingDays: 12, nutritionValue: "Protein, Vitamins E, B", selected: false, allocation: 0 },
  { id: "peagreens", name: "Pea Shoot Greens", category: "specialty", yieldPerSqft: 4.0, growingDays: 14, nutritionValue: "Vitamins A, C, Folic acid", selected: false, allocation: 0 },
];

const EQUIPMENT_LIST: EquipmentItem[] = [
  { id: "growtowers", name: "Vertical Grow Towers", category: "growing", unitCost: 350, unitsPerSqft: 0.05, description: "ZipGrow-style vertical towers for leafy greens and herbs" },
  { id: "growbeds", name: "NFT Grow Channels", category: "growing", unitCost: 45, unitsPerSqft: 0.15, description: "Nutrient Film Technique channels for lettuce and greens" },
  { id: "deepwater", name: "Deep Water Culture Rafts", category: "growing", unitCost: 25, unitsPerSqft: 0.20, description: "Floating raft systems for larger plants" },
  { id: "ledpanels", name: "LED Grow Panels (400W)", category: "lighting", unitCost: 450, unitsPerSqft: 0.02, description: "Full-spectrum LED panels for supplemental lighting" },
  { id: "ledstrips", name: "LED Strip Lighting", category: "lighting", unitCost: 85, unitsPerSqft: 0.08, description: "Inter-canopy lighting for vertical systems" },
  { id: "lightcontrol", name: "Light Timer Controllers", category: "lighting", unitCost: 150, unitsPerSqft: 0.005, description: "Programmable lighting schedules" },
  { id: "mainpump", name: "Main Circulation Pumps", category: "irrigation", unitCost: 280, unitsPerSqft: 0.003, description: "High-efficiency recirculating pumps" },
  { id: "drippers", name: "Drip Irrigation Lines", category: "irrigation", unitCost: 3, unitsPerSqft: 0.5, description: "Precision drip emitters and tubing" },
  { id: "nutrient", name: "Nutrient Dosing System", category: "irrigation", unitCost: 1200, unitsPerSqft: 0.001, description: "Automated pH and EC management" },
  { id: "reservoir", name: "Nutrient Reservoirs", category: "irrigation", unitCost: 450, unitsPerSqft: 0.004, description: "Food-grade tanks with covers" },
  { id: "hvac", name: "Climate Control HVAC", category: "climate", unitCost: 2500, unitsPerSqft: 0.002, description: "Heating, cooling, and dehumidification" },
  { id: "vents", name: "Automated Roof Vents", category: "climate", unitCost: 650, unitsPerSqft: 0.003, description: "Temperature-responsive ventilation" },
  { id: "fans", name: "Circulation Fans", category: "climate", unitCost: 120, unitsPerSqft: 0.01, description: "Air movement for plant health" },
  { id: "co2", name: "CO2 Enrichment System", category: "climate", unitCost: 800, unitsPerSqft: 0.001, description: "Controlled CO2 supplementation" },
  { id: "sensors", name: "Environmental Sensors", category: "climate", unitCost: 350, unitsPerSqft: 0.005, description: "Temperature, humidity, CO2 monitoring" },
  { id: "benches", name: "Growing Benches", category: "infrastructure", unitCost: 95, unitsPerSqft: 0.12, description: "Aluminum growing benches with drainage" },
  { id: "flooring", name: "Greenhouse Flooring", category: "infrastructure", unitCost: 8, unitsPerSqft: 1.0, description: "Permeable, cleanable floor covering" },
  { id: "storage", name: "Tool & Supply Storage", category: "infrastructure", unitCost: 400, unitsPerSqft: 0.01, description: "Organized storage for supplies" },
  { id: "workstation", name: "Harvest Workstations", category: "infrastructure", unitCost: 650, unitsPerSqft: 0.008, description: "Stainless steel prep areas" },
];

const STAFF_POSITIONS: StaffPosition[] = [
  { role: "Greenhouse Manager", type: "employee", countPerSchool: 0.5, hoursPerWeek: 40, hourlyWage: 28, description: "Oversees daily operations, planting schedules, and staff" },
  { role: "Growing Technician", type: "employee", countPerSchool: 1, hoursPerWeek: 40, hourlyWage: 22, description: "Manages plant care, harvesting, and equipment maintenance" },
  { role: "Nutrition Educator", type: "employee", countPerSchool: 0.25, hoursPerWeek: 20, hourlyWage: 25, description: "Integrates greenhouse learning into curriculum" },
  { role: "Student Intern (HS)", type: "student", countPerSchool: 4, hoursPerWeek: 10, hourlyWage: 15, description: "High school students earning credits and experience" },
  { role: "Student Helper (MS)", type: "student", countPerSchool: 6, hoursPerWeek: 4, hourlyWage: 0, description: "Middle school students learning agriculture basics" },
  { role: "Student Explorer (K-5)", type: "student", countPerSchool: 8, hoursPerWeek: 2, hourlyWage: 0, description: "Elementary students participating in garden activities" },
  { role: "Master Gardener", type: "volunteer", countPerSchool: 2, hoursPerWeek: 4, hourlyWage: 0, description: "Community experts mentoring students" },
  { role: "Parent Volunteer", type: "volunteer", countPerSchool: 4, hoursPerWeek: 2, hourlyWage: 0, description: "Parent helpers for special events and harvests" },
  { role: "Retiree Mentor", type: "volunteer", countPerSchool: 1, hoursPerWeek: 6, hourlyWage: 0, description: "Senior community members sharing knowledge" },
];

const CATEGORY_LABELS: Record<string, string> = {
  greens: "Salad Greens",
  vegetables: "Vegetables",
  berries: "Berries",
  fruits: "Greenhouse Fruits",
  exotictrees: "Exotic Trees (Indoor)",
  orchard: "Orchard Trees (Outdoor)",
  herbs: "Fresh Herbs",
  specialty: "Specialty Crops"
};

const GRADE_LABELS: Record<string, string> = {
  elementary: "Elementary (K-5)",
  middle: "Middle (6-8)",
  high: "High School (9-12)",
  k8: "K-8",
  k12: "K-12"
};

const SCHOOL_TYPE_LABELS: Record<string, string> = {
  public: "Public",
  private: "Private",
  charter: "Charter"
};

const MIN_GREENHOUSE_SQFT = 3500;
const MAX_GREENHOUSE_SQFT = 4500;
const DEFAULT_GREENHOUSE_LENGTH = 70;
const DEFAULT_GREENHOUSE_WIDTH = 55;

const STEPS = [
  { id: 1, title: "Select Schools", icon: School },
  { id: 2, title: "Configure Greenhouses", icon: Ruler },
  { id: 3, title: "Choose Produce", icon: Leaf },
  { id: 4, title: "Equipment & Staff", icon: Wrench },
  { id: 5, title: "Review Plan", icon: FileText },
];

export default function ClusterBuilder() {
  const districts: any[] = [];
  const isLoading = false;
  const [currentStep, setCurrentStep] = useState(1);
  const [selectedDistrict, setSelectedDistrict] = useState<string>("");
  const [schools, setSchools] = useState<SchoolGreenhouse[]>([]);
  const [customSchoolName, setCustomSchoolName] = useState("");
  const [customEnrollment, setCustomEnrollment] = useState("");
  const [customGradeLevel, setCustomGradeLevel] = useState<SchoolGreenhouse["gradeLevel"]>("high");
  const [customSchoolType, setCustomSchoolType] = useState<SchoolGreenhouse["schoolType"]>("public");
  const [produceItems, setProduceItems] = useState<ProduceItem[]>(PRODUCE_OPTIONS);
  const [clusterName, setClusterName] = useState("");
  const [activeSchoolId, setActiveSchoolId] = useState<string | null>(null);

  const selectedDistricts = useMemo(() => {
    if (!districts) return [];
    return districts.filter(d => d.districtName === selectedDistrict);
  }, [districts, selectedDistrict]);

  const totalEnrollment = useMemo(() => {
    return schools.reduce((sum, s) => sum + s.enrollment, 0);
  }, [schools]);

  const totalGreenhouseSqft = useMemo(() => {
    return schools.reduce((sum, s) => sum + s.greenhouseSqft, 0);
  }, [schools]);

  const selectedProduce = useMemo(() => {
    return produceItems.filter(p => p.selected);
  }, [produceItems]);

  const clusterValidation = useMemo(() => {
    const hasElementary = schools.some(s => s.gradeLevel === "elementary" || s.gradeLevel === "k8" || s.gradeLevel === "k12");
    const hasMiddle = schools.some(s => s.gradeLevel === "middle" || s.gradeLevel === "k8" || s.gradeLevel === "k12");
    const hasHigh = schools.some(s => s.gradeLevel === "high" || s.gradeLevel === "k12");
    const hasK12Coverage = hasElementary && hasMiddle && hasHigh;
    
    const hasPublic = schools.some(s => s.schoolType === "public");
    const hasPrivate = schools.some(s => s.schoolType === "private" || s.schoolType === "charter");
    const hasMixedTypes = hasPublic && hasPrivate;
    
    return {
      hasK12Coverage,
      hasMixedTypes,
      hasElementary,
      hasMiddle,
      hasHigh,
      hasPublic,
      hasPrivate,
      schoolCount: schools.length,
      isValid: schools.length >= 2
    };
  }, [schools]);

  const equipmentForCluster = useMemo(() => {
    return EQUIPMENT_LIST.map(eq => ({
      ...eq,
      totalUnits: Math.ceil(totalGreenhouseSqft * eq.unitsPerSqft),
      totalCost: Math.ceil(totalGreenhouseSqft * eq.unitsPerSqft) * eq.unitCost
    }));
  }, [totalGreenhouseSqft]);

  const staffingForCluster = useMemo(() => {
    return STAFF_POSITIONS.map(pos => ({
      ...pos,
      totalCount: Math.ceil(pos.countPerSchool * schools.length),
      totalHours: Math.ceil(pos.countPerSchool * schools.length) * pos.hoursPerWeek,
      totalWeeklyCost: Math.ceil(pos.countPerSchool * schools.length) * pos.hoursPerWeek * pos.hourlyWage
    }));
  }, [schools.length]);

  const pilotMetrics = useMemo(() => {
    if (totalEnrollment === 0 || selectedProduce.length === 0) {
      return null;
    }

    const mealsPerStudentPerYear = 180;
    const producePerMealLbs = 0.25;
    const totalProduceNeededLbs = totalEnrollment * mealsPerStudentPerYear * producePerMealLbs;
    
    const avgYieldPerSqft = selectedProduce.reduce((sum, p) => sum + p.yieldPerSqft, 0) / selectedProduce.length;
    const cyclesPerYear = 4;
    const annualProductionLbs = totalGreenhouseSqft * avgYieldPerSqft * cyclesPerYear;
    
    const employeeStaff = staffingForCluster.filter(s => s.type === "employee");
    const totalEmployees = employeeStaff.reduce((sum, s) => sum + s.totalCount, 0);
    const totalStudents = staffingForCluster.filter(s => s.type === "student").reduce((sum, s) => sum + s.totalCount, 0);
    const totalVolunteers = staffingForCluster.filter(s => s.type === "volunteer").reduce((sum, s) => sum + s.totalCount, 0);
    
    const equipmentCost = equipmentForCluster.reduce((sum, e) => sum + e.totalCost, 0);
    const constructionCostPerSqft = 85;
    const totalConstructionCost = totalGreenhouseSqft * constructionCostPerSqft;
    const totalInvestment = equipmentCost + totalConstructionCost;
    
    const annualLaborCost = staffingForCluster
      .filter(s => s.type === "employee")
      .reduce((sum, s) => sum + (s.totalWeeklyCost * 52), 0);
    const annualOperatingCost = (totalGreenhouseSqft * 12) + annualLaborCost;
    const costPerMeal = annualOperatingCost / (totalEnrollment * mealsPerStudentPerYear);
    
    const carbonSequesteredTons = (totalGreenhouseSqft / 1000) * 0.9;
    const waterSavedGallons = totalGreenhouseSqft * 25;
    const foodMilesSaved = totalProduceNeededLbs * 1500;

    return {
      sqftNeeded: totalGreenhouseSqft,
      greenhouseCount: schools.length,
      totalEmployees,
      totalStudents,
      totalVolunteers,
      annualProductionLbs,
      totalInvestment,
      equipmentCost,
      constructionCost: totalConstructionCost,
      annualOperatingCost,
      costPerMeal,
      carbonSequesteredTons,
      waterSavedGallons,
      foodMilesSaved,
      studentsServed: totalEnrollment,
      schoolCount: schools.length,
      produceVarieties: selectedProduce.length
    };
  }, [totalEnrollment, selectedProduce, schools.length, totalGreenhouseSqft, equipmentForCluster, staffingForCluster]);

  const handleAddCustomSchool = () => {
    if (customSchoolName && customEnrollment) {
      const enrollment = parseInt(customEnrollment) || 0;
      if (enrollment > 0) {
        const defaultSqft = Math.round((MIN_GREENHOUSE_SQFT + MAX_GREENHOUSE_SQFT) / 2);
        setSchools([...schools, {
          id: `custom-${Date.now()}`,
          name: customSchoolName,
          enrollment,
          gradeLevel: customGradeLevel,
          schoolType: customSchoolType,
          isCustom: true,
          greenhouseLength: DEFAULT_GREENHOUSE_LENGTH,
          greenhouseWidth: DEFAULT_GREENHOUSE_WIDTH,
          greenhouseSqft: defaultSqft
        }]);
        setCustomSchoolName("");
        setCustomEnrollment("");
      }
    }
  };

  const handleAddDistrictSchool = () => {
    const district = selectedDistricts[0];
    if (district && !schools.some(s => s.id === `district-${district.id}`)) {
      const defaultSqft = Math.round((MIN_GREENHOUSE_SQFT + MAX_GREENHOUSE_SQFT) / 2);
      setSchools([...schools, {
        id: `district-${district.id}`,
        name: district.topCandidateSchool,
        enrollment: Math.floor(district.totalEnrollment / district.totalSchools),
        gradeLevel: "high",
        schoolType: "public",
        greenhouseLength: DEFAULT_GREENHOUSE_LENGTH,
        greenhouseWidth: DEFAULT_GREENHOUSE_WIDTH,
        greenhouseSqft: defaultSqft
      }]);
    }
  };

  const handleRemoveSchool = (id: string) => {
    setSchools(schools.filter(s => s.id !== id));
    if (activeSchoolId === id) setActiveSchoolId(null);
  };

  const handleUpdateGreenhouseDimensions = (id: string, length: number, width: number) => {
    const sqft = length * width;
    let finalLength = length;
    let finalWidth = width;
    let finalSqft = sqft;
    
    if (sqft < MIN_GREENHOUSE_SQFT) {
      const ratio = length / width;
      finalSqft = MIN_GREENHOUSE_SQFT;
      finalWidth = Math.ceil(Math.sqrt(MIN_GREENHOUSE_SQFT / ratio));
      finalLength = Math.ceil(finalWidth * ratio);
      finalSqft = finalLength * finalWidth;
    }
    
    setSchools(schools.map(s => 
      s.id === id ? { ...s, greenhouseLength: finalLength, greenhouseWidth: finalWidth, greenhouseSqft: finalSqft } : s
    ));
  };

  const handleToggleProduce = (id: string) => {
    setProduceItems(produceItems.map(p => 
      p.id === id ? { ...p, selected: !p.selected } : p
    ));
  };

  const handleSelectAllCategory = (category: string) => {
    const categoryItems = produceItems.filter(p => p.category === category);
    const allSelected = categoryItems.every(p => p.selected);
    setProduceItems(produceItems.map(p => 
      p.category === category ? { ...p, selected: !allSelected } : p
    ));
  };

  const canProceed = () => {
    switch (currentStep) {
      case 1: 
        return schools.length >= 2 && clusterValidation.hasK12Coverage;
      case 2: return schools.every(s => s.greenhouseSqft >= MIN_GREENHOUSE_SQFT);
      case 3: return selectedProduce.length > 0;
      case 4: return true;
      default: return true;
    }
  };

  const getStepBlockerMessage = () => {
    if (currentStep === 1) {
      if (schools.length < 2) return "Add at least 2 schools to your cluster";
      if (!clusterValidation.hasK12Coverage) return "Include K-12 coverage (elementary + middle + high schools)";
    }
    return null;
  };

  const progressPercent = (currentStep / STEPS.length) * 100;

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background">
      <div className="border-b bg-card">
        <div className="container mx-auto px-4 py-4">
          <div className="flex items-center justify-between flex-wrap gap-4">
            <div className="flex items-center gap-4">
              <Link href="/">
                <Button variant="ghost" size="sm" data-testid="button-back-home">
                  <Home className="h-4 w-4 mr-2" />
                  Dashboard
                </Button>
              </Link>
              <div>
                <h1 className="text-2xl font-bold flex items-center gap-2">
                  <Sprout className="h-6 w-6 text-primary" />
                  Greenhouse Cluster Builder
                </h1>
                <p className="text-sm text-muted-foreground">Design your K-12 pilot program with custom greenhouses</p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <Badge variant={clusterValidation.hasK12Coverage ? "default" : "outline"} className="gap-1">
                {clusterValidation.hasK12Coverage ? <CheckCircle2 className="h-3 w-3" /> : <AlertCircle className="h-3 w-3" />}
                K-12 Coverage
              </Badge>
              <Badge variant={clusterValidation.hasMixedTypes ? "default" : "outline"} className="gap-1">
                {clusterValidation.hasMixedTypes ? <CheckCircle2 className="h-3 w-3" /> : <AlertCircle className="h-3 w-3" />}
                Public+Private
              </Badge>
            </div>
          </div>
        </div>
      </div>

      <div className="container mx-auto px-4 py-6">
        <div className="mb-8">
          <div className="flex items-center justify-between mb-2 overflow-x-auto">
            {STEPS.map((step, index) => (
              <div key={step.id} className="flex items-center">
                <div className={`flex items-center gap-2 px-3 py-2 rounded-lg transition-colors whitespace-nowrap ${
                  currentStep === step.id 
                    ? "bg-primary text-primary-foreground" 
                    : currentStep > step.id 
                      ? "bg-primary/20 text-primary" 
                      : "bg-muted text-muted-foreground"
                }`}>
                  {currentStep > step.id ? (
                    <CheckCircle2 className="h-5 w-5" />
                  ) : (
                    <step.icon className="h-5 w-5" />
                  )}
                  <span className="hidden md:inline font-medium">{step.title}</span>
                </div>
                {index < STEPS.length - 1 && (
                  <div className={`w-4 md:w-12 h-0.5 mx-1 md:mx-2 ${
                    currentStep > step.id ? "bg-primary" : "bg-muted"
                  }`} />
                )}
              </div>
            ))}
          </div>
          <Progress value={progressPercent} className="h-2" />
        </div>

        <AnimatePresence mode="wait">
          {currentStep === 1 && (
            <motion.div
              key="step1"
              initial={{ opacity: 0, x: 20 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: -20 }}
            >
              <div className="grid lg:grid-cols-2 gap-6">
                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <MapPin className="h-5 w-5" />
                      Add Schools to Your Cluster
                    </CardTitle>
                    <CardDescription>
                      Select schools from Minnesota districts or add custom schools. Each school gets its own greenhouse (min {MIN_GREENHOUSE_SQFT.toLocaleString()} sqft).
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-4">
                      <div>
                        <Label>School District</Label>
                        <select
                          value={selectedDistrict}
                          onChange={(e) => setSelectedDistrict(e.target.value)}
                          className="w-full h-10 px-3 rounded-md border border-input bg-background text-sm mt-1"
                          data-testid="select-district"
                        >
                          <option value="">Select a district...</option>
                          {districts?.map(d => (
                            <option key={d.id} value={d.districtName}>{d.districtName}</option>
                          ))}
                        </select>
                      </div>

                      {selectedDistrict && selectedDistricts[0] && (
                        <div className="p-3 bg-muted/50 rounded-lg">
                          <p className="text-sm font-medium">{selectedDistricts[0].districtName}</p>
                          <p className="text-xs text-muted-foreground">
                            {selectedDistricts[0].totalSchools} schools | {selectedDistricts[0].totalEnrollment.toLocaleString()} students
                          </p>
                          <Button
                            variant="outline"
                            size="sm"
                            className="mt-2"
                            onClick={handleAddDistrictSchool}
                            disabled={schools.some(s => s.id === `district-${selectedDistricts[0].id}`)}
                            data-testid="button-add-district-school"
                          >
                            Add {selectedDistricts[0].topCandidateSchool}
                          </Button>
                        </div>
                      )}

                      <div className="border-t pt-4">
                        <Label className="text-sm font-medium">Or Add Custom School</Label>
                        <div className="space-y-2 mt-2">
                          <div className="grid grid-cols-2 gap-2">
                            <Input
                              placeholder="School name"
                              value={customSchoolName}
                              onChange={(e) => setCustomSchoolName(e.target.value)}
                              data-testid="input-custom-school-name"
                            />
                            <Input
                              type="number"
                              placeholder="Enrollment"
                              value={customEnrollment}
                              onChange={(e) => setCustomEnrollment(e.target.value)}
                              data-testid="input-custom-enrollment"
                            />
                          </div>
                          <div className="grid grid-cols-2 gap-2">
                            <select
                              value={customGradeLevel}
                              onChange={(e) => setCustomGradeLevel(e.target.value as SchoolGreenhouse["gradeLevel"])}
                              className="h-10 px-3 rounded-md border border-input bg-background text-sm"
                              data-testid="select-grade-level"
                            >
                              {Object.entries(GRADE_LABELS).map(([value, label]) => (
                                <option key={value} value={value}>{label}</option>
                              ))}
                            </select>
                            <select
                              value={customSchoolType}
                              onChange={(e) => setCustomSchoolType(e.target.value as SchoolGreenhouse["schoolType"])}
                              className="h-10 px-3 rounded-md border border-input bg-background text-sm"
                              data-testid="select-school-type"
                            >
                              {Object.entries(SCHOOL_TYPE_LABELS).map(([value, label]) => (
                                <option key={value} value={value}>{label}</option>
                              ))}
                            </select>
                          </div>
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={handleAddCustomSchool}
                            disabled={!customSchoolName || !customEnrollment}
                            data-testid="button-add-custom-school"
                          >
                            Add School
                          </Button>
                        </div>
                      </div>

                      <div className="p-3 bg-amber-50 dark:bg-amber-950/30 rounded-lg border border-amber-200 dark:border-amber-800">
                        <h4 className="text-sm font-medium text-amber-800 dark:text-amber-300 flex items-center gap-2">
                          <AlertCircle className="h-4 w-4" />
                          Cluster Requirements
                        </h4>
                        <ul className="mt-2 space-y-1 text-xs text-amber-700 dark:text-amber-400">
                          <li className="flex items-center gap-2">
                            {clusterValidation.hasK12Coverage ? <CheckCircle2 className="h-3 w-3 text-green-600" /> : <AlertCircle className="h-3 w-3" />}
                            Include K-12 grade coverage (elementary + middle + high)
                          </li>
                          <li className="flex items-center gap-2">
                            {clusterValidation.hasMixedTypes ? <CheckCircle2 className="h-3 w-3 text-green-600" /> : <AlertCircle className="h-3 w-3" />}
                            Mix public and private/charter schools when possible
                          </li>
                          <li className="flex items-center gap-2">
                            {clusterValidation.schoolCount >= 2 ? <CheckCircle2 className="h-3 w-3 text-green-600" /> : <AlertCircle className="h-3 w-3" />}
                            Minimum 2 schools per cluster
                          </li>
                        </ul>
                      </div>
                    </div>
                  </CardContent>
                </Card>

                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <School className="h-5 w-5" />
                      Your Cluster Schools
                    </CardTitle>
                    <CardDescription>
                      Each school will have its own greenhouse facility
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    {schools.length === 0 ? (
                      <div className="text-center py-8 text-muted-foreground">
                        <School className="h-12 w-12 mx-auto mb-2 opacity-50" />
                        <p>No schools added yet</p>
                        <p className="text-sm">Add at least 2 schools with K-12 coverage</p>
                      </div>
                    ) : (
                      <ScrollArea className="h-[350px]">
                        <div className="space-y-2">
                          {schools.map(school => (
                            <div
                              key={school.id}
                              className="p-3 bg-muted/50 rounded-lg border border-border/50"
                              data-testid={`school-item-${school.id}`}
                            >
                              <div className="flex items-start justify-between gap-2">
                                <div className="flex-1 min-w-0">
                                  <p className="font-medium truncate">{school.name}</p>
                                  <div className="flex flex-wrap gap-1 mt-1">
                                    <Badge variant="outline" className="text-xs">
                                      {GRADE_LABELS[school.gradeLevel]}
                                    </Badge>
                                    <Badge variant={school.schoolType === "public" ? "secondary" : "default"} className="text-xs gap-1">
                                      {school.schoolType === "public" ? <Unlock className="h-2 w-2" /> : <Lock className="h-2 w-2" />}
                                      {SCHOOL_TYPE_LABELS[school.schoolType]}
                                    </Badge>
                                    {school.isCustom && (
                                      <Badge variant="outline" className="text-xs">Custom</Badge>
                                    )}
                                  </div>
                                  <p className="text-sm text-muted-foreground mt-1 flex items-center gap-2">
                                    <Users className="h-3 w-3" />
                                    {school.enrollment.toLocaleString()} students
                                    <span className="text-muted-foreground/50">|</span>
                                    <Building2 className="h-3 w-3" />
                                    {school.greenhouseSqft.toLocaleString()} sqft
                                  </p>
                                </div>
                                <Button
                                  variant="ghost"
                                  size="sm"
                                  onClick={() => handleRemoveSchool(school.id)}
                                  data-testid={`button-remove-school-${school.id}`}
                                >
                                  Remove
                                </Button>
                              </div>
                            </div>
                          ))}
                        </div>
                      </ScrollArea>
                    )}

                    {schools.length > 0 && (
                      <div className="mt-4 pt-4 border-t space-y-2">
                        <div className="flex items-center justify-between">
                          <span className="text-sm text-muted-foreground">Total Schools</span>
                          <span className="font-semibold">{schools.length}</span>
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-sm text-muted-foreground">Total Students</span>
                          <span className="font-semibold">{totalEnrollment.toLocaleString()}</span>
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-sm text-muted-foreground">Total Greenhouse Space</span>
                          <span className="font-semibold">{totalGreenhouseSqft.toLocaleString()} sqft</span>
                        </div>
                      </div>
                    )}
                  </CardContent>
                </Card>
              </div>
            </motion.div>
          )}

          {currentStep === 2 && (
            <motion.div
              key="step2"
              initial={{ opacity: 0, x: 20 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: -20 }}
            >
              <div className="grid lg:grid-cols-3 gap-6">
                <div className="lg:col-span-1">
                  <Card>
                    <CardHeader>
                      <CardTitle className="flex items-center gap-2">
                        <School className="h-5 w-5" />
                        School Greenhouses
                      </CardTitle>
                      <CardDescription>
                        Select a school to configure its greenhouse dimensions
                      </CardDescription>
                    </CardHeader>
                    <CardContent>
                      <ScrollArea className="h-[400px]">
                        <div className="space-y-2">
                          {schools.map(school => (
                            <div
                              key={school.id}
                              className={`p-3 rounded-lg border cursor-pointer transition-all ${
                                activeSchoolId === school.id 
                                  ? "border-primary bg-primary/10" 
                                  : "border-border hover-elevate"
                              }`}
                              onClick={() => setActiveSchoolId(school.id)}
                              data-testid={`greenhouse-config-${school.id}`}
                            >
                              <p className="font-medium text-sm">{school.name}</p>
                              <div className="flex items-center gap-2 mt-1 text-xs text-muted-foreground">
                                <span>{school.greenhouseLength}' x {school.greenhouseWidth}'</span>
                                <span className="text-muted-foreground/50">|</span>
                                <span className={school.greenhouseSqft >= MIN_GREENHOUSE_SQFT ? "text-green-600" : "text-red-600"}>
                                  {school.greenhouseSqft.toLocaleString()} sqft
                                </span>
                              </div>
                            </div>
                          ))}
                        </div>
                      </ScrollArea>
                    </CardContent>
                  </Card>
                </div>

                <div className="lg:col-span-2">
                  {activeSchoolId ? (
                    <>
                      {(() => {
                        const school = schools.find(s => s.id === activeSchoolId);
                        if (!school) return null;
                        return (
                          <div className="space-y-6">
                            <Card>
                              <CardHeader>
                                <CardTitle className="flex items-center gap-2">
                                  <Ruler className="h-5 w-5" />
                                  {school.name} - Greenhouse Dimensions
                                </CardTitle>
                                <CardDescription>
                                  Minimum size: {MIN_GREENHOUSE_SQFT.toLocaleString()} sqft | Average statewide: ~7,500 sqft
                                </CardDescription>
                              </CardHeader>
                              <CardContent>
                                <div className="grid md:grid-cols-2 gap-6">
                                  <div className="space-y-4">
                                    <div>
                                      <Label>Length (feet)</Label>
                                      <Input
                                        type="number"
                                        value={school.greenhouseLength}
                                        onChange={(e) => handleUpdateGreenhouseDimensions(
                                          school.id, 
                                          parseInt(e.target.value) || 50, 
                                          school.greenhouseWidth
                                        )}
                                        min={50}
                                        max={200}
                                        className="mt-1"
                                        data-testid="input-greenhouse-length"
                                      />
                                    </div>
                                    <div>
                                      <Label>Width (feet)</Label>
                                      <Input
                                        type="number"
                                        value={school.greenhouseWidth}
                                        onChange={(e) => handleUpdateGreenhouseDimensions(
                                          school.id, 
                                          school.greenhouseLength, 
                                          parseInt(e.target.value) || 50
                                        )}
                                        min={30}
                                        max={100}
                                        className="mt-1"
                                        data-testid="input-greenhouse-width"
                                      />
                                    </div>
                                    <div className="p-3 bg-muted rounded-lg">
                                      <p className="text-sm text-muted-foreground">Total Square Feet</p>
                                      <p className={`text-2xl font-bold ${school.greenhouseSqft >= MIN_GREENHOUSE_SQFT ? "text-green-600" : "text-red-600"}`}>
                                        {school.greenhouseSqft.toLocaleString()} sqft
                                      </p>
                                      {school.greenhouseSqft < MIN_GREENHOUSE_SQFT && (
                                        <p className="text-xs text-red-600 mt-1">
                                          Below minimum {MIN_GREENHOUSE_SQFT.toLocaleString()} sqft
                                        </p>
                                      )}
                                    </div>
                                  </div>

                                  <div className="space-y-4">
                                    <Tabs defaultValue="2d">
                                      <TabsList className="w-full">
                                        <TabsTrigger value="2d" className="flex-1">2D Layout</TabsTrigger>
                                        <TabsTrigger value="3d" className="flex-1">3D View</TabsTrigger>
                                      </TabsList>
                                      <TabsContent value="2d" className="mt-4">
                                        <div className="border rounded-lg p-4 bg-slate-50 dark:bg-slate-900">
                                          <svg viewBox={`0 0 ${school.greenhouseLength + 20} ${school.greenhouseWidth + 20}`} className="w-full h-auto" data-testid="greenhouse-2d-layout">
                                            <rect x="10" y="10" width={school.greenhouseLength} height={school.greenhouseWidth} fill="none" stroke="currentColor" strokeWidth="2" className="text-primary" />
                                            
                                            {Array.from({ length: Math.floor(school.greenhouseLength / 8) }).map((_, i) => (
                                              <g key={`tower-${i}`}>
                                                <rect x={15 + i * 8} y={15} width="4" height={school.greenhouseWidth - 10} fill="currentColor" className="text-green-500/30" />
                                                <line x1={17 + i * 8} y1={15} x2={17 + i * 8} y2={school.greenhouseWidth + 5} stroke="currentColor" strokeWidth="0.5" className="text-green-600" />
                                              </g>
                                            ))}
                                            
                                            <rect x={school.greenhouseLength - 8} y={school.greenhouseWidth - 8} width="6" height="6" fill="currentColor" className="text-blue-500" />
                                            <text x={school.greenhouseLength - 5} y={school.greenhouseWidth + 8} fontSize="4" textAnchor="middle" className="fill-muted-foreground">Tank</text>
                                            
                                            <rect x="12" y={school.greenhouseWidth - 8} width="8" height="6" fill="currentColor" className="text-amber-500" />
                                            <text x="16" y={school.greenhouseWidth + 8} fontSize="4" textAnchor="middle" className="fill-muted-foreground">Entry</text>
                                            
                                            <text x={school.greenhouseLength / 2 + 10} y={school.greenhouseWidth + 18} fontSize="5" textAnchor="middle" className="fill-foreground font-medium">
                                              {school.greenhouseLength}' x {school.greenhouseWidth}' = {school.greenhouseSqft.toLocaleString()} sqft
                                            </text>
                                          </svg>
                                          <div className="mt-3 flex flex-wrap gap-2 text-xs">
                                            <Badge variant="outline" className="gap-1"><div className="w-2 h-2 bg-green-500 rounded" /> Grow Towers</Badge>
                                            <Badge variant="outline" className="gap-1"><div className="w-2 h-2 bg-blue-500 rounded" /> Reservoir</Badge>
                                            <Badge variant="outline" className="gap-1"><div className="w-2 h-2 bg-amber-500 rounded" /> Entry</Badge>
                                          </div>
                                        </div>
                                      </TabsContent>
                                      <TabsContent value="3d" className="mt-4">
                                        <div className="border rounded-lg p-4 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-800 dark:to-slate-900 min-h-[200px] flex items-center justify-center" data-testid="greenhouse-3d-view">
                                          <div className="relative" style={{ perspective: "500px" }}>
                                            <div 
                                              className="border-2 border-green-600 bg-green-500/10 rounded"
                                              style={{
                                                width: `${Math.min(school.greenhouseLength * 1.5, 250)}px`,
                                                height: `${Math.min(school.greenhouseWidth * 0.8, 120)}px`,
                                                transform: "rotateX(15deg) rotateY(-15deg)",
                                                transformStyle: "preserve-3d"
                                              }}
                                            >
                                              <div className="absolute inset-2 grid grid-cols-6 gap-1">
                                                {Array.from({ length: 18 }).map((_, i) => (
                                                  <div key={i} className="bg-green-600/40 rounded-sm" />
                                                ))}
                                              </div>
                                              <div className="absolute -top-4 left-0 right-0 h-4 bg-gradient-to-b from-sky-200/50 to-transparent rounded-t border-t-2 border-l-2 border-r-2 border-green-600/50" 
                                                style={{ transform: "rotateX(-30deg)", transformOrigin: "bottom" }} 
                                              />
                                            </div>
                                            <div className="text-center mt-4 text-sm font-medium">
                                              {school.name} Greenhouse
                                            </div>
                                          </div>
                                        </div>
                                      </TabsContent>
                                    </Tabs>
                                  </div>
                                </div>
                              </CardContent>
                            </Card>

                            <Card>
                              <CardHeader>
                                <CardTitle className="flex items-center gap-2">
                                  <Calculator className="h-5 w-5" />
                                  Quick Metrics for {school.name}
                                </CardTitle>
                              </CardHeader>
                              <CardContent>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                  <div className="p-3 bg-green-500/10 rounded-lg text-center">
                                    <Leaf className="h-5 w-5 mx-auto text-green-600 mb-1" />
                                    <p className="text-lg font-bold">{Math.round(school.greenhouseSqft * 4 * 4 / 1000)}K</p>
                                    <p className="text-xs text-muted-foreground">Lbs/Year</p>
                                  </div>
                                  <div className="p-3 bg-blue-500/10 rounded-lg text-center">
                                    <Users className="h-5 w-5 mx-auto text-blue-600 mb-1" />
                                    <p className="text-lg font-bold">{Math.round(school.greenhouseSqft * 4 * 4 / 180 / 0.25)}</p>
                                    <p className="text-xs text-muted-foreground">Students Fed</p>
                                  </div>
                                  <div className="p-3 bg-amber-500/10 rounded-lg text-center">
                                    <DollarSign className="h-5 w-5 mx-auto text-amber-600 mb-1" />
                                    <p className="text-lg font-bold">${Math.round(school.greenhouseSqft * 85 / 1000)}K</p>
                                    <p className="text-xs text-muted-foreground">Build Cost</p>
                                  </div>
                                  <div className="p-3 bg-purple-500/10 rounded-lg text-center">
                                    <Briefcase className="h-5 w-5 mx-auto text-purple-600 mb-1" />
                                    <p className="text-lg font-bold">{(school.greenhouseSqft / 5000 * 0.8).toFixed(1)}</p>
                                    <p className="text-xs text-muted-foreground">FTE Jobs</p>
                                  </div>
                                </div>
                              </CardContent>
                            </Card>
                          </div>
                        );
                      })()}
                    </>
                  ) : (
                    <Card className="h-full flex items-center justify-center">
                      <CardContent className="text-center py-12">
                        <Building2 className="h-16 w-16 mx-auto text-muted-foreground/30 mb-4" />
                        <p className="text-muted-foreground">Select a school to configure its greenhouse</p>
                      </CardContent>
                    </Card>
                  )}
                </div>
              </div>
            </motion.div>
          )}

          {currentStep === 3 && (
            <motion.div
              key="step3"
              initial={{ opacity: 0, x: 20 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: -20 }}
            >
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Salad className="h-5 w-5" />
                    Select Produce for Your Cluster
                  </CardTitle>
                  <CardDescription>
                    Choose which crops to grow across your {schools.length} school greenhouses ({totalGreenhouseSqft.toLocaleString()} sqft total)
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-6">
                    {Object.keys(CATEGORY_LABELS).map(category => {
                      const categoryItems = produceItems.filter(p => p.category === category);
                      if (categoryItems.length === 0) return null;
                      const allSelected = categoryItems.every(p => p.selected);
                      
                      return (
                        <div key={category}>
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="font-semibold">{CATEGORY_LABELS[category]}</h3>
                            <Button
                              variant="ghost"
                              size="sm"
                              onClick={() => handleSelectAllCategory(category)}
                              data-testid={`button-select-all-${category}`}
                            >
                              {allSelected ? "Deselect All" : "Select All"}
                            </Button>
                          </div>
                          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                            {categoryItems.map(item => (
                              <div
                                key={item.id}
                                className={`p-3 rounded-lg border cursor-pointer transition-all ${
                                  item.selected 
                                    ? "border-primary bg-primary/10" 
                                    : "border-border hover-elevate"
                                }`}
                                onClick={() => handleToggleProduce(item.id)}
                                data-testid={`produce-item-${item.id}`}
                              >
                                <div className="flex items-start gap-2">
                                  <Checkbox
                                    checked={item.selected}
                                    onCheckedChange={() => handleToggleProduce(item.id)}
                                  />
                                  <div className="flex-1 min-w-0">
                                    <p className="font-medium text-sm">{item.name}</p>
                                    <p className="text-xs text-muted-foreground">
                                      {item.yieldPerSqft} lbs/sqft | {item.growingDays}d
                                    </p>
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>

                  {selectedProduce.length > 0 && (
                    <div className="mt-6 pt-4 border-t">
                      <div className="flex flex-wrap gap-2 items-center">
                        <span className="text-sm text-muted-foreground">Selected ({selectedProduce.length}):</span>
                        {selectedProduce.map(p => (
                          <Badge key={p.id} variant="secondary">{p.name}</Badge>
                        ))}
                      </div>
                      <div className="mt-4 p-3 bg-green-500/10 rounded-lg">
                        <p className="text-sm font-medium text-green-700 dark:text-green-300">
                          Estimated Annual Production: {Math.round(totalGreenhouseSqft * (selectedProduce.reduce((sum, p) => sum + p.yieldPerSqft, 0) / selectedProduce.length) * 4).toLocaleString()} lbs
                        </p>
                      </div>
                    </div>
                  )}
                </CardContent>
              </Card>
            </motion.div>
          )}

          {currentStep === 4 && (
            <motion.div
              key="step4"
              initial={{ opacity: 0, x: 20 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: -20 }}
            >
              <div className="grid lg:grid-cols-2 gap-6">
                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <Layers className="h-5 w-5" />
                      Equipment List
                    </CardTitle>
                    <CardDescription>
                      Required equipment for {totalGreenhouseSqft.toLocaleString()} sqft across {schools.length} greenhouses
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    <Tabs defaultValue="growing">
                      <TabsList className="w-full flex-wrap h-auto">
                        <TabsTrigger value="growing" className="gap-1"><Sprout className="h-3 w-3" /> Growing</TabsTrigger>
                        <TabsTrigger value="lighting" className="gap-1"><Lightbulb className="h-3 w-3" /> Lighting</TabsTrigger>
                        <TabsTrigger value="irrigation" className="gap-1"><Droplets className="h-3 w-3" /> Irrigation</TabsTrigger>
                        <TabsTrigger value="climate" className="gap-1"><Thermometer className="h-3 w-3" /> Climate</TabsTrigger>
                        <TabsTrigger value="infrastructure" className="gap-1"><Building className="h-3 w-3" /> Infrastructure</TabsTrigger>
                      </TabsList>
                      {["growing", "lighting", "irrigation", "climate", "infrastructure"].map(cat => (
                        <TabsContent key={cat} value={cat} className="mt-4">
                          <ScrollArea className="h-[300px]">
                            <div className="space-y-2">
                              {equipmentForCluster.filter(e => e.category === cat).map(eq => (
                                <div key={eq.id} className="p-3 bg-muted/50 rounded-lg" data-testid={`equipment-${eq.id}`}>
                                  <div className="flex items-center justify-between">
                                    <div>
                                      <p className="font-medium text-sm">{eq.name}</p>
                                      <p className="text-xs text-muted-foreground">{eq.description}</p>
                                    </div>
                                    <div className="text-right">
                                      <p className="font-semibold">{eq.totalUnits} units</p>
                                      <p className="text-sm text-muted-foreground">${eq.totalCost.toLocaleString()}</p>
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </ScrollArea>
                        </TabsContent>
                      ))}
                    </Tabs>
                    <div className="mt-4 pt-4 border-t">
                      <div className="flex items-center justify-between">
                        <span className="font-semibold">Total Equipment Cost</span>
                        <span className="text-xl font-bold text-primary">
                          ${equipmentForCluster.reduce((sum, e) => sum + e.totalCost, 0).toLocaleString()}
                        </span>
                      </div>
                    </div>
                  </CardContent>
                </Card>

                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <Users className="h-5 w-5" />
                      Staffing Requirements
                    </CardTitle>
                    <CardDescription>
                      Employees, students, and volunteers for {schools.length} schools
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    <Tabs defaultValue="employee">
                      <TabsList className="w-full">
                        <TabsTrigger value="employee" className="flex-1 gap-1"><Briefcase className="h-3 w-3" /> Employees</TabsTrigger>
                        <TabsTrigger value="student" className="flex-1 gap-1"><GraduationCap className="h-3 w-3" /> Students</TabsTrigger>
                        <TabsTrigger value="volunteer" className="flex-1 gap-1"><Heart className="h-3 w-3" /> Volunteers</TabsTrigger>
                      </TabsList>
                      {["employee", "student", "volunteer"].map(type => (
                        <TabsContent key={type} value={type} className="mt-4">
                          <ScrollArea className="h-[250px]">
                            <div className="space-y-2">
                              {staffingForCluster.filter(s => s.type === type).map((pos, idx) => (
                                <div key={idx} className="p-3 bg-muted/50 rounded-lg" data-testid={`staff-${pos.role.toLowerCase().replace(/\s+/g, "-")}`}>
                                  <div className="flex items-center justify-between">
                                    <div>
                                      <p className="font-medium text-sm">{pos.role}</p>
                                      <p className="text-xs text-muted-foreground">{pos.description}</p>
                                    </div>
                                    <div className="text-right">
                                      <p className="font-semibold">{pos.totalCount} people</p>
                                      <p className="text-xs text-muted-foreground">
                                        {pos.totalHours} hrs/wk
                                        {pos.hourlyWage > 0 && ` @ $${pos.hourlyWage}/hr`}
                                      </p>
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </ScrollArea>
                        </TabsContent>
                      ))}
                    </Tabs>
                    <div className="mt-4 pt-4 border-t space-y-2">
                      <div className="flex items-center justify-between text-sm">
                        <span className="text-muted-foreground">Total Employees</span>
                        <span className="font-semibold">{staffingForCluster.filter(s => s.type === "employee").reduce((sum, s) => sum + s.totalCount, 0)}</span>
                      </div>
                      <div className="flex items-center justify-between text-sm">
                        <span className="text-muted-foreground">Total Students Engaged</span>
                        <span className="font-semibold">{staffingForCluster.filter(s => s.type === "student").reduce((sum, s) => sum + s.totalCount, 0)}</span>
                      </div>
                      <div className="flex items-center justify-between text-sm">
                        <span className="text-muted-foreground">Total Volunteers</span>
                        <span className="font-semibold">{staffingForCluster.filter(s => s.type === "volunteer").reduce((sum, s) => sum + s.totalCount, 0)}</span>
                      </div>
                      <div className="flex items-center justify-between pt-2 border-t">
                        <span className="font-semibold">Weekly Labor Cost</span>
                        <span className="font-bold text-primary">
                          ${staffingForCluster.filter(s => s.type === "employee").reduce((sum, s) => sum + s.totalWeeklyCost, 0).toLocaleString()}
                        </span>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </div>
            </motion.div>
          )}

          {currentStep === 5 && pilotMetrics && (
            <motion.div
              key="step5"
              initial={{ opacity: 0, x: 20 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: -20 }}
            >
              <div className="space-y-6">
                <div className="mb-4">
                  <Label htmlFor="cluster-name">Name Your Pilot Program</Label>
                  <Input
                    id="cluster-name"
                    placeholder="e.g., North Metro Green Schools Initiative"
                    value={clusterName}
                    onChange={(e) => setClusterName(e.target.value)}
                    className="mt-2 max-w-md"
                    data-testid="input-cluster-name"
                  />
                </div>

                <Card className="border-primary/50">
                  <CardHeader className="text-center border-b bg-primary/5">
                    <div className="flex items-center justify-center gap-2 mb-2">
                      <Sprout className="h-8 w-8 text-primary" />
                    </div>
                    <CardTitle className="text-2xl">{clusterName || "Your Pilot Program"}</CardTitle>
                    <CardDescription>
                      Greenhouse Cluster Proposal | {schools.length} Schools | {totalGreenhouseSqft.toLocaleString()} sqft
                    </CardDescription>
                    <div className="flex justify-center gap-2 mt-2">
                      <Badge variant={clusterValidation.hasK12Coverage ? "default" : "secondary"}>
                        {clusterValidation.hasK12Coverage ? "Full K-12 Coverage" : "Partial K-12"}
                      </Badge>
                      <Badge variant={clusterValidation.hasMixedTypes ? "default" : "secondary"}>
                        {clusterValidation.hasMixedTypes ? "Public + Private" : "Single Type"}
                      </Badge>
                    </div>
                  </CardHeader>
                  <CardContent className="p-6">
                    <div className="space-y-6">
                      <div className="grid md:grid-cols-4 gap-4">
                        <div className="text-center p-4 bg-muted rounded-lg">
                          <School className="h-8 w-8 mx-auto text-primary mb-2" />
                          <p className="text-2xl font-bold">{pilotMetrics.schoolCount}</p>
                          <p className="text-sm text-muted-foreground">Schools</p>
                        </div>
                        <div className="text-center p-4 bg-muted rounded-lg">
                          <Users className="h-8 w-8 mx-auto text-blue-500 mb-2" />
                          <p className="text-2xl font-bold">{pilotMetrics.studentsServed.toLocaleString()}</p>
                          <p className="text-sm text-muted-foreground">Students Served</p>
                        </div>
                        <div className="text-center p-4 bg-muted rounded-lg">
                          <Building2 className="h-8 w-8 mx-auto text-amber-500 mb-2" />
                          <p className="text-2xl font-bold">{pilotMetrics.sqftNeeded.toLocaleString()}</p>
                          <p className="text-sm text-muted-foreground">Total Sqft</p>
                        </div>
                        <div className="text-center p-4 bg-muted rounded-lg">
                          <Leaf className="h-8 w-8 mx-auto text-green-500 mb-2" />
                          <p className="text-2xl font-bold">{Math.round(pilotMetrics.annualProductionLbs / 1000)}K</p>
                          <p className="text-sm text-muted-foreground">Lbs/Year</p>
                        </div>
                      </div>

                      <div className="border rounded-lg p-4">
                        <h3 className="font-semibold mb-3">Participating Schools</h3>
                        <div className="grid md:grid-cols-2 gap-2">
                          {schools.map(s => (
                            <div key={s.id} className="flex items-center justify-between p-2 bg-muted/50 rounded">
                              <div>
                                <p className="font-medium text-sm">{s.name}</p>
                                <p className="text-xs text-muted-foreground">
                                  {GRADE_LABELS[s.gradeLevel]} | {s.enrollment.toLocaleString()} students
                                </p>
                              </div>
                              <Badge variant="outline">{s.greenhouseSqft.toLocaleString()} sqft</Badge>
                            </div>
                          ))}
                        </div>
                      </div>

                      <div className="border rounded-lg p-4">
                        <h3 className="font-semibold mb-3">Produce Varieties ({selectedProduce.length})</h3>
                        <div className="flex flex-wrap gap-2">
                          {selectedProduce.map(p => (
                            <Badge key={p.id} variant="secondary">{p.name}</Badge>
                          ))}
                        </div>
                      </div>

                      <div className="grid md:grid-cols-3 gap-4">
                        <div className="border rounded-lg p-4">
                          <h3 className="font-semibold mb-3 flex items-center gap-2">
                            <Briefcase className="h-4 w-4 text-blue-500" />
                            Staffing
                          </h3>
                          <div className="space-y-2 text-sm">
                            <div className="flex justify-between">
                              <span className="text-muted-foreground">Employees</span>
                              <span className="font-medium">{pilotMetrics.totalEmployees}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-muted-foreground">Student Participants</span>
                              <span className="font-medium">{pilotMetrics.totalStudents}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-muted-foreground">Volunteers</span>
                              <span className="font-medium">{pilotMetrics.totalVolunteers}</span>
                            </div>
                          </div>
                        </div>

                        <div className="border rounded-lg p-4">
                          <h3 className="font-semibold mb-3 flex items-center gap-2">
                            <DollarSign className="h-4 w-4 text-green-500" />
                            Investment
                          </h3>
                          <div className="space-y-2 text-sm">
                            <div className="flex justify-between">
                              <span className="text-muted-foreground">Construction</span>
                              <span className="font-medium">${(pilotMetrics.constructionCost / 1000000).toFixed(2)}M</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-muted-foreground">Equipment</span>
                              <span className="font-medium">${(pilotMetrics.equipmentCost / 1000).toFixed(0)}K</span>
                            </div>
                            <div className="flex justify-between pt-2 border-t">
                              <span className="font-medium">Total</span>
                              <span className="font-bold text-primary">${(pilotMetrics.totalInvestment / 1000000).toFixed(2)}M</span>
                            </div>
                          </div>
                        </div>

                        <div className="border rounded-lg p-4">
                          <h3 className="font-semibold mb-3 flex items-center gap-2">
                            <Calculator className="h-4 w-4 text-amber-500" />
                            Operations
                          </h3>
                          <div className="space-y-2 text-sm">
                            <div className="flex justify-between">
                              <span className="text-muted-foreground">Annual Cost</span>
                              <span className="font-medium">${(pilotMetrics.annualOperatingCost / 1000).toFixed(0)}K</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-muted-foreground">Cost Per Meal</span>
                              <span className="font-medium text-green-600">${pilotMetrics.costPerMeal.toFixed(2)}</span>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div className="border rounded-lg p-4 bg-green-500/5">
                        <h3 className="font-semibold mb-3 flex items-center gap-2">
                          <Sprout className="h-4 w-4 text-green-600" />
                          Environmental Impact
                        </h3>
                        <div className="grid md:grid-cols-3 gap-4 text-center">
                          <div>
                            <p className="text-xl font-bold text-green-600">{pilotMetrics.carbonSequesteredTons.toFixed(1)}</p>
                            <p className="text-xs text-muted-foreground">Tons CO2 Sequestered/Year</p>
                          </div>
                          <div>
                            <p className="text-xl font-bold text-blue-600">{(pilotMetrics.waterSavedGallons / 1000000).toFixed(1)}M</p>
                            <p className="text-xs text-muted-foreground">Gallons Water Saved</p>
                          </div>
                          <div>
                            <p className="text-xl font-bold text-amber-600">{(pilotMetrics.foodMilesSaved / 1000000).toFixed(1)}M</p>
                            <p className="text-xs text-muted-foreground">Food Miles Eliminated</p>
                          </div>
                        </div>
                      </div>

                      <div className="flex justify-center gap-4 pt-4">
                        <Button variant="outline" onClick={() => window.print()} data-testid="button-print">
                          Print Proposal
                        </Button>
                        <Link href="/">
                          <Button data-testid="button-back-to-dashboard">
                            Back to Dashboard
                          </Button>
                        </Link>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </div>
            </motion.div>
          )}
        </AnimatePresence>

        <div className="flex justify-between items-center mt-8">
          <Button
            variant="outline"
            onClick={() => setCurrentStep(currentStep - 1)}
            disabled={currentStep === 1}
            data-testid="button-previous-step"
          >
            <ArrowLeft className="h-4 w-4 mr-2" />
            Previous
          </Button>
          
          <div className="flex items-center gap-4">
            {!canProceed() && getStepBlockerMessage() && (
              <div className="flex items-center gap-2 text-amber-600 text-sm" data-testid="validation-message">
                <AlertCircle className="h-4 w-4" />
                {getStepBlockerMessage()}
              </div>
            )}
            {currentStep < STEPS.length && (
              <Button
                onClick={() => setCurrentStep(currentStep + 1)}
                disabled={!canProceed()}
                data-testid="button-next-step"
              >
                Next
                <ArrowRight className="h-4 w-4 ml-2" />
              </Button>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}


================================================================================
5. FRONTEND - Key Components
================================================================================


--- client/src/components/FundingCalculator.tsx ---

import { useState, useMemo } from "react";
import { motion } from "framer-motion";
import { Calculator, DollarSign, TrendingUp, Users, Building2, Leaf, Heart, Trophy, Globe, Server } from "lucide-react";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Slider } from "@/components/ui/slider";
import { Badge } from "@/components/ui/badge";

interface FundingSource {
  name: string;
  baseRate: number;
  baseRevenue: number;
  maxRate: number;
  icon: React.ReactNode;
  color: string;
}

const fundingSources: FundingSource[] = [
  { name: "Top 20 Local Corps", baseRate: 0.4, baseRevenue: 1000, maxRate: 1.5, icon: <Building2 className="h-4 w-4" />, color: "bg-blue-500" },
  { name: "Pro Sports Franchises", baseRate: 3, baseRevenue: 60, maxRate: 10, icon: <Trophy className="h-4 w-4" />, color: "bg-orange-500" },
  { name: "Local Med/Ins", baseRate: 0.4, baseRevenue: 600, maxRate: 1.5, icon: <Heart className="h-4 w-4" />, color: "bg-red-500" },
  { name: "Out-State Corp/Med/Ins", baseRate: 0.45, baseRevenue: 3150, maxRate: 1.5, icon: <Globe className="h-4 w-4" />, color: "bg-emerald-500" },
  { name: "Data/Online Retail", baseRate: 2.5, baseRevenue: 2620, maxRate: 8, icon: <Server className="h-4 w-4" />, color: "bg-purple-500" },
  { name: "Out-of-Country Mining", baseRate: 10, baseRevenue: 1000, maxRate: 25, icon: <Leaf className="h-4 w-4" />, color: "bg-amber-500" },
  { name: "Federal Government", baseRate: 1, baseRevenue: 500, maxRate: 3, icon: <Building2 className="h-4 w-4" />, color: "bg-indigo-500" },
  { name: "Local Billionaires", baseRate: 1, baseRevenue: 200, maxRate: 5, icon: <Users className="h-4 w-4" />, color: "bg-pink-500" },
];

function formatMoney(millions: number): string {
  if (millions >= 1000) return `$${(millions / 1000).toFixed(2)}B`;
  return `$${millions.toFixed(0)}M`;
}

export function FundingCalculator() {
  const [rates, setRates] = useState<number[]>(fundingSources.map(s => s.baseRate));

  const calculations = useMemo(() => {
    const revenues = fundingSources.map((source, i) => {
      const ratio = rates[i] / source.baseRate;
      return source.baseRevenue * ratio;
    });
    
    const totalRevenue = revenues.reduce((a, b) => a + b, 0);
    const endowmentTarget = 5000;
    const excessRevenue = Math.max(0, totalRevenue - endowmentTarget);
    const yearlyDraw = endowmentTarget * 0.045;
    
    const jobsPerMillion = 8.5;
    const totalJobs = Math.round(totalRevenue * jobsPerMillion);
    
    const studentsPerMillion = 450;
    const studentsFed = Math.round(totalRevenue * studentsPerMillion);

    return {
      revenues,
      totalRevenue,
      endowmentTarget,
      excessRevenue,
      yearlyDraw,
      totalJobs,
      studentsFed,
    };
  }, [rates]);

  const updateRate = (index: number, value: number[]) => {
    const newRates = [...rates];
    newRates[index] = value[0];
    setRates(newRates);
  };

  const resetRates = () => {
    setRates(fundingSources.map(s => s.baseRate));
  };

  return (
    <Card className="glass-panel" data-testid="funding-calculator">
      <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
        <Calculator className="h-5 w-5 text-primary" />
        <CardTitle className="text-lg font-semibold">Interactive Funding Calculator</CardTitle>
        <Badge 
          variant="outline" 
          className="ml-auto cursor-pointer hover-elevate"
          onClick={resetRates}
          data-testid="button-reset-calculator"
        >
          Reset
        </Badge>
      </CardHeader>
      <CardContent>
        <p className="text-sm text-muted-foreground mb-6">
          Adjust the surcharge rates to explore different funding scenarios. See how changes affect total revenue, jobs created, and students fed.
        </p>
        
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="space-y-6">
            <h4 className="font-medium text-foreground">Adjust Surcharge Rates</h4>
            {fundingSources.map((source, index) => (
              <div key={source.name} className="space-y-2">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    {source.icon}
                    <span className="text-sm font-medium">{source.name}</span>
                  </div>
                  <Badge variant="outline" className="text-xs">
                    {rates[index].toFixed(2)}% → {formatMoney(calculations.revenues[index])}
                  </Badge>
                </div>
                <Slider
                  value={[rates[index]]}
                  onValueChange={(value) => updateRate(index, value)}
                  max={source.maxRate}
                  min={0.01}
                  step={0.01}
                  className="w-full"
                  data-testid={`slider-${source.name.toLowerCase().replace(/\s/g, '-')}`}
                />
                <div className="flex justify-between text-xs text-muted-foreground">
                  <span>0.01%</span>
                  <span className="text-primary">{source.baseRate}% (current)</span>
                  <span>{source.maxRate}%</span>
                </div>
              </div>
            ))}
          </div>

          <div className="space-y-4">
            <h4 className="font-medium text-foreground">Projected Impact</h4>
            
            <motion.div 
              key={calculations.totalRevenue}
              initial={{ scale: 0.95, opacity: 0.5 }}
              animate={{ scale: 1, opacity: 1 }}
              className="grid grid-cols-2 gap-3"
            >
              <div className="p-4 bg-primary/10 rounded-xl">
                <div className="flex items-center gap-2 mb-1">
                  <DollarSign className="h-4 w-4 text-primary" />
                  <span className="text-xs text-muted-foreground">Total Revenue</span>
                </div>
                <p className="text-2xl font-bold text-primary">{formatMoney(calculations.totalRevenue)}</p>
              </div>
              
              <div className="p-4 bg-emerald-500/10 rounded-xl">
                <div className="flex items-center gap-2 mb-1">
                  <TrendingUp className="h-4 w-4 text-emerald-600" />
                  <span className="text-xs text-muted-foreground">Excess for Expansion</span>
                </div>
                <p className="text-2xl font-bold text-emerald-600">{formatMoney(calculations.excessRevenue)}</p>
              </div>
              
              <div className="p-4 bg-blue-500/10 rounded-xl">
                <div className="flex items-center gap-2 mb-1">
                  <Users className="h-4 w-4 text-blue-600" />
                  <span className="text-xs text-muted-foreground">Jobs Created</span>
                </div>
                <p className="text-2xl font-bold text-blue-600">{calculations.totalJobs.toLocaleString()}</p>
              </div>
              
              <div className="p-4 bg-amber-500/10 rounded-xl">
                <div className="flex items-center gap-2 mb-1">
                  <Users className="h-4 w-4 text-amber-600" />
                  <span className="text-xs text-muted-foreground">Students Fed</span>
                </div>
                <p className="text-2xl font-bold text-amber-600">{calculations.studentsFed.toLocaleString()}</p>
              </div>
            </motion.div>

            <div className="p-3 bg-muted/50 rounded-lg">
              <p className="text-xs text-muted-foreground">
                <strong>Note:</strong> These projections are estimates based on proposed surcharge rates. 
                The core endowment target is $5B @ 4.5% = $225M/year, with excess funds allocated to tribal programs, 
                mining alternatives, and distribution infrastructure.
              </p>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}

--- client/src/components/EndowmentGrowthChart.tsx ---

import { useState, useMemo } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import {
  AreaChart,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  Legend,
} from "recharts";
import { TrendingUp, DollarSign, Calendar } from "lucide-react";
import { motion } from "framer-motion";

interface EndowmentDataPoint {
  year: number;
  corpus: number;
  cumulativeDraws: number;
  annualDraw: number;
}

interface EndowmentGrowthChartProps {
  initialCorpus?: number;
  drawRate?: number;
  growthRate?: number;
}

const generateEndowmentData = (
  initialCorpus: number = 5000000000,
  drawRate: number = 0.045,
  growthRate: number = 0.07
): EndowmentDataPoint[] => {
  const data: EndowmentDataPoint[] = [];
  let corpus = initialCorpus;
  let cumulativeDraws = 0;

  for (let year = 2028; year <= 2078; year++) {
    const annualDraw = corpus * drawRate;
    cumulativeDraws += annualDraw;
    
    data.push({
      year,
      corpus: Math.round(corpus),
      cumulativeDraws: Math.round(cumulativeDraws),
      annualDraw: Math.round(annualDraw),
    });

    corpus = corpus * (1 + growthRate - drawRate);
  }

  return data;
};

const formatCurrency = (value: number): string => {
  if (value >= 1000000000) {
    return `$${(value / 1000000000).toFixed(1)}B`;
  }
  if (value >= 1000000) {
    return `$${(value / 1000000).toFixed(0)}M`;
  }
  return `$${value.toLocaleString()}`;
};

const CustomTooltip = ({ active, payload, label }: any) => {
  if (active && payload && payload.length) {
    return (
      <div className="bg-background border rounded-lg shadow-lg p-4">
        <p className="font-bold text-foreground mb-2">Year {label}</p>
        {payload.map((entry: any, index: number) => (
          <p key={index} style={{ color: entry.color }} className="text-sm">
            {entry.name}: {formatCurrency(entry.value)}
          </p>
        ))}
      </div>
    );
  }
  return null;
};

export default function EndowmentGrowthChart({
  initialCorpus = 5000000000,
  drawRate = 0.045,
  growthRate = 0.07
}: EndowmentGrowthChartProps = {}) {
  const [viewMode, setViewMode] = useState<"growth" | "draws">("growth");
  const data = useMemo(
    () => generateEndowmentData(initialCorpus, drawRate, growthRate),
    [initialCorpus, drawRate, growthRate]
  );

  const startData = data[0];
  const endData = data[data.length - 1];
  const year25Data = data.find(d => d.year === 2053) || data[25];

  return (
    <Card className="w-full" data-testid="endowment-growth-chart">
      <CardHeader className="flex flex-row items-center justify-between gap-2 space-y-0 pb-2">
        <CardTitle className="flex items-center gap-2">
          <TrendingUp className="h-5 w-5 text-primary" />
          50-Year Endowment Projections
        </CardTitle>
        <div className="flex gap-2">
          <Button
            size="sm"
            variant={viewMode === "growth" ? "default" : "outline"}
            onClick={() => setViewMode("growth")}
            data-testid="btn-view-growth"
          >
            Corpus Growth
          </Button>
          <Button
            size="sm"
            variant={viewMode === "draws" ? "default" : "outline"}
            onClick={() => setViewMode("draws")}
            data-testid="btn-view-draws"
          >
            Cumulative Draws
          </Button>
        </div>
      </CardHeader>
      <CardContent>
        <div className="grid grid-cols-3 gap-4 mb-6">
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.1 }}
            className="bg-primary/10 rounded-lg p-4 text-center"
          >
            <DollarSign className="h-6 w-6 mx-auto mb-2 text-primary" />
            <div className="text-2xl font-bold text-foreground" data-testid="text-initial-corpus">
              {formatCurrency(startData.corpus)}
            </div>
            <p className="text-sm text-muted-foreground">Initial Corpus (2028)</p>
          </motion.div>
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.2 }}
            className="bg-emerald-500/10 rounded-lg p-4 text-center"
          >
            <Calendar className="h-6 w-6 mx-auto mb-2 text-emerald-600" />
            <div className="text-2xl font-bold text-foreground" data-testid="text-year25-draws">
              {formatCurrency(year25Data.cumulativeDraws)}
            </div>
            <p className="text-sm text-muted-foreground">25-Year Total Draws</p>
          </motion.div>
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.3 }}
            className="bg-blue-500/10 rounded-lg p-4 text-center"
          >
            <TrendingUp className="h-6 w-6 mx-auto mb-2 text-blue-600" />
            <div className="text-2xl font-bold text-foreground" data-testid="text-final-corpus">
              {formatCurrency(endData.corpus)}
            </div>
            <p className="text-sm text-muted-foreground">50-Year Corpus</p>
          </motion.div>
        </div>

        <motion.div
          key={viewMode}
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ duration: 0.5 }}
          className="h-[350px]"
          data-testid={`chart-container-${viewMode}`}
        >
          <ResponsiveContainer width="100%" height="100%">
            {viewMode === "growth" ? (
              <AreaChart data={data} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                <defs>
                  <linearGradient id="colorCorpus" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor="#10b981" stopOpacity={0.8} />
                    <stop offset="95%" stopColor="#10b981" stopOpacity={0.1} />
                  </linearGradient>
                </defs>
                <CartesianGrid strokeDasharray="3 3" className="opacity-30" />
                <XAxis
                  dataKey="year"
                  tick={{ fontSize: 12 }}
                  tickFormatter={(value) => `'${String(value).slice(-2)}`}
                />
                <YAxis
                  tick={{ fontSize: 12 }}
                  tickFormatter={(value) => formatCurrency(value)}
                  width={80}
                />
                <Tooltip content={<CustomTooltip />} />
                <Legend />
                <Area
                  type="monotone"
                  dataKey="corpus"
                  name="Endowment Corpus"
                  stroke="#10b981"
                  fillOpacity={1}
                  fill="url(#colorCorpus)"
                  strokeWidth={2}
                />
              </AreaChart>
            ) : (
              <AreaChart data={data} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                <defs>
                  <linearGradient id="colorDraws" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.8} />
                    <stop offset="95%" stopColor="#3b82f6" stopOpacity={0.1} />
                  </linearGradient>
                  <linearGradient id="colorAnnual" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor="#f59e0b" stopOpacity={0.8} />
                    <stop offset="95%" stopColor="#f59e0b" stopOpacity={0.1} />
                  </linearGradient>
                </defs>
                <CartesianGrid strokeDasharray="3 3" className="opacity-30" />
                <XAxis
                  dataKey="year"
                  tick={{ fontSize: 12 }}
                  tickFormatter={(value) => `'${String(value).slice(-2)}`}
                />
                <YAxis
                  tick={{ fontSize: 12 }}
                  tickFormatter={(value) => formatCurrency(value)}
                  width={80}
                />
                <Tooltip content={<CustomTooltip />} />
                <Legend />
                <Area
                  type="monotone"
                  dataKey="cumulativeDraws"
                  name="Cumulative Draws"
                  stroke="#3b82f6"
                  fillOpacity={1}
                  fill="url(#colorDraws)"
                  strokeWidth={2}
                />
              </AreaChart>
            )}
          </ResponsiveContainer>
        </motion.div>

        <div className="mt-4 p-4 bg-muted/50 rounded-lg">
          <p className="text-sm text-muted-foreground text-center">
            <strong>Key Insight:</strong> With a 4.5% annual draw rate and 7% average market returns, 
            the endowment grows to <strong>{formatCurrency(endData.corpus)}</strong> over 50 years 
            while distributing <strong>{formatCurrency(endData.cumulativeDraws)}</strong> in total funding.
          </p>
        </div>
      </CardContent>
    </Card>
  );
}

--- client/src/components/JobsBreakdownChart.tsx ---

import { useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  Cell,
  PieChart,
  Pie,
  Legend,
} from "recharts";
import { Briefcase, Users, HardHat, Building2 } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";

type Scale = "pilot" | "statewide" | "national" | "global";

interface JobCategory {
  name: string;
  jobs: number;
  color: string;
  icon: string;
}

interface ScaleData {
  permanentJobs: number;
  constructionJobs: number;
  categories: JobCategory[];
  constructionBreakdown: JobCategory[];
}

const scaleData: Record<Scale, ScaleData> = {
  pilot: {
    permanentJobs: 18,
    constructionJobs: 76,
    categories: [
      { name: "Greenhouse Staff", jobs: 12, color: "#10b981", icon: "sprout" },
      { name: "Educators", jobs: 2, color: "#3b82f6", icon: "graduation" },
      { name: "Distribution", jobs: 2, color: "#f59e0b", icon: "truck" },
      { name: "School Staff", jobs: 2, color: "#8b5cf6", icon: "building" },
    ],
    constructionBreakdown: [
      { name: "General Construction", jobs: 30, color: "#6b7280", icon: "hammer" },
      { name: "Electricians", jobs: 15, color: "#f59e0b", icon: "zap" },
      { name: "Plumbers", jobs: 11, color: "#3b82f6", icon: "droplet" },
      { name: "HVAC Technicians", jobs: 11, color: "#10b981", icon: "wind" },
      { name: "Greenhouse Specialists", jobs: 9, color: "#22c55e", icon: "leaf" },
    ],
  },
  statewide: {
    permanentJobs: 2400,
    constructionJobs: 13900,
    categories: [
      { name: "Greenhouse Staff", jobs: 1440, color: "#10b981", icon: "sprout" },
      { name: "Educators", jobs: 240, color: "#3b82f6", icon: "graduation" },
      { name: "Distribution", jobs: 360, color: "#f59e0b", icon: "truck" },
      { name: "School Staff", jobs: 360, color: "#8b5cf6", icon: "building" },
    ],
    constructionBreakdown: [
      { name: "General Construction", jobs: 5560, color: "#6b7280", icon: "hammer" },
      { name: "Electricians", jobs: 2780, color: "#f59e0b", icon: "zap" },
      { name: "Plumbers", jobs: 2085, color: "#3b82f6", icon: "droplet" },
      { name: "HVAC Technicians", jobs: 2085, color: "#10b981", icon: "wind" },
      { name: "Greenhouse Specialists", jobs: 1390, color: "#22c55e", icon: "leaf" },
    ],
  },
  national: {
    permanentJobs: 250000,
    constructionJobs: 1170000,
    categories: [
      { name: "Greenhouse Staff", jobs: 156000, color: "#10b981", icon: "sprout" },
      { name: "Educators", jobs: 26000, color: "#3b82f6", icon: "graduation" },
      { name: "Distribution", jobs: 39000, color: "#f59e0b", icon: "truck" },
      { name: "School Staff", jobs: 29000, color: "#8b5cf6", icon: "building" },
    ],
    constructionBreakdown: [
      { name: "General Construction", jobs: 468000, color: "#6b7280", icon: "hammer" },
      { name: "Electricians", jobs: 234000, color: "#f59e0b", icon: "zap" },
      { name: "Plumbers", jobs: 175500, color: "#3b82f6", icon: "droplet" },
      { name: "HVAC Technicians", jobs: 175500, color: "#10b981", icon: "wind" },
      { name: "Greenhouse Specialists", jobs: 117000, color: "#22c55e", icon: "leaf" },
    ],
  },
  global: {
    permanentJobs: 2000000,
    constructionJobs: 6500000,
    categories: [
      { name: "Greenhouse Staff", jobs: 1200000, color: "#10b981", icon: "sprout" },
      { name: "Educators", jobs: 200000, color: "#3b82f6", icon: "graduation" },
      { name: "Distribution", jobs: 350000, color: "#f59e0b", icon: "truck" },
      { name: "School Staff", jobs: 250000, color: "#8b5cf6", icon: "building" },
    ],
    constructionBreakdown: [
      { name: "General Construction", jobs: 2600000, color: "#6b7280", icon: "hammer" },
      { name: "Electricians", jobs: 1300000, color: "#f59e0b", icon: "zap" },
      { name: "Plumbers", jobs: 975000, color: "#3b82f6", icon: "droplet" },
      { name: "HVAC Technicians", jobs: 975000, color: "#10b981", icon: "wind" },
      { name: "Greenhouse Specialists", jobs: 650000, color: "#22c55e", icon: "leaf" },
    ],
  },
};

const formatNumber = (value: number): string => {
  if (value >= 1000000) {
    return `${(value / 1000000).toFixed(1)}M`;
  }
  if (value >= 1000) {
    return `${(value / 1000).toFixed(value >= 10000 ? 0 : 1)}K`;
  }
  return value.toLocaleString();
};

const scaleLabels: Record<Scale, string> = {
  pilot: "Pilot (6 Schools)",
  statewide: "Statewide (1,200 Greenhouses)",
  national: "National (130K Schools)",
  global: "Global (1M Schools)",
};

const CustomTooltip = ({ active, payload }: any) => {
  if (active && payload && payload.length) {
    const data = payload[0].payload;
    return (
      <div className="bg-background border rounded-lg shadow-lg p-3">
        <p className="font-bold text-foreground">{data.name}</p>
        <p className="text-sm text-muted-foreground">
          {formatNumber(data.jobs)} jobs
        </p>
      </div>
    );
  }
  return null;
};

interface JobsBreakdownChartProps {
  defaultScale?: Scale;
}

const validScales: Scale[] = ["pilot", "statewide", "national", "global"];

export default function JobsBreakdownChart({ defaultScale = "statewide" }: JobsBreakdownChartProps) {
  const safeDefaultScale = validScales.includes(defaultScale) ? defaultScale : "statewide";
  const [scale, setScale] = useState<Scale>(safeDefaultScale);
  const [viewType, setViewType] = useState<"permanent" | "construction">("permanent");
  const data = scaleData[scale] || scaleData.statewide;

  const chartData = viewType === "permanent" ? data.categories : data.constructionBreakdown;
  const totalJobs = viewType === "permanent" ? data.permanentJobs : data.constructionJobs;

  return (
    <Card className="w-full" data-testid="jobs-breakdown-chart">
      <CardHeader className="flex flex-col gap-4 space-y-0 pb-2">
        <div className="flex flex-row items-center justify-between gap-2">
          <CardTitle className="flex items-center gap-2">
            <Briefcase className="h-5 w-5 text-primary" />
            Jobs Breakdown
          </CardTitle>
          <div className="flex gap-2">
            <Button
              size="sm"
              variant={viewType === "permanent" ? "default" : "outline"}
              onClick={() => setViewType("permanent")}
              data-testid="btn-permanent-jobs"
            >
              <Users className="h-4 w-4 mr-1" />
              Permanent
            </Button>
            <Button
              size="sm"
              variant={viewType === "construction" ? "default" : "outline"}
              onClick={() => setViewType("construction")}
              data-testid="btn-construction-jobs"
            >
              <HardHat className="h-4 w-4 mr-1" />
              Construction
            </Button>
          </div>
        </div>
        <div className="flex flex-wrap gap-2">
          {(Object.keys(scaleData) as Scale[]).map((s) => (
            <Button
              key={s}
              size="sm"
              variant={scale === s ? "secondary" : "ghost"}
              onClick={() => setScale(s)}
              data-testid={`btn-scale-${s}`}
            >
              {scaleLabels[s]}
            </Button>
          ))}
        </div>
      </CardHeader>
      <CardContent>
        <AnimatePresence mode="wait">
          <motion.div
            key={`${scale}-${viewType}`}
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -20 }}
            transition={{ duration: 0.3 }}
          >
            <div className="flex items-center justify-center gap-2 mb-4">
              <Building2 className="h-8 w-8 text-primary" />
              <span className="text-3xl font-bold" data-testid="text-total-jobs">
                {formatNumber(totalJobs)}
              </span>
              <span className="text-muted-foreground">
                {viewType === "permanent" ? "permanent jobs" : "construction phase jobs"}
              </span>
            </div>

            <div className="grid md:grid-cols-2 gap-6">
              <div className="h-[300px]">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart
                    data={chartData}
                    layout="vertical"
                    margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
                  >
                    <CartesianGrid strokeDasharray="3 3" className="opacity-30" />
                    <XAxis type="number" tickFormatter={(value) => formatNumber(value)} />
                    <YAxis
                      dataKey="name"
                      type="category"
                      width={120}
                      tick={{ fontSize: 11 }}
                    />
                    <Tooltip content={<CustomTooltip />} />
                    <Bar dataKey="jobs" radius={[0, 4, 4, 0]}>
                      {chartData.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={entry.color} />
                      ))}
                    </Bar>
                  </BarChart>
                </ResponsiveContainer>
              </div>

              <div className="h-[300px]">
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie
                      data={chartData}
                      cx="50%"
                      cy="50%"
                      innerRadius={60}
                      outerRadius={100}
                      paddingAngle={2}
                      dataKey="jobs"
                      nameKey="name"
                      label={({ name, percent }) =>
                        `${name.split(" ")[0]} ${(percent * 100).toFixed(0)}%`
                      }
                      labelLine={false}
                    >
                      {chartData.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={entry.color} />
                      ))}
                    </Pie>
                    <Tooltip content={<CustomTooltip />} />
                  </PieChart>
                </ResponsiveContainer>
              </div>
            </div>

            <div className="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3" data-testid="container-job-categories">
              {chartData.slice(0, 4).map((cat, idx) => (
                <motion.div
                  key={cat.name}
                  initial={{ opacity: 0, scale: 0.9 }}
                  animate={{ opacity: 1, scale: 1 }}
                  transition={{ delay: idx * 0.1 }}
                  className="p-3 rounded-lg text-center"
                  style={{ backgroundColor: `${cat.color}20` }}
                  data-testid={`card-job-category-${cat.name.toLowerCase().replace(/\s+/g, '-')}`}
                >
                  <div className="font-bold text-lg" style={{ color: cat.color }}>
                    {formatNumber(cat.jobs)}
                  </div>
                  <div className="text-xs text-muted-foreground">{cat.name}</div>
                </motion.div>
              ))}
            </div>

            {viewType === "permanent" && scale === "statewide" && (
              <div className="mt-4 p-4 bg-emerald-500/10 rounded-lg border border-emerald-500/20">
                <p className="text-sm text-center">
                  <strong className="text-emerald-600">100% Union Labor</strong> at{" "}
                  <strong>$32-35/hr</strong> prevailing wages. All jobs are permanent with
                  full benefits, funded perpetually by the endowment.
                </p>
              </div>
            )}

            {viewType === "construction" && (
              <div className="mt-4 p-4 bg-amber-500/10 rounded-lg border border-amber-500/20">
                <p className="text-sm text-center">
                  <strong className="text-amber-600">Union trades:</strong> IBEW
                  (electricians), UA (plumbers), SMART (HVAC), UBC (carpenters).
                  100% local hire priority.
                </p>
              </div>
            )}
          </motion.div>
        </AnimatePresence>
      </CardContent>
    </Card>
  );
}

--- client/src/components/ImpactCalculator.tsx ---

import { useState, useMemo } from "react";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Slider } from "@/components/ui/slider";
import { 
  Calculator, 
  School, 
  Users, 
  Salad, 
  DollarSign,
  Briefcase,
  Leaf,
  Building
} from "lucide-react";

interface CalculatorInputs {
  schoolCount: number;
  avgStudentsPerSchool: number;
  avgGreenhouseSqft: number;
}

interface CalculatedImpact {
  totalStudents: number;
  totalSqft: number;
  annualProduceLbs: number;
  jobsFTE: number;
  constructionJobs: number;
  annualCO2Tons: number;
  annualValue: number;
  endowmentShare: number;
}

const STATEWIDE_DEFAULTS = {
  schoolCount: 1200,
  avgStudentsPerSchool: 594,
  avgGreenhouseSqft: 7500,
};

export function ImpactCalculator() {
  const [inputs, setInputs] = useState<CalculatorInputs>({
    schoolCount: 6,
    avgStudentsPerSchool: 938,
    avgGreenhouseSqft: 7500,
  });

  const impact = useMemo<CalculatedImpact>(() => {
    const totalStudents = inputs.schoolCount * inputs.avgStudentsPerSchool;
    const totalSqft = inputs.schoolCount * inputs.avgGreenhouseSqft;
    const annualProduceLbs = totalStudents * 75;
    const jobsFTE = inputs.schoolCount * 2;
    const constructionJobs = Math.round(inputs.schoolCount * 11.58);
    const annualCO2Tons = Math.round(totalSqft * 5.93 / 2000);
    // State savings: Students × 180 school days × $1.82/meal (1/3 of $5.45 meal cost = fruits/vegetables)
    const annualValue = totalStudents * 180 * 1.82;
    const endowmentShare = (inputs.schoolCount / 1200) * 5000000000;

    return {
      totalStudents,
      totalSqft,
      annualProduceLbs,
      jobsFTE,
      constructionJobs,
      annualCO2Tons,
      annualValue,
      endowmentShare,
    };
  }, [inputs]);

  const formatNumber = (num: number): string => {
    if (num >= 1000000000) return `$${(num / 1000000000).toFixed(1)}B`;
    if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;
    if (num >= 1000) return `${(num / 1000).toFixed(1)}K`;
    return num.toLocaleString();
  };

  const formatCurrency = (num: number): string => {
    if (num >= 1000000000) return `$${(num / 1000000000).toFixed(2)}B`;
    if (num >= 1000000) return `$${(num / 1000000).toFixed(1)}M`;
    if (num >= 1000) return `$${(num / 1000).toFixed(0)}K`;
    return `$${num.toLocaleString()}`;
  };

  return (
    <Card className="glass-panel" data-testid="card-impact-calculator">
      <CardHeader className="flex flex-row items-center gap-2 space-y-0 pb-4">
        <Calculator className="h-5 w-5 text-muted-foreground" />
        <div>
          <CardTitle className="text-lg font-semibold">Impact Calculator</CardTitle>
          <CardDescription>See what Gaia Commons means for YOUR community</CardDescription>
        </div>
        <Badge variant="secondary" className="ml-auto">Interactive</Badge>
      </CardHeader>
      <CardContent>
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div className="space-y-6">
            <div>
              <Label className="flex items-center gap-2 mb-3" data-testid="label-school-count">
                <School className="h-4 w-4 text-muted-foreground" />
                Number of Schools in Your District
              </Label>
              <div className="flex items-center gap-4">
                <Slider
                  value={[inputs.schoolCount]}
                  onValueChange={(v) => setInputs({ ...inputs, schoolCount: v[0] })}
                  min={1}
                  max={100}
                  step={1}
                  className="flex-1"
                  data-testid="slider-school-count"
                />
                <Input
                  type="number"
                  value={inputs.schoolCount}
                  onChange={(e) => setInputs({ ...inputs, schoolCount: Math.max(1, parseInt(e.target.value) || 1) })}
                  className="w-20"
                  data-testid="input-school-count"
                />
              </div>
            </div>

            <div>
              <Label className="flex items-center gap-2 mb-3" data-testid="label-students">
                <Users className="h-4 w-4 text-muted-foreground" />
                Average Students per School
              </Label>
              <div className="flex items-center gap-4">
                <Slider
                  value={[inputs.avgStudentsPerSchool]}
                  onValueChange={(v) => setInputs({ ...inputs, avgStudentsPerSchool: v[0] })}
                  min={100}
                  max={2000}
                  step={50}
                  className="flex-1"
                  data-testid="slider-students"
                />
                <Input
                  type="number"
                  value={inputs.avgStudentsPerSchool}
                  onChange={(e) => setInputs({ ...inputs, avgStudentsPerSchool: Math.max(100, parseInt(e.target.value) || 100) })}
                  className="w-20"
                  data-testid="input-students"
                />
              </div>
            </div>

            <div>
              <Label className="flex items-center gap-2 mb-3" data-testid="label-sqft">
                <Building className="h-4 w-4 text-muted-foreground" />
                Greenhouse Size (sqft per school)
              </Label>
              <div className="flex items-center gap-4">
                <Slider
                  value={[inputs.avgGreenhouseSqft]}
                  onValueChange={(v) => setInputs({ ...inputs, avgGreenhouseSqft: v[0] })}
                  min={2500}
                  max={15000}
                  step={500}
                  className="flex-1"
                  data-testid="slider-sqft"
                />
                <Input
                  type="number"
                  value={inputs.avgGreenhouseSqft}
                  onChange={(e) => setInputs({ ...inputs, avgGreenhouseSqft: Math.max(2500, parseInt(e.target.value) || 2500) })}
                  className="w-24"
                  data-testid="input-sqft"
                />
              </div>
            </div>

            <div className="flex flex-wrap gap-2">
              <Button
                variant="outline"
                size="sm"
                onClick={() => setInputs({
                  schoolCount: 6,
                  avgStudentsPerSchool: 938,
                  avgGreenhouseSqft: 7500,
                })}
                data-testid="button-reset-pilot"
              >
                Reset to Pilot (6 schools)
              </Button>
              <Button
                variant="outline"
                size="sm"
                onClick={() => setInputs(STATEWIDE_DEFAULTS)}
                data-testid="button-reset-statewide"
              >
                Use Statewide Average
              </Button>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div className="p-4 bg-blue-50 dark:bg-blue-950/20 rounded-lg border border-blue-200 dark:border-blue-900/50" data-testid="result-students">
              <div className="flex items-center gap-2 mb-2">
                <Users className="h-4 w-4 text-blue-600 dark:text-blue-400" />
                <span className="text-sm font-medium text-blue-700 dark:text-blue-400" data-testid="label-result-students">Students Fed</span>
              </div>
              <p className="text-2xl font-bold text-blue-600 dark:text-blue-400" data-testid="value-result-students">{formatNumber(impact.totalStudents)}</p>
              <p className="text-xs text-muted-foreground">daily fresh produce</p>
            </div>

            <div className="p-4 bg-green-50 dark:bg-green-950/20 rounded-lg border border-green-200 dark:border-green-900/50" data-testid="result-produce">
              <div className="flex items-center gap-2 mb-2">
                <Salad className="h-4 w-4 text-green-600 dark:text-green-400" />
                <span className="text-sm font-medium text-green-700 dark:text-green-400" data-testid="label-result-produce">Annual Produce</span>
              </div>
              <p className="text-2xl font-bold text-green-600 dark:text-green-400" data-testid="value-result-produce">{formatNumber(impact.annualProduceLbs)} lb</p>
              <p className="text-xs text-muted-foreground">75 lb per student/year</p>
            </div>

            <div className="p-4 bg-purple-50 dark:bg-purple-950/20 rounded-lg border border-purple-200 dark:border-purple-900/50" data-testid="result-jobs">
              <div className="flex items-center gap-2 mb-2">
                <Briefcase className="h-4 w-4 text-purple-600 dark:text-purple-400" />
                <span className="text-sm font-medium text-purple-700 dark:text-purple-400" data-testid="label-result-jobs">FTE Jobs</span>
              </div>
              <p className="text-2xl font-bold text-purple-600 dark:text-purple-400" data-testid="value-result-jobs">{impact.jobsFTE.toLocaleString()}</p>
              <p className="text-xs text-muted-foreground">permanent positions</p>
            </div>

            <div className="p-4 bg-amber-50 dark:bg-amber-950/20 rounded-lg border border-amber-200 dark:border-amber-900/50" data-testid="result-construction">
              <div className="flex items-center gap-2 mb-2">
                <Building className="h-4 w-4 text-amber-600 dark:text-amber-400" />
                <span className="text-sm font-medium text-amber-700 dark:text-amber-400" data-testid="label-result-construction">Construction Jobs</span>
              </div>
              <p className="text-2xl font-bold text-amber-600 dark:text-amber-400" data-testid="value-result-construction">{impact.constructionJobs.toLocaleString()}</p>
              <p className="text-xs text-muted-foreground">during build phase</p>
            </div>

            <div className="p-4 bg-emerald-50 dark:bg-emerald-950/20 rounded-lg border border-emerald-200 dark:border-emerald-900/50" data-testid="result-co2">
              <div className="flex items-center gap-2 mb-2">
                <Leaf className="h-4 w-4 text-emerald-600 dark:text-emerald-400" />
                <span className="text-sm font-medium text-emerald-700 dark:text-emerald-400" data-testid="label-result-co2">CO2 Sequestered</span>
              </div>
              <p className="text-2xl font-bold text-emerald-600 dark:text-emerald-400" data-testid="value-result-co2">{impact.annualCO2Tons.toLocaleString()} tons</p>
              <p className="text-xs text-muted-foreground">annually</p>
            </div>

            <div className="p-4 bg-muted/50 rounded-lg border border-border/50" data-testid="result-value">
              <div className="flex items-center gap-2 mb-2">
                <DollarSign className="h-4 w-4 text-foreground" />
                <span className="text-sm font-medium text-foreground" data-testid="label-result-value">State Savings</span>
              </div>
              <p className="text-2xl font-bold text-foreground" data-testid="value-result-value">{formatCurrency(impact.annualValue)}</p>
              <p className="text-xs text-muted-foreground">$1.82/meal × 180 days</p>
            </div>
          </div>
        </div>

        <div className="mt-6 p-4 bg-muted/30 rounded-lg border border-border/50" data-testid="result-endowment">
          <div className="flex items-center justify-between flex-wrap gap-2">
            <div>
              <p className="text-sm font-medium text-foreground" data-testid="label-endowment-share">Your District's Share of $5B Endowment</p>
              <p className="text-xs text-muted-foreground">Proportional funding based on school count</p>
            </div>
            <p className="text-2xl font-bold text-foreground" data-testid="value-endowment-share">{formatCurrency(impact.endowmentShare)}</p>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}


================================================================================
6. BACKEND - server/routes.ts (API Routes + Seed Data)
================================================================================

import type { Express } from "express";
import type { Server } from "http";
import { storage } from "./storage";
import { api } from "@shared/routes";

export async function registerRoutes(
  httpServer: Server,
  app: Express
): Promise<Server> {
  
  // === Health ===
  app.get(api.health.get.path, (_req, res) => {
    res.json({
      status: "healthy",
      version: "5.0",
      service: "gaia-commons-api"
    });
  });

  // === Pilot Stats ===
  app.get(api.pilot.get.path, async (_req, res) => {
    const stats = await storage.getPilotStats();
    if (!stats) {
      return res.status(404).json({ message: "Pilot stats not initialized" });
    }
    res.json(stats);
  });

  // === Endowment Stats ===
  app.get(api.endowment.get.path, async (_req, res) => {
    const stats = await storage.getEndowmentStats();
    if (!stats) {
      return res.status(404).json({ message: "Endowment stats not initialized" });
    }
    res.json(stats);
  });

  // === Timeline ===
  app.get(api.timeline.list.path, async (_req, res) => {
    const events = await storage.getTimelineEvents();
    res.json(events);
  });

  // === Financial Metrics ===
  app.get(api.financials.get.path, async (_req, res) => {
    const metrics = await storage.getFinancialMetrics();
    if (!metrics) return res.status(404).json({ message: "Financial metrics not found" });
    res.json(metrics);
  });

  // === Climate Metrics ===
  app.get(api.climate.get.path, async (_req, res) => {
    const metrics = await storage.getClimateMetrics();
    if (!metrics) return res.status(404).json({ message: "Climate metrics not found" });
    res.json(metrics);
  });

  // === Slide Deck ===
  app.get(api.slides.list.path, async (_req, res) => {
    const slides = await storage.getSlides();
    res.json(slides);
  });

  // === Historical Financials ===
  app.get(api.historicalFinancials.list.path, async (_req, res) => {
    const data = await storage.getHistoricalFinancials();
    res.json(data);
  });

  // === School Clusters ===
  app.get(api.schoolClusters.list.path, async (_req, res) => {
    const clusters = await storage.getSchoolClusters();
    res.json(clusters);
  });

  // === Schools ===
  app.get(api.schools.list.path, async (_req, res) => {
    const schoolsList = await storage.getSchools();
    res.json(schoolsList);
  });

  // === Scale Projections ===
  app.get(api.scaleProjections.list.path, async (_req, res) => {
    const projections = await storage.getScaleProjections();
    res.json(projections);
  });

  // === Environmental Impact ===
  app.get(api.environmentalImpact.list.path, async (_req, res) => {
    const impacts = await storage.getEnvironmentalImpacts();
    res.json(impacts);
  });

  // === Job Creation ===
  app.get(api.jobCreation.list.path, async (_req, res) => {
    const jobs = await storage.getJobCreations();
    res.json(jobs);
  });

  // === Legal Framework ===
  app.get(api.legalFramework.get.path, async (_req, res) => {
    const legal = await storage.getLegalFramework();
    if (!legal) return res.status(404).json({ message: "Legal framework not found" });
    res.json(legal);
  });

  // === Endowment Projections ===
  app.get(api.endowmentProjections.list.path, async (_req, res) => {
    const projections = await storage.getEndowmentProjections();
    res.json(projections);
  });

  // === Expanded Jobs ===
  app.get(api.expandedJobs.list.path, async (_req, res) => {
    const jobs = await storage.getExpandedJobs();
    res.json(jobs);
  });

  // === K-12 Curriculum ===
  app.get(api.k12Curriculum.list.path, async (_req, res) => {
    const curriculum = await storage.getK12Curriculum();
    res.json(curriculum);
  });

  // === Coalition Partners ===
  app.get(api.coalitionPartners.list.path, async (_req, res) => {
    const partners = await storage.getCoalitionPartners();
    res.json(partners);
  });

  // === Funding Sources ===
  app.get(api.fundingSources.list.path, async (_req, res) => {
    const sources = await storage.getFundingSources();
    res.json(sources);
  });

  // === Transparency Features ===
  app.get(api.transparencyFeatures.list.path, async (_req, res) => {
    const features = await storage.getTransparencyFeatures();
    res.json(features);
  });

  // === Accountability Mechanisms ===
  app.get(api.accountabilityMechanisms.list.path, async (_req, res) => {
    const mechanisms = await storage.getAccountabilityMechanisms();
    res.json(mechanisms);
  });

  // === Tribal Partnerships ===
  app.get(api.tribalPartnerships.list.path, async (_req, res) => {
    const partnerships = await storage.getTribalPartnerships();
    res.json(partnerships);
  });

  // === Implementation Timeline ===
  app.get(api.implementationTimeline.list.path, async (_req, res) => {
    const timeline = await storage.getImplementationTimeline();
    res.json(timeline);
  });

  // === Political Roadmap ===
  app.get(api.politicalRoadmap.list.path, async (_req, res) => {
    const roadmap = await storage.getPoliticalRoadmap();
    res.json(roadmap);
  });

  // === Stress Tests ===
  app.get(api.stressTests.list.path, async (_req, res) => {
    const tests = await storage.getStressTests();
    res.json(tests);
  });

  app.get(api.tieredCarbonPricing.list.path, async (_req, res) => {
    const data = await storage.getTieredCarbonPricing();
    res.json(data);
  });

  app.get(api.regenerativeAgriculture.list.path, async (_req, res) => {
    const data = await storage.getRegenerativeAgriculture();
    res.json(data);
  });

  app.get(api.nationwideFoodSecurity.get.path, async (_req, res) => {
    const data = await storage.getNationwideFoodSecurity();
    if (!data) return res.status(404).json({ message: "Food security data not found" });
    res.json(data);
  });

  app.get(api.laborTransition.list.path, async (_req, res) => {
    const data = await storage.getLaborTransition();
    res.json(data);
  });

  app.get(api.politicalCoalition.list.path, async (_req, res) => {
    const data = await storage.getPoliticalCoalition();
    res.json(data);
  });

  app.get(api.globalRegenerationSummary.get.path, async (_req, res) => {
    const data = await storage.getGlobalRegenerationSummary();
    if (!data) return res.status(404).json({ message: "Global regeneration summary not found" });
    res.json(data);
  });

  // === Calibration & Validation ===
  app.get(api.planetaryBoundaries.list.path, async (_req, res) => {
    const data = await storage.getPlanetaryBoundaries();
    res.json(data);
  });

  app.get(api.calibrationTargets.list.path, async (_req, res) => {
    const data = await storage.getCalibrationTargets();
    res.json(data);
  });

  app.get(api.modelMaturity.list.path, async (_req, res) => {
    const data = await storage.getModelMaturity();
    res.json(data);
  });

  app.get(api.historicalClimateData.list.path, async (_req, res) => {
    const data = await storage.getHistoricalClimateData();
    res.json(data);
  });

  // === Advanced Modeling ===
  app.get(api.monteCarloSimulations.list.path, async (_req, res) => {
    const data = await storage.getMonteCarloSimulations();
    res.json(data);
  });

  app.get(api.scenarioComparisons.list.path, async (_req, res) => {
    const data = await storage.getScenarioComparisons();
    res.json(data);
  });

  app.get(api.optimizationParams.list.path, async (_req, res) => {
    const data = await storage.getOptimizationParams();
    res.json(data);
  });

  app.get(api.sensitivityAnalysis.list.path, async (_req, res) => {
    const data = await storage.getSensitivityAnalysis();
    res.json(data);
  });

  // === Global Regeneration Regions (World Map) ===
  app.get(api.globalRegenerationRegions.list.path, async (_req, res) => {
    const data = await storage.getGlobalRegenerationRegions();
    res.json(data);
  });

  // === Mining Alternatives (Twin Metals Replacement) ===
  app.get(api.miningAlternatives.list.path, async (_req, res) => {
    const data = await storage.getMiningAlternatives();
    res.json(data);
  });

  // === Seed Data ===
  await seedDatabase();

  return httpServer;
}

async function seedDatabase() {
  const isEmpty = await storage.isEmpty();
  
  // Always check if tribal partnerships needs seeding (may have been added after initial seed)
  const tribalData = await storage.getTribalPartnerships();
  if (tribalData.length === 0) {
    console.log("Seeding tribal partnerships...");
    await storage.createTribalPartnership({
      tribeName: "Leech Lake Band of Ojibwe",
      location: "Leech Lake Reservation, Minnesota",
      greenhouseCount: "5-10",
      jobsCreated: "50-100",
      hourlyWage: "$25-32/hr + full benefits",
      firstHarvest: "Fall 2027",
      schoolsServed: "Cass Lake-Bena, Bug-O-Nay-Ge-Shig, Head Start",
      studentsServed: 1500,
      annualSurplus: "$400,000/year",
      surplusSplit: "35% Tribal Govt, 35% Growing Endowment, 30% Youth Scholarships & Food Pantry",
      breakEvenYear: 5,
      governance: "Council veto power, majority board seats, walk-away clause, annual Big-4 audits, public dashboard",
      complementaryProjects: "New $3.6M wild-rice facility - together lock in permanent food sovereignty and generational wealth",
      status: "Partnership Development"
    });
  }

  // Seed implementation timeline if empty
  const timelineData = await storage.getImplementationTimeline();
  if (timelineData.length === 0) {
    console.log("Seeding implementation timeline...");
    const milestones = [
      { phase: "Foundation", quarter: "2027 Q1", milestone: "Board Elections & Corpus Receipt", details: "Board elections; receive $5B corpus from state filings", greenhouseCount: 0, jobsCreated: 50, studentsServed: 0 },
      { phase: "Launch", quarter: "2027 Q2-Q4", milestone: "First 50 Greenhouses", details: "Build first 50 greenhouses; hire staff, train teachers", greenhouseCount: 50, jobsCreated: 260, studentsServed: 159000 },
      { phase: "Launch", quarter: "2027 Q3", milestone: "First Harvest", details: "First harvest; K-12 curriculum pilots with 9 school districts", greenhouseCount: 50, jobsCreated: 260, studentsServed: 159000 },
      { phase: "Scale", quarter: "2028 Q1-Q4", milestone: "Scale to 200 Greenhouses", details: "Expand to 200 greenhouses across all 8 congressional districts", greenhouseCount: 200, jobsCreated: 1040, studentsServed: 636000 },
      { phase: "Full Operation", quarter: "2029 Q4", milestone: "All 1,200 Greenhouses Operational", details: "712,500 students fed (75 lb/yr each); 2,400 FTE jobs created; 9M sqft statewide", greenhouseCount: 1200, jobsCreated: 2400, studentsServed: 712500 }
    ];
    for (const m of milestones) {
      await storage.createImplementationTimeline(m);
    }
  }

  // Seed political roadmap if empty
  const roadmapData = await storage.getPoliticalRoadmap();
  if (roadmapData.length === 0) {
    console.log("Seeding political roadmap...");
    const districts = [
      { district: "MN-03", supportLevel: "Strong YES", supportPct: "70%+", strategy: "Bankroll field ops for weak districts", keyMessaging: "Education investment, suburban families" },
      { district: "MN-04", supportLevel: "Strong YES", supportPct: "70%+", strategy: "Bankroll field ops for weak districts", keyMessaging: "Urban food access, jobs" },
      { district: "MN-05", supportLevel: "Strong YES", supportPct: "70%+", strategy: "Bankroll field ops for weak districts", keyMessaging: "Climate action, equity" },
      { district: "MN-01", supportLevel: "Competitive", supportPct: "50-56%", strategy: "Ground game + local partnerships", keyMessaging: "Rural jobs, farm partnerships" },
      { district: "MN-06", supportLevel: "Competitive", supportPct: "50-56%", strategy: "Ground game + local partnerships", keyMessaging: "Local food, school nutrition" },
      { district: "MN-07", supportLevel: "Competitive", supportPct: "50-56%", strategy: "Ground game + local partnerships", keyMessaging: "Agricultural innovation, jobs" },
      { district: "MN-08", supportLevel: "Competitive", supportPct: "50-56%", strategy: "Ground game + local partnerships", keyMessaging: "Iron Range jobs, Boundary Waters protection" },
      { district: "MN-02", supportLevel: "Lean NO", supportPct: "48-52%", strategy: "Regenerative ag + jobs messaging", keyMessaging: "Economic development, local hiring" }
    ];
    for (const d of districts) {
      await storage.createPoliticalRoadmap(d);
    }
  }

  // Seed stress tests if empty
  const stressData = await storage.getStressTests();
  if (stressData.length === 0) {
    console.log("Seeding stress tests...");
    const scenarios = [
      { scenario: "Bear Market", description: "5% annual loss for 5 consecutive years", impact: "Corpus temporarily reduced by ~22%", mitigation: "Spending-smoothing policy maintains draw; recovery within 10 years", solvencyProbability: "99%+" },
      { scenario: "Inflation Surge", description: "4% annual inflation for 10 years", impact: "Purchasing power erosion risk", mitigation: "CPI adjustment protects purchasing power; corpus grows real 2%", solvencyProbability: "99%+" },
      { scenario: "Combined Shock", description: "Bear market + inflation surge simultaneously", impact: "Maximum stress on corpus and spending", mitigation: "1000-path Monte Carlo using 1926-2022 data shows resilience", solvencyProbability: "99%+" },
      { scenario: "Spending Policy", description: "3-year rolling-average corpus with caps", impact: "Smooths volatility in annual draws", mitigation: "Max 10% year-to-year change; emergency 5% cap (board vote)", solvencyProbability: "100%" }
    ];
    for (const s of scenarios) {
      await storage.createStressTest(s);
    }
  }

  // Seed Global Regeneration: Tiered Carbon Pricing
  const carbonData = await storage.getTieredCarbonPricing();
  if (carbonData.length === 0) {
    console.log("Seeding tiered carbon pricing...");
    const tiers = [
      { tierName: "small_emitters", thresholdMin: 0, thresholdMax: 25000, carbonTaxRate: 25, description: "Small businesses, local operations", emissionFraction: 0.15, reductionRate: 0.10, businessSurvival: 0.95, revenueMillions: 262 },
      { tierName: "medium_emitters", thresholdMin: 25000, thresholdMax: 100000, carbonTaxRate: 75, description: "Regional companies, mid-size operations", emissionFraction: 0.25, reductionRate: 0.25, businessSurvival: 0.90, revenueMillions: 984 },
      { tierName: "large_emitters", thresholdMin: 100000, thresholdMax: 1000000, carbonTaxRate: 150, description: "Major corporations, large industrial facilities", emissionFraction: 0.35, reductionRate: 0.45, businessSurvival: 0.80, revenueMillions: 2021 },
      { tierName: "mega_polluters", thresholdMin: 1000000, thresholdMax: null, carbonTaxRate: 200, description: "Fossil fuel companies, massive industrial polluters", emissionFraction: 0.25, reductionRate: 0.70, businessSurvival: 0.40, revenueMillions: 1050 }
    ];
    for (const t of tiers) {
      await storage.createTieredCarbonPricing(t);
    }
  }

  // Seed Global Regeneration: Regenerative Agriculture
  const agData = await storage.getRegenerativeAgriculture();
  if (agData.length === 0) {
    console.log("Seeding regenerative agriculture...");
    const usAcres = 180000000 * 0.8; // 80% transition at $150 carbon
    const operations = [
      { operationType: "hemp_production", name: "Industrial Hemp Multi-Stream", description: "Fiber, seed, biomass, soil remediation", acresAllocated: usAcres * 0.25, revenuePerAcre: 2850, jobsPer1000Acres: 6.8, avgWage: 48000, carbonSequestration: 4.2, peopleFedPerAcre: 12, totalJobs: Math.floor(usAcres * 0.25 / 1000 * 6.8), totalRevenue: usAcres * 0.25 * 2850, totalCarbonSequestered: usAcres * 0.25 * 4.2 },
      { operationType: "market_garden", name: "Diversified Market Garden", description: "50+ vegetable crops for local markets", acresAllocated: usAcres * 0.20, revenuePerAcre: 8500, jobsPer1000Acres: 12.5, avgWage: 45000, carbonSequestration: 3.2, peopleFedPerAcre: 8, totalJobs: Math.floor(usAcres * 0.20 / 1000 * 12.5), totalRevenue: usAcres * 0.20 * 8500, totalCarbonSequestered: usAcres * 0.20 * 3.2 },
      { operationType: "food_forest", name: "Agroforestry/Food Forest", description: "Perennial nuts, fruits, berries, mushrooms", acresAllocated: usAcres * 0.20, revenuePerAcre: 3200, jobsPer1000Acres: 6.8, avgWage: 42000, carbonSequestration: 5.8, peopleFedPerAcre: 4, totalJobs: Math.floor(usAcres * 0.20 / 1000 * 6.8), totalRevenue: usAcres * 0.20 * 3200, totalCarbonSequestered: usAcres * 0.20 * 5.8 },
      { operationType: "silvopasture", name: "Silvopasture Livestock", description: "Rotational grazing with trees", acresAllocated: usAcres * 0.35, revenuePerAcre: 850, jobsPer1000Acres: 4.2, avgWage: 48000, carbonSequestration: 2.8, peopleFedPerAcre: 1.2, totalJobs: Math.floor(usAcres * 0.35 / 1000 * 4.2), totalRevenue: usAcres * 0.35 * 850, totalCarbonSequestered: usAcres * 0.35 * 2.8 }
    ];
    for (const op of operations) {
      await storage.createRegenerativeAgriculture(op);
    }
  }

  // Seed Global Regeneration: Nationwide Food Security
  const foodSecData = await storage.getNationwideFoodSecurity();
  if (!foodSecData) {
    console.log("Seeding nationwide food security...");
    const totalStudents = 52000000; // ~52 million public school students
    const facilitiesNeeded = Math.ceil(totalStudents / 3000);
    await storage.createNationwideFoodSecurity({
      scope: "All 50 states",
      totalStudents: totalStudents,
      facilitiesNeeded: facilitiesNeeded,
      jobsCreated: facilitiesNeeded * 4,
      constructionCost: facilitiesNeeded * 400000,
      annualOperating: facilitiesNeeded * 150000,
      co2ReductionTons: totalStudents * 365 * 0.0003 * 1500 * 0.90 * 0.0004,
      waterSavingsGallons: facilitiesNeeded * 50000,
      pesticideElimination: "100% - no pesticides in controlled environment",
      replicationModel: "State-by-state using MCS template"
    });
  }

  // Seed Global Regeneration: Labor Transition
  const laborData = await storage.getLaborTransition();
  if (laborData.length === 0) {
    console.log("Seeding labor transition...");
    const sectors = [
      { sector: "Coal", workersAffected: 43000, avgWage: 75000, incomeGuaranteeRate: 1.25, transitionDurationYears: 3, retrainingCostPerWorker: 45000, successRate: 0.78, totalCost: 43000 * (75000 * 1.25 * 3 + 45000), choicePreservation: "Workers choose timing and pathway" },
      { sector: "Oil & Gas", workersAffected: 1200000, avgWage: 75000, incomeGuaranteeRate: 1.25, transitionDurationYears: 3, retrainingCostPerWorker: 45000, successRate: 0.78, totalCost: 1200000 * (75000 * 1.25 * 3 + 45000), choicePreservation: "Workers choose timing and pathway" },
      { sector: "Pipeline", workersAffected: 125000, avgWage: 75000, incomeGuaranteeRate: 1.25, transitionDurationYears: 3, retrainingCostPerWorker: 45000, successRate: 0.78, totalCost: 125000 * (75000 * 1.25 * 3 + 45000), choicePreservation: "Workers choose timing and pathway" },
      { sector: "Auto (ICE)", workersAffected: 180000, avgWage: 75000, incomeGuaranteeRate: 1.25, transitionDurationYears: 3, retrainingCostPerWorker: 45000, successRate: 0.78, totalCost: 180000 * (75000 * 1.25 * 3 + 45000), choicePreservation: "Workers choose timing and pathway" }
    ];
    for (const s of sectors) {
      await storage.createLaborTransition(s);
    }
  }

  // Seed Global Regeneration: Political Coalition
  const coalitionData = await storage.getPoliticalCoalition();
  if (coalitionData.length === 0) {
    console.log("Seeding political coalition...");
    const groups = [
      { groupName: "Green Job Workers", memberCount: 0, description: "New jobs from energy transition", isCalculated: 1 },
      { groupName: "Students & Families", memberCount: 0, description: "Beneficiaries of food security program", isCalculated: 1 },
      { groupName: "Farmers Transitioned", memberCount: 0, description: "Regenerative agriculture adopters", isCalculated: 1 },
      { groupName: "Environmental Activists", memberCount: 15000000, description: "Climate advocacy organizations", isCalculated: 0 },
      { groupName: "Healthcare Workers", memberCount: 18000000, description: "Support universal programs", isCalculated: 0 },
      { groupName: "Teachers", memberCount: 3500000, description: "Support education investments", isCalculated: 0 },
      { groupName: "Young Voters (18-35)", memberCount: 65000000, description: "Climate-concerned generation", isCalculated: 0 }
    ];
    for (const g of groups) {
      await storage.createPoliticalCoalition(g);
    }
  }

  // Seed Global Regeneration Summary
  const summaryData = await storage.getGlobalRegenerationSummary();
  if (!summaryData) {
    console.log("Seeding global regeneration summary...");
    const totalJobs = 840000 + 69334 + 2500000; // ag jobs + food security + green energy
    const totalCoalition = 101500000 + totalJobs + 26000000; // base + jobs + calculated families
    await storage.createGlobalRegenerationSummary({
      totalJobsCreated: totalJobs,
      totalCoalitionSize: totalCoalition,
      coalitionPercentage: (totalCoalition / 240000000) * 100,
      politicalPowerAssessment: "Overwhelming - largest coalition in US history",
      oppositionSize: 75000,
      coalitionAdvantage: "1000:1 ratio favoring Gaia coalition",
      totalTransitionCosts: 525000000000, // ~$525B
      choicePreservationAchieved: 1
    });
  }
  
  // Seed K-12 Curriculum if empty (detailed per-grade curriculum)
  const curriculumData = await storage.getK12Curriculum();
  if (curriculumData.length === 0) {
    console.log("Seeding detailed K-12 curriculum...");
    // Kindergarten
    await storage.createK12Curriculum({
      gradeRange: "K",
      title: "Seeds & Sprouts",
      description: "Introduction to plant life through hands-on seed planting. Students observe germination, learn plant parts (roots, stems, leaves), practice daily watering responsibility, and create plant journals with drawings. Culminates in 'Sprout Celebration' where students share their first harvest of microgreens.",
      durationWeeks: 6,
      standards: "NGSS: K-LS1-1 (What plants need), K-ESS2-2 (Weather patterns)"
    });
    await storage.createK12Curriculum({
      gradeRange: "1",
      title: "Garden Helpers",
      description: "Exploring the ecosystem of helpers in our greenhouse: earthworms, beneficial insects, and pollinators. Students create 'bug hotels', learn composting basics, identify helpful vs. harmful insects, and understand the food web. Field trips to observe bees and butterflies in action.",
      durationWeeks: 8,
      standards: "NGSS: 1-LS1-1 (Animal survival), 1-LS3-1 (Inheritance)"
    });
    await storage.createK12Curriculum({
      gradeRange: "2",
      title: "Soil Scientists",
      description: "Deep dive into soil health: texture, composition, and life underground. Students conduct soil tests, compare different growing mediums, learn about decomposition, and create terrariums. Introduction to the nutrient cycle through 'feeding the soil' activities with compost.",
      durationWeeks: 8,
      standards: "NGSS: 2-LS2-1 (Seed dispersal), 2-LS4-1 (Habitats), K-ESS3-1 (Human impact)"
    });
    await storage.createK12Curriculum({
      gradeRange: "3",
      title: "Plant Detectives",
      description: "Scientific observation and data collection. Students maintain growth charts, measure plant height/width weekly, learn to use digital thermometers and moisture meters, create graphs of growth data, and conduct simple experiments on light and water variables.",
      durationWeeks: 10,
      standards: "NGSS: 3-LS1-1 (Life cycles), 3-LS4-3 (Fossils & environment)"
    });
    await storage.createK12Curriculum({
      gradeRange: "4",
      title: "Energy Explorers",
      description: "Understanding photosynthesis and energy flow. Students measure light intensity in different greenhouse zones, track plant growth under varying light conditions, learn about solar energy and greenhouse heating, and create energy flow diagrams from sun to plate.",
      durationWeeks: 10,
      standards: "NGSS: 4-LS1-1 (Energy in organisms), 4-PS3-2 (Energy transfer)"
    });
    await storage.createK12Curriculum({
      gradeRange: "5",
      title: "Food Systems Analysts",
      description: "Introduction to systems thinking through food. Students map the journey of food from seed to table, calculate food miles for imported vs. local produce, analyze grocery store produce origins, and design their ideal local food system.",
      durationWeeks: 12,
      standards: "NGSS: 5-LS2-1 (Matter cycling), 5-ESS3-1 (Human impact on Earth)"
    });
    await storage.createK12Curriculum({
      gradeRange: "6",
      title: "Hydroponics Engineers",
      description: "Building and managing hydroponic systems. Students learn water chemistry (pH, EC, dissolved oxygen), build simple DWC systems, monitor nutrient solutions, troubleshoot plant health issues, and compare hydroponic vs. soil growing efficiency.",
      durationWeeks: 14,
      standards: "NGSS: MS-LS1-6 (Photosynthesis), MS-PS1-2 (Chemical reactions)"
    });
    await storage.createK12Curriculum({
      gradeRange: "7",
      title: "Aquaponics Masters",
      description: "Integration of fish and plant systems. Students understand the nitrogen cycle, manage tilapia populations, monitor water quality for fish and plants, calculate feed ratios, and design balanced aquaponic ecosystems. Introduction to business basics through produce sales.",
      durationWeeks: 16,
      standards: "NGSS: MS-LS2-3 (Ecosystem dynamics), MS-LS2-4 (Biodiversity & ecosystem services)"
    });
    await storage.createK12Curriculum({
      gradeRange: "8",
      title: "Climate Action Scientists",
      description: "Connecting greenhouse operations to climate science. Students calculate the carbon footprint of food production, measure CO2 sequestration in greenhouse operations, model climate scenarios using real data, and develop school-wide sustainability plans.",
      durationWeeks: 16,
      standards: "NGSS: MS-ESS3-3 (Human impact on climate), MS-ESS3-4 (Natural hazards)"
    });
    await storage.createK12Curriculum({
      gradeRange: "9",
      title: "Agricultural Economics",
      description: "Business of sustainable farming. Students develop business plans for greenhouse operations, analyze profit/loss statements, understand supply chains and market dynamics, learn agricultural finance basics, and explore cooperative ownership models.",
      durationWeeks: 18,
      standards: "NGSS: HS-LS2-7 (Human activity & ecosystems), HS-ETS1-1 (Engineering design)"
    });
    await storage.createK12Curriculum({
      gradeRange: "10",
      title: "Food Security & Justice",
      description: "Examining food access and equity. Students research food deserts and their causes, interview community members about food access, analyze USDA data on food insecurity, explore the history of agricultural policy, and design community food access solutions.",
      durationWeeks: 18,
      standards: "NGSS: HS-ESS3-1 (Resource availability), HS-ESS3-3 (Sustainability)"
    });
    await storage.createK12Curriculum({
      gradeRange: "11",
      title: "Food Policy & Advocacy",
      description: "Civic engagement through food policy analysis. Students study Farm Bill history, analyze SNAP and school lunch programs, draft policy proposals, meet with local legislators, and learn advocacy strategies. Mock ballot initiative development and campaign planning.",
      durationWeeks: 18,
      standards: "NGSS: HS-ESS3-1 (Resource availability), HS-ESS3-4 (Sustainability solutions)"
    });
    await storage.createK12Curriculum({
      gradeRange: "12",
      title: "Capstone: Community Food Project",
      description: "Year-long capstone integrating all K-12 learning. Students design, propose, and implement a community food security project. Includes grant writing, community engagement, project management, outcome measurement, and final presentation to school board and community partners. Career pathway exploration in sustainable agriculture.",
      durationWeeks: 36,
      standards: "NGSS: HS-LS2-7, HS-ESS3-4, HS-ETS1-3 (Integrated application)"
    });
  }
  
  // Seed Funding Sources if empty (updated per user specifications - $8.84B total)
  const fundingData = await storage.getFundingSources();
  if (fundingData.length === 0) {
    console.log("Seeding funding sources with corrected rates...");
    await storage.createFundingSource({
      sourceType: "Top 20 Local Corps",
      description: "0.4% contribution from top 20 Minnesota-headquartered corporations",
      targetAmount: 1000000000,
      percentage: 0.4,
      entities: "Target, UnitedHealth, Best Buy, 3M, General Mills, US Bancorp, Xcel Energy, CHS, Land O'Lakes, Hormel, Polaris, Fastenal, Patterson, CH Robinson, Graco, Pentair, Donaldson, Ameriprise, Ecolab, Thrivent"
    });
    await storage.createFundingSource({
      sourceType: "Pro Sports Franchises",
      description: "3% contribution from Minnesota professional sports franchises annual revenue",
      targetAmount: 60000000,
      percentage: 3.0,
      entities: "Minnesota Vikings (NFL), Minnesota Twins (MLB), Minnesota Timberwolves (NBA), Minnesota Lynx (WNBA), Minnesota Wild (NHL), Minnesota United FC (MLS), St. Paul Saints (MiLB)"
    });
    await storage.createFundingSource({
      sourceType: "Local Med/Ins",
      description: "0.4% contribution from Minnesota-based healthcare and insurance companies",
      targetAmount: 600000000,
      percentage: 0.4,
      entities: "UnitedHealth Group, Medtronic, Mayo Clinic, Allina Health, Fairview Health, HealthPartners, Blue Cross Blue Shield of MN, Securian Financial"
    });
    await storage.createFundingSource({
      sourceType: "Out-State Corp/Med/Ins",
      description: "0.45% surcharge on out-of-state corporations, medical, and insurance companies with significant MN presence",
      targetAmount: 3150000000,
      percentage: 0.45,
      entities: "Major out-of-state insurers, banks, retailers, healthcare systems, and ag-conglomerates with >$100M MN revenue"
    });
    await storage.createFundingSource({
      sourceType: "Data/Online Retail",
      description: "2.5% surcharge on major tech data centers and online retail operations in Minnesota",
      targetAmount: 2620000000,
      percentage: 2.5,
      entities: "Amazon, Microsoft, Google, Meta, Apple, Walmart.com, Target.com, Best Buy online, Wayfair, and major data center operators"
    });
    await storage.createFundingSource({
      sourceType: "Out-of-Country Mining",
      description: "10% surcharge on out-of-country mining corporations seeking to operate in Minnesota",
      targetAmount: 1000000000,
      percentage: 10.0,
      entities: "Antofagasta (Chile/UK - Twin Metals owner), Codelco (Chile), Vale (Brazil), Glencore (Switzerland), Rio Tinto (UK/Australia), BHP (Australia), Anglo American (UK), Teck Resources (Canada)"
    });
    await storage.createFundingSource({
      sourceType: "Federal Government",
      description: "Federal grants and matching funds for food security and education initiatives",
      targetAmount: 500000000,
      percentage: null,
      entities: "USDA Farm to School, USDA Community Food Projects, Dept of Education, EPA Environmental Education, HHS Community Health"
    });
    await storage.createFundingSource({
      sourceType: "Local Billionaires",
      description: "Voluntary philanthropic contributions from Minnesota billionaires",
      targetAmount: 200000000,
      percentage: null,
      entities: "Glen Taylor (Wolves, Lynx, Star Tribune), Whitney MacMillan (Cargill heir), Stanley Hubbard (Hubbard Broadcasting), Marilyn Carlson Nelson (Carlson Companies), Richard Schulze (Best Buy founder)"
    });
  }
  
  // Seed Scale Projections if empty (may have been cleared for updates)
  const scaleData = await storage.getScaleProjections();
  if (scaleData.length === 0) {
    console.log("Seeding scale projections...");
    // State Savings = Students × 180 school days × $1.82/meal (1/3 of $5.45 meal cost = fruits/vegetables)
    // This represents money the state saves when greenhouses provide produce instead of purchasing it
    await storage.createScaleProjection({
      scale: "pilot",
      schools: 6,
      students: 5630,
      greenhouses: 6,
      sqft: 45050,
      capex: 2950000,
      annualRevenue: 1844000,    // 5,630 × 180 days × $1.82/meal = ~$1.84M state savings
      annualOpex: 360000,
      npv5yr: 12847000,
      roiPct: 435,
      endowmentTarget: 5000000,
      endowmentYr15: 15400000,
      jobs: 36,
      co2TonsAnnual: 246,
      mealsPerDay: 15500
    });

    // Statewide: 1,200 high school greenhouses (7,500 sqft avg), 9M sqft total, 712,500 students (75% of 950K)
    // State Savings: 712,500 students × 180 days × $1.82/meal = ~$233M/year
    await storage.createScaleProjection({
      scale: "statewide",
      schools: 3100,         // Schools with curriculum (statewide)
      students: 712500,      // 75% of 950K K-12 enrollment = 712,500 lunch participation
      greenhouses: 1200,     // 1,200 high school greenhouses
      sqft: 9000000,         // 1,200 × 7,500 sqft avg = 9M sqft total
      capex: 1390000000,     // $1.39B-$2.69B capex range (mid-point ~$1.39B)
      annualRevenue: 233415000,   // State savings: 712,500 × 180 days × $1.82/meal = ~$233M
      annualOpex: 90000000,       // 1,200 greenhouses × $75K/yr avg opex
      npv5yr: 950000000,
      roiPct: 435,
      endowmentTarget: 5000000000,  // $5B @ 4.5% = $225M/yr
      endowmentYr15: 12000000000,
      jobs: 2400,            // 2,400 FTE jobs
      co2TonsAnnual: 53370,  // 9M sqft × 5.93 lbs CO2/sqft sequestration
      mealsPerDay: 712500    // 712,500 students served daily
    });

    // National: 50M students × 180 days × $1.82/meal = ~$16.4B state savings
    await storage.createScaleProjection({
      scale: "national",
      schools: 130000,
      students: 50000000,
      greenhouses: 130000,
      sqft: 1040000000,
      capex: 48000000000,
      annualRevenue: 16380000000,  // 50M × 180 days × $1.82/meal = ~$16.4B state savings
      annualOpex: 7800000000,
      npv5yr: 740000000000,
      roiPct: 435,
      endowmentTarget: 48000000000,
      endowmentYr15: 740000000000,
      jobs: 250000,
      co2TonsAnnual: 5330000,
      mealsPerDay: 50000000
    });

    // Global: 500M students × 180 days × $1.82/meal = ~$163.8B state savings
    await storage.createScaleProjection({
      scale: "global",
      schools: 1000000,
      students: 500000000,
      greenhouses: 1000000,
      sqft: 8000000000,
      capex: 370000000000,
      annualRevenue: 163800000000,  // 500M × 180 days × $1.82/meal = ~$163.8B state savings
      annualOpex: 60000000000,
      npv5yr: 5700000000000,
      roiPct: 435,
      endowmentTarget: 370000000000,
      endowmentYr15: 5700000000000,
      jobs: 2000000,
      co2TonsAnnual: 41000000,
      mealsPerDay: 500000000
    });
  }

  if (isEmpty) {
    console.log("Seeding database with GAIA v4.1 MASTER PLATFORM data...");
    
    // Seed Pilot - 6 schools, 5630 students (corrected), 49250 sqft (from Python PILOT_SUMMARY)
    await storage.updatePilotStats({
      students: 5630,
      sqft: 49250,
      schools: 6,
      status: "live"
    });

    // Seed Endowment - v5.0 Updated ($5B statewide target @ 4.5% = $225M)
    await storage.updateEndowmentStats({
      size: "5.0B",
      annual: "225M",
      greenhouses: 1200
    });

    // Seed Financials (v4.1 from Python - 6 schools)
    await storage.updateFinancialMetrics({
      schoolCount: 6,
      initialInvestment: 2950000,
      annualOpex: 360000,
      yieldPerSchool: 120000,
      foodPricePerLb: 1.82,             // $1.82/meal state savings (1/3 of $5.45 meal cost)
      discountRate: 0.08,
      npv10yr: 12847000,
      roi10yrPct: 435,
      investmentPerSchool: 491667,
      opexPerSchool: 60000,
      annualRevenuePerSchool: 307000,   // Per school state savings: ~938 students × 180 days × $1.82/meal
      totalAnnualYield: 720000,
      totalAnnualRevenue: 1844000,     // Total state savings: 5,630 × 180 days × $1.82/meal = ~$1.84M
      paybackYears: 0.8
    });

    // Seed Climate (v5.0 ETL - 365-day year-round aquaponics)
    await storage.updateClimateMetrics({
      avgTemp: 45.2,
      growingSeasonDays: 365,
      co2Ppm: 425,
      annualTons: 246000,
      studentMealsAnnual: "175,000,000"
    });

    // Seed School Clusters (St. Paul and Mendota Heights from Python)
    // St. Paul: SPA 952 + Highland Park 1456 + Groveland 385 = 2793
    const stPaulCluster = await storage.createSchoolCluster({
      name: "Saint Paul",
      region: "St. Paul, MN",
      totalStudents: 2793,
      totalSqft: 22350,
      greenhouses: 3,
      yr5Students: 3212,
      co2TonsSequestered: 123000
    });
    
    const mendotaCluster = await storage.createSchoolCluster({
      name: "Mendota Heights",
      region: "Mendota Heights, MN",
      totalStudents: 2837,
      totalSqft: 22700,
      greenhouses: 3,
      yr5Students: 3262,
      co2TonsSequestered: 123000
    });

    // Seed Individual Schools (from Python ST_PAUL_CLUSTER and MENDOTA_CLUSTER)
    await storage.createSchool({ clusterId: stPaulCluster.id, name: "Saint Paul Academy (SPA)", enrollment: 952, grades: "PK-12", sqftTarget: 7600 });
    await storage.createSchool({ clusterId: stPaulCluster.id, name: "Highland Park High School", enrollment: 1456, grades: "9-12", sqftTarget: 11650 });
    await storage.createSchool({ clusterId: stPaulCluster.id, name: "Groveland Elementary", enrollment: 385, grades: "K-5", sqftTarget: 3100 });
    await storage.createSchool({ clusterId: mendotaCluster.id, name: "Saint Thomas Academy (STA)", enrollment: 588, grades: "6-12", sqftTarget: 4700 });
    await storage.createSchool({ clusterId: mendotaCluster.id, name: "Visitation School", enrollment: 601, grades: "PK-12", sqftTarget: 4800 });
    await storage.createSchool({ clusterId: mendotaCluster.id, name: "Two Rivers High School", enrollment: 1648, grades: "9-12", sqftTarget: 13200 });

    // Seed Environmental Impact by Scale
    await storage.createEnvironmentalImpact({
      scale: "pilot",
      co2SequesteredTons: 246,
      waterSavedGallons: 2500000,
      landPreservedAcres: 50,
      foodMilesReduced: 500000,
      renewableEnergyPct: 85,
      wasteReducedTons: 120
    });

    await storage.createEnvironmentalImpact({
      scale: "statewide",
      co2SequesteredTons: 11275,
      waterSavedGallons: 115000000,
      landPreservedAcres: 2300,
      foodMilesReduced: 23000000,
      renewableEnergyPct: 85,
      wasteReducedTons: 5500
    });

    await storage.createEnvironmentalImpact({
      scale: "national",
      co2SequesteredTons: 5330000,
      waterSavedGallons: 54000000000,
      landPreservedAcres: 1100000,
      foodMilesReduced: 11000000000,
      renewableEnergyPct: 85,
      wasteReducedTons: 2600000
    });

    await storage.createEnvironmentalImpact({
      scale: "global",
      co2SequesteredTons: 41000000,
      waterSavedGallons: 420000000000,
      landPreservedAcres: 8500000,
      foodMilesReduced: 85000000000,
      renewableEnergyPct: 85,
      wasteReducedTons: 20000000
    });

    // Seed Job Creation by Scale
    await storage.createJobCreation({
      scale: "pilot",
      directJobs: 24,
      indirectJobs: 8,
      inducedJobs: 4,
      totalJobs: 36,
      avgSalary: 52000,
      economicImpact: 1872000
    });

    await storage.createJobCreation({
      scale: "statewide",
      directJobs: 1100,
      indirectJobs: 380,
      inducedJobs: 170,
      totalJobs: 1650,
      avgSalary: 52000,
      economicImpact: 85800000
    });

    await storage.createJobCreation({
      scale: "national",
      directJobs: 165000,
      indirectJobs: 57500,
      inducedJobs: 27500,
      totalJobs: 250000,
      avgSalary: 52000,
      economicImpact: 13000000000
    });

    await storage.createJobCreation({
      scale: "global",
      directJobs: 1300000,
      indirectJobs: 480000,
      inducedJobs: 220000,
      totalJobs: 2000000,
      avgSalary: 45000,
      economicImpact: 90000000000
    });

    // Seed Legal Framework (from Python)
    await storage.createLegalFramework({
      entityName: "Gaia Commons Council",
      entityType: "501(c)(3) Nonprofit Trust",
      boardSize: 7,
      boardComposition: "Multi-Stakeholder: Schools, Donors, Ag Experts, Tribal Rep, Student Council",
      endowmentRules: "4% Annual Spend | Planetary Boundaries Clause | Inflation-Proof Principal",
      filings: "MN SOS Articles, IRS Form 1023, Endowment Trust Agreement",
      complianceHash: "sha256:gaia-pilot-v4.1"
    });

    // Seed Ballot Slide Deck (15 slides matching UI in BallotPresentation.tsx)
    const slides = [
      { n: 1, title: "One Vote, Forever Fed", text: "712,500 Students | $225M/Year | Forever - Minnesota 2026 Ballot Initiative" },
      { n: 2, title: "The Problem", text: "1 in 6 MN children face food insecurity | 87% of school produce from outside MN | $2.8B spent on out-of-state produce" },
      { n: 3, title: "Our Solution", text: "1,200 Greenhouses at high schools + Orchards + Exotic Trees + $5B Perpetual Endowment" },
      { n: 4, title: "What We'll Grow", text: "100+ Varieties: Salad Greens, Vegetables, Berries, Herbs & Specialty | 53.4M lb/year" },
      { n: 5, title: "Exotic Greenhouse Trees", text: "Year-Round Tropical Fruits: Meyer Lemons, Key Limes, Dwarf Bananas, Papaya, Avocado, Dragon Fruit" },
      { n: 6, title: "Outdoor Orchards", text: "Traditional Cold-Hardy Trees: Apple, Pear, Cherry, Peach + Nut Trees + Berry Bushes" },
      { n: 7, title: "The Endowment Model", text: "$5B Initial Endowment | 4.5% Annual Draw | $225M/Year Forever - Principal never touched" },
      { n: 8, title: "Jobs Created", text: "2,400 Permanent MN Jobs: 1,440 Greenhouse Staff + 240 Educators + 360 Distribution + 360 School Staff | 100% Union Labor $32-35/hr" },
      { n: 9, title: "vs. Foreign Mining", text: "Twin Metals (100% Chilean-owned, 50% profits abroad, temporary jobs) vs Gaia (100% MN-owned, 2,400 permanent jobs, forever)" },
      { n: 10, title: "330 School Districts", text: "712,500 Students | 330 Districts | 1,200 Greenhouses | 3,100+ Schools w/ Curriculum | Priority: Tribal food sovereignty" },
      { n: 11, title: "Land Conservation", text: "10% of Revenue: $22.5M Annual | $1.125B over 50 Years | 375K+ Acres Protected Forever" },
      { n: 12, title: "Environmental Impact", text: "9B Gallons Water Saved | 53,370 Tons CO2 Sequestered | 12.5M Food Miles Eliminated | Zero Pesticides" },
      { n: 13, title: "Educational Benefits", text: "STEM Integration + Agriculture + Career Pathways | K-12 participation from seed planting to internships" },
      { n: 14, title: "Scaling Beyond Minnesota", text: "Pilot (6 Schools) → Statewide (1,200 Greenhouses) → National (130K) → Global (1M Schools, 350M children, 6.5M jobs)" },
      { n: 15, title: "Vote YES in 2026", text: "330 Districts | 712,500 Students | Forever - One Vote to Feed Minnesota Forever" }
    ];
    for (const s of slides) {
      await storage.createSlide({ slideNumber: s.n, title: s.title, content: s.text });
    }

    // Seed Timeline - v4.1 Deliverables
    await storage.createTimelineEvent({ year: "2026 Q1", event: "St. Paul/Mendota 6-School Pilots Live" });
    await storage.createTimelineEvent({ year: "2026 Q2", event: "Principal Meetings Complete (Jan 20)" });
    await storage.createTimelineEvent({ year: "2026 Q4", event: "Ballot Signature Drive Begins" });
    await storage.createTimelineEvent({ year: "2027", event: "Statewide Expansion Planning" });
    await storage.createTimelineEvent({ year: "2028", event: "Constitutional Amendment Vote - $5B Funded" });
    await storage.createTimelineEvent({ year: "2029", event: "1,200 Greenhouses Deployed Statewide" });
    await storage.createTimelineEvent({ year: "2035", event: "National Rollout - 50 States" });
    await storage.createTimelineEvent({ year: "2040", event: "Global Deployment Initiated" });

    // Seed Historical Financials for Trend Analysis (starting 2026)
    const historicalData = [
      { year: 2026, quarter: 1, schoolCount: 6, totalRevenue: 915000, totalOpex: 90000, totalYieldLbs: 180000, endowmentValue: 5000000, studentsServed: 5630 },
      { year: 2026, quarter: 2, schoolCount: 6, totalRevenue: 915000, totalOpex: 90000, totalYieldLbs: 180000, endowmentValue: 5250000, studentsServed: 5630 },
      { year: 2026, quarter: 3, schoolCount: 6, totalRevenue: 915000, totalOpex: 90000, totalYieldLbs: 180000, endowmentValue: 5512000, studentsServed: 5630 },
      { year: 2026, quarter: 4, schoolCount: 6, totalRevenue: 915000, totalOpex: 90000, totalYieldLbs: 180000, endowmentValue: 5788000, studentsServed: 5630 },
      { year: 2027, quarter: 1, schoolCount: 25, totalRevenue: 3812500, totalOpex: 375000, totalYieldLbs: 750000, endowmentValue: 25000000, studentsServed: 23460 },
      { year: 2027, quarter: 2, schoolCount: 50, totalRevenue: 7625000, totalOpex: 750000, totalYieldLbs: 1500000, endowmentValue: 75000000, studentsServed: 46920 },
      { year: 2027, quarter: 3, schoolCount: 100, totalRevenue: 15250000, totalOpex: 1500000, totalYieldLbs: 3000000, endowmentValue: 175000000, studentsServed: 93840 },
      { year: 2027, quarter: 4, schoolCount: 150, totalRevenue: 22875000, totalOpex: 2250000, totalYieldLbs: 4500000, endowmentValue: 350000000, studentsServed: 140760 },
      { year: 2028, quarter: 1, schoolCount: 200, totalRevenue: 30500000, totalOpex: 3000000, totalYieldLbs: 6000000, endowmentValue: 700000000, studentsServed: 187680 },
      { year: 2028, quarter: 2, schoolCount: 225, totalRevenue: 34312500, totalOpex: 3375000, totalYieldLbs: 6750000, endowmentValue: 1050000000, studentsServed: 211140 },
      { year: 2028, quarter: 3, schoolCount: 250, totalRevenue: 38125000, totalOpex: 3750000, totalYieldLbs: 7500000, endowmentValue: 1400000000, studentsServed: 234600 },
      { year: 2028, quarter: 4, schoolCount: 350, totalRevenue: 52250000, totalOpex: 26250000, totalYieldLbs: 14940000, endowmentValue: 1500000000, studentsServed: 199170 },
      { year: 2029, quarter: 4, schoolCount: 1200, totalRevenue: 186900000, totalOpex: 90000000, totalYieldLbs: 53400000, endowmentValue: 5000000000, studentsServed: 712500 },
    ];
    for (const h of historicalData) {
      await storage.createHistoricalFinancial(h);
    }

    // Seed 50-Year Endowment Projections
    // Starting 2028 with $5B corpus @ 4.5% draw, 7% avg returns = 2.5% net growth per year
    // Formula: corpus = corpus × (1 + 0.07 - 0.045) = corpus × 1.025 annually
    const endowmentYears = [
      { year: 2028, corpus: 5000000000, annualDraw: 225000000, inflationAdjusted: 225000000 },
      { year: 2033, corpus: 5657000000, annualDraw: 255000000, inflationAdjusted: 210000000 },
      { year: 2038, corpus: 6400000000, annualDraw: 288000000, inflationAdjusted: 195000000 },
      { year: 2048, corpus: 8193000000, annualDraw: 369000000, inflationAdjusted: 185000000 },
      { year: 2058, corpus: 10491000000, annualDraw: 472000000, inflationAdjusted: 175000000 },
      { year: 2068, corpus: 13435000000, annualDraw: 605000000, inflationAdjusted: 170000000 },
      { year: 2078, corpus: 17203000000, annualDraw: 774000000, inflationAdjusted: 165000000 }
    ];
    for (const e of endowmentYears) {
      await storage.createEndowmentProjection(e);
    }

    // Seed Expanded Jobs Data (FTE + Internships + Volunteers + Construction from ballot deck)
    // Wages match or exceed Twin Metals mining wages (~$25-30/hr)
    // Construction jobs calculated at ~1 job per $100K construction spend
    await storage.createExpandedJobs({
      scale: "pilot",
      fteJobs: 36,
      studentInternships: 144,
      volunteerPositions: 66,
      hourlyWage: 28,
      directWages: 2100000,
      economicMultiplier: 2.4,
      // Pilot: 6 schools × 15K sqft = 90K sqft @ $85/sqft = $7.65M
      constructionJobs: 76,
      constructionGeneral: 30,
      constructionElectricians: 15,
      constructionPlumbers: 12,
      constructionHvac: 12,
      constructionSpecialists: 7,
      constructionWage: 35,
      constructionDurationYears: "1-2 years",
      constructionSpending: 7650000
    });
    await storage.createExpandedJobs({
      scale: "statewide",
      fteJobs: 2400,  // 2,400 FTE permanent jobs
      studentInternships: 9600,
      volunteerPositions: 4400,
      hourlyWage: 28,
      directWages: 140160000,  // 2400 jobs × $58,400 avg salary
      economicMultiplier: 2.4,
      // Statewide: 1,200 greenhouses × 7,500 sqft = 9M sqft @ $155/sqft avg = $1.39B
      constructionJobs: 13900,
      constructionGeneral: 5560,
      constructionElectricians: 2780,
      constructionPlumbers: 2085,
      constructionHvac: 2085,
      constructionSpecialists: 1390,
      constructionWage: 35,
      constructionDurationYears: "4 years (2026-2029)",
      constructionSpending: 1390000000
    });
    await storage.createExpandedJobs({
      scale: "national",
      fteJobs: 67500,
      studentInternships: 312000,
      volunteerPositions: 143000,
      hourlyWage: 26,
      directWages: 3650000000,
      economicMultiplier: 2.4,
      // National: 130K schools × 12K sqft avg = 1.56B sqft @ $75/sqft = $117B (economies of scale)
      constructionJobs: 1170000,
      constructionGeneral: 468000,
      constructionElectricians: 234000,
      constructionPlumbers: 175500,
      constructionHvac: 175500,
      constructionSpecialists: 117000,
      constructionWage: 32,
      constructionDurationYears: "10-15 years (rolling)",
      constructionSpending: 117000000000
    });
    await storage.createExpandedJobs({
      scale: "global",
      fteJobs: 520000,
      studentInternships: 2400000,
      volunteerPositions: 1100000,
      hourlyWage: 22,
      directWages: 23800000000,
      economicMultiplier: 2.2,
      // Global: 1M schools × 10K sqft avg = 10B sqft @ $65/sqft = $650B (global economies of scale)
      constructionJobs: 6500000,
      constructionGeneral: 2600000,
      constructionElectricians: 1300000,
      constructionPlumbers: 975000,
      constructionHvac: 975000,
      constructionSpecialists: 650000,
      constructionWage: 28,
      constructionDurationYears: "20-30 years (phased)",
      constructionSpending: 650000000000
    });

    // Seed K-12 NGSS Curriculum (from ballot deck slide 9) - Expanded with detailed units
    // Kindergarten
    await storage.createK12Curriculum({
      gradeRange: "K",
      title: "Seeds & Sprouts",
      description: "Introduction to plant life through hands-on seed planting. Students observe germination, learn plant parts (roots, stems, leaves), practice daily watering responsibility, and create plant journals with drawings. Culminates in 'Sprout Celebration' where students share their first harvest of microgreens.",
      durationWeeks: 6,
      standards: "NGSS: K-LS1-1 (What plants need), K-ESS2-2 (Weather patterns)"
    });
    await storage.createK12Curriculum({
      gradeRange: "1",
      title: "Garden Helpers",
      description: "Exploring the ecosystem of helpers in our greenhouse: earthworms, beneficial insects, and pollinators. Students create 'bug hotels', learn composting basics, identify helpful vs. harmful insects, and understand the food web. Field trips to observe bees and butterflies in action.",
      durationWeeks: 8,
      standards: "NGSS: 1-LS1-1 (Animal survival), 1-LS3-1 (Inheritance)"
    });
    await storage.createK12Curriculum({
      gradeRange: "2",
      title: "Soil Scientists",
      description: "Deep dive into soil health: texture, composition, and life underground. Students conduct soil tests, compare different growing mediums, learn about decomposition, and create terrariums. Introduction to the nutrient cycle through 'feeding the soil' activities with compost.",
      durationWeeks: 8,
      standards: "NGSS: 2-LS2-1 (Seed dispersal), 2-LS4-1 (Habitats), K-ESS3-1 (Human impact)"
    });
    // Elementary (3-5)
    await storage.createK12Curriculum({
      gradeRange: "3",
      title: "Plant Detectives",
      description: "Scientific observation and data collection. Students maintain growth charts, measure plant height/width weekly, learn to use digital thermometers and moisture meters, create graphs of growth data, and conduct simple experiments on light and water variables.",
      durationWeeks: 10,
      standards: "NGSS: 3-LS1-1 (Life cycles), 3-LS4-3 (Fossils & environment)"
    });
    await storage.createK12Curriculum({
      gradeRange: "4",
      title: "Energy Flow",
      description: "Understanding photosynthesis and the carbon cycle. Students trace energy from sun to plant to plate, learn about chlorophyll through leaf chromatography, explore how plants 'breathe' CO2, and calculate carbon sequestration of classroom plants. Introduction to renewable energy concepts.",
      durationWeeks: 12,
      standards: "NGSS: 4-LS1-1 (Plant structures), 4-PS3-2 (Energy transfer), 4-ESS3-1 (Energy resources)"
    });
    await storage.createK12Curriculum({
      gradeRange: "5",
      title: "Ecosystem Engineers",
      description: "Designing balanced ecosystems. Students create and manage mini aquaponic systems, understand nitrogen cycling, learn about symbiotic relationships, troubleshoot ecosystem problems, and present solutions. Capstone: Design a self-sustaining closed ecosystem.",
      durationWeeks: 14,
      standards: "NGSS: 5-LS2-1 (Ecosystem interactions), 5-PS3-1 (Energy in food), 5-ESS3-1 (Earth resources)"
    });
    // Middle School (6-8)
    await storage.createK12Curriculum({
      gradeRange: "6",
      title: "Hydroponic Systems",
      description: "Engineering hydroponic growing systems. Students learn water chemistry (pH, EC, nutrients), design and build NFT and DWC systems, calculate nutrient solutions, monitor water quality, and optimize growing conditions. Focus on STEM integration with math applications.",
      durationWeeks: 14,
      standards: "NGSS: MS-LS1-6 (Photosynthesis), MS-PS1-2 (Chemical reactions), MS-ETS1-4 (Design process)"
    });
    await storage.createK12Curriculum({
      gradeRange: "7",
      title: "Food Systems & Justice",
      description: "Examining food access, food deserts, and community solutions. Students map local food access, interview community members, analyze nutritional disparities, research food policy history, and design community food security proposals. Guest speakers from local food banks and urban farms.",
      durationWeeks: 12,
      standards: "NGSS: MS-LS2-1 (Resource competition), MS-LS2-3 (Ecosystem cycling), MS-ESS3-3 (Human impacts)"
    });
    await storage.createK12Curriculum({
      gradeRange: "8",
      title: "Regenerative Agriculture",
      description: "Soil health and sustainable farming practices. Students learn no-till methods, cover cropping, crop rotation, companion planting, and integrated pest management. Hands-on soil biology analysis using microscopes. Compare conventional vs. regenerative farming outcomes.",
      durationWeeks: 16,
      standards: "NGSS: MS-LS2-4 (Ecosystem disruption), MS-ESS3-4 (Human solutions), MS-ETS1-1 (Engineering criteria)"
    });
    // High School (9-12)
    await storage.createK12Curriculum({
      gradeRange: "9",
      title: "Climate Science & Agriculture",
      description: "Understanding climate change impacts on food systems. Students analyze climate data, model greenhouse gas emissions, study agricultural adaptation strategies, and examine the carbon footprint of food. Lab work includes soil carbon measurement and emissions calculations.",
      durationWeeks: 16,
      standards: "NGSS: HS-LS2-7 (Carbon cycling), HS-ESS2-4 (Energy balance), HS-ESS3-5 (Human impacts)"
    });
    await storage.createK12Curriculum({
      gradeRange: "10",
      title: "Agricultural Economics",
      description: "Business of sustainable food production. Students develop greenhouse business plans, analyze cost-benefit of different crops, learn supply chain management, calculate break-even points, and study cooperative economics. Partnerships with local farmers markets for real-world sales experience.",
      durationWeeks: 14,
      standards: "NGSS: HS-ETS1-3 (Design optimization), HS-ESS3-2 (Resource management)"
    });
    await storage.createK12Curriculum({
      gradeRange: "11",
      title: "Food Policy & Advocacy",
      description: "Civic engagement through food policy analysis. Students study Farm Bill history, analyze SNAP and school lunch programs, draft policy proposals, meet with local legislators, and learn advocacy strategies. Mock ballot initiative development and campaign planning.",
      durationWeeks: 18,
      standards: "NGSS: HS-ESS3-1 (Resource availability), HS-ESS3-4 (Sustainability solutions)"
    });
    await storage.createK12Curriculum({
      gradeRange: "12",
      title: "Capstone: Community Food Project",
      description: "Year-long capstone integrating all K-12 learning. Students design, propose, and implement a community food security project. Includes grant writing, community engagement, project management, outcome measurement, and final presentation to school board and community partners. Career pathway exploration in sustainable agriculture.",
      durationWeeks: 36,
      standards: "NGSS: HS-LS2-7, HS-ESS3-4, HS-ETS1-3 (Integrated application)"
    });

    console.log("K-12 curriculum seeded successfully");
  }

  // Seed Coalition Partners (independent block)
  const coalitionPartnersData = await storage.getCoalitionPartners();
  if (coalitionPartnersData.length === 0) {
    console.log("Seeding coalition partners...");
    // Tier 1 - Essential
    await storage.createCoalitionPartner({ tier: 1, name: "Minnesota Education Association", category: "Labor", memberCount: 200000, focus: "Teacher support, curriculum" });
    await storage.createCoalitionPartner({ tier: 1, name: "Minnesota AFL-CIO", category: "Labor", memberCount: 300000, focus: "Job creation, fair wages" });
    await storage.createCoalitionPartner({ tier: 1, name: "Sierra Club Minnesota", category: "Environmental", memberCount: 25000, focus: "Climate action, sustainability" });
    await storage.createCoalitionPartner({ tier: 1, name: "Minnesota Farmers Union", category: "Agriculture", memberCount: 20000, focus: "Local food systems" });
    // Tier 2 - Amplification
    await storage.createCoalitionPartner({ tier: 2, name: "NAACP Minnesota", category: "Equity", memberCount: 5000, focus: "Food equity, access" });
    await storage.createCoalitionPartner({ tier: 2, name: "Minnesota Council of Churches", category: "Faith", memberCount: 50000, focus: "Community outreach" });
    await storage.createCoalitionPartner({ tier: 2, name: "University of Minnesota", category: "Academic", memberCount: 70000, focus: "Research, ag extension" });
    await storage.createCoalitionPartner({ tier: 2, name: "Mayo Clinic", category: "Health", memberCount: 73000, focus: "Nutrition, public health" });
    // Tier 3 - Business (Top 10 Minnesota-Headquartered Corporations + Key Partners)
    await storage.createCoalitionPartner({ tier: 3, name: "UnitedHealth Group", category: "Healthcare", memberCount: null, focus: "Employee wellness, nutrition programs" });
    await storage.createCoalitionPartner({ tier: 3, name: "Target Corporation", category: "Retail", memberCount: null, focus: "Corporate sponsorship, supply chain" });
    await storage.createCoalitionPartner({ tier: 3, name: "Cargill", category: "Agriculture", memberCount: null, focus: "Ag technology, distribution" });
    await storage.createCoalitionPartner({ tier: 3, name: "Best Buy", category: "Technology", memberCount: null, focus: "Greenhouse automation, tech systems" });
    await storage.createCoalitionPartner({ tier: 3, name: "U.S. Bancorp", category: "Finance", memberCount: null, focus: "Endowment management, financing" });
    await storage.createCoalitionPartner({ tier: 3, name: "3M Company", category: "Manufacturing", memberCount: null, focus: "Sustainability tech, materials" });
    await storage.createCoalitionPartner({ tier: 3, name: "General Mills", category: "Food", memberCount: null, focus: "Food production, nutrition education" });
    await storage.createCoalitionPartner({ tier: 3, name: "C.H. Robinson", category: "Logistics", memberCount: null, focus: "Distribution, supply chain logistics" });
    await storage.createCoalitionPartner({ tier: 3, name: "Ameriprise Financial", category: "Finance", memberCount: null, focus: "Investment partnerships, funding" });
    await storage.createCoalitionPartner({ tier: 3, name: "Ecolab", category: "Environmental", memberCount: null, focus: "Water systems, hygiene solutions" });
    await storage.createCoalitionPartner({ tier: 3, name: "CHS Inc.", category: "Agriculture", memberCount: null, focus: "Agricultural cooperative, grain systems" });
    await storage.createCoalitionPartner({ tier: 3, name: "Minneapolis Chamber of Commerce", category: "Business", memberCount: 1200, focus: "Economic development" });
    console.log("Coalition partners seeded successfully");
  }

  // Seed Transparency Features (independent block)
  const transparencyData = await storage.getTransparencyFeatures();
  if (transparencyData.length === 0) {
    console.log("Seeding transparency features...");
    await storage.createTransparencyFeature({
      category: "Radical Visibility",
      feature: "Real-Time Dashboard",
      description: "Public quarterly dashboard showing corpus balance, investment performance, spending breakdown, production metrics",
      whoSees: "Politicians, school districts, students, stewards, media, auditors, public",
      fraudPrevention: "No hiding place - every dollar accounted for, visible, traceable"
    });
    await storage.createTransparencyFeature({
      category: "Distributed Construction",
      feature: "Visible Building Process",
      description: "Weekly construction photos, public permits, school staff inspections, budget transparency",
      whoSees: "Community, teachers, students, local media",
      fraudPrevention: "Can't hide cost overruns, shoddy construction, or corrupted contractors"
    });
    await storage.createTransparencyFeature({
      category: "Distributed Hiring",
      feature: "Local Jobs Transparency",
      description: "Local hiring preference, published wages, visible career ladder, equity tracking",
      whoSees: "Community, school boards, parents, unions",
      fraudPrevention: "Can't pay workers less, create fake jobs, or exploit workers secretly"
    });
    await storage.createTransparencyFeature({
      category: "Distributed Learning",
      feature: "Teacher-Controlled Curriculum",
      description: "Curriculum designed by K-12 educators, public lesson plans, tracked student outcomes",
      whoSees: "Teachers, parents, students, auditors",
      fraudPrevention: "Can't fake learning outcomes or use curriculum as money-laundering"
    });
    await storage.createTransparencyFeature({
      category: "Distributed Governance",
      feature: "Community Board Elections",
      description: "3 of 13 seats elected by community, public meetings, published minutes, 10-year reviews",
      whoSees: "Voters, citizens, media, attorney general",
      fraudPrevention: "Can't control board indefinitely or hide governance decisions"
    });
    console.log("Transparency features seeded successfully");
  }

  // Seed Accountability Mechanisms (independent block)
  const accountabilityData = await storage.getAccountabilityMechanisms();
  if (accountabilityData.length === 0) {
    console.log("Seeding accountability mechanisms...");
    await storage.createAccountabilityMechanism({
      mechanism: "Big 4 Independent Audit",
      description: "Full financial and compliance audit by Deloitte, EY, PwC, or KPMG",
      frequency: "Annual",
      whoAudits: "External Big 4 auditor",
      visibility: "Results published publicly via Form 990 and IRS record"
    });
    await storage.createAccountabilityMechanism({
      mechanism: "Steward Review",
      description: "Major donors ($500K+) review financials and raise questions publicly",
      frequency: "Quarterly",
      whoAudits: "Steward Advisory Council",
      visibility: "Meeting documentation shared with stakeholders"
    });
    await storage.createAccountabilityMechanism({
      mechanism: "Community Inspection",
      description: "School staff, student interns, parents can visit greenhouses unannounced",
      frequency: "Ongoing",
      whoAudits: "Teachers, students, parents, journalists",
      visibility: "Open access policy for media and community members"
    });
    await storage.createAccountabilityMechanism({
      mechanism: "Board Elections",
      description: "3 community-elected seats with public candidates and debates",
      frequency: "Every 3 years",
      whoAudits: "Minnesota voters",
      visibility: "Public election process with recorded votes"
    });
    await storage.createAccountabilityMechanism({
      mechanism: "Multi-Layer Verification",
      description: "Multiple auditors prevent corruption - requires conspiracy of 3+ people",
      frequency: "Continuous",
      whoAudits: "Big 4 + Stewards + Community + Media",
      visibility: "Discovery is inevitable - public shame and legal prosecution for fraud"
    });
    console.log("Accountability mechanisms seeded successfully");
  }

  // Seed Calibration & Validation data if empty
  const boundariesData = await storage.getPlanetaryBoundaries();
  if (boundariesData.length === 0) {
    console.log("Seeding calibration and validation data...");
    
    // Planetary Boundaries (Steffen et al. 2015, updated Richardson et al. 2023)
    const boundaries = [
      { boundary: "Climate Change", currentValue: 1.2, safeLimit: 1.5, criticalLimit: 2.0, unit: "°C warming", source: "IPCC AR6 2023", status: "caution", description: "Atmospheric CO2 concentration driving global temperature rise" },
      { boundary: "Biosphere Integrity", currentValue: 0.82, safeLimit: 0.90, criticalLimit: 0.70, unit: "intact fraction", source: "Newbold et al. 2016", status: "caution", description: "Biodiversity loss and ecosystem degradation" },
      { boundary: "Land-System Change", currentValue: 0.69, safeLimit: 0.75, criticalLimit: 0.60, unit: "forest fraction", source: "FAO 2023", status: "caution", description: "Deforestation and land use conversion" },
      { boundary: "Nitrogen Cycle", currentValue: 1.8, safeLimit: 1.0, criticalLimit: 2.5, unit: "safe boundary ratio", source: "Steffen et al. 2015", status: "danger", description: "Industrial nitrogen fixation exceeding safe limits" },
      { boundary: "Phosphorus Cycle", currentValue: 2.1, safeLimit: 1.0, criticalLimit: 3.0, unit: "safe boundary ratio", source: "Steffen et al. 2015", status: "danger", description: "Phosphorus loading in freshwater systems" },
      { boundary: "Ocean Acidification", currentValue: 8.04, safeLimit: 8.10, criticalLimit: 7.95, unit: "pH units", source: "IPCC Ocean 2023", status: "caution", description: "CO2 absorption reducing ocean pH levels" }
    ];
    for (const b of boundaries) {
      await storage.createPlanetaryBoundary(b);
    }

    // Calibration Targets
    const targets = [
      { parameter: "Temperature Anomaly", dataSource: "NASA GISS Surface Temperature", targetAccuracy: 0.05, actualAccuracy: 0.03, validationPeriodStart: 2015, validationPeriodEnd: 2024, status: "passed", description: "Global mean surface temperature deviation from 1951-1980 baseline" },
      { parameter: "Renewable Energy Share", dataSource: "IEA World Energy Outlook", targetAccuracy: 0.02, actualAccuracy: 0.015, validationPeriodStart: 2020, validationPeriodEnd: 2024, status: "passed", description: "Share of renewables in global electricity generation" },
      { parameter: "CO2 Concentration", dataSource: "NOAA Global Monitoring Lab", targetAccuracy: 0.01, actualAccuracy: 0.008, validationPeriodStart: 2015, validationPeriodEnd: 2024, status: "passed", description: "Atmospheric CO2 measured at Mauna Loa Observatory" },
      { parameter: "Sea Level Rise", dataSource: "NASA Satellite Altimetry", targetAccuracy: 0.03, actualAccuracy: 0.025, validationPeriodStart: 2015, validationPeriodEnd: 2024, status: "passed", description: "Global mean sea level change from satellite measurements" },
      { parameter: "Arctic Ice Extent", dataSource: "NSIDC Sea Ice Index", targetAccuracy: 0.05, actualAccuracy: 0.045, validationPeriodStart: 2015, validationPeriodEnd: 2024, status: "passed", description: "September minimum Arctic sea ice extent" }
    ];
    for (const t of targets) {
      await storage.createCalibrationTarget(t);
    }

    // Model Maturity Levels
    const maturity = [
      { subsystem: "Climate Science", maturityLevel: "validated", description: "IPCC-aligned climate projections with multi-model ensemble validation", dataSourcesCount: 12, validationTests: 48, lastUpdated: "2024-01" },
      { subsystem: "Energy Transition", maturityLevel: "calibrated", description: "IEA-validated renewable deployment curves and cost trajectories", dataSourcesCount: 8, validationTests: 32, lastUpdated: "2024-01" },
      { subsystem: "Economic Modeling", maturityLevel: "calibrated", description: "World Bank GDP and inequality projections with regional calibration", dataSourcesCount: 6, validationTests: 24, lastUpdated: "2024-01" },
      { subsystem: "Agricultural Transformation", maturityLevel: "sandbox", description: "Regenerative agriculture scaling models under development", dataSourcesCount: 4, validationTests: 12, lastUpdated: "2024-01" },
      { subsystem: "Political Coalition", maturityLevel: "sandbox", description: "Voter behavior and coalition formation models", dataSourcesCount: 3, validationTests: 8, lastUpdated: "2024-01" }
    ];
    for (const m of maturity) {
      await storage.createModelMaturity(m);
    }

    // Historical Climate Data (2015-2024)
    const climateHistory = [
      { year: 2015, tempAnomaly: 0.90, co2Ppm: 400.8, seaLevelMm: 68.5, arcticIceExtent: 11.6, renewableShare: 0.234, globalGdpTrillion: 78.3, povertyRate: 0.098, carbonIntensity: 0.45 },
      { year: 2016, tempAnomaly: 1.02, co2Ppm: 404.2, seaLevelMm: 70.1, arcticIceExtent: 11.1, renewableShare: 0.248, globalGdpTrillion: 80.1, povertyRate: 0.094, carbonIntensity: 0.44 },
      { year: 2017, tempAnomaly: 0.92, co2Ppm: 406.6, seaLevelMm: 72.8, arcticIceExtent: 10.6, renewableShare: 0.259, globalGdpTrillion: 82.8, povertyRate: 0.091, carbonIntensity: 0.43 },
      { year: 2018, tempAnomaly: 0.85, co2Ppm: 408.5, seaLevelMm: 74.2, arcticIceExtent: 10.8, renewableShare: 0.269, globalGdpTrillion: 86.2, povertyRate: 0.088, carbonIntensity: 0.42 },
      { year: 2019, tempAnomaly: 0.98, co2Ppm: 411.4, seaLevelMm: 76.5, arcticIceExtent: 10.4, renewableShare: 0.278, globalGdpTrillion: 87.8, povertyRate: 0.085, carbonIntensity: 0.41 },
      { year: 2020, tempAnomaly: 1.02, co2Ppm: 414.2, seaLevelMm: 78.1, arcticIceExtent: 10.2, renewableShare: 0.288, globalGdpTrillion: 84.5, povertyRate: 0.091, carbonIntensity: 0.40 },
      { year: 2021, tempAnomaly: 0.85, co2Ppm: 416.5, seaLevelMm: 79.8, arcticIceExtent: 10.5, renewableShare: 0.295, globalGdpTrillion: 96.5, povertyRate: 0.088, carbonIntensity: 0.39 },
      { year: 2022, tempAnomaly: 0.89, co2Ppm: 421.1, seaLevelMm: 82.3, arcticIceExtent: 10.1, renewableShare: 0.305, globalGdpTrillion: 100.3, povertyRate: 0.085, carbonIntensity: 0.38 },
      { year: 2023, tempAnomaly: 1.17, co2Ppm: 424.0, seaLevelMm: 84.7, arcticIceExtent: 9.9, renewableShare: 0.315, globalGdpTrillion: 104.8, povertyRate: 0.082, carbonIntensity: 0.37 },
      { year: 2024, tempAnomaly: 1.21, co2Ppm: 427.2, seaLevelMm: 87.1, arcticIceExtent: 9.7, renewableShare: 0.325, globalGdpTrillion: 109.1, povertyRate: 0.079, carbonIntensity: 0.36 }
    ];
    for (const c of climateHistory) {
      await storage.createHistoricalClimateData(c);
    }

    console.log("Calibration and validation data seeded successfully");
  }

  // Seed Advanced Modeling data if empty
  const monteCarloData = await storage.getMonteCarloSimulations();
  if (monteCarloData.length === 0) {
    console.log("Seeding advanced modeling data...");
    
    // Monte Carlo Simulations - uncertainty analysis for key projections
    const monteCarloSims = [
      { parameter: "CO2 Sequestration", scale: "statewide", baselineValue: 53370, p10Value: 48033, p25Value: 50702, p50Value: 53370, p75Value: 56039, p90Value: 58707, iterations: 10000, confidenceLevel: 0.95, unit: "tons/year", description: "Annual CO2 sequestration from 9M sqft across 1,200 greenhouses" },
      { parameter: "Job Creation", scale: "statewide", baselineValue: 2400, p10Value: 2160, p25Value: 2280, p50Value: 2400, p75Value: 2520, p90Value: 2640, iterations: 10000, confidenceLevel: 0.95, unit: "FTE jobs", description: "Direct employment with economic multiplier effects" },
      { parameter: "Endowment Growth", scale: "statewide", baselineValue: 5000000000, p10Value: 4000000000, p25Value: 4500000000, p50Value: 5000000000, p75Value: 5500000000, p90Value: 6000000000, iterations: 10000, confidenceLevel: 0.95, unit: "USD", description: "15-year endowment projection with market volatility" },
      { parameter: "Student Meals Served", scale: "statewide", baselineValue: 712500, p10Value: 641250, p25Value: 676875, p50Value: 712500, p75Value: 748125, p90Value: 783750, iterations: 10000, confidenceLevel: 0.95, unit: "meals/day", description: "Daily meals with participation rate uncertainty" },
      { parameter: "Greenhouse Yield", scale: "statewide", baselineValue: 53400000, p10Value: 45390000, p25Value: 49395000, p50Value: 53400000, p75Value: 57405000, p90Value: 61410000, iterations: 10000, confidenceLevel: 0.95, unit: "lbs/year", description: "Annual produce yield (712,500 students × 75 lb/yr)" },
      { parameter: "Revenue Generation", scale: "national", baselineValue: 19500000000, p10Value: 15600000000, p25Value: 17550000000, p50Value: 19500000000, p75Value: 21450000000, p90Value: 23400000000, iterations: 10000, confidenceLevel: 0.95, unit: "USD/year", description: "National revenue with food price and demand uncertainty" }
    ];
    for (const mc of monteCarloSims) {
      await storage.createMonteCarloSimulation(mc);
    }

    // Scenario Comparisons - baseline vs optimistic vs conservative
    const scenarios = [
      { metric: "Greenhouses Deployed", category: "Infrastructure", baselineValue: 1200, optimisticValue: 1320, conservativeValue: 1080, unit: "greenhouses", description: "Number of high school greenhouses (7,500 sqft avg)", keyAssumptions: "Baseline: current plan; Optimistic: accelerated adoption; Conservative: regulatory delays" },
      { metric: "Year 5 Endowment", category: "Financial", baselineValue: 5000000000, optimisticValue: 6500000000, conservativeValue: 4000000000, unit: "USD", description: "Endowment value after 5 years of operation", keyAssumptions: "Baseline: 7% return; Optimistic: 10% return; Conservative: 5% return + higher costs" },
      { metric: "CO2 Reduction", category: "Climate", baselineValue: 53370, optimisticValue: 65000, conservativeValue: 45000, unit: "tons/year", description: "Annual CO2 sequestration and avoided emissions", keyAssumptions: "Baseline: standard yields; Optimistic: enhanced practices; Conservative: weather challenges" },
      { metric: "Jobs Created", category: "Economic", baselineValue: 2400, optimisticValue: 2800, conservativeValue: 2000, unit: "FTE", description: "Full-time equivalent employment", keyAssumptions: "Baseline: standard staffing; Optimistic: expanded services; Conservative: automation" },
      { metric: "Food Miles Saved", category: "Environmental", baselineValue: 12500000, optimisticValue: 18000000, conservativeValue: 9000000, unit: "miles/year", description: "Transportation emissions avoided through local production", keyAssumptions: "Baseline: current sourcing; Optimistic: full local; Conservative: partial implementation" },
      { metric: "Voter Support", category: "Political", baselineValue: 0.62, optimisticValue: 0.72, conservativeValue: 0.52, unit: "approval rate", description: "Expected ballot initiative approval", keyAssumptions: "Baseline: current polling; Optimistic: successful outreach; Conservative: opposition campaign" },
      { metric: "Implementation Speed", category: "Operations", baselineValue: 48, optimisticValue: 36, conservativeValue: 60, unit: "months to full scale", description: "Time to reach 1,200-greenhouse deployment (4 years)", keyAssumptions: "Baseline: standard timeline; Optimistic: streamlined permits; Conservative: supply chain issues" }
    ];
    for (const s of scenarios) {
      await storage.createScenarioComparison(s);
    }

    // Optimization Parameters - target-seeking analysis
    const optimizations = [
      { targetMetric: "Net Zero Carbon", optimizationType: "minimize", currentValue: 53370, targetValue: 75000, optimalValue: 70000, constraintName: "Budget Cap", constraintValue: 5000000000, unit: "tons CO2/year", feasibility: "achievable", description: "Maximize carbon sequestration within budget constraints" },
      { targetMetric: "ROI Maximization", optimizationType: "maximize", currentValue: 0.12, targetValue: 0.18, optimalValue: 0.165, constraintName: "Risk Tolerance", constraintValue: 0.15, unit: "annual return", feasibility: "achievable", description: "Optimize endowment returns within risk parameters" },
      { targetMetric: "Jobs per Dollar", optimizationType: "maximize", currentValue: 0.68, targetValue: 1.0, optimalValue: 0.85, constraintName: "Wage Floor", constraintValue: 18, unit: "jobs per $1M", feasibility: "partially achievable", description: "Maximize employment while maintaining living wages" },
      { targetMetric: "Student Coverage", optimizationType: "maximize", currentValue: 712500, targetValue: 800000, optimalValue: 750000, constraintName: "Greenhouse Capacity", constraintValue: 1200, unit: "students/day", feasibility: "achievable", description: "Maximize student participation within infrastructure" },
      { targetMetric: "Food Waste", optimizationType: "minimize", currentValue: 0.12, targetValue: 0.05, optimalValue: 0.06, constraintName: "Quality Standards", constraintValue: 0.95, unit: "waste fraction", feasibility: "achievable", description: "Minimize food waste while maintaining quality" }
    ];
    for (const o of optimizations) {
      await storage.createOptimizationParam(o);
    }

    // Sensitivity Analysis - parameter impact ranking
    const sensitivities = [
      { inputParameter: "Carbon Price", outputMetric: "Project NPV", baselineInput: 50, perturbationPct: 0.20, outputChange: 0.35, elasticity: 1.75, rank: 1, description: "Carbon pricing has highest impact on project value" },
      { inputParameter: "Endowment Return Rate", outputMetric: "Year 15 Value", baselineInput: 0.07, perturbationPct: 0.20, outputChange: 0.28, elasticity: 1.40, rank: 2, description: "Investment returns significantly affect long-term endowment" },
      { inputParameter: "Food Price Index", outputMetric: "Annual Revenue", baselineInput: 1.0, perturbationPct: 0.20, outputChange: 0.22, elasticity: 1.10, rank: 3, description: "Food prices directly impact greenhouse revenue" },
      { inputParameter: "Labor Costs", outputMetric: "Operating Margin", baselineInput: 18, perturbationPct: 0.20, outputChange: -0.18, elasticity: -0.90, rank: 4, description: "Wage increases reduce margins but support workers" },
      { inputParameter: "Energy Costs", outputMetric: "Operating Costs", baselineInput: 0.12, perturbationPct: 0.20, outputChange: 0.08, elasticity: 0.40, rank: 5, description: "Energy costs have moderate impact on operations" },
      { inputParameter: "Greenhouse Yield", outputMetric: "Meals Served", baselineInput: 18000, perturbationPct: 0.20, outputChange: 0.16, elasticity: 0.80, rank: 6, description: "Yield variation affects food security outcomes" },
      { inputParameter: "Student Participation", outputMetric: "Program Impact", baselineInput: 0.85, perturbationPct: 0.20, outputChange: 0.12, elasticity: 0.60, rank: 7, description: "Participation rates affect educational outcomes" }
    ];
    for (const s of sensitivities) {
      await storage.createSensitivityAnalysis(s);
    }

    console.log("Advanced modeling data seeded successfully");
  }

  // Seed Global Regeneration Regions for World Map
  const globalRegionsData = await storage.getGlobalRegenerationRegions();
  if (globalRegionsData.length === 0) {
    console.log("Seeding global regeneration regions data...");
    
    const regions = [
      { regionName: "Great Plains USA", countryCode: "US", latitude: 41.5, longitude: -99.8, category: "Regenerative Agriculture", projectName: "Great Plains Hemp & Grain Initiative", description: "Industrial hemp and diversified grain production on restored farmland", greenhouseFacilities: 450, jobsCreated: 285000, annualCarbonSequestrationTons: 45000000, peopleFed: 25000000, acresRestored: 28800000, waterSavedGallons: 850000000000, investmentMillions: 42000, status: "Active", impactHighlight: "Largest regenerative transition in US history" },
      { regionName: "California Central Valley", countryCode: "US", latitude: 36.7, longitude: -119.8, category: "Market Gardens", projectName: "Valley Food Forest Network", description: "Diversified market gardens and agroforestry replacing monoculture", greenhouseFacilities: 380, jobsCreated: 195000, annualCarbonSequestrationTons: 18000000, peopleFed: 18000000, acresRestored: 12500000, waterSavedGallons: 1200000000000, investmentMillions: 28000, status: "Active", impactHighlight: "80% reduction in water usage vs conventional" },
      { regionName: "Amazon Basin", countryCode: "BR", latitude: -3.4, longitude: -62.2, category: "Forest Restoration", projectName: "Amazon Agroforestry Alliance", description: "Reforestation with integrated food production systems", greenhouseFacilities: 120, jobsCreated: 450000, annualCarbonSequestrationTons: 120000000, peopleFed: 8000000, acresRestored: 45000000, waterSavedGallons: 0, investmentMillions: 18000, status: "Active", impactHighlight: "45M acres restored, carbon-negative by 2030" },
      { regionName: "Sahel Region", countryCode: "SN", latitude: 14.5, longitude: -14.5, category: "Desert Restoration", projectName: "Great Green Wall Initiative", description: "Combating desertification through regenerative practices", greenhouseFacilities: 85, jobsCreated: 380000, annualCarbonSequestrationTons: 35000000, peopleFed: 12000000, acresRestored: 30000000, waterSavedGallons: 450000000000, investmentMillions: 12000, status: "Active", impactHighlight: "Reversing desertification across 8,000km" },
      { regionName: "Northern Europe", countryCode: "DE", latitude: 51.2, longitude: 10.5, category: "Indoor Agriculture", projectName: "EU Climate-Smart Greenhouse Network", description: "High-tech greenhouse facilities for year-round production", greenhouseFacilities: 850, jobsCreated: 125000, annualCarbonSequestrationTons: 8500000, peopleFed: 35000000, acresRestored: 2500000, waterSavedGallons: 280000000000, investmentMillions: 35000, status: "Active", impactHighlight: "90% less water, zero pesticides" },
      { regionName: "Indo-Gangetic Plains", countryCode: "IN", latitude: 28.6, longitude: 77.2, category: "Regenerative Agriculture", projectName: "Bharat Regenerative Farming Mission", description: "Transitioning smallholder farms to regenerative practices", greenhouseFacilities: 220, jobsCreated: 2500000, annualCarbonSequestrationTons: 65000000, peopleFed: 180000000, acresRestored: 85000000, waterSavedGallons: 2100000000000, investmentMillions: 45000, status: "Active", impactHighlight: "180M people fed through regenerative systems" },
      { regionName: "East Africa", countryCode: "KE", latitude: -1.3, longitude: 36.8, category: "Food Security", projectName: "East African Food Sovereignty Network", description: "Community-owned greenhouse and permaculture systems", greenhouseFacilities: 165, jobsCreated: 520000, annualCarbonSequestrationTons: 22000000, peopleFed: 28000000, acresRestored: 18000000, waterSavedGallons: 380000000000, investmentMillions: 8500, status: "Active", impactHighlight: "28M food-secure, community ownership" },
      { regionName: "Southeast Asia", countryCode: "VN", latitude: 16.0, longitude: 108.0, category: "Agroforestry", projectName: "Mekong Regenerative Zone", description: "Rice-fish-tree integrated systems replacing monoculture", greenhouseFacilities: 180, jobsCreated: 680000, annualCarbonSequestrationTons: 42000000, peopleFed: 45000000, acresRestored: 25000000, waterSavedGallons: 680000000000, investmentMillions: 15000, status: "Active", impactHighlight: "45M people fed, 42M tons CO2 sequestered" },
      { regionName: "Australia Outback", countryCode: "AU", latitude: -25.3, longitude: 134.5, category: "Silvopasture", projectName: "Regenerative Rangelands Australia", description: "Holistic managed grazing with tree integration", greenhouseFacilities: 45, jobsCreated: 85000, annualCarbonSequestrationTons: 28000000, peopleFed: 5000000, acresRestored: 55000000, waterSavedGallons: 180000000000, investmentMillions: 9500, status: "Planning", impactHighlight: "55M acres restored, drought-resilient" },
      { regionName: "Mediterranean Basin", countryCode: "ES", latitude: 40.4, longitude: -3.7, category: "Drought-Resilient", projectName: "Mediterranean Food Forest Alliance", description: "Drought-resistant perennial food systems", greenhouseFacilities: 280, jobsCreated: 145000, annualCarbonSequestrationTons: 15000000, peopleFed: 22000000, acresRestored: 12000000, waterSavedGallons: 420000000000, investmentMillions: 18500, status: "Active", impactHighlight: "Climate adaptation model for dry regions" },
      { regionName: "Midwest USA", countryCode: "US", latitude: 46.0, longitude: -94.0, category: "School Greenhouses", projectName: "Minnesota Gaia Commons", description: "1,200 high school greenhouses (7,500 sqft avg, 9M sqft total) feeding 712,500 students 75 lb/yr", greenhouseFacilities: 1200, jobsCreated: 2400, annualCarbonSequestrationTons: 53370, peopleFed: 712500, acresRestored: 0, waterSavedGallons: 9000000000, investmentMillions: 5000, status: "Active", impactHighlight: "Anti-Boundary Waters mining alternative" },
      { regionName: "Southern Africa", countryCode: "ZA", latitude: -33.9, longitude: 18.4, category: "Water Security", projectName: "Cape Water-Food Nexus", description: "Integrated water harvesting and food production", greenhouseFacilities: 95, jobsCreated: 175000, annualCarbonSequestrationTons: 12000000, peopleFed: 15000000, acresRestored: 8500000, waterSavedGallons: 850000000000, investmentMillions: 11000, status: "Planning", impactHighlight: "Water-positive food production" },
      { regionName: "Central America", countryCode: "GT", latitude: 14.6, longitude: -90.5, category: "Indigenous Systems", projectName: "Mesoamerican Milpa Revival", description: "Traditional polyculture with modern enhancements", greenhouseFacilities: 65, jobsCreated: 280000, annualCarbonSequestrationTons: 18000000, peopleFed: 12000000, acresRestored: 9500000, waterSavedGallons: 220000000000, investmentMillions: 6500, status: "Active", impactHighlight: "Indigenous knowledge driving regeneration" },
      { regionName: "Eastern Europe", countryCode: "UA", latitude: 48.4, longitude: 31.2, category: "Soil Restoration", projectName: "Black Earth Revival", description: "Restoring degraded chernozem soils through regenerative practices", greenhouseFacilities: 185, jobsCreated: 320000, annualCarbonSequestrationTons: 38000000, peopleFed: 35000000, acresRestored: 28000000, waterSavedGallons: 480000000000, investmentMillions: 22000, status: "Planning", impactHighlight: "World's most fertile soils restored" },
      { regionName: "China Northeast", countryCode: "CN", latitude: 45.8, longitude: 126.5, category: "Carbon Farming", projectName: "Manchurian Carbon Initiative", description: "Large-scale carbon farming with food production", greenhouseFacilities: 520, jobsCreated: 850000, annualCarbonSequestrationTons: 85000000, peopleFed: 120000000, acresRestored: 45000000, waterSavedGallons: 1500000000000, investmentMillions: 55000, status: "Active", impactHighlight: "85M tons CO2 annually, 120M fed" }
    ];
    
    for (const region of regions) {
      await storage.createGlobalRegenerationRegion(region);
    }
    
    console.log("Global regeneration regions data seeded successfully");
  }

  // Seed Mining Alternative data (Twin Metals Replacement) if empty
  const miningAltData = await storage.getMiningAlternatives();
  if (miningAltData.length === 0) {
    console.log("Seeding mining alternatives data...");
    // Financial constants: $85/sqft construction, $12/sqft/year ops, 40 lbs/sqft/year production, $3.50/lb wholesale
    // 60% for schools, 40% excess for stores/markets
    const miningAlternatives = [
      {
        community: "Ely",
        county: "St. Louis",
        latitude: 47.9033,
        longitude: -91.8672,
        population: 3460,
        miningJobsPromised: 600,  // Updated: Twin Metals total ~1,500 jobs
        miningAvgSalary: 65000,
        miningDuration: "20-25 years (then depleted)",
        greenhouseComplexSqft: 225000,  // Halved from 450K
        greenhouseJobs: 270,
        greenhouseAvgSalary: 52000,
        schoolGreenhouseJobs: 25,
        totalGreenhouseJobs: 295,
        annualEndowmentFunding: 15340000,
        jobDuration: "Permanent (endowment-funded forever)",
        environmentalRisk: "None - clean food production",
        boundaryWatersImpact: "Protective - no sulfide mining pollution risk",
        economicMultiplier: 2.4,
        localFoodProduction: 9000000,  // 225K sqft × 40 lbs/sqft
        co2Sequestered: 6750,
        status: "Proposed Alternative",
        specialtyCrops: "Mushrooms, Microgreens, Specialty Peppers",
        suppliesAllSchools: "Yes - Supplies all 330 MN school districts",
        // Financial & Production
        annualProductionLbs: 9000000,      // 225K × 40 lbs/sqft
        schoolDistributionLbs: 5400000,    // 60% to schools
        excessForSaleLbs: 3600000,         // 40% excess for stores
        wholesalePricePerLb: 3.50,
        annualSalesRevenue: 12600000,      // 3.6M lbs × $3.50
        constructionCost: 19125000,        // 225K × $85
        annualOperatingCost: 2700000,      // 225K × $12
        netAnnualRevenue: 9900000,         // $12.6M - $2.7M ops
        // Distribution Infrastructure Jobs (for 3.6M lbs excess to stores/markets)
        sortingPackagingJobs: 12,          // ~1 per 300K lbs/year
        deliveryDriverJobs: 9,             // ~1 per 400K lbs/year
        warehouseLogisticsJobs: 3,         // Supervisors/coordinators
        totalDistributionJobs: 24,
        // School Distribution Jobs (for 5.4M lbs to 330 school districts)
        schoolSortingJobs: 18,             // Sorting/packaging for schools
        schoolDeliveryDrivers: 14,         // Refrigerated trucks to districts
        schoolLogisticsCoordinators: 4,    // Route planning/scheduling
        totalSchoolDistributionJobs: 36,
        grandTotalJobs: 355                // 295 greenhouse + 24 stores + 36 schools
      },
      {
        community: "Babbitt",
        county: "St. Louis",
        latitude: 47.7083,
        longitude: -91.9436,
        population: 1475,
        miningJobsPromised: 285,  // Updated: Twin Metals total ~1,500 jobs
        miningAvgSalary: 62000,
        miningDuration: "20-25 years (then depleted)",
        greenhouseComplexSqft: 127500,  // Halved from 255K
        greenhouseJobs: 153,
        greenhouseAvgSalary: 50000,
        schoolGreenhouseJobs: 12,
        totalGreenhouseJobs: 165,
        annualEndowmentFunding: 8250000,
        jobDuration: "Permanent (endowment-funded forever)",
        environmentalRisk: "None - clean food production",
        boundaryWatersImpact: "Protective - no sulfide mining pollution risk",
        economicMultiplier: 2.4,
        localFoodProduction: 5100000,
        co2Sequestered: 3825,
        status: "Proposed Alternative",
        specialtyCrops: "Edible Flowers, Exotic Herbs, Gourmet Greens",
        suppliesAllSchools: "Yes - Supplies all 330 MN school districts",
        // Financial & Production
        annualProductionLbs: 5100000,      // 127.5K × 40 lbs/sqft
        schoolDistributionLbs: 3060000,    // 60% to schools
        excessForSaleLbs: 2040000,         // 40% excess for stores
        wholesalePricePerLb: 3.50,
        annualSalesRevenue: 7140000,
        constructionCost: 10837500,        // 127.5K × $85
        annualOperatingCost: 1530000,      // 127.5K × $12
        netAnnualRevenue: 5610000,
        // Distribution Infrastructure Jobs (for 2.04M lbs excess to stores/markets)
        sortingPackagingJobs: 7,
        deliveryDriverJobs: 5,
        warehouseLogisticsJobs: 2,
        totalDistributionJobs: 14,
        // School Distribution Jobs (for 3.06M lbs to 330 school districts)
        schoolSortingJobs: 10,
        schoolDeliveryDrivers: 8,
        schoolLogisticsCoordinators: 2,
        totalSchoolDistributionJobs: 20,
        grandTotalJobs: 199                // 165 greenhouse + 14 stores + 20 schools
      },
      {
        community: "Hibbing",
        county: "St. Louis",
        latitude: 47.4272,
        longitude: -92.9378,
        population: 15560,
        miningJobsPromised: 400,  // Updated: Twin Metals total ~1,500 jobs
        miningAvgSalary: 64000,
        miningDuration: "20-25 years (then depleted)",
        greenhouseComplexSqft: 375000,  // Halved from 750K
        greenhouseJobs: 450,
        greenhouseAvgSalary: 52000,
        schoolGreenhouseJobs: 35,
        totalGreenhouseJobs: 485,
        annualEndowmentFunding: 25220000,
        jobDuration: "Permanent (endowment-funded forever)",
        environmentalRisk: "None - clean food production",
        boundaryWatersImpact: "Protective - no sulfide mining pollution risk",
        economicMultiplier: 2.4,
        localFoodProduction: 15000000,
        co2Sequestered: 11250,
        status: "Proposed Alternative",
        specialtyCrops: "Year-Round Strawberries, Specialty Melons, Heirloom Tomatoes",
        suppliesAllSchools: "Yes - Supplies all 330 MN school districts",
        // Financial & Production
        annualProductionLbs: 15000000,     // 375K × 40 lbs/sqft
        schoolDistributionLbs: 9000000,    // 60% to schools
        excessForSaleLbs: 6000000,         // 40% excess for stores
        wholesalePricePerLb: 3.50,
        annualSalesRevenue: 21000000,
        constructionCost: 31875000,        // 375K × $85
        annualOperatingCost: 4500000,
        netAnnualRevenue: 16500000,
        // Distribution Infrastructure Jobs (for 6M lbs excess to stores/markets - largest hub)
        sortingPackagingJobs: 20,
        deliveryDriverJobs: 15,
        warehouseLogisticsJobs: 5,
        totalDistributionJobs: 40,
        // School Distribution Jobs (for 9M lbs to 330 school districts - main hub)
        schoolSortingJobs: 30,
        schoolDeliveryDrivers: 23,
        schoolLogisticsCoordinators: 7,
        totalSchoolDistributionJobs: 60,
        grandTotalJobs: 585                // 485 greenhouse + 40 stores + 60 schools
      },
      {
        community: "Tower",
        county: "St. Louis",
        latitude: 47.8053,
        longitude: -92.2917,
        population: 490,
        miningJobsPromised: 60,   // Updated: Twin Metals total ~1,500 jobs
        miningAvgSalary: 58000,
        miningDuration: "20-25 years (then depleted)",
        greenhouseComplexSqft: 52500,   // Halved from 105K
        greenhouseJobs: 63,
        greenhouseAvgSalary: 48000,
        schoolGreenhouseJobs: 6,
        totalGreenhouseJobs: 69,
        annualEndowmentFunding: 3312000,
        jobDuration: "Permanent (endowment-funded forever)",
        environmentalRisk: "None - clean food production",
        boundaryWatersImpact: "Protective - no sulfide mining pollution risk",
        economicMultiplier: 2.4,
        localFoodProduction: 2100000,
        co2Sequestered: 1575,
        status: "Proposed Alternative",
        specialtyCrops: "Specialty Squash, Artisan Cucumbers",
        suppliesAllSchools: "Yes - Supplies all 330 MN school districts",
        // Financial & Production
        annualProductionLbs: 2100000,      // 52.5K × 40 lbs/sqft
        schoolDistributionLbs: 1260000,    // 60% to schools
        excessForSaleLbs: 840000,          // 40% excess for stores
        wholesalePricePerLb: 3.50,
        annualSalesRevenue: 2940000,
        constructionCost: 4462500,         // 52.5K × $85
        annualOperatingCost: 630000,
        netAnnualRevenue: 2310000,
        // Distribution Infrastructure Jobs (for 0.84M lbs excess to stores/markets - smallest)
        sortingPackagingJobs: 3,
        deliveryDriverJobs: 2,
        warehouseLogisticsJobs: 1,
        totalDistributionJobs: 6,
        // School Distribution Jobs (for 1.26M lbs to 330 school districts)
        schoolSortingJobs: 4,
        schoolDeliveryDrivers: 3,
        schoolLogisticsCoordinators: 1,
        totalSchoolDistributionJobs: 8,
        grandTotalJobs: 83                 // 69 greenhouse + 6 stores + 8 schools
      },
      {
        community: "Virginia",
        county: "St. Louis",
        latitude: 47.5233,
        longitude: -92.5364,
        population: 8060,
        miningJobsPromised: 155,  // Updated: Twin Metals total ~1,500 jobs
        miningAvgSalary: 60000,
        miningDuration: "20-25 years (then depleted)",
        greenhouseComplexSqft: 180000,  // Halved from 360K
        greenhouseJobs: 216,
        greenhouseAvgSalary: 50000,
        schoolGreenhouseJobs: 18,
        totalGreenhouseJobs: 234,
        annualEndowmentFunding: 11700000,
        jobDuration: "Permanent (endowment-funded forever)",
        environmentalRisk: "None - clean food production",
        boundaryWatersImpact: "Protective - no sulfide mining pollution risk",
        economicMultiplier: 2.4,
        localFoodProduction: 7200000,
        co2Sequestered: 5400,
        status: "Proposed Alternative",
        specialtyCrops: "Gourmet Mushrooms, Asian Vegetables, Baby Root Vegetables",
        suppliesAllSchools: "Yes - Supplies all 330 MN school districts",
        // Financial & Production
        annualProductionLbs: 7200000,      // 180K × 40 lbs/sqft
        schoolDistributionLbs: 4320000,    // 60% to schools
        excessForSaleLbs: 2880000,         // 40% excess for stores
        wholesalePricePerLb: 3.50,
        annualSalesRevenue: 10080000,
        constructionCost: 15300000,        // 180K × $85
        annualOperatingCost: 2160000,
        netAnnualRevenue: 7920000,
        // Distribution Infrastructure Jobs (for 2.88M lbs excess to stores/markets)
        sortingPackagingJobs: 10,
        deliveryDriverJobs: 7,
        warehouseLogisticsJobs: 3,
        totalDistributionJobs: 20,
        // School Distribution Jobs (for 4.32M lbs to 330 school districts)
        schoolSortingJobs: 14,
        schoolDeliveryDrivers: 11,
        schoolLogisticsCoordinators: 3,
        totalSchoolDistributionJobs: 28,
        grandTotalJobs: 282                // 234 greenhouse + 20 stores + 28 schools
      }
    ];
    
    for (const alt of miningAlternatives) {
      await storage.createMiningAlternative(alt);
    }
    
    console.log("Mining alternatives data seeded successfully");
  }
}


================================================================================
7. SHARED - shared/schema.ts (Database Schema)
================================================================================

import { pgTable, text, serial, integer, real, timestamp, jsonb } from "drizzle-orm/pg-core";
import { createInsertSchema } from "drizzle-zod";
import { z } from "zod";

// === TABLE DEFINITIONS ===

export const pilotStats = pgTable("pilot_stats", {
  id: serial("id").primaryKey(),
  students: integer("students").notNull(),
  sqft: integer("sqft").notNull(),
  schools: integer("schools").notNull(),
  status: text("status").notNull(),
});

// School Clusters (St. Paul and Mendota Heights)
export const schoolClusters = pgTable("school_clusters", {
  id: serial("id").primaryKey(),
  name: text("name").notNull(),
  region: text("region").notNull(),
  totalStudents: integer("total_students").notNull(),
  totalSqft: integer("total_sqft").notNull(),
  greenhouses: integer("greenhouses").notNull(),
  yr5Students: integer("yr5_students").notNull(),
  co2TonsSequestered: real("co2_tons_sequestered").notNull(),
});

// Individual Schools within Clusters
export const schools = pgTable("schools", {
  id: serial("id").primaryKey(),
  clusterId: integer("cluster_id").notNull(),
  name: text("name").notNull(),
  enrollment: integer("enrollment").notNull(),
  grades: text("grades").notNull(),
  sqftTarget: integer("sqft_target").notNull(),
});

// Multi-Scale Projections (Pilot, Statewide, National, Global)
export const scaleProjections = pgTable("scale_projections", {
  id: serial("id").primaryKey(),
  scale: text("scale").notNull(),
  schools: real("schools").notNull(),
  students: real("students").notNull(),
  greenhouses: real("greenhouses").notNull(),
  sqft: real("sqft").notNull(),
  capex: real("capex").notNull(),
  annualRevenue: real("annual_revenue").notNull(),
  annualOpex: real("annual_opex").notNull(),
  npv5yr: real("npv_5yr").notNull(),
  roiPct: real("roi_pct").notNull(),
  endowmentTarget: real("endowment_target").notNull(),
  endowmentYr15: real("endowment_yr15").notNull(),
  jobs: real("jobs").notNull(),
  co2TonsAnnual: real("co2_tons_annual").notNull(),
  mealsPerDay: real("meals_per_day").notNull(),
});

// Environmental Impact Metrics
export const environmentalImpact = pgTable("environmental_impact", {
  id: serial("id").primaryKey(),
  scale: text("scale").notNull(),
  co2SequesteredTons: real("co2_sequestered_tons").notNull(),
  waterSavedGallons: real("water_saved_gallons").notNull(),
  landPreservedAcres: real("land_preserved_acres").notNull(),
  foodMilesReduced: real("food_miles_reduced").notNull(),
  renewableEnergyPct: real("renewable_energy_pct").notNull(),
  wasteReducedTons: real("waste_reduced_tons").notNull(),
});

// Job Creation Projections
export const jobCreation = pgTable("job_creation", {
  id: serial("id").primaryKey(),
  scale: text("scale").notNull(),
  directJobs: integer("direct_jobs").notNull(),
  indirectJobs: integer("indirect_jobs").notNull(),
  inducedJobs: integer("induced_jobs").notNull(),
  totalJobs: integer("total_jobs").notNull(),
  avgSalary: real("avg_salary").notNull(),
  economicImpact: real("economic_impact").notNull(),
});

// Legal Framework and Governance
export const legalFramework = pgTable("legal_framework", {
  id: serial("id").primaryKey(),
  entityName: text("entity_name").notNull(),
  entityType: text("entity_type").notNull(),
  boardSize: integer("board_size").notNull(),
  boardComposition: text("board_composition").notNull(),
  endowmentRules: text("endowment_rules").notNull(),
  filings: text("filings").notNull(),
  complianceHash: text("compliance_hash"),
});

export const endowmentStats = pgTable("endowment_stats", {
  id: serial("id").primaryKey(),
  size: text("size").notNull(),
  annual: text("annual").notNull(),
  greenhouses: integer("greenhouses").notNull(),
});

export const timelineEvents = pgTable("timeline_events", {
  id: serial("id").primaryKey(),
  year: text("year").notNull(),
  event: text("event").notNull(),
});

// Advanced Financial Metrics
export const financialMetrics = pgTable("financial_metrics", {
  id: serial("id").primaryKey(),
  schoolCount: integer("school_count").notNull(),
  initialInvestment: real("initial_investment").notNull(),
  annualOpex: real("annual_opex").notNull(),
  yieldPerSchool: real("yield_per_school").notNull(),
  foodPricePerLb: real("food_price_per_lb").notNull(),
  discountRate: real("discount_rate").notNull(),
  npv10yr: real("npv_10yr").notNull(),
  roi10yrPct: real("roi_10yr_pct").notNull(),
  investmentPerSchool: real("investment_per_school").notNull(),
  opexPerSchool: real("opex_per_school").notNull(),
  annualRevenuePerSchool: real("annual_revenue_per_school").notNull(),
  totalAnnualYield: real("total_annual_yield").notNull(),
  totalAnnualRevenue: real("total_annual_revenue").notNull(),
  paybackYears: real("payback_years").notNull(),
  updatedAt: timestamp("updated_at").defaultNow(),
});

// Climate and Yield Metrics
export const climateMetrics = pgTable("climate_metrics", {
  id: serial("id").primaryKey(),
  avgTemp: real("avg_temp").notNull(),
  growingSeasonDays: integer("growing_season_days").notNull(),
  co2Ppm: integer("co2_ppm").notNull(),
  annualTons: real("annual_tons").notNull(),
  studentMealsAnnual: text("student_meals_annual").notNull(),
  updatedAt: timestamp("updated_at").defaultNow(),
});

// Slide Deck for Ballot Initiative
export const slideDeck = pgTable("slide_deck", {
  id: serial("id").primaryKey(),
  slideNumber: integer("slide_number").notNull(),
  title: text("title").notNull(),
  content: text("content").notNull(),
  chartData: jsonb("chart_data"),
});

// 50-Year Endowment Growth Projections
export const endowmentProjections = pgTable("endowment_projections", {
  id: serial("id").primaryKey(),
  year: integer("year").notNull(),
  corpus: real("corpus").notNull(),
  annualDraw: real("annual_draw").notNull(),
  inflationAdjusted: real("inflation_adjusted"),
});

// Expanded Job Creation (includes internships, volunteers, construction)
export const expandedJobs = pgTable("expanded_jobs", {
  id: serial("id").primaryKey(),
  scale: text("scale").notNull(),
  fteJobs: integer("fte_jobs").notNull(),
  studentInternships: integer("student_internships").notNull(),
  volunteerPositions: integer("volunteer_positions").notNull(),
  hourlyWage: real("hourly_wage").notNull(),
  directWages: real("direct_wages").notNull(),
  economicMultiplier: real("economic_multiplier").notNull(),
  // Construction Phase Jobs
  constructionJobs: integer("construction_jobs").default(0),
  constructionGeneral: integer("construction_general").default(0),
  constructionElectricians: integer("construction_electricians").default(0),
  constructionPlumbers: integer("construction_plumbers").default(0),
  constructionHvac: integer("construction_hvac").default(0),
  constructionSpecialists: integer("construction_specialists").default(0),
  constructionWage: real("construction_wage").default(35),
  constructionDurationYears: text("construction_duration_years"),
  constructionSpending: real("construction_spending").default(0),
});

// K-12 NGSS Curriculum
export const k12Curriculum = pgTable("k12_curriculum", {
  id: serial("id").primaryKey(),
  gradeRange: text("grade_range").notNull(),
  title: text("title").notNull(),
  description: text("description").notNull(),
  durationWeeks: integer("duration_weeks").notNull(),
  standards: text("standards").notNull(),
});

// Coalition Partners
export const coalitionPartners = pgTable("coalition_partners", {
  id: serial("id").primaryKey(),
  tier: integer("tier").notNull(),
  name: text("name").notNull(),
  category: text("category").notNull(),
  memberCount: integer("member_count"),
  focus: text("focus"),
});

// Funding Sources Breakdown
export const fundingSources = pgTable("funding_sources", {
  id: serial("id").primaryKey(),
  sourceType: text("source_type").notNull(),
  description: text("description").notNull(),
  targetAmount: real("target_amount").notNull(),
  percentage: real("percentage"),
  entities: text("entities"),
});

// Historical Financial Data for Trend Analysis
export const historicalFinancials = pgTable("historical_financials", {
  id: serial("id").primaryKey(),
  year: integer("year").notNull(),
  quarter: integer("quarter").notNull(),
  schoolCount: integer("school_count").notNull(),
  totalRevenue: real("total_revenue").notNull(),
  totalOpex: real("total_opex").notNull(),
  totalYieldLbs: real("total_yield_lbs").notNull(),
  endowmentValue: real("endowment_value").notNull(),
  studentsServed: integer("students_served").notNull(),
  createdAt: timestamp("created_at").defaultNow(),
});

// Transparency Features - Dashboard visibility
export const transparencyFeatures = pgTable("transparency_features", {
  id: serial("id").primaryKey(),
  category: text("category").notNull(),
  feature: text("feature").notNull(),
  description: text("description").notNull(),
  whoSees: text("who_sees").notNull(),
  fraudPrevention: text("fraud_prevention").notNull(),
});

// Accountability Mechanisms - Audit layers
export const accountabilityMechanisms = pgTable("accountability_mechanisms", {
  id: serial("id").primaryKey(),
  mechanism: text("mechanism").notNull(),
  description: text("description").notNull(),
  frequency: text("frequency").notNull(),
  whoAudits: text("who_audits").notNull(),
  visibility: text("visibility").notNull(),
});

// Tribal Partnerships - Sovereign nation food systems
export const tribalPartnerships = pgTable("tribal_partnerships", {
  id: serial("id").primaryKey(),
  tribeName: text("tribe_name").notNull(),
  location: text("location").notNull(),
  greenhouseCount: text("greenhouse_count").notNull(),
  jobsCreated: text("jobs_created").notNull(),
  hourlyWage: text("hourly_wage").notNull(),
  firstHarvest: text("first_harvest").notNull(),
  schoolsServed: text("schools_served").notNull(),
  studentsServed: integer("students_served").notNull(),
  annualSurplus: text("annual_surplus"),
  surplusSplit: text("surplus_split"),
  breakEvenYear: integer("break_even_year"),
  governance: text("governance").notNull(),
  complementaryProjects: text("complementary_projects"),
  status: text("status").notNull(),
});

// Implementation Timeline - Greenhouse rollout milestones
export const implementationTimeline = pgTable("implementation_timeline", {
  id: serial("id").primaryKey(),
  phase: text("phase").notNull(),
  quarter: text("quarter").notNull(),
  milestone: text("milestone").notNull(),
  details: text("details").notNull(),
  greenhouseCount: integer("greenhouse_count"),
  jobsCreated: integer("jobs_created"),
  studentsServed: integer("students_served"),
});

// Political Roadmap - Congressional district strategy
export const politicalRoadmap = pgTable("political_roadmap", {
  id: serial("id").primaryKey(),
  district: text("district").notNull(),
  supportLevel: text("support_level").notNull(),
  supportPct: text("support_pct").notNull(),
  strategy: text("strategy").notNull(),
  keyMessaging: text("key_messaging").notNull(),
});

// Stress Tests - Financial resilience scenarios
export const stressTests = pgTable("stress_tests", {
  id: serial("id").primaryKey(),
  scenario: text("scenario").notNull(),
  description: text("description").notNull(),
  impact: text("impact").notNull(),
  mitigation: text("mitigation").notNull(),
  solvencyProbability: text("solvency_probability").notNull(),
});

// Global Regeneration: Tiered Carbon Pricing
export const tieredCarbonPricing = pgTable("tiered_carbon_pricing", {
  id: serial("id").primaryKey(),
  tierName: text("tier_name").notNull(),
  thresholdMin: real("threshold_min").notNull(),
  thresholdMax: real("threshold_max"),
  carbonTaxRate: real("carbon_tax_rate").notNull(),
  description: text("description").notNull(),
  emissionFraction: real("emission_fraction").notNull(),
  reductionRate: real("reduction_rate").notNull(),
  businessSurvival: real("business_survival").notNull(),
  revenueMillions: real("revenue_millions"),
});

// Global Regeneration: Regenerative Agriculture Operations
export const regenerativeAgriculture = pgTable("regenerative_agriculture", {
  id: serial("id").primaryKey(),
  operationType: text("operation_type").notNull(),
  name: text("name").notNull(),
  description: text("description").notNull(),
  acresAllocated: real("acres_allocated").notNull(),
  revenuePerAcre: real("revenue_per_acre").notNull(),
  jobsPer1000Acres: real("jobs_per_1000_acres").notNull(),
  avgWage: real("avg_wage").notNull(),
  carbonSequestration: real("carbon_sequestration").notNull(),
  peopleFedPerAcre: real("people_fed_per_acre").notNull(),
  totalJobs: integer("total_jobs").notNull(),
  totalRevenue: real("total_revenue").notNull(),
  totalCarbonSequestered: real("total_carbon_sequestered").notNull(),
});

// Global Regeneration: Nationwide Food Security
export const nationwideFoodSecurity = pgTable("nationwide_food_security", {
  id: serial("id").primaryKey(),
  scope: text("scope").notNull(),
  totalStudents: integer("total_students").notNull(),
  facilitiesNeeded: integer("facilities_needed").notNull(),
  jobsCreated: integer("jobs_created").notNull(),
  constructionCost: real("construction_cost").notNull(),
  annualOperating: real("annual_operating").notNull(),
  co2ReductionTons: real("co2_reduction_tons").notNull(),
  waterSavingsGallons: real("water_savings_gallons").notNull(),
  pesticideElimination: text("pesticide_elimination").notNull(),
  replicationModel: text("replication_model").notNull(),
});

// Global Regeneration: Labor Transition Program
export const laborTransition = pgTable("labor_transition", {
  id: serial("id").primaryKey(),
  sector: text("sector").notNull(),
  workersAffected: integer("workers_affected").notNull(),
  avgWage: real("avg_wage").notNull(),
  incomeGuaranteeRate: real("income_guarantee_rate").notNull(),
  transitionDurationYears: integer("transition_duration_years").notNull(),
  retrainingCostPerWorker: real("retraining_cost_per_worker").notNull(),
  successRate: real("success_rate").notNull(),
  totalCost: real("total_cost").notNull(),
  choicePreservation: text("choice_preservation").notNull(),
});

// Global Regeneration: Political Coalition
export const politicalCoalition = pgTable("political_coalition", {
  id: serial("id").primaryKey(),
  groupName: text("group_name").notNull(),
  memberCount: integer("member_count").notNull(),
  description: text("description"),
  isCalculated: integer("is_calculated").default(0),
});

// Global Regeneration Summary
export const globalRegenerationSummary = pgTable("global_regeneration_summary", {
  id: serial("id").primaryKey(),
  totalJobsCreated: integer("total_jobs_created").notNull(),
  totalCoalitionSize: integer("total_coalition_size").notNull(),
  coalitionPercentage: real("coalition_percentage").notNull(),
  politicalPowerAssessment: text("political_power_assessment").notNull(),
  oppositionSize: integer("opposition_size").notNull(),
  coalitionAdvantage: text("coalition_advantage").notNull(),
  totalTransitionCosts: real("total_transition_costs").notNull(),
  choicePreservationAchieved: integer("choice_preservation_achieved").default(1),
});

// Mining Alternative - Twin Metals Replacement Jobs for Northern MN
export const miningAlternative = pgTable("mining_alternative", {
  id: serial("id").primaryKey(),
  community: text("community").notNull(),
  county: text("county").notNull(),
  latitude: real("latitude").notNull(),
  longitude: real("longitude").notNull(),
  population: integer("population").notNull(),
  miningJobsPromised: integer("mining_jobs_promised").notNull(),
  miningAvgSalary: real("mining_avg_salary").notNull(),
  miningDuration: text("mining_duration").notNull(),
  greenhouseComplexSqft: integer("greenhouse_complex_sqft").notNull(),
  greenhouseJobs: integer("greenhouse_jobs").notNull(),
  greenhouseAvgSalary: real("greenhouse_avg_salary").notNull(),
  schoolGreenhouseJobs: integer("school_greenhouse_jobs").notNull(),
  totalGreenhouseJobs: integer("total_greenhouse_jobs").notNull(),
  annualEndowmentFunding: real("annual_endowment_funding").notNull(),
  jobDuration: text("job_duration").notNull(),
  environmentalRisk: text("environmental_risk").notNull(),
  boundaryWatersImpact: text("boundary_waters_impact").notNull(),
  economicMultiplier: real("economic_multiplier").notNull(),
  localFoodProduction: real("local_food_production").notNull(),
  co2Sequestered: real("co2_sequestered").notNull(),
  status: text("status").notNull(),
  specialtyCrops: text("specialty_crops"),
  suppliesAllSchools: text("supplies_all_schools"),
  // Financial & Production Fields
  annualProductionLbs: real("annual_production_lbs"),
  schoolDistributionLbs: real("school_distribution_lbs"),
  excessForSaleLbs: real("excess_for_sale_lbs"),
  wholesalePricePerLb: real("wholesale_price_per_lb"),
  annualSalesRevenue: real("annual_sales_revenue"),
  constructionCost: real("construction_cost"),
  annualOperatingCost: real("annual_operating_cost"),
  netAnnualRevenue: real("net_annual_revenue"),
  // Distribution Infrastructure Jobs (for 40% excess to stores/markets)
  sortingPackagingJobs: integer("sorting_packaging_jobs"),
  deliveryDriverJobs: integer("delivery_driver_jobs"),
  warehouseLogisticsJobs: integer("warehouse_logistics_jobs"),
  totalDistributionJobs: integer("total_distribution_jobs"),
  // School Distribution Jobs (for 60% to 330 school districts)
  schoolSortingJobs: integer("school_sorting_jobs"),
  schoolDeliveryDrivers: integer("school_delivery_drivers"),
  schoolLogisticsCoordinators: integer("school_logistics_coordinators"),
  totalSchoolDistributionJobs: integer("total_school_distribution_jobs"),
  // Grand totals
  grandTotalJobs: integer("grand_total_jobs"),
});

// === INSERT SCHEMAS ===

export const insertPilotStatsSchema = createInsertSchema(pilotStats).omit({ id: true });
export const insertEndowmentStatsSchema = createInsertSchema(endowmentStats).omit({ id: true });
export const insertTimelineEventSchema = createInsertSchema(timelineEvents).omit({ id: true });
export const insertFinancialMetricsSchema = createInsertSchema(financialMetrics).omit({ id: true, updatedAt: true });
export const insertClimateMetricsSchema = createInsertSchema(climateMetrics).omit({ id: true, updatedAt: true });
export const insertSlideSchema = createInsertSchema(slideDeck).omit({ id: true });
export const insertHistoricalFinancialsSchema = createInsertSchema(historicalFinancials).omit({ id: true, createdAt: true });
export const insertSchoolClusterSchema = createInsertSchema(schoolClusters).omit({ id: true });
export const insertSchoolSchema = createInsertSchema(schools).omit({ id: true });
export const insertScaleProjectionSchema = createInsertSchema(scaleProjections).omit({ id: true });
export const insertEnvironmentalImpactSchema = createInsertSchema(environmentalImpact).omit({ id: true });
export const insertJobCreationSchema = createInsertSchema(jobCreation).omit({ id: true });
export const insertLegalFrameworkSchema = createInsertSchema(legalFramework).omit({ id: true });
export const insertEndowmentProjectionSchema = createInsertSchema(endowmentProjections).omit({ id: true });
export const insertExpandedJobsSchema = createInsertSchema(expandedJobs).omit({ id: true });
export const insertK12CurriculumSchema = createInsertSchema(k12Curriculum).omit({ id: true });
export const insertCoalitionPartnerSchema = createInsertSchema(coalitionPartners).omit({ id: true });
export const insertFundingSourceSchema = createInsertSchema(fundingSources).omit({ id: true });
export const insertTransparencyFeatureSchema = createInsertSchema(transparencyFeatures).omit({ id: true });
export const insertAccountabilityMechanismSchema = createInsertSchema(accountabilityMechanisms).omit({ id: true });
export const insertTribalPartnershipSchema = createInsertSchema(tribalPartnerships).omit({ id: true });
export const insertImplementationTimelineSchema = createInsertSchema(implementationTimeline).omit({ id: true });
export const insertPoliticalRoadmapSchema = createInsertSchema(politicalRoadmap).omit({ id: true });
export const insertStressTestSchema = createInsertSchema(stressTests).omit({ id: true });
export const insertTieredCarbonPricingSchema = createInsertSchema(tieredCarbonPricing).omit({ id: true });
export const insertRegenerativeAgricultureSchema = createInsertSchema(regenerativeAgriculture).omit({ id: true });
export const insertNationwideFoodSecuritySchema = createInsertSchema(nationwideFoodSecurity).omit({ id: true });
export const insertLaborTransitionSchema = createInsertSchema(laborTransition).omit({ id: true });
export const insertPoliticalCoalitionSchema = createInsertSchema(politicalCoalition).omit({ id: true });
export const insertGlobalRegenerationSummarySchema = createInsertSchema(globalRegenerationSummary).omit({ id: true });
export const insertMiningAlternativeSchema = createInsertSchema(miningAlternative).omit({ id: true });

// Planetary Boundaries (Steffen et al. 2015, updated Richardson et al. 2023)
export const planetaryBoundaries = pgTable("planetary_boundaries", {
  id: serial("id").primaryKey(),
  boundary: text("boundary").notNull(),
  currentValue: real("current_value").notNull(),
  safeLimit: real("safe_limit").notNull(),
  criticalLimit: real("critical_limit").notNull(),
  unit: text("unit").notNull(),
  source: text("source").notNull(),
  status: text("status").notNull(), // safe, caution, danger
  description: text("description").notNull(),
});

// Calibration Targets for model validation
export const calibrationTargets = pgTable("calibration_targets", {
  id: serial("id").primaryKey(),
  parameter: text("parameter").notNull(),
  dataSource: text("data_source").notNull(),
  targetAccuracy: real("target_accuracy").notNull(),
  actualAccuracy: real("actual_accuracy").notNull(),
  validationPeriodStart: integer("validation_period_start").notNull(),
  validationPeriodEnd: integer("validation_period_end").notNull(),
  status: text("status").notNull(), // passed, warning, failed
  description: text("description").notNull(),
});

// Model Maturity Levels
export const modelMaturity = pgTable("model_maturity", {
  id: serial("id").primaryKey(),
  subsystem: text("subsystem").notNull(),
  maturityLevel: text("maturity_level").notNull(), // sandbox, calibrated, validated
  description: text("description").notNull(),
  dataSourcesCount: integer("data_sources_count").notNull(),
  validationTests: integer("validation_tests").notNull(),
  lastUpdated: text("last_updated").notNull(),
});

// Historical Climate Data (2015-2024 for validation charts)
export const historicalClimateData = pgTable("historical_climate_data", {
  id: serial("id").primaryKey(),
  year: integer("year").notNull(),
  tempAnomaly: real("temp_anomaly").notNull(),
  co2Ppm: real("co2_ppm").notNull(),
  seaLevelMm: real("sea_level_mm").notNull(),
  arcticIceExtent: real("arctic_ice_extent").notNull(),
  renewableShare: real("renewable_share").notNull(),
  globalGdpTrillion: real("global_gdp_trillion").notNull(),
  povertyRate: real("poverty_rate").notNull(),
  carbonIntensity: real("carbon_intensity").notNull(),
});

// Monte Carlo Simulation Results
export const monteCarloSimulations = pgTable("monte_carlo_simulations", {
  id: serial("id").primaryKey(),
  parameter: text("parameter").notNull(),
  scale: text("scale").notNull(),
  baselineValue: real("baseline_value").notNull(),
  p10Value: real("p10_value").notNull(),
  p25Value: real("p25_value").notNull(),
  p50Value: real("p50_value").notNull(),
  p75Value: real("p75_value").notNull(),
  p90Value: real("p90_value").notNull(),
  iterations: integer("iterations").notNull(),
  confidenceLevel: real("confidence_level").notNull(),
  unit: text("unit").notNull(),
  description: text("description").notNull(),
});

// Scenario Comparisons (Baseline, Optimistic, Conservative)
export const scenarioComparisons = pgTable("scenario_comparisons", {
  id: serial("id").primaryKey(),
  metric: text("metric").notNull(),
  category: text("category").notNull(),
  baselineValue: real("baseline_value").notNull(),
  optimisticValue: real("optimistic_value").notNull(),
  conservativeValue: real("conservative_value").notNull(),
  unit: text("unit").notNull(),
  description: text("description").notNull(),
  keyAssumptions: text("key_assumptions").notNull(),
});

// Optimization Parameters
export const optimizationParams = pgTable("optimization_params", {
  id: serial("id").primaryKey(),
  targetMetric: text("target_metric").notNull(),
  optimizationType: text("optimization_type").notNull(),
  currentValue: real("current_value").notNull(),
  targetValue: real("target_value").notNull(),
  optimalValue: real("optimal_value").notNull(),
  constraintName: text("constraint_name").notNull(),
  constraintValue: real("constraint_value").notNull(),
  unit: text("unit").notNull(),
  feasibility: text("feasibility").notNull(),
  description: text("description").notNull(),
});

// Sensitivity Analysis Results
export const sensitivityAnalysis = pgTable("sensitivity_analysis", {
  id: serial("id").primaryKey(),
  inputParameter: text("input_parameter").notNull(),
  outputMetric: text("output_metric").notNull(),
  baselineInput: real("baseline_input").notNull(),
  perturbationPct: real("perturbation_pct").notNull(),
  outputChange: real("output_change").notNull(),
  elasticity: real("elasticity").notNull(),
  rank: integer("rank").notNull(),
  description: text("description").notNull(),
});

// Global Regeneration Regions - World Map Data
export const globalRegenerationRegions = pgTable("global_regeneration_regions", {
  id: serial("id").primaryKey(),
  regionName: text("region_name").notNull(),
  countryCode: text("country_code").notNull(),
  latitude: real("latitude").notNull(),
  longitude: real("longitude").notNull(),
  category: text("category").notNull(),
  projectName: text("project_name").notNull(),
  description: text("description").notNull(),
  greenhouseFacilities: integer("greenhouse_facilities").notNull(),
  jobsCreated: integer("jobs_created").notNull(),
  annualCarbonSequestrationTons: real("annual_carbon_sequestration_tons").notNull(),
  peopleFed: integer("people_fed").notNull(),
  acresRestored: real("acres_restored").notNull(),
  waterSavedGallons: real("water_saved_gallons").notNull(),
  investmentMillions: real("investment_millions").notNull(),
  status: text("status").notNull(),
  impactHighlight: text("impact_highlight").notNull(),
});

export const insertGlobalRegenerationRegionSchema = createInsertSchema(globalRegenerationRegions).omit({ id: true });


export const insertPlanetaryBoundariesSchema = createInsertSchema(planetaryBoundaries).omit({ id: true });
export const insertCalibrationTargetsSchema = createInsertSchema(calibrationTargets).omit({ id: true });
export const insertModelMaturitySchema = createInsertSchema(modelMaturity).omit({ id: true });
export const insertHistoricalClimateDataSchema = createInsertSchema(historicalClimateData).omit({ id: true });
export const insertMonteCarloSimulationsSchema = createInsertSchema(monteCarloSimulations).omit({ id: true });
export const insertScenarioComparisonsSchema = createInsertSchema(scenarioComparisons).omit({ id: true });
export const insertOptimizationParamsSchema = createInsertSchema(optimizationParams).omit({ id: true });
export const insertSensitivityAnalysisSchema = createInsertSchema(sensitivityAnalysis).omit({ id: true });

// === TYPES ===

// Select types
export type PilotStats = typeof pilotStats.$inferSelect;
export type EndowmentStats = typeof endowmentStats.$inferSelect;
export type TimelineEvent = typeof timelineEvents.$inferSelect;
export type FinancialMetric = typeof financialMetrics.$inferSelect;
export type ClimateMetric = typeof climateMetrics.$inferSelect;
export type Slide = typeof slideDeck.$inferSelect;
export type HistoricalFinancial = typeof historicalFinancials.$inferSelect;
export type SchoolCluster = typeof schoolClusters.$inferSelect;
export type School = typeof schools.$inferSelect;
export type ScaleProjection = typeof scaleProjections.$inferSelect;
export type EnvironmentalImpactType = typeof environmentalImpact.$inferSelect;
export type JobCreationType = typeof jobCreation.$inferSelect;
export type LegalFrameworkType = typeof legalFramework.$inferSelect;
export type EndowmentProjection = typeof endowmentProjections.$inferSelect;
export type ExpandedJobs = typeof expandedJobs.$inferSelect;
export type K12Curriculum = typeof k12Curriculum.$inferSelect;
export type CoalitionPartner = typeof coalitionPartners.$inferSelect;
export type FundingSource = typeof fundingSources.$inferSelect;
export type TransparencyFeature = typeof transparencyFeatures.$inferSelect;
export type AccountabilityMechanism = typeof accountabilityMechanisms.$inferSelect;
export type TribalPartnership = typeof tribalPartnerships.$inferSelect;
export type ImplementationTimelineType = typeof implementationTimeline.$inferSelect;
export type PoliticalRoadmapType = typeof politicalRoadmap.$inferSelect;
export type StressTest = typeof stressTests.$inferSelect;
export type TieredCarbonPricingType = typeof tieredCarbonPricing.$inferSelect;
export type RegenerativeAgricultureType = typeof regenerativeAgriculture.$inferSelect;
export type NationwideFoodSecurityType = typeof nationwideFoodSecurity.$inferSelect;
export type LaborTransitionType = typeof laborTransition.$inferSelect;
export type PoliticalCoalitionType = typeof politicalCoalition.$inferSelect;
export type GlobalRegenerationSummaryType = typeof globalRegenerationSummary.$inferSelect;
export type MiningAlternativeType = typeof miningAlternative.$inferSelect;
export type PlanetaryBoundaryType = typeof planetaryBoundaries.$inferSelect;
export type CalibrationTargetType = typeof calibrationTargets.$inferSelect;
export type ModelMaturityType = typeof modelMaturity.$inferSelect;
export type HistoricalClimateDataType = typeof historicalClimateData.$inferSelect;
export type MonteCarloSimulationType = typeof monteCarloSimulations.$inferSelect;
export type ScenarioComparisonType = typeof scenarioComparisons.$inferSelect;
export type OptimizationParamType = typeof optimizationParams.$inferSelect;
export type SensitivityAnalysisType = typeof sensitivityAnalysis.$inferSelect;
export type GlobalRegenerationRegionType = typeof globalRegenerationRegions.$inferSelect;

// Insert types
export type InsertPilotStats = z.infer<typeof insertPilotStatsSchema>;
export type InsertEndowmentStats = z.infer<typeof insertEndowmentStatsSchema>;
export type InsertTimelineEvent = z.infer<typeof insertTimelineEventSchema>;
export type InsertFinancialMetrics = z.infer<typeof insertFinancialMetricsSchema>;
export type InsertClimateMetrics = z.infer<typeof insertClimateMetricsSchema>;
export type InsertSlide = z.infer<typeof insertSlideSchema>;
export type InsertHistoricalFinancial = z.infer<typeof insertHistoricalFinancialsSchema>;
export type InsertSchoolCluster = z.infer<typeof insertSchoolClusterSchema>;
export type InsertSchool = z.infer<typeof insertSchoolSchema>;
export type InsertScaleProjection = z.infer<typeof insertScaleProjectionSchema>;
export type InsertEnvironmentalImpact = z.infer<typeof insertEnvironmentalImpactSchema>;
export type InsertJobCreation = z.infer<typeof insertJobCreationSchema>;
export type InsertLegalFramework = z.infer<typeof insertLegalFrameworkSchema>;
export type InsertEndowmentProjection = z.infer<typeof insertEndowmentProjectionSchema>;
export type InsertExpandedJobs = z.infer<typeof insertExpandedJobsSchema>;
export type InsertK12Curriculum = z.infer<typeof insertK12CurriculumSchema>;
export type InsertCoalitionPartner = z.infer<typeof insertCoalitionPartnerSchema>;
export type InsertFundingSource = z.infer<typeof insertFundingSourceSchema>;
export type InsertTransparencyFeature = z.infer<typeof insertTransparencyFeatureSchema>;
export type InsertAccountabilityMechanism = z.infer<typeof insertAccountabilityMechanismSchema>;
export type InsertTribalPartnership = z.infer<typeof insertTribalPartnershipSchema>;
export type InsertImplementationTimeline = z.infer<typeof insertImplementationTimelineSchema>;
export type InsertPoliticalRoadmap = z.infer<typeof insertPoliticalRoadmapSchema>;
export type InsertStressTest = z.infer<typeof insertStressTestSchema>;
export type InsertTieredCarbonPricing = z.infer<typeof insertTieredCarbonPricingSchema>;
export type InsertRegenerativeAgriculture = z.infer<typeof insertRegenerativeAgricultureSchema>;
export type InsertNationwideFoodSecurity = z.infer<typeof insertNationwideFoodSecuritySchema>;
export type InsertLaborTransition = z.infer<typeof insertLaborTransitionSchema>;
export type InsertPoliticalCoalition = z.infer<typeof insertPoliticalCoalitionSchema>;
export type InsertGlobalRegenerationSummary = z.infer<typeof insertGlobalRegenerationSummarySchema>;
export type InsertMiningAlternative = z.infer<typeof insertMiningAlternativeSchema>;
export type InsertPlanetaryBoundary = z.infer<typeof insertPlanetaryBoundariesSchema>;
export type InsertCalibrationTarget = z.infer<typeof insertCalibrationTargetsSchema>;
export type InsertModelMaturity = z.infer<typeof insertModelMaturitySchema>;
export type InsertHistoricalClimateData = z.infer<typeof insertHistoricalClimateDataSchema>;
export type InsertMonteCarloSimulation = z.infer<typeof insertMonteCarloSimulationsSchema>;
export type InsertScenarioComparison = z.infer<typeof insertScenarioComparisonsSchema>;
export type InsertOptimizationParam = z.infer<typeof insertOptimizationParamsSchema>;
export type InsertSensitivityAnalysis = z.infer<typeof insertSensitivityAnalysisSchema>;
export type InsertGlobalRegenerationRegion = z.infer<typeof insertGlobalRegenerationRegionSchema>;


================================================================================
8. BACKEND - server/storage.ts (Database Interface)
================================================================================

import { db } from "./db";
import {
  pilotStats, endowmentStats, timelineEvents, financialMetrics, climateMetrics, slideDeck, historicalFinancials,
  schoolClusters, schools, scaleProjections, environmentalImpact, jobCreation, legalFramework,
  endowmentProjections, expandedJobs, k12Curriculum, coalitionPartners, fundingSources,
  transparencyFeatures, accountabilityMechanisms, tribalPartnerships,
  implementationTimeline, politicalRoadmap, stressTests,
  tieredCarbonPricing, regenerativeAgriculture, nationwideFoodSecurity, laborTransition, politicalCoalition, globalRegenerationSummary,
  planetaryBoundaries, calibrationTargets, modelMaturity, historicalClimateData,
  monteCarloSimulations, scenarioComparisons, optimizationParams, sensitivityAnalysis,
  type PilotStats, type InsertPilotStats,
  type EndowmentStats, type InsertEndowmentStats,
  type TimelineEvent, type InsertTimelineEvent,
  type FinancialMetric, type InsertFinancialMetrics,
  type ClimateMetric, type InsertClimateMetrics,
  type Slide, type InsertSlide,
  type HistoricalFinancial, type InsertHistoricalFinancial,
  type SchoolCluster, type InsertSchoolCluster,
  type School, type InsertSchool,
  type ScaleProjection, type InsertScaleProjection,
  type EnvironmentalImpactType, type InsertEnvironmentalImpact,
  type JobCreationType, type InsertJobCreation,
  type LegalFrameworkType, type InsertLegalFramework,
  type EndowmentProjection, type InsertEndowmentProjection,
  type ExpandedJobs, type InsertExpandedJobs,
  type K12Curriculum, type InsertK12Curriculum,
  type CoalitionPartner, type InsertCoalitionPartner,
  type FundingSource, type InsertFundingSource,
  type TransparencyFeature, type InsertTransparencyFeature,
  type AccountabilityMechanism, type InsertAccountabilityMechanism,
  type TribalPartnership, type InsertTribalPartnership,
  type ImplementationTimelineType, type InsertImplementationTimeline,
  type PoliticalRoadmapType, type InsertPoliticalRoadmap,
  type StressTest, type InsertStressTest,
  type TieredCarbonPricingType, type InsertTieredCarbonPricing,
  type RegenerativeAgricultureType, type InsertRegenerativeAgriculture,
  type NationwideFoodSecurityType, type InsertNationwideFoodSecurity,
  type LaborTransitionType, type InsertLaborTransition,
  type PoliticalCoalitionType, type InsertPoliticalCoalition,
  type GlobalRegenerationSummaryType, type InsertGlobalRegenerationSummary,
  type PlanetaryBoundaryType, type InsertPlanetaryBoundary,
  type CalibrationTargetType, type InsertCalibrationTarget,
  type ModelMaturityType, type InsertModelMaturity,
  type HistoricalClimateDataType, type InsertHistoricalClimateData,
  type MonteCarloSimulationType, type InsertMonteCarloSimulation,
  type ScenarioComparisonType, type InsertScenarioComparison,
  type OptimizationParamType, type InsertOptimizationParam,
  type SensitivityAnalysisType, type InsertSensitivityAnalysis,
  globalRegenerationRegions,
  type GlobalRegenerationRegionType, type InsertGlobalRegenerationRegion,
  miningAlternative,
  type MiningAlternativeType, type InsertMiningAlternative
} from "@shared/schema";
import { eq, asc } from "drizzle-orm";

export interface IStorage {
  getPilotStats(): Promise<PilotStats | undefined>;
  updatePilotStats(stats: InsertPilotStats): Promise<PilotStats>;
  getEndowmentStats(): Promise<EndowmentStats | undefined>;
  updateEndowmentStats(stats: InsertEndowmentStats): Promise<EndowmentStats>;
  getTimelineEvents(): Promise<TimelineEvent[]>;
  createTimelineEvent(event: InsertTimelineEvent): Promise<TimelineEvent>;
  getFinancialMetrics(): Promise<FinancialMetric | undefined>;
  updateFinancialMetrics(metrics: InsertFinancialMetrics): Promise<FinancialMetric>;
  getClimateMetrics(): Promise<ClimateMetric | undefined>;
  updateClimateMetrics(metrics: InsertClimateMetrics): Promise<ClimateMetric>;
  getSlides(): Promise<Slide[]>;
  createSlide(slide: InsertSlide): Promise<Slide>;
  getHistoricalFinancials(): Promise<HistoricalFinancial[]>;
  createHistoricalFinancial(data: InsertHistoricalFinancial): Promise<HistoricalFinancial>;
  getSchoolClusters(): Promise<SchoolCluster[]>;
  createSchoolCluster(cluster: InsertSchoolCluster): Promise<SchoolCluster>;
  getSchools(): Promise<School[]>;
  getSchoolsByCluster(clusterId: number): Promise<School[]>;
  createSchool(school: InsertSchool): Promise<School>;
  getScaleProjections(): Promise<ScaleProjection[]>;
  getScaleProjection(scale: string): Promise<ScaleProjection | undefined>;
  createScaleProjection(projection: InsertScaleProjection): Promise<ScaleProjection>;
  getEnvironmentalImpacts(): Promise<EnvironmentalImpactType[]>;
  createEnvironmentalImpact(impact: InsertEnvironmentalImpact): Promise<EnvironmentalImpactType>;
  getJobCreations(): Promise<JobCreationType[]>;
  createJobCreation(job: InsertJobCreation): Promise<JobCreationType>;
  getLegalFramework(): Promise<LegalFrameworkType | undefined>;
  createLegalFramework(legal: InsertLegalFramework): Promise<LegalFrameworkType>;
  getEndowmentProjections(): Promise<EndowmentProjection[]>;
  createEndowmentProjection(proj: InsertEndowmentProjection): Promise<EndowmentProjection>;
  getExpandedJobs(): Promise<ExpandedJobs[]>;
  createExpandedJobs(job: InsertExpandedJobs): Promise<ExpandedJobs>;
  getK12Curriculum(): Promise<K12Curriculum[]>;
  createK12Curriculum(curr: InsertK12Curriculum): Promise<K12Curriculum>;
  getCoalitionPartners(): Promise<CoalitionPartner[]>;
  createCoalitionPartner(partner: InsertCoalitionPartner): Promise<CoalitionPartner>;
  getFundingSources(): Promise<FundingSource[]>;
  createFundingSource(source: InsertFundingSource): Promise<FundingSource>;
  getTransparencyFeatures(): Promise<TransparencyFeature[]>;
  createTransparencyFeature(feature: InsertTransparencyFeature): Promise<TransparencyFeature>;
  getAccountabilityMechanisms(): Promise<AccountabilityMechanism[]>;
  createAccountabilityMechanism(mechanism: InsertAccountabilityMechanism): Promise<AccountabilityMechanism>;
  getTribalPartnerships(): Promise<TribalPartnership[]>;
  createTribalPartnership(partnership: InsertTribalPartnership): Promise<TribalPartnership>;
  getImplementationTimeline(): Promise<ImplementationTimelineType[]>;
  createImplementationTimeline(item: InsertImplementationTimeline): Promise<ImplementationTimelineType>;
  getPoliticalRoadmap(): Promise<PoliticalRoadmapType[]>;
  createPoliticalRoadmap(item: InsertPoliticalRoadmap): Promise<PoliticalRoadmapType>;
  getStressTests(): Promise<StressTest[]>;
  createStressTest(item: InsertStressTest): Promise<StressTest>;
  getTieredCarbonPricing(): Promise<TieredCarbonPricingType[]>;
  createTieredCarbonPricing(item: InsertTieredCarbonPricing): Promise<TieredCarbonPricingType>;
  getRegenerativeAgriculture(): Promise<RegenerativeAgricultureType[]>;
  createRegenerativeAgriculture(item: InsertRegenerativeAgriculture): Promise<RegenerativeAgricultureType>;
  getNationwideFoodSecurity(): Promise<NationwideFoodSecurityType | undefined>;
  createNationwideFoodSecurity(item: InsertNationwideFoodSecurity): Promise<NationwideFoodSecurityType>;
  getLaborTransition(): Promise<LaborTransitionType[]>;
  createLaborTransition(item: InsertLaborTransition): Promise<LaborTransitionType>;
  getPoliticalCoalition(): Promise<PoliticalCoalitionType[]>;
  createPoliticalCoalition(item: InsertPoliticalCoalition): Promise<PoliticalCoalitionType>;
  getGlobalRegenerationSummary(): Promise<GlobalRegenerationSummaryType | undefined>;
  createGlobalRegenerationSummary(item: InsertGlobalRegenerationSummary): Promise<GlobalRegenerationSummaryType>;
  getPlanetaryBoundaries(): Promise<PlanetaryBoundaryType[]>;
  createPlanetaryBoundary(item: InsertPlanetaryBoundary): Promise<PlanetaryBoundaryType>;
  getCalibrationTargets(): Promise<CalibrationTargetType[]>;
  createCalibrationTarget(item: InsertCalibrationTarget): Promise<CalibrationTargetType>;
  getModelMaturity(): Promise<ModelMaturityType[]>;
  createModelMaturity(item: InsertModelMaturity): Promise<ModelMaturityType>;
  getHistoricalClimateData(): Promise<HistoricalClimateDataType[]>;
  createHistoricalClimateData(item: InsertHistoricalClimateData): Promise<HistoricalClimateDataType>;
  getMonteCarloSimulations(): Promise<MonteCarloSimulationType[]>;
  createMonteCarloSimulation(item: InsertMonteCarloSimulation): Promise<MonteCarloSimulationType>;
  getScenarioComparisons(): Promise<ScenarioComparisonType[]>;
  createScenarioComparison(item: InsertScenarioComparison): Promise<ScenarioComparisonType>;
  getOptimizationParams(): Promise<OptimizationParamType[]>;
  createOptimizationParam(item: InsertOptimizationParam): Promise<OptimizationParamType>;
  getSensitivityAnalysis(): Promise<SensitivityAnalysisType[]>;
  createSensitivityAnalysis(item: InsertSensitivityAnalysis): Promise<SensitivityAnalysisType>;
  getGlobalRegenerationRegions(): Promise<GlobalRegenerationRegionType[]>;
  createGlobalRegenerationRegion(item: InsertGlobalRegenerationRegion): Promise<GlobalRegenerationRegionType>;
  getMiningAlternatives(): Promise<MiningAlternativeType[]>;
  createMiningAlternative(item: InsertMiningAlternative): Promise<MiningAlternativeType>;
  isEmpty(): Promise<boolean>;
}

export class DatabaseStorage implements IStorage {
  async getPilotStats(): Promise<PilotStats | undefined> {
    const [stats] = await db.select().from(pilotStats).limit(1);
    return stats;
  }
  async updatePilotStats(stats: InsertPilotStats): Promise<PilotStats> {
    const existing = await this.getPilotStats();
    if (!existing) {
      const [newStats] = await db.insert(pilotStats).values(stats).returning();
      return newStats;
    }
    const [updated] = await db.update(pilotStats).set(stats).where(eq(pilotStats.id, existing.id)).returning();
    return updated;
  }
  async getEndowmentStats(): Promise<EndowmentStats | undefined> {
    const [stats] = await db.select().from(endowmentStats).limit(1);
    return stats;
  }
  async updateEndowmentStats(stats: InsertEndowmentStats): Promise<EndowmentStats> {
    const existing = await this.getEndowmentStats();
    if (!existing) {
      const [newStats] = await db.insert(endowmentStats).values(stats).returning();
      return newStats;
    }
    const [updated] = await db.update(endowmentStats).set(stats).where(eq(endowmentStats.id, existing.id)).returning();
    return updated;
  }
  async getTimelineEvents(): Promise<TimelineEvent[]> {
    return await db.select().from(timelineEvents).orderBy(timelineEvents.year);
  }
  async createTimelineEvent(event: InsertTimelineEvent): Promise<TimelineEvent> {
    const [newEvent] = await db.insert(timelineEvents).values(event).returning();
    return newEvent;
  }
  async getFinancialMetrics(): Promise<FinancialMetric | undefined> {
    const [m] = await db.select().from(financialMetrics).limit(1);
    return m;
  }
  async updateFinancialMetrics(metrics: InsertFinancialMetrics): Promise<FinancialMetric> {
    const existing = await this.getFinancialMetrics();
    if (!existing) {
      const [nm] = await db.insert(financialMetrics).values(metrics).returning();
      return nm;
    }
    const [up] = await db.update(financialMetrics).set(metrics).where(eq(financialMetrics.id, existing.id)).returning();
    return up;
  }
  async getClimateMetrics(): Promise<ClimateMetric | undefined> {
    const [m] = await db.select().from(climateMetrics).limit(1);
    return m;
  }
  async updateClimateMetrics(metrics: InsertClimateMetrics): Promise<ClimateMetric> {
    const existing = await this.getClimateMetrics();
    if (!existing) {
      const [nm] = await db.insert(climateMetrics).values(metrics).returning();
      return nm;
    }
    const [up] = await db.update(climateMetrics).set(metrics).where(eq(climateMetrics.id, existing.id)).returning();
    return up;
  }
  async getSlides(): Promise<Slide[]> {
    return await db.select().from(slideDeck).orderBy(slideDeck.slideNumber);
  }
  async createSlide(slide: InsertSlide): Promise<Slide> {
    const [s] = await db.insert(slideDeck).values(slide).returning();
    return s;
  }
  async getHistoricalFinancials(): Promise<HistoricalFinancial[]> {
    return await db.select().from(historicalFinancials).orderBy(asc(historicalFinancials.year), asc(historicalFinancials.quarter));
  }
  async createHistoricalFinancial(data: InsertHistoricalFinancial): Promise<HistoricalFinancial> {
    const [h] = await db.insert(historicalFinancials).values(data).returning();
    return h;
  }
  async getSchoolClusters(): Promise<SchoolCluster[]> {
    return await db.select().from(schoolClusters);
  }
  async createSchoolCluster(cluster: InsertSchoolCluster): Promise<SchoolCluster> {
    const [c] = await db.insert(schoolClusters).values(cluster).returning();
    return c;
  }
  async getSchools(): Promise<School[]> {
    return await db.select().from(schools);
  }
  async getSchoolsByCluster(clusterId: number): Promise<School[]> {
    return await db.select().from(schools).where(eq(schools.clusterId, clusterId));
  }
  async createSchool(school: InsertSchool): Promise<School> {
    const [s] = await db.insert(schools).values(school).returning();
    return s;
  }
  async getScaleProjections(): Promise<ScaleProjection[]> {
    return await db.select().from(scaleProjections);
  }
  async getScaleProjection(scale: string): Promise<ScaleProjection | undefined> {
    const [p] = await db.select().from(scaleProjections).where(eq(scaleProjections.scale, scale));
    return p;
  }
  async createScaleProjection(projection: InsertScaleProjection): Promise<ScaleProjection> {
    const [p] = await db.insert(scaleProjections).values(projection).returning();
    return p;
  }
  async getEnvironmentalImpacts(): Promise<EnvironmentalImpactType[]> {
    return await db.select().from(environmentalImpact);
  }
  async createEnvironmentalImpact(impact: InsertEnvironmentalImpact): Promise<EnvironmentalImpactType> {
    const [i] = await db.insert(environmentalImpact).values(impact).returning();
    return i;
  }
  async getJobCreations(): Promise<JobCreationType[]> {
    return await db.select().from(jobCreation);
  }
  async createJobCreation(job: InsertJobCreation): Promise<JobCreationType> {
    const [j] = await db.insert(jobCreation).values(job).returning();
    return j;
  }
  async getLegalFramework(): Promise<LegalFrameworkType | undefined> {
    const [l] = await db.select().from(legalFramework).limit(1);
    return l;
  }
  async createLegalFramework(legal: InsertLegalFramework): Promise<LegalFrameworkType> {
    const [l] = await db.insert(legalFramework).values(legal).returning();
    return l;
  }
  async getEndowmentProjections(): Promise<EndowmentProjection[]> {
    return await db.select().from(endowmentProjections).orderBy(asc(endowmentProjections.year));
  }
  async createEndowmentProjection(proj: InsertEndowmentProjection): Promise<EndowmentProjection> {
    const [p] = await db.insert(endowmentProjections).values(proj).returning();
    return p;
  }
  async getExpandedJobs(): Promise<ExpandedJobs[]> {
    return await db.select().from(expandedJobs);
  }
  async createExpandedJobs(job: InsertExpandedJobs): Promise<ExpandedJobs> {
    const [j] = await db.insert(expandedJobs).values(job).returning();
    return j;
  }
  async getK12Curriculum(): Promise<K12Curriculum[]> {
    return await db.select().from(k12Curriculum);
  }
  async createK12Curriculum(curr: InsertK12Curriculum): Promise<K12Curriculum> {
    const [c] = await db.insert(k12Curriculum).values(curr).returning();
    return c;
  }
  async getCoalitionPartners(): Promise<CoalitionPartner[]> {
    return await db.select().from(coalitionPartners).orderBy(asc(coalitionPartners.tier));
  }
  async createCoalitionPartner(partner: InsertCoalitionPartner): Promise<CoalitionPartner> {
    const [p] = await db.insert(coalitionPartners).values(partner).returning();
    return p;
  }
  async getFundingSources(): Promise<FundingSource[]> {
    return await db.select().from(fundingSources);
  }
  async createFundingSource(source: InsertFundingSource): Promise<FundingSource> {
    const [s] = await db.insert(fundingSources).values(source).returning();
    return s;
  }
  async getTransparencyFeatures(): Promise<TransparencyFeature[]> {
    return await db.select().from(transparencyFeatures);
  }
  async createTransparencyFeature(feature: InsertTransparencyFeature): Promise<TransparencyFeature> {
    const [f] = await db.insert(transparencyFeatures).values(feature).returning();
    return f;
  }
  async getAccountabilityMechanisms(): Promise<AccountabilityMechanism[]> {
    return await db.select().from(accountabilityMechanisms);
  }
  async createAccountabilityMechanism(mechanism: InsertAccountabilityMechanism): Promise<AccountabilityMechanism> {
    const [m] = await db.insert(accountabilityMechanisms).values(mechanism).returning();
    return m;
  }
  async getTribalPartnerships(): Promise<TribalPartnership[]> {
    return await db.select().from(tribalPartnerships);
  }
  async createTribalPartnership(partnership: InsertTribalPartnership): Promise<TribalPartnership> {
    const [p] = await db.insert(tribalPartnerships).values(partnership).returning();
    return p;
  }
  async getImplementationTimeline(): Promise<ImplementationTimelineType[]> {
    return await db.select().from(implementationTimeline);
  }
  async createImplementationTimeline(item: InsertImplementationTimeline): Promise<ImplementationTimelineType> {
    const [i] = await db.insert(implementationTimeline).values(item).returning();
    return i;
  }
  async getPoliticalRoadmap(): Promise<PoliticalRoadmapType[]> {
    return await db.select().from(politicalRoadmap);
  }
  async createPoliticalRoadmap(item: InsertPoliticalRoadmap): Promise<PoliticalRoadmapType> {
    const [p] = await db.insert(politicalRoadmap).values(item).returning();
    return p;
  }
  async getStressTests(): Promise<StressTest[]> {
    return await db.select().from(stressTests);
  }
  async createStressTest(item: InsertStressTest): Promise<StressTest> {
    const [s] = await db.insert(stressTests).values(item).returning();
    return s;
  }
  async getTieredCarbonPricing(): Promise<TieredCarbonPricingType[]> {
    return await db.select().from(tieredCarbonPricing);
  }
  async createTieredCarbonPricing(item: InsertTieredCarbonPricing): Promise<TieredCarbonPricingType> {
    const [c] = await db.insert(tieredCarbonPricing).values(item).returning();
    return c;
  }
  async getRegenerativeAgriculture(): Promise<RegenerativeAgricultureType[]> {
    return await db.select().from(regenerativeAgriculture);
  }
  async createRegenerativeAgriculture(item: InsertRegenerativeAgriculture): Promise<RegenerativeAgricultureType> {
    const [a] = await db.insert(regenerativeAgriculture).values(item).returning();
    return a;
  }
  async getNationwideFoodSecurity(): Promise<NationwideFoodSecurityType | undefined> {
    const [n] = await db.select().from(nationwideFoodSecurity).limit(1);
    return n;
  }
  async createNationwideFoodSecurity(item: InsertNationwideFoodSecurity): Promise<NationwideFoodSecurityType> {
    const [n] = await db.insert(nationwideFoodSecurity).values(item).returning();
    return n;
  }
  async getLaborTransition(): Promise<LaborTransitionType[]> {
    return await db.select().from(laborTransition);
  }
  async createLaborTransition(item: InsertLaborTransition): Promise<LaborTransitionType> {
    const [l] = await db.insert(laborTransition).values(item).returning();
    return l;
  }
  async getPoliticalCoalition(): Promise<PoliticalCoalitionType[]> {
    return await db.select().from(politicalCoalition);
  }
  async createPoliticalCoalition(item: InsertPoliticalCoalition): Promise<PoliticalCoalitionType> {
    const [p] = await db.insert(politicalCoalition).values(item).returning();
    return p;
  }
  async getGlobalRegenerationSummary(): Promise<GlobalRegenerationSummaryType | undefined> {
    const [g] = await db.select().from(globalRegenerationSummary).limit(1);
    return g;
  }
  async createGlobalRegenerationSummary(item: InsertGlobalRegenerationSummary): Promise<GlobalRegenerationSummaryType> {
    const [g] = await db.insert(globalRegenerationSummary).values(item).returning();
    return g;
  }
  async getPlanetaryBoundaries(): Promise<PlanetaryBoundaryType[]> {
    return await db.select().from(planetaryBoundaries);
  }
  async createPlanetaryBoundary(item: InsertPlanetaryBoundary): Promise<PlanetaryBoundaryType> {
    const [p] = await db.insert(planetaryBoundaries).values(item).returning();
    return p;
  }
  async getCalibrationTargets(): Promise<CalibrationTargetType[]> {
    return await db.select().from(calibrationTargets);
  }
  async createCalibrationTarget(item: InsertCalibrationTarget): Promise<CalibrationTargetType> {
    const [c] = await db.insert(calibrationTargets).values(item).returning();
    return c;
  }
  async getModelMaturity(): Promise<ModelMaturityType[]> {
    return await db.select().from(modelMaturity);
  }
  async createModelMaturity(item: InsertModelMaturity): Promise<ModelMaturityType> {
    const [m] = await db.insert(modelMaturity).values(item).returning();
    return m;
  }
  async getHistoricalClimateData(): Promise<HistoricalClimateDataType[]> {
    return await db.select().from(historicalClimateData).orderBy(asc(historicalClimateData.year));
  }
  async createHistoricalClimateData(item: InsertHistoricalClimateData): Promise<HistoricalClimateDataType> {
    const [h] = await db.insert(historicalClimateData).values(item).returning();
    return h;
  }
  async getMonteCarloSimulations(): Promise<MonteCarloSimulationType[]> {
    return await db.select().from(monteCarloSimulations);
  }
  async createMonteCarloSimulation(item: InsertMonteCarloSimulation): Promise<MonteCarloSimulationType> {
    const [m] = await db.insert(monteCarloSimulations).values(item).returning();
    return m;
  }
  async getScenarioComparisons(): Promise<ScenarioComparisonType[]> {
    return await db.select().from(scenarioComparisons);
  }
  async createScenarioComparison(item: InsertScenarioComparison): Promise<ScenarioComparisonType> {
    const [s] = await db.insert(scenarioComparisons).values(item).returning();
    return s;
  }
  async getOptimizationParams(): Promise<OptimizationParamType[]> {
    return await db.select().from(optimizationParams);
  }
  async createOptimizationParam(item: InsertOptimizationParam): Promise<OptimizationParamType> {
    const [o] = await db.insert(optimizationParams).values(item).returning();
    return o;
  }
  async getSensitivityAnalysis(): Promise<SensitivityAnalysisType[]> {
    return await db.select().from(sensitivityAnalysis).orderBy(asc(sensitivityAnalysis.rank));
  }
  async createSensitivityAnalysis(item: InsertSensitivityAnalysis): Promise<SensitivityAnalysisType> {
    const [s] = await db.insert(sensitivityAnalysis).values(item).returning();
    return s;
  }
  async getGlobalRegenerationRegions(): Promise<GlobalRegenerationRegionType[]> {
    return await db.select().from(globalRegenerationRegions);
  }
  async createGlobalRegenerationRegion(item: InsertGlobalRegenerationRegion): Promise<GlobalRegenerationRegionType> {
    const [r] = await db.insert(globalRegenerationRegions).values(item).returning();
    return r;
  }
  async getMiningAlternatives(): Promise<MiningAlternativeType[]> {
    return await db.select().from(miningAlternative);
  }
  async createMiningAlternative(item: InsertMiningAlternative): Promise<MiningAlternativeType> {
    const [m] = await db.insert(miningAlternative).values(item).returning();
    return m;
  }
  async isEmpty(): Promise<boolean> {
    const [stats] = await db.select().from(pilotStats).limit(1);
    return !stats;
  }
}

export const storage = new DatabaseStorage();
